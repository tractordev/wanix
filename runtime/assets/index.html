<html>
<head>
    <meta charset="utf-8"/>
    <link rel="stylesheet" href="./wanix.css" />
    <script src="./wanix.min.js"></script>
</head>
<body>
<script>
    (async () => {
        const queryParams = new URLSearchParams(window.location.search);
        const w = new Wanix({ helpers: true, bundle: queryParams.get('bundle') || "/shell/shell.tgz" });
        
        const url = queryParams.get("tty");
        if (url) {
            // websocket tty mode 
            const wid = (await w.readText("cap/new/ws")).trim();
            await w.writeFile("cap/1/ctl", `mount ${url}`);            
            await w.writeFile("task/1/ctl", `bind #console/data cap/${wid}/data`); // todo: make this work
        } else {
            // xterm.js mode 
            const xid = (await w.readText("web/dom/new/xterm")).trim();
            await w.writeFile("task/1/ctl", `bind #console/data web/dom/${xid}/data`);
            await w.writeFile("web/dom/body/ctl", `append-child ${xid}`);
        }
        
        try {
            (new Function(await w.readText("#bundle/init.js")))();
        } catch (e) {
            console.log("No bundle init.js found");
        }
    })()
</script>
</body>
</html>