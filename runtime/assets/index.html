<html>
<head>
    <meta charset="utf-8"/>
    <link rel="stylesheet" href="./wanix.css" />
</head>
<body>
<script type="module">
    import { WanixRuntime } from "./wanix.min.js";
    
    const queryParams = new URLSearchParams(window.location.search);
    const w = new WanixRuntime({ 
        helpers: true, 
        export9p: queryParams.get('export9p') === 'true',
        wasm: queryParams.get('wasm') || "./wanix.wasm", 
        bundle: queryParams.get('bundle') || "/shell/bundle.tgz",
        network: queryParams.get('network') || "ws://localhost:7654/.well-known/ethernet"
    });
    await w.ready();
    console.log("wanix ready");

    const url = queryParams.get("tty");
    if (url) {
        // websocket tty mode 
        const wid = (await w.readText("cap/new/ws")).trim();
        await w.writeFile("cap/1/ctl", `mount ${url}`);            
        await w.writeFile("task/1/ctl", `bind #console/data cap/${wid}/data`); // todo: make this work
    } else {
        // xterm.js mode 
        const xid = (await w.readText("web/dom/new/xterm")).trim();
        await w.writeFile("task/1/ctl", `bind #console/data web/dom/${xid}/data`);
        await w.writeFile("web/dom/body/ctl", `append-child ${xid}`);
    }
    
    try {
        const initJS = await w.readText("#bundle/init.js");
        const blob = new Blob([initJS], { type: 'text/javascript' });
        const initUrl = URL.createObjectURL(blob);
        const initModule = await import(initUrl);
        await initModule.default(w);
    } catch (e) {
        console.log("No bundle init.js found");
    }
</script>
</body>
</html>