(()=>{var ar=Object.create;var os=Object.defineProperty;var _r=Object.getOwnPropertyDescriptor;var cr=Object.getOwnPropertyNames;var dr=Object.getPrototypeOf,ur=Object.prototype.hasOwnProperty;var St=(t=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(t,{get:(e,i)=>(typeof require<"u"?require:e)[i]}):t)(function(t){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+t+'" is not supported')});var pr=(t,e,i,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of cr(e))!ur.call(t,r)&&r!==i&&os(t,r,{get:()=>e[r],enumerable:!(s=_r(e,r))||s.enumerable});return t};var yi=(t,e,i)=>(i=t!=null?ar(dr(t)):{},pr(e||!t||!t.__esModule?os(i,"default",{value:t,enumerable:!0}):i,t));var Le={exports:{}};function hs(t,e){return(t||t===0?t+"":"").padEnd(e," ")}function P(t,e,i,s){return new Proxy({},{get:function(r,n){r=new t(e.buffer,i,s);let o=r[n];return typeof o=="function"?o.bind(r):(/^\d+$/.test(n),o)},set:function(r,n,o){return/^\d+$/.test(n),new t(e.buffer,i,s)[n]=o,!0}})}function a(t,e){return t=(t?t.toString(16):"").toUpperCase(),"0x"+(t||t===0?t+"":"").padStart(e||1,"0")}var Xe;if(typeof crypto<"u"&&crypto.getRandomValues){let t=new Int32Array(1);Xe=function(){return crypto.getRandomValues(t),t[0]}}else if(typeof St<"u"){let t=St("crypto");Xe=function(){return t.randomBytes(4).readInt32LE(0)}}else typeof process<"u"&&import("node:crypto").then(t=>{Xe=function(){return t.randomBytes(4).readInt32LE(0)}});var Ee;if(typeof Math.clz32=="function")Ee=function(t){return 31-Math.clz32(t)};else{for(xe=new Int8Array(256),Ae=0,wi=-2;256>Ae;Ae++)Ae&Ae-1||wi++,xe[Ae]=wi;Ee=function(t){t>>>=0;var e=t>>>16;if(e){var i=e>>>8;return i?24+xe[i]:16+xe[e]}return(i=t>>>8)?8+xe[i]:xe[t]}}var xe,Ae,wi;function lr(t){return 1>=t?1:1<<1+Ee(t-1)}function Fe(t){var e=new Uint8Array(t),i,s;this.length=0,this.push=function(r){this.length!==t&&this.length++,e[s]=r,s=s+1&t-1},this.shift=function(){if(this.length){var r=e[i];return i=i+1&t-1,this.length--,r}return-1},this.peek=function(){return this.length?e[i]:-1},this.clear=function(){this.length=s=i=0},this.clear()}function me(t){this.size=t,this.data=new Float32Array(t),this.length=this.end=this.start=0}me.prototype.push=function(t){this.length===this.size?this.start=this.start+1&this.size-1:this.length++,this.data[this.end]=t,this.end=this.end+1&this.size-1};me.prototype.shift=function(){if(this.length){var t=this.data[this.start];return this.start=this.start+1&this.size-1,this.length--,t}};me.prototype.shift_block=function(t){var e=new Float32Array(t);t>this.length&&(t=this.length);var i=this.start+t,s=this.data.subarray(this.start,i);return e.set(s),i>=this.size&&(i-=this.size,e.set(this.data.subarray(0,i),s.length)),this.start=i,this.length-=t,e};me.prototype.peek=function(){if(this.length)return this.data[this.start]};me.prototype.clear=function(){this.length=this.end=this.start=0};function je(t){typeof t=="number"?this.view=new Uint8Array(t+7>>3):t instanceof ArrayBuffer&&(this.view=new Uint8Array(t))}je.prototype.set=function(t,e){let i=t>>3;t=1<<(t&7),this.view[i]=e?this.view[i]|t:this.view[i]&~t};je.prototype.get=function(t){return this.view[t>>3]>>(t&7)&1};je.prototype.get_buffer=function(){return this.view.buffer};var Ct,vi;if(typeof XMLHttpRequest>"u"||typeof process<"u"&&process.versions&&process.versions.node){let t;Ct=async function(e,i){if(t||(t=await import("node:fs/promises")),i.range){e=await t.open(e,"r");let s=Buffer.allocUnsafe(i.range.length);try{await e.read({buffer:s,position:i.range.start})}finally{await e.close()}i.done&&i.done(new Uint8Array(s))}else e=await t.readFile(e,{encoding:i.as_json?"utf-8":null}),e=i.as_json?JSON.parse(e):new Uint8Array(e).buffer,i.done(e)},vi=async function(e){return t||(t=await import("node:fs/promises")),(await t.stat(e)).size}}else Ct=async function(t,e,i){function s(){let _=i||0;setTimeout(()=>{Ct(t,e,_+1)},1e3*([1,1,2,3,5,8,13,21][_]||34))}var r=new XMLHttpRequest;if(r.open(e.method||"get",t,!0),r.responseType=e.as_json?"json":"arraybuffer",e.headers)for(var n=Object.keys(e.headers),o=0;o<n.length;o++){var h=n[o];r.setRequestHeader(h,e.headers[h])}e.range&&(n=e.range.start,r.setRequestHeader("Range","bytes="+n+"-"+(n+e.range.length-1)),r.setRequestHeader("X-Accept-Encoding","identity"),r.onreadystatechange=function(){r.status===200&&(console.error("Server sent full file in response to ranged request, aborting",{filename:t}),r.abort())}),r.onload=function(){if(r.readyState===4){if(r.status!==200&&r.status!==206)console.error("Loading the image "+t+" failed (status %d)",r.status),500<=r.status&&600>r.status&&s();else if(r.response){if(e.range){let _=r.getResponseHeader("Content-Encoding");_&&_!=="identity"&&console.error("Server sent Content-Encoding in response to ranged request",{filename:t,enc:_})}e.done&&e.done(r.response,r)}}},r.onerror=function(_){console.error("Loading the image "+t+" failed",_),s()},e.progress&&(r.onprogress=function(_){e.progress(_)}),r.send(null)},vi=async function(t){return new Promise((e,i)=>{Ct(t,{done:(s,r)=>{s=r.getResponseHeader("Content-Range")||"",(r=s.match(/\/(\d+)\s*$/))?e(+r[1]):i(Error("`Range: bytes=...` header not supported (Got `"+s+"`)"))},headers:{Range:"bytes=0-0","X-Accept-Encoding":"identity"}})})};function fr(t,e){function i(E){return E=E.toString(16),"#"+"0".repeat(6-E.length)+E}function s(E){var v=256*ut,C=8*Q,W=Et?Et.canvas:null;W&&W.width===v&&W.height===C||(W?(W.width=v,W.height=C):(W=new OffscreenCanvas(v,C),Et=W.getContext("2d")),ve=Et.createImageData(v,C));let tt=ve.data,J=0,et;C=ke?function(at){et=et||at,tt[J+3]=at,tt[J+7]=at,J+=8}:function(at){et=et||at,tt[J+3]=at,J+=4},W=32-Q;let It=v*(Q-1)*4;v=4*(ut-v*Q);let xt=1020*ut;for(let at=0,te=0;2048>at;++at,te+=W,J+=v){let ee=at%256;at&&!ee&&(J+=It),et=!1;for(let he=0;he<Q;++he,++te,J+=xt){let ae=E[te];for(let jt=128;0<jt;jt>>=1)C(ae&jt?255:0);be&&C(m&&192<=ee&&223>=ee&&ae&1?255:0)}Qt[at]=et?1:0}Et.putImageData(ve,0,0)}function r(E,v,C,W){if(v&&C){E.style.width="",E.style.height="",W&&(E.style.transform="");var tt=E.getBoundingClientRect();W?E.style.transform=(v===1?"":" scaleX("+v+")")+(C===1?"":" scaleY("+C+")"):(v%1===0&&C%1===0?(o.style.imageRendering="crisp-edges",o.style.imageRendering="pixelated",o.style["-ms-interpolation-mode"]="nearest-neighbor"):(o.style.imageRendering="",o.style["-ms-interpolation-mode"]=""),W=window.devicePixelRatio||1,W%1!==0&&(v/=W,C/=W)),v!==1&&(E.style.width=tt.width*v+"px"),C!==1&&(E.style.height=tt.height*C+"px")}}let n=t.container;this.screen_fill_buffer=e,console.assert(n,"options.container must be provided"),this.FLAG_BLINKING=1,this.FLAG_FONT_PAGE_B=2;var o=n.getElementsByTagName("canvas")[0],h=o.getContext("2d",{alpha:!1}),_=n.getElementsByTagName("div")[0],c=document.createElement("div"),d,p,f=t.scale!==void 0?t.scale:1,g=t.scale!==void 0?t.scale:1,x=1,b,w,F,A,S,X,dt,Et,ve,Qt=new Int8Array(2048),Q,ut,be,ke,m,O=0,k=0,I,U=0,R,j,G,V=[],H=V,fe=0,gi=!1;this.init=function(){let E=new Uint16Array([32,9786,9787,9829,9830,9827,9824,8226,9688,9675,9689,9794,9792,9834,9835,9788,9658,9668,8597,8252,182,167,9644,8616,8593,8595,8594,8592,8735,8596,9650,9660]),v=new Uint16Array([8962,199,252,233,226,228,224,229,231,234,235,232,239,238,236,196,197,201,230,198,244,246,242,251,249,255,214,220,162,163,165,8359,402,225,237,243,250,241,209,170,186,191,8976,172,189,188,161,171,187,9617,9618,9619,9474,9508,9569,9570,9558,9557,9571,9553,9559,9565,9564,9563,9488,9492,9524,9516,9500,9472,9532,9566,9567,9562,9556,9577,9574,9568,9552,9580,9575,9576,9572,9573,9561,9560,9554,9555,9579,9578,9496,9484,9608,9604,9612,9616,9600,945,223,915,960,931,963,181,964,934,920,937,948,8734,966,949,8745,8801,177,8805,8804,8992,8993,247,8776,176,8729,183,8730,8319,178,9632,160]);for(var C=0,W;256>C;C++)W=126<C?v[C-127]:32>C?E[C]:C,V.push(String.fromCharCode(W));c.classList.add("cursor"),c.style.position="absolute",c.style.backgroundColor="#ccc",c.style.width="7px",c.style.display="inline-block",this.set_mode(!1),this.set_size_text(80,25),w===2&&this.set_size_graphical(720,400,720,400),this.set_scale(f,g),this.timer()},this.make_screenshot=function(){let E=new Image;if(w===1||w===2)E.src=o.toDataURL("image/png");else{let v=[9,16],C=document.createElement("canvas");C.width=A*v[0],C.height=S*v[1];let W=C.getContext("2d");W.imageSmoothingEnabled=!1,W.font=window.getComputedStyle(_).font,W.textBaseline="top";for(let tt=0;tt<S;tt++)for(let J=0;J<A;J++){let et=4*(tt*A+J),It=F[et+0],xt=F[et+3];W.fillStyle=i(F[et+2]),W.fillRect(J*v[0],tt*v[1],v[0],v[1]),W.fillStyle=i(xt),W.fillText(H[It],J*v[0],tt*v[1])}c.style.display!=="none"&&d<S&&p<A&&(W.fillStyle=c.style.backgroundColor,W.fillRect(p*v[0],d*v[1]+parseInt(c.style.marginTop,10),parseInt(c.style.width,10),parseInt(c.style.height,10))),E.src=C.toDataURL("image/png")}return E},this.put_char=function(E,v,C,W,tt,J){v=4*(E*A+v),F[v+0]=C,F[v+1]=W,F[v+2]=tt,F[v+3]=J,b[E]=1},this.timer=function(){fe=requestAnimationFrame(()=>this.update_screen())},this.update_screen=function(){gi||(w===0?this.update_text():w===1?this.update_graphical():this.update_graphical_text()),this.timer()},this.update_text=function(){for(var E=0;E<S;E++)b[E]&&(this.text_update_row(E),b[E]=0)},this.update_graphical=function(){this.screen_fill_buffer()},this.update_graphical_text=function(){if(X){var E=performance.now();if(266<E-U){I=!I,G&&(b[d]=1);var v=4*A;for(let It=0,xt=0;It<S;++It)if(b[It])xt+=v;else for(var C=0;C<A;++C,xt+=4)if(F[xt+1]&1){b[It]=1,xt+=v-4*C;break}U=E}E=Et.canvas,v=dt.canvas,C=4*A;let tt=A*ut,J=Q,et=0;for(let It=0,xt=0,at=0;It<S;++It,xt+=Q){if(!b[It]){at+=C;continue}++et,dt.clearRect(0,J,tt,Q);let te,ee,he,ae;for(let jt=0;jt<tt;jt+=ut,at+=4){let is=F[at+0];var W=F[at+1];let ss=F[at+2],rs=F[at+3],ns=W&2?k:O;W=(!(W&1)||I)&&Qt[(ns<<8)+is],he!==ss&&(he!==void 0&&(X.fillStyle=i(he),X.fillRect(ae,xt,jt-ae,Q)),he=ss,ae=jt),te!==rs&&(te!==void 0&&(dt.fillStyle=i(te),dt.fillRect(ee,0,jt-ee,Q)),te=rs,ee=jt),W&&dt.drawImage(E,is*ut,ns*Q,ut,Q,jt,J,ut,Q)}dt.fillStyle=i(te),dt.fillRect(ee,0,tt-ee,Q),dt.globalCompositeOperation="destination-in",dt.drawImage(v,0,J,tt,Q,0,0,tt,Q),dt.globalCompositeOperation="source-over",X.fillStyle=i(he),X.fillRect(ae,xt,tt-ae,Q),X.drawImage(v,0,0,tt,Q,0,xt,tt,Q)}et&&(I&&G&&b[d]&&(X.fillStyle=i(F[4*(d*A+p)+3]),X.fillRect(p*ut,d*Q+R,ut,j-R+1)),b.fill(0)),et&&h.drawImage(X.canvas,0,0)}},this.destroy=function(){fe&&(cancelAnimationFrame(fe),fe=0)},this.pause=function(){gi=!0,c.classList.remove("blinking-cursor")},this.continue=function(){gi=!1,c.classList.add("blinking-cursor")},this.set_mode=function(E){w=E?1:t.use_graphical_text?2:0,w===0?(_.style.display="block",o.style.display="none"):(_.style.display="none",o.style.display="block",w===2&&b&&b.fill(1))},this.set_font_bitmap=function(E,v,C,W,tt,J){let et=C?16:v?9:8;(Q!==E||ut!==et||be!==v||ke!==C||m!==W||J)&&(J=ut!==et||Q!==E,Q=E,ut=et,be=v,ke=C,m=W,w===2&&(s(tt),b.fill(1),J&&this.set_size_graphical_text()))},this.set_font_page=function(E,v){(O!==E||k!==v)&&(O=E,k=v,b.fill(1))},this.clear_screen=function(){h.fillStyle="#000",h.fillRect(0,0,o.width,o.height)},this.set_size_graphical_text=function(){if(Et){var E=ut*A,v=Q*S,C=2*Q;X&&X.canvas.width===E&&X.canvas.height===v&&dt.canvas.height===C||(X?(X.canvas.width=E,X.canvas.height=v,dt.canvas.width=E,dt.canvas.height=C):(X=new OffscreenCanvas(E,v).getContext("2d",{alpha:!1}),dt=new OffscreenCanvas(E,C).getContext("2d")),this.set_size_graphical(E,v,E,v),b.fill(1))}},this.set_size_text=function(E,v){if(E!==A||v!==S)if(b=new Int8Array(v),F=new Int32Array(E*v*4),A=E,S=v,w===0){for(;_.childNodes.length>v;)_.removeChild(_.firstChild);for(;_.childNodes.length<v;)_.appendChild(document.createElement("div"));for(E=0;E<v;E++)this.text_update_row(E);r(_,f,g,!0)}else w===2&&this.set_size_graphical_text()},this.set_size_graphical=function(E,v){o.style.display="block",o.width=E,o.height=v,h.imageSmoothingEnabled=!1,x=640>=E&&2*E<window.innerWidth*window.devicePixelRatio&&2*v<window.innerHeight*window.devicePixelRatio?2:1,r(o,f*x,g*x,!1)},this.set_charmap=function(E){H=E||V},this.set_scale=function(E,v){f=E,g=v,r(_,f,g,!0),r(o,f*x,g*x,!1)},this.update_cursor_scanline=function(E,v,C){(E!==R||v!==j||C!==G)&&(w===0?C?(c.style.display="inline",c.style.height=v-E+"px",c.style.marginTop=E+"px"):c.style.display="none":w===2&&d<S&&(b[d]=1),R=E,j=v,G=C)},this.update_cursor=function(E,v){(E!==d||v!==p)&&(E<S&&(b[E]=1),d<S&&(b[d]=1),d=E,p=v)},this.text_update_row=function(E){for(var v=4*E*A,C,W=_.childNodes[E],tt=document.createElement("div"),J=0;J<A;){var et=document.createElement("span"),It=F[v+1]&1,xt=F[v+2],at=F[v+3];for(It&&et.classList.add("blink"),et.style.backgroundColor=i(xt),et.style.color=i(at),C="";J<A&&(F[v+1]&1)===It&&F[v+2]===xt&&F[v+3]===at;)if(C+=H[F[v+0]],J++,v+=4,E===d){if(J===p)break;if(J===p+1){c.style.backgroundColor=et.style.color,tt.appendChild(c);break}}et.textContent=C,tt.appendChild(et)}W.parentNode.replaceChild(tt,W)},this.update_buffer=function(E){for(let v of E)h.putImageData(v.image_data,v.screen_x-v.buffer_x,v.screen_y-v.buffer_y,v.buffer_x,v.buffer_y,v.buffer_width,v.buffer_height)},this.get_text_screen=function(){for(var E=[],v=0;v<S;v++)E.push(this.get_text_row(v));return E},this.get_text_row=function(E){let v="";for(let C=0;C<A;C++)v+=H[F[4*(E*A+C)]];return v},this.init()}function lt(t){this.buffer=t,this.byteLength=t.byteLength,this.onprogress=this.onload=void 0}lt.prototype.load=function(){this.onload&&this.onload({buffer:this.buffer})};lt.prototype.get=function(t,e,i){i(new Uint8Array(this.buffer,t,e))};lt.prototype.set=function(t,e,i){new Uint8Array(this.buffer,t,e.byteLength).set(e),i()};lt.prototype.get_buffer=function(t){t(this.buffer)};lt.prototype.get_state=function(){let t=[];return t[0]=this.byteLength,t[1]=new Uint8Array(this.buffer),t};lt.prototype.set_state=function(t){this.byteLength=t[0],this.buffer=t[1].slice().buffer};function mt(t,e,i){this.filename=t,this.byteLength=e,this.block_cache=new Map,this.block_cache_is_write=new Set,this.fixed_chunk_size=i,this.cache_reads=!!i,this.onprogress=this.onload=void 0}mt.prototype.load=async function(){this.byteLength===void 0&&(this.byteLength=await vi(this.filename)),this.onload&&this.onload(Object.create(null))};mt.prototype.get_from_cache=function(t,e){var i=e/256;t/=256;for(var s=0;s<i;s++)if(!this.block_cache.get(t+s))return;if(i===1)return this.block_cache.get(t);for(e=new Uint8Array(e),s=0;s<i;s++)e.set(this.block_cache.get(t+s),256*s);return e};mt.prototype.get=function(t,e,i){var s=this.get_from_cache(t,e);if(s)i(s);else{var r=t,n=e;this.fixed_chunk_size&&(r=t-t%this.fixed_chunk_size,n=Math.ceil((t-r+e)/this.fixed_chunk_size)*this.fixed_chunk_size),Ct(this.filename,{done:function(o){o=new Uint8Array(o),this.handle_read(r,n,o),i(r===t&&n===e?o:o.subarray(t-r,t-r+e))}.bind(this),range:{start:r,length:n}})}};mt.prototype.set=function(t,e,i){t/=256;for(var s=e.length/256,r=0;r<s;r++){var n=this.block_cache.get(t+r);if(n===void 0)n=e.slice(256*r,256*(r+1)),this.block_cache.set(t+r,n);else{let o=e.subarray(256*r,256*(r+1));n.set(o)}this.block_cache_is_write.add(t+r)}i()};mt.prototype.handle_read=function(t,e,i){t/=256,e/=256;for(var s=0;s<e;s++){let r=this.block_cache.get(t+s);r?i.set(r,256*s):this.cache_reads&&this.block_cache.set(t+s,i.slice(256*s,256*(s+1)))}};mt.prototype.get_buffer=function(t){t()};mt.prototype.get_state=function(){let t=[],e=[];for(let[i,s]of this.block_cache)isFinite(i),this.block_cache_is_write.has(i)&&e.push([i,s]);return t[0]=e,t};mt.prototype.set_state=function(t){t=t[0],this.block_cache.clear(),this.block_cache_is_write.clear();for(let[e,i]of t)isFinite(e),this.block_cache.set(e,i),this.block_cache_is_write.add(e)};function ce(t,e,i,s,r){let n=t.match(/\.[^\.]+(\.zst)?$/);this.extension=n?n[0]:"",this.basename=t.substring(0,t.length-this.extension.length),this.is_zstd=this.extension.endsWith(".zst"),this.basename.endsWith("/")||(this.basename+="-"),this.block_cache=new Map,this.block_cache_is_write=new Set,this.byteLength=e,this.fixed_chunk_size=i,this.partfile_alt_format=!!s,this.zstd_decompress=r,this.cache_reads=!!i,this.onprogress=this.onload=void 0}ce.prototype.load=function(){this.onload&&this.onload(Object.create(null))};ce.prototype.get=function(t,e,i){var s=this.get_from_cache(t,e);if(s)i(s);else if(this.fixed_chunk_size){let n=Math.floor(t/this.fixed_chunk_size),o=t-n*this.fixed_chunk_size,h=Math.ceil((o+e)/this.fixed_chunk_size),_=new Uint8Array(h*this.fixed_chunk_size),c=0;for(let d=0;d<h;d++){var r=(n+d)*this.fixed_chunk_size;s=this.partfile_alt_format?this.basename+(n+d+"").padStart(8,"0")+this.extension:this.basename+r+"-"+(r+this.fixed_chunk_size)+this.extension,(r=this.get_from_cache(r,this.fixed_chunk_size))?(_.set(r,d*this.fixed_chunk_size),c++,c===h&&i(_.subarray(o,o+e))):Ct(s,{done:async function(p){p=new Uint8Array(p),this.is_zstd&&(p=await this.zstd_decompress(this.fixed_chunk_size,p),p=new Uint8Array(p)),_.set(p,d*this.fixed_chunk_size),this.handle_read((n+d)*this.fixed_chunk_size,this.fixed_chunk_size|0,p),c++,c===h&&i(_.subarray(o,o+e))}.bind(this)})}}else Ct(this.basename+t+"-"+(t+e)+this.extension,{done:function(n){n=new Uint8Array(n),this.handle_read(t,e,n),i(n)}.bind(this)})};ce.prototype.get_from_cache=mt.prototype.get_from_cache;ce.prototype.set=mt.prototype.set;ce.prototype.handle_read=mt.prototype.handle_read;ce.prototype.get_state=mt.prototype.get_state;ce.prototype.set_state=mt.prototype.set_state;function de(t){this.file=t,this.byteLength=t.size,1073741824<t.size&&console.warn("SyncFileBuffer: Allocating buffer of "+(t.size>>20)+" MB ..."),this.buffer=new ArrayBuffer(t.size),this.onprogress=this.onload=void 0}de.prototype.load=function(){this.load_next(0)};de.prototype.load_next=function(t){var e=new FileReader;if(e.onload=function(s){s=new Uint8Array(s.target.result),new Uint8Array(this.buffer,t).set(s),this.load_next(t+4194304)}.bind(this),this.onprogress&&this.onprogress({loaded:t,total:this.byteLength,lengthComputable:!0}),t<this.byteLength){var i=this.file.slice(t,Math.min(t+4194304,this.byteLength));e.readAsArrayBuffer(i)}else this.file=void 0,this.onload&&this.onload({buffer:this.buffer})};de.prototype.get=lt.prototype.get;de.prototype.set=lt.prototype.set;de.prototype.get_buffer=lt.prototype.get_buffer;de.prototype.get_state=lt.prototype.get_state;de.prototype.set_state=lt.prototype.set_state;function Kt(t){this.file=t,this.byteLength=t.size,this.block_cache=new Map,this.block_cache_is_write=new Set,this.onprogress=this.onload=void 0}Kt.prototype.load=function(){this.onload&&this.onload(Object.create(null))};Kt.prototype.get=function(t,e,i){var s=this.get_from_cache(t,e);s?i(s):(s=new FileReader,s.onload=function(r){r=new Uint8Array(r.target.result),this.handle_read(t,e,r),i(r)}.bind(this),s.readAsArrayBuffer(this.file.slice(t,t+e)))};Kt.prototype.get_from_cache=mt.prototype.get_from_cache;Kt.prototype.set=mt.prototype.set;Kt.prototype.handle_read=mt.prototype.handle_read;Kt.prototype.get_state=mt.prototype.get_state;Kt.prototype.set_state=mt.prototype.set_state;Kt.prototype.get_buffer=function(t){t()};Kt.prototype.get_as_file=function(t){for(var e=[],i=Array.from(this.block_cache.keys()).sort(function(h,_){return h-_}),s=0,r=0;r<i.length;r++){var n=i[r],o=this.block_cache.get(n);n*=256,n!==s&&(e.push(this.file.slice(s,n)),s=n),e.push(o),s+=o.length}return s!==this.file.size&&e.push(this.file.slice(s)),new File(e,t)};function Ai(t,e){if(t.buffer instanceof ArrayBuffer)return new lt(t.buffer);if(typeof File<"u"&&t.buffer instanceof File)return e=t.async,e===void 0&&(e=268435456<=t.buffer.size),e?new Kt(t.buffer):new de(t.buffer);if(t.url)return t.use_parts?new ce(t.url,t.size,t.fixed_chunk_size,!1,e):new mt(t.url,t.size,t.fixed_chunk_size)}function nt(t){this.cpu=t,this.channel_page=new Uint8Array(8),this.channel_pagehi=new Uint8Array(8),this.channel_addr=new Uint16Array(8),this.channel_addr_init=new Uint16Array(8),this.channel_count=new Uint16Array(8),this.channel_count_init=new Uint16Array(8),this.channel_mask=new Uint8Array(8),this.channel_mode=new Uint8Array(8),this.unmask_listeners=[],this.lsb_msb_flipflop=0,t=t.io,t.register_write(0,this,this.port_addr_write.bind(this,0)),t.register_write(2,this,this.port_addr_write.bind(this,1)),t.register_write(4,this,this.port_addr_write.bind(this,2)),t.register_write(6,this,this.port_addr_write.bind(this,3)),t.register_write(1,this,this.port_count_write.bind(this,0)),t.register_write(3,this,this.port_count_write.bind(this,1)),t.register_write(5,this,this.port_count_write.bind(this,2)),t.register_write(7,this,this.port_count_write.bind(this,3)),t.register_read(0,this,this.port_addr_read.bind(this,0)),t.register_read(2,this,this.port_addr_read.bind(this,1)),t.register_read(4,this,this.port_addr_read.bind(this,2)),t.register_read(6,this,this.port_addr_read.bind(this,3)),t.register_read(1,this,this.port_count_read.bind(this,0)),t.register_read(3,this,this.port_count_read.bind(this,1)),t.register_read(5,this,this.port_count_read.bind(this,2)),t.register_read(7,this,this.port_count_read.bind(this,3)),t.register_write(192,this,this.port_addr_write.bind(this,4)),t.register_write(196,this,this.port_addr_write.bind(this,5)),t.register_write(200,this,this.port_addr_write.bind(this,6)),t.register_write(204,this,this.port_addr_write.bind(this,7)),t.register_write(194,this,this.port_count_write.bind(this,4)),t.register_write(198,this,this.port_count_write.bind(this,5)),t.register_write(202,this,this.port_count_write.bind(this,6)),t.register_write(206,this,this.port_count_write.bind(this,7)),t.register_read(192,this,this.port_addr_read.bind(this,4)),t.register_read(196,this,this.port_addr_read.bind(this,5)),t.register_read(200,this,this.port_addr_read.bind(this,6)),t.register_read(204,this,this.port_addr_read.bind(this,7)),t.register_read(194,this,this.port_count_read.bind(this,4)),t.register_read(198,this,this.port_count_read.bind(this,5)),t.register_read(202,this,this.port_count_read.bind(this,6)),t.register_read(206,this,this.port_count_read.bind(this,7)),t.register_write(135,this,this.port_page_write.bind(this,0)),t.register_write(131,this,this.port_page_write.bind(this,1)),t.register_write(129,this,this.port_page_write.bind(this,2)),t.register_write(130,this,this.port_page_write.bind(this,3)),t.register_write(143,this,this.port_page_write.bind(this,4)),t.register_write(139,this,this.port_page_write.bind(this,5)),t.register_write(137,this,this.port_page_write.bind(this,6)),t.register_write(138,this,this.port_page_write.bind(this,7)),t.register_read(135,this,this.port_page_read.bind(this,0)),t.register_read(131,this,this.port_page_read.bind(this,1)),t.register_read(129,this,this.port_page_read.bind(this,2)),t.register_read(130,this,this.port_page_read.bind(this,3)),t.register_read(143,this,this.port_page_read.bind(this,4)),t.register_read(139,this,this.port_page_read.bind(this,5)),t.register_read(137,this,this.port_page_read.bind(this,6)),t.register_read(138,this,this.port_page_read.bind(this,7)),t.register_write(1159,this,this.port_pagehi_write.bind(this,0)),t.register_write(1155,this,this.port_pagehi_write.bind(this,1)),t.register_write(1153,this,this.port_pagehi_write.bind(this,2)),t.register_write(1154,this,this.port_pagehi_write.bind(this,3)),t.register_write(1163,this,this.port_pagehi_write.bind(this,5)),t.register_write(1161,this,this.port_pagehi_write.bind(this,6)),t.register_write(1162,this,this.port_pagehi_write.bind(this,7)),t.register_read(1159,this,this.port_pagehi_read.bind(this,0)),t.register_read(1155,this,this.port_pagehi_read.bind(this,1)),t.register_read(1153,this,this.port_pagehi_read.bind(this,2)),t.register_read(1154,this,this.port_pagehi_read.bind(this,3)),t.register_read(1163,this,this.port_pagehi_read.bind(this,5)),t.register_read(1161,this,this.port_pagehi_read.bind(this,6)),t.register_read(1162,this,this.port_pagehi_read.bind(this,7)),t.register_write(10,this,this.port_singlemask_write.bind(this,0)),t.register_write(212,this,this.port_singlemask_write.bind(this,4)),t.register_write(15,this,this.port_multimask_write.bind(this,0)),t.register_write(222,this,this.port_multimask_write.bind(this,4)),t.register_read(15,this,this.port_multimask_read.bind(this,0)),t.register_read(222,this,this.port_multimask_read.bind(this,4)),t.register_write(11,this,this.port_mode_write.bind(this,0)),t.register_write(214,this,this.port_mode_write.bind(this,4)),t.register_write(12,this,this.portC_write),t.register_write(216,this,this.portC_write)}nt.prototype.get_state=function(){return[this.channel_page,this.channel_pagehi,this.channel_addr,this.channel_addr_init,this.channel_count,this.channel_count_init,this.channel_mask,this.channel_mode,this.lsb_msb_flipflop]};nt.prototype.set_state=function(t){this.channel_page=t[0],this.channel_pagehi=t[1],this.channel_addr=t[2],this.channel_addr_init=t[3],this.channel_count=t[4],this.channel_count_init=t[5],this.channel_mask=t[6],this.channel_mode=t[7],this.lsb_msb_flipflop=t[8]};nt.prototype.port_count_write=function(t,e){a(e),this.channel_count[t]=this.flipflop_get(this.channel_count[t],e,!1),this.channel_count_init[t]=this.flipflop_get(this.channel_count_init[t],e,!0)};nt.prototype.port_count_read=function(t){return a(this.channel_count[t]),this.flipflop_read(this.channel_count[t])};nt.prototype.port_addr_write=function(t,e){a(e),this.channel_addr[t]=this.flipflop_get(this.channel_addr[t],e,!1),this.channel_addr_init[t]=this.flipflop_get(this.channel_addr_init[t],e,!0)};nt.prototype.port_addr_read=function(t){return a(this.channel_addr[t]),this.flipflop_read(this.channel_addr[t])};nt.prototype.port_pagehi_write=function(t,e){a(e),this.channel_pagehi[t]=e};nt.prototype.port_pagehi_read=function(t){return this.channel_pagehi[t]};nt.prototype.port_page_write=function(t,e){a(e),this.channel_page[t]=e};nt.prototype.port_page_read=function(t){return this.channel_page[t]};nt.prototype.port_singlemask_write=function(t,e){this.update_mask((e&3)+t,e&4?1:0)};nt.prototype.port_multimask_write=function(t,e){a(e);for(var i=0;4>i;i++)this.update_mask(t+i,e&1<<i)};nt.prototype.port_multimask_read=function(t){var e=0|this.channel_mask[t+0];return e|=this.channel_mask[t+1]<<1,e|=this.channel_mask[t+2]<<2,e|=this.channel_mask[t+3]<<3,a(e),e};nt.prototype.port_mode_write=function(t,e){t=(e&3)+t,a(e),this.channel_mode[t]=e};nt.prototype.portC_write=function(){this.lsb_msb_flipflop=0};nt.prototype.on_unmask=function(t,e){this.unmask_listeners.push({fn:t,this_value:e})};nt.prototype.update_mask=function(t,e){if(this.channel_mask[t]!==e&&(this.channel_mask[t]=e,!e))for(e=0;e<this.unmask_listeners.length;e++)this.unmask_listeners[e].fn.call(this.unmask_listeners[e].this_value,t)};nt.prototype.do_read=function(t,e,i,s,r){var n=this.count_get_8bit(s),o=this.address_get_8bit(s);if(""+a(o)+a(n),i<n&&(""+a(i)+a(n),void 0),e+n>t.byteLength)r(!0);else{var h=this.cpu;this.channel_addr[s]+=n,t.get(e,n,function(_){h.write_blob(_,o),r(!1)})}};nt.prototype.do_write=function(t,e,i,s,r){var n=this.channel_count[s]+1&65535,o=5<=s?2:1,h=n*o,_=this.address_get_8bit(s),c=!1,d=!1,p=this.channel_mode[s]&16;""+a(_)+a(h),i<h?(n=Math.floor(i/o),h=n*o,c=!0):i>h&&(d=!0),e+h>t.byteLength?r(!0):(this.channel_addr[s]+=n,this.channel_count[s]-=n,!c&&p&&(this.channel_addr[s]=this.channel_addr_init[s],this.channel_count[s]=this.channel_count_init[s]),t.set(e,this.cpu.mem8.subarray(_,_+h),()=>{d&&p?this.do_write(t,e+h,i-h,s,r):r(!1)}))};nt.prototype.address_get_8bit=function(t){var e=this.channel_addr[t];return 5<=t&&(e<<=1),e=e&65535|this.channel_page[t]<<16,e|=this.channel_pagehi[t]<<24};nt.prototype.count_get_8bit=function(t){var e=this.channel_count[t]+1;return 5<=t&&(e*=2),e};nt.prototype.flipflop_get=function(t,e,i){return i||(this.lsb_msb_flipflop^=1),this.lsb_msb_flipflop?t&-256|e:t&-65281|e<<8};nt.prototype.flipflop_read=function(t){return(this.lsb_msb_flipflop^=1)?t&255:t>>8&255};function ft(t){this.ports=[],this.cpu=t;for(var e=0;65536>e;e++)this.ports[e]=this.create_empty_entry();var i=t.memory_size[0];for(e=0;e<<17<i;e++)t.memory_map_read8[e]=t.memory_map_write8[e]=void 0,t.memory_map_read32[e]=t.memory_map_write32[e]=void 0;this.mmap_register(i,4294967296-i,function(s){return a(s>>>0,8),255},function(s,r){a(s>>>0,8),a(r,2)},function(s){return a(s>>>0,8),-1},function(s,r){a(s>>>0,8),a(r>>>0,8)})}ft.prototype.create_empty_entry=function(){return{read8:this.empty_port_read8,read16:this.empty_port_read16,read32:this.empty_port_read32,write8:this.empty_port_write,write16:this.empty_port_write,write32:this.empty_port_write,device:void 0}};ft.prototype.empty_port_read8=function(){return 255};ft.prototype.empty_port_read16=function(){return 65535};ft.prototype.empty_port_read32=function(){return-1};ft.prototype.empty_port_write=function(){};ft.prototype.register_read=function(t,e,i,s,r){i&&(this.ports[t].read8=i),s&&(this.ports[t].read16=s),r&&(this.ports[t].read32=r),this.ports[t].device=e};ft.prototype.register_write=function(t,e,i,s,r){i&&(this.ports[t].write8=i),s&&(this.ports[t].write16=s),r&&(this.ports[t].write32=r),this.ports[t].device=e};ft.prototype.register_read_consecutive=function(t,e,i,s,r,n){function o(){return i.call(this)|s.call(this)<<8}function h(){return r.call(this)|n.call(this)<<8}function _(){return i.call(this)|s.call(this)<<8|r.call(this)<<16|n.call(this)<<24}r&&n?(this.register_read(t,e,i,o,_),this.register_read(t+1,e,s),this.register_read(t+2,e,r,h),this.register_read(t+3,e,n)):(this.register_read(t,e,i,o),this.register_read(t+1,e,s))};ft.prototype.register_write_consecutive=function(t,e,i,s,r,n){function o(c){i.call(this,c&255),s.call(this,c>>8&255)}function h(c){r.call(this,c&255),n.call(this,c>>8&255)}function _(c){i.call(this,c&255),s.call(this,c>>8&255),r.call(this,c>>16&255),n.call(this,c>>>24)}r&&n?(this.register_write(t,e,i,o,_),this.register_write(t+1,e,s),this.register_write(t+2,e,r,h),this.register_write(t+3,e,n)):(this.register_write(t,e,i,o),this.register_write(t+1,e,s))};ft.prototype.mmap_read32_shim=function(t){var e=this.cpu.memory_map_read8[t>>>17];return e(t)|e(t+1)<<8|e(t+2)<<16|e(t+3)<<24};ft.prototype.mmap_write32_shim=function(t,e){var i=this.cpu.memory_map_write8[t>>>17];i(t,e&255),i(t+1,e>>8&255),i(t+2,e>>16&255),i(t+3,e>>>24)};ft.prototype.mmap_register=function(t,e,i,s,r,n){for(a(t>>>0,8),a(e,8),r||(r=this.mmap_read32_shim.bind(this)),n||(n=this.mmap_write32_shim.bind(this)),t>>>=17;0<e;t++)this.cpu.memory_map_read8[t]=i,this.cpu.memory_map_write8[t]=s,this.cpu.memory_map_read32[t]=r,this.cpu.memory_map_write32[t]=n,e-=131072};ft.prototype.port_write8=function(t,e){var i=this.ports[t];return i.write8===this.empty_port_write&&(a(t,4),a(e,2),this.get_port_description(t)),i.write8.call(i.device,e)};ft.prototype.port_write16=function(t,e){var i=this.ports[t];return i.write16===this.empty_port_write&&(a(t,4),a(e,4),this.get_port_description(t)),i.write16.call(i.device,e)};ft.prototype.port_write32=function(t,e){var i=this.ports[t];return i.write32===this.empty_port_write&&(a(t,4),a(e>>>0,8),this.get_port_description(t)),i.write32.call(i.device,e)};ft.prototype.port_read8=function(t){var e=this.ports[t];return e.read8===this.empty_port_read8&&(a(t,4),this.get_port_description(t)),e=e.read8.call(e.device,t),(0>e||256<=e)&&a(t),e};ft.prototype.port_read16=function(t){var e=this.ports[t];return e.read16===this.empty_port_read16&&(a(t,4),this.get_port_description(t)),e=e.read16.call(e.device,t),(0>e||65536<=e)&&a(t),e};ft.prototype.port_read32=function(t){var e=this.ports[t];return e.read32===this.empty_port_read32&&(a(t,4),this.get_port_description(t)),e.read32.call(e.device,t)};var as={4:"PORT_DMA_ADDR_2",5:"PORT_DMA_CNT_2",10:"PORT_DMA1_MASK_REG",11:"PORT_DMA1_MODE_REG",12:"PORT_DMA1_CLEAR_FF_REG",13:"PORT_DMA1_MASTER_CLEAR",32:"PORT_PIC1_CMD",33:"PORT_PIC1_DATA",64:"PORT_PIT_COUNTER0",65:"PORT_PIT_COUNTER1",66:"PORT_PIT_COUNTER2",67:"PORT_PIT_MODE",96:"PORT_PS2_DATA",97:"PORT_PS2_CTRLB",100:"PORT_PS2_STATUS",112:"PORT_CMOS_INDEX",113:"PORT_CMOS_DATA",128:"PORT_DIAG",129:"PORT_DMA_PAGE_2",146:"PORT_A20",160:"PORT_PIC2_CMD",161:"PORT_PIC2_DATA",178:"PORT_SMI_CMD",179:"PORT_SMI_STATUS",212:"PORT_DMA2_MASK_REG",214:"PORT_DMA2_MODE_REG",218:"PORT_DMA2_MASTER_CLEAR",240:"PORT_MATH_CLEAR",368:"PORT_ATA2_CMD_BASE",496:"PORT_ATA1_CMD_BASE",632:"PORT_LPT2",744:"PORT_SERIAL4",760:"PORT_SERIAL2",884:"PORT_ATA2_CTRL_BASE",888:"PORT_LPT1",1e3:"PORT_SERIAL3",1008:"PORT_FD_BASE",1010:"PORT_FD_DOR",1012:"PORT_FD_STATUS",1013:"PORT_FD_DATA",1014:"PORT_HD_DATA",1015:"PORT_FD_DIR",1016:"PORT_SERIAL1",3320:"PORT_PCI_CMD",3321:"PORT_PCI_REBOOT",3324:"PORT_PCI_DATA",1026:"PORT_BIOS_DEBUG",1296:"PORT_QEMU_CFG_CTL",1297:"PORT_QEMU_CFG_DATA",45056:"PORT_ACPI_PM_BASE",45312:"PORT_SMB_BASE",35072:"PORT_BIOS_APM"};ft.prototype.get_port_description=function(t){return as[t]?"  ("+as[t]+")":""};var ps={};function Ie(){this.listeners={},this.pair=void 0}Ie.prototype.register=function(t,e,i){var s=this.listeners[t];s===void 0&&(s=this.listeners[t]=[]),s.push({fn:e,this_value:i})};Ie.prototype.unregister=function(t,e){var i=this.listeners[t];i!==void 0&&(this.listeners[t]=i.filter(function(s){return s.fn!==e}))};Ie.prototype.send=function(t,e){if(this.pair&&(t=this.pair.listeners[t],t!==void 0))for(var i=0;i<t.length;i++){var s=t[i];s.fn.call(s.this_value,e)}};Ie.prototype.send_async=function(t,e){setTimeout(this.send.bind(this,t,e),0)};ps.create=function(){var t=new Ie,e=new Ie;return t.pair=e,e.pair=t,[t,e]};var ls=new Uint8Array(256),fs=[],Je=[],Qe=[],ms=new Uint8Array(256),Ui=[];function T(t,e){this.cpu=t,this.bus=e,this.write_buffer=new Fe(64),this.read_buffer=new Fe(64),this.mixer_current_address=this.command_size=this.command=this.read_buffer_lastvalue=0,this.mixer_registers=new Uint8Array(256),this.mixer_reset(),this.dummy_speaker_enabled=!1,this.test_register=0,this.dsp_signed=this.dsp_16bit=this.dsp_stereo=this.dsp_highspeed=!1,this.dac_buffers=[new me(65536),new me(65536)],this.dma=t.devices.dma,this.dma_channel=this.dma_irq=this.dma_bytes_block=this.dma_bytes_left=this.dma_bytes_count=this.dma_sample_count=0,this.dma_channel_8bit=1,this.dma_channel_16bit=5,this.dma_autoinit=!1,this.dma_buffer=new ArrayBuffer(65536),this.dma_buffer_int8=new Int8Array(this.dma_buffer),this.dma_buffer_uint8=new Uint8Array(this.dma_buffer),this.dma_buffer_int16=new Int16Array(this.dma_buffer),this.dma_buffer_uint16=new Uint16Array(this.dma_buffer),this.dma_syncbuffer=new lt(this.dma_buffer),this.dma_paused=this.dma_waiting_transfer=!1,this.sampling_rate=22050,e.send("dac-tell-sampling-rate",this.sampling_rate),this.bytes_per_sample=1,this.e2_value=170,this.e2_count=0,this.asp_registers=new Uint8Array(256),this.mpu_read_buffer=new Fe(64),this.fm_current_address1=this.fm_current_address0=this.mpu_read_buffer_lastvalue=0,this.fm_waveform_select_enable=!1,this.irq=5,this.irq_triggered=new Uint8Array(16),t.io.register_read_consecutive(544,this,this.port2x0_read,this.port2x1_read,this.port2x2_read,this.port2x3_read),t.io.register_read_consecutive(904,this,this.port2x0_read,this.port2x1_read),t.io.register_read_consecutive(548,this,this.port2x4_read,this.port2x5_read),t.io.register_read(550,this,this.port2x6_read),t.io.register_read(551,this,this.port2x7_read),t.io.register_read(552,this,this.port2x8_read),t.io.register_read(553,this,this.port2x9_read),t.io.register_read(554,this,this.port2xA_read),t.io.register_read(555,this,this.port2xB_read),t.io.register_read(556,this,this.port2xC_read),t.io.register_read(557,this,this.port2xD_read),t.io.register_read_consecutive(558,this,this.port2xE_read,this.port2xF_read),t.io.register_write_consecutive(544,this,this.port2x0_write,this.port2x1_write,this.port2x2_write,this.port2x3_write),t.io.register_write_consecutive(904,this,this.port2x0_write,this.port2x1_write),t.io.register_write_consecutive(548,this,this.port2x4_write,this.port2x5_write),t.io.register_write(550,this,this.port2x6_write),t.io.register_write(551,this,this.port2x7_write),t.io.register_write_consecutive(552,this,this.port2x8_write,this.port2x9_write),t.io.register_write(554,this,this.port2xA_write),t.io.register_write(555,this,this.port2xB_write),t.io.register_write(556,this,this.port2xC_write),t.io.register_write(557,this,this.port2xD_write),t.io.register_write(558,this,this.port2xE_write),t.io.register_write(559,this,this.port2xF_write),t.io.register_read_consecutive(816,this,this.port3x0_read,this.port3x1_read),t.io.register_write_consecutive(816,this,this.port3x0_write,this.port3x1_write),this.dma.on_unmask(this.dma_on_unmask,this),e.register("dac-request-data",function(){this.dac_handle_request()},this),e.register("speaker-has-initialized",function(){this.mixer_reset()},this),e.send("speaker-confirm-initialized"),this.dsp_reset()}T.prototype.dsp_reset=function(){this.write_buffer.clear(),this.read_buffer.clear(),this.command_size=this.command=0,this.dummy_speaker_enabled=!1,this.test_register=0,this.dsp_signed=this.dsp_16bit=this.dsp_stereo=this.dsp_highspeed=!1,this.dac_buffers[0].clear(),this.dac_buffers[1].clear(),this.dma_channel=this.dma_irq=this.dma_bytes_block=this.dma_bytes_left=this.dma_bytes_count=this.dma_sample_count=0,this.dma_autoinit=!1,this.dma_buffer_uint8.fill(0),this.dma_paused=this.dma_waiting_transfer=!1,this.e2_value=170,this.e2_count=0,this.sampling_rate=22050,this.bytes_per_sample=1,this.lower_irq(1),this.irq_triggered.fill(0),this.asp_registers.fill(0),this.asp_registers[5]=1,this.asp_registers[9]=248};T.prototype.get_state=function(){var t=[];return t[2]=this.read_buffer_lastvalue,t[3]=this.command,t[4]=this.command_size,t[5]=this.mixer_current_address,t[6]=this.mixer_registers,t[7]=this.dummy_speaker_enabled,t[8]=this.test_register,t[9]=this.dsp_highspeed,t[10]=this.dsp_stereo,t[11]=this.dsp_16bit,t[12]=this.dsp_signed,t[15]=this.dma_sample_count,t[16]=this.dma_bytes_count,t[17]=this.dma_bytes_left,t[18]=this.dma_bytes_block,t[19]=this.dma_irq,t[20]=this.dma_channel,t[21]=this.dma_channel_8bit,t[22]=this.dma_channel_16bit,t[23]=this.dma_autoinit,t[24]=this.dma_buffer_uint8,t[25]=this.dma_waiting_transfer,t[26]=this.dma_paused,t[27]=this.sampling_rate,t[28]=this.bytes_per_sample,t[29]=this.e2_value,t[30]=this.e2_count,t[31]=this.asp_registers,t[33]=this.mpu_read_buffer_last_value,t[34]=this.irq,t[35]=this.irq_triggered,t};T.prototype.set_state=function(t){this.read_buffer_lastvalue=t[2],this.command=t[3],this.command_size=t[4],this.mixer_current_address=t[5],this.mixer_registers=t[6],this.mixer_full_update(),this.dummy_speaker_enabled=t[7],this.test_register=t[8],this.dsp_highspeed=t[9],this.dsp_stereo=t[10],this.dsp_16bit=t[11],this.dsp_signed=t[12],this.dma_sample_count=t[15],this.dma_bytes_count=t[16],this.dma_bytes_left=t[17],this.dma_bytes_block=t[18],this.dma_irq=t[19],this.dma_channel=t[20],this.dma_channel_8bit=t[21],this.dma_channel_16bit=t[22],this.dma_autoinit=t[23],this.dma_buffer_uint8=t[24],this.dma_waiting_transfer=t[25],this.dma_paused=t[26],this.sampling_rate=t[27],this.bytes_per_sample=t[28],this.e2_value=t[29],this.e2_count=t[30],this.asp_registers=t[31],this.mpu_read_buffer_last_value=t[33],this.irq=t[34],this.irq_triggered=t[35],this.dma_buffer=this.dma_buffer_uint8.buffer,this.dma_buffer_int8=new Int8Array(this.dma_buffer),this.dma_buffer_int16=new Int16Array(this.dma_buffer),this.dma_buffer_uint16=new Uint16Array(this.dma_buffer),this.dma_syncbuffer=new lt(this.dma_buffer),this.dma_paused?this.bus.send("dac-disable"):this.bus.send("dac-enable")};T.prototype.port2x0_read=function(){return 255};T.prototype.port2x1_read=function(){return 255};T.prototype.port2x2_read=function(){return 255};T.prototype.port2x3_read=function(){return 255};T.prototype.port2x4_read=function(){return this.mixer_current_address};T.prototype.port2x5_read=function(){return this.mixer_read(this.mixer_current_address)};T.prototype.port2x6_read=function(){return 255};T.prototype.port2x7_read=function(){return 255};T.prototype.port2x8_read=function(){return 255};T.prototype.port2x9_read=function(){return 255};T.prototype.port2xA_read=function(){return this.read_buffer.length&&(this.read_buffer_lastvalue=this.read_buffer.shift()),a(this.read_buffer_lastvalue),String.fromCharCode(this.read_buffer_lastvalue),this.read_buffer_lastvalue};T.prototype.port2xB_read=function(){return 255};T.prototype.port2xC_read=function(){return 127};T.prototype.port2xD_read=function(){return 255};T.prototype.port2xE_read=function(){return this.irq_triggered[1]&&this.lower_irq(1),(this.read_buffer.length&&!this.dsp_highspeed)<<7|127};T.prototype.port2xF_read=function(){return this.lower_irq(2),0};T.prototype.port2x0_write=function(t){a(t),this.fm_current_address0=0};T.prototype.port2x1_write=function(t){a(t);var e=Ui[this.fm_current_address0];e||(e=this.fm_default_write),e.call(this,t,0,this.fm_current_address0)};T.prototype.port2x2_write=function(t){a(t),this.fm_current_address1=0};T.prototype.port2x3_write=function(t){a(t);var e=Ui[this.fm_current_address1];e||(e=this.fm_default_write),e.call(this,t,1,this.fm_current_address1)};T.prototype.port2x4_write=function(t){a(t),this.mixer_current_address=t};T.prototype.port2x5_write=function(t){a(t),this.mixer_write(this.mixer_current_address,t)};T.prototype.port2x6_write=function(t){a(t),this.dsp_highspeed?this.dsp_highspeed=!1:t&&this.dsp_reset(),this.read_buffer.clear(),this.read_buffer.push(170)};T.prototype.port2x7_write=function(){};T.prototype.port2x8_write=function(){};T.prototype.port2x9_write=function(){};T.prototype.port2xA_write=function(){};T.prototype.port2xB_write=function(){};T.prototype.port2xC_write=function(t){this.command===0?(a(t),this.command=t,this.write_buffer.clear(),this.command_size=ls[t]):(a(t),this.write_buffer.push(t)),this.write_buffer.length>=this.command_size&&this.command_do()};T.prototype.port2xD_write=function(){};T.prototype.port2xE_write=function(){};T.prototype.port2xF_write=function(){};T.prototype.port3x0_read=function(){return this.mpu_read_buffer.length&&(this.mpu_read_buffer_lastvalue=this.mpu_read_buffer.shift()),a(this.mpu_read_buffer_lastvalue),this.mpu_read_buffer_lastvalue};T.prototype.port3x0_write=function(t){a(t)};T.prototype.port3x1_read=function(){return 0|128*!this.mpu_read_buffer.length};T.prototype.port3x1_write=function(t){a(t),t===255&&(this.mpu_read_buffer.clear(),this.mpu_read_buffer.push(254))};T.prototype.command_do=function(){var t=fs[this.command];t||(t=this.dsp_default_handler),t.call(this),this.command_size=this.command=0,this.write_buffer.clear()};T.prototype.dsp_default_handler=function(){a(this.command)};function L(t,e,i){i||(i=T.prototype.dsp_default_handler);for(var s=0;s<t.length;s++)ls[t[s]]=e,fs[t[s]]=i}function gs(t){for(var e=[],i=0;16>i;i++)e.push(t+i);return e}L([14],2,function(){this.asp_registers[this.write_buffer.shift()]=this.write_buffer.shift()});L([15],1,function(){this.read_buffer.clear(),this.read_buffer.push(this.asp_registers[this.write_buffer.shift()])});L([16],1,function(){var t=this.write_buffer.shift();t=ys(t/127.5+-1,-1,1),this.dac_buffers[0].push(t),this.dac_buffers[1].push(t),this.bus.send("dac-enable")});L([20,21],2,function(){this.dma_irq=1,this.dma_channel=this.dma_channel_8bit,this.dsp_highspeed=this.dsp_16bit=this.dsp_signed=this.dma_autoinit=!1,this.dma_transfer_size_set(),this.dma_transfer_start()});L([22],2);L([23],2);L([28],0,function(){this.dma_irq=1,this.dma_channel=this.dma_channel_8bit,this.dma_autoinit=!0,this.dsp_highspeed=this.dsp_16bit=this.dsp_signed=!1,this.dma_transfer_start()});L([31],0);L([32],0,function(){this.read_buffer.clear(),this.read_buffer.push(127)});L([36],2);L([44],0);L([48],0);L([49],0);L([52],0);L([53],0);L([54],0);L([55],0);L([56],0);L([64],1,function(){this.sampling_rate_change(1e6/(256-this.write_buffer.shift())/this.get_channel_count())});L([65,66],2,function(){this.sampling_rate_change(this.write_buffer.shift()<<8|this.write_buffer.shift())});L([72],2,function(){this.dma_transfer_size_set()});L([116],2);L([117],2);L([118],2);L([119],2);L([125],0);L([127],0);L([128],2);L([144],0,function(){this.dma_irq=1,this.dma_channel=this.dma_channel_8bit,this.dma_autoinit=!0,this.dsp_signed=!1,this.dsp_highspeed=!0,this.dsp_16bit=!1,this.dma_transfer_start()});L([145],0);L([152],0);L([153],0);L([160],0);L([168],0);L(gs(176),3,function(){if(this.command&8)this.dsp_default_handler();else{var t=this.write_buffer.shift();this.dma_irq=2,this.dma_channel=this.dma_channel_16bit,this.dma_autoinit=!!(this.command&4),this.dsp_signed=!!(t&16),this.dsp_stereo=!!(t&32),this.dsp_16bit=!0,this.dma_transfer_size_set(),this.dma_transfer_start()}});L(gs(192),3,function(){if(this.command&8)this.dsp_default_handler();else{var t=this.write_buffer.shift();this.dma_irq=1,this.dma_channel=this.dma_channel_8bit,this.dma_autoinit=!!(this.command&4),this.dsp_signed=!!(t&16),this.dsp_stereo=!!(t&32),this.dsp_16bit=!1,this.dma_transfer_size_set(),this.dma_transfer_start()}});L([208],0,function(){this.dma_paused=!0,this.bus.send("dac-disable")});L([209],0,function(){this.dummy_speaker_enabled=!0});L([211],0,function(){this.dummy_speaker_enabled=!1});L([212],0,function(){this.dma_paused=!1,this.bus.send("dac-enable")});L([213],0,function(){this.dma_paused=!0,this.bus.send("dac-disable")});L([214],0,function(){this.dma_paused=!1,this.bus.send("dac-enable")});L([216],0,function(){this.read_buffer.clear(),this.read_buffer.push(255*this.dummy_speaker_enabled)});L([217,218],0,function(){this.dma_autoinit=!1});L([224],1,function(){this.read_buffer.clear(),this.read_buffer.push(~this.write_buffer.shift())});L([225],0,function(){this.read_buffer.clear(),this.read_buffer.push(4),this.read_buffer.push(5)});L([226],1);L([227],0,function(){this.read_buffer.clear();for(var t=0;44>t;t++)this.read_buffer.push("COPYRIGHT (C) CREATIVE TECHNOLOGY LTD, 1992.".charCodeAt(t));this.read_buffer.push(0)});L([228],1,function(){this.test_register=this.write_buffer.shift()});L([232],0,function(){this.read_buffer.clear(),this.read_buffer.push(this.test_register)});L([242,243],0,function(){this.raise_irq()});var ti=new Uint8Array(256);ti[14]=255;ti[15]=7;ti[55]=56;L([249],1,function(){var t=this.write_buffer.shift();this.read_buffer.clear(),this.read_buffer.push(ti[t])});T.prototype.mixer_read=function(t){var e=Je[t];return e?e=e.call(this):(e=this.mixer_registers[t],a(t),a(e)),e};T.prototype.mixer_write=function(t,e){var i=Qe[t];i?i.call(this,e):(a(t),a(e))};T.prototype.mixer_default_read=function(){return a(this.mixer_current_address),this.mixer_registers[this.mixer_current_address]};T.prototype.mixer_default_write=function(t){a(this.mixer_current_address),a(t),this.mixer_registers[this.mixer_current_address]=t};T.prototype.mixer_reset=function(){this.mixer_registers[4]=204,this.mixer_registers[34]=204,this.mixer_registers[38]=204,this.mixer_registers[40]=0,this.mixer_registers[46]=0,this.mixer_registers[10]=0,this.mixer_registers[48]=192,this.mixer_registers[49]=192,this.mixer_registers[50]=192,this.mixer_registers[51]=192,this.mixer_registers[52]=192,this.mixer_registers[53]=192,this.mixer_registers[54]=0,this.mixer_registers[55]=0,this.mixer_registers[56]=0,this.mixer_registers[57]=0,this.mixer_registers[59]=0,this.mixer_registers[60]=31,this.mixer_registers[61]=21,this.mixer_registers[62]=11,this.mixer_registers[63]=0,this.mixer_registers[64]=0,this.mixer_registers[65]=0,this.mixer_registers[66]=0,this.mixer_registers[67]=0,this.mixer_registers[68]=128,this.mixer_registers[69]=128,this.mixer_registers[70]=128,this.mixer_registers[71]=128,this.mixer_full_update()};T.prototype.mixer_full_update=function(){for(var t=1;t<this.mixer_registers.length;t++)ms[t]||this.mixer_write(t,this.mixer_registers[t])};function Bt(t,e){e||(e=T.prototype.mixer_default_read),Je[t]=e}function $t(t,e){e||(e=T.prototype.mixer_default_write),Qe[t]=e}function Be(t,e,i){ms[t]=1,Je[t]=function(){return this.mixer_registers[e]&240|this.mixer_registers[i]>>>4},Qe[t]=function(s){this.mixer_registers[t]=s;var r=s<<4&240|this.mixer_registers[i]&15;this.mixer_write(e,s&240|this.mixer_registers[e]&15),this.mixer_write(i,r)}}function ei(t,e,i){Je[t]=T.prototype.mixer_default_read,Qe[t]=function(s){this.mixer_registers[t]=s,this.bus.send("mixer-volume",[e,i,(s>>>2)-62])}}Bt(0,function(){return this.mixer_reset(),0});$t(0);Be(4,50,51);Be(34,48,49);Be(38,52,53);Be(40,54,55);Be(46,56,57);ei(48,0,0);ei(49,0,1);ei(50,2,0);ei(51,2,1);Bt(59);$t(59,function(t){this.mixer_registers[59]=t,this.bus.send("mixer-volume",[1,2,6*(t>>>6)-18])});Bt(65);$t(65,function(t){this.mixer_registers[65]=t,this.bus.send("mixer-gain-left",6*(t>>>6))});Bt(66);$t(66,function(t){this.mixer_registers[66]=t,this.bus.send("mixer-gain-right",6*(t>>>6))});Bt(68);$t(68,function(t){this.mixer_registers[68]=t,t>>>=3,this.bus.send("mixer-treble-left",t-(16>t?14:16))});Bt(69);$t(69,function(t){this.mixer_registers[69]=t,t>>>=3,this.bus.send("mixer-treble-right",t-(16>t?14:16))});Bt(70);$t(70,function(t){this.mixer_registers[70]=t,t>>>=3,this.bus.send("mixer-bass-right",t-(16>t?14:16))});Bt(71);$t(71,function(t){this.mixer_registers[71]=t,t>>>=3,this.bus.send("mixer-bass-right",t-(16>t?14:16))});Bt(128,function(){switch(this.irq){case 2:return 1;case 5:return 2;case 7:return 4;case 10:return 8;default:return 0}});$t(128,function(t){t&1&&(this.irq=2),t&2&&(this.irq=5),t&4&&(this.irq=7),t&8&&(this.irq=10)});Bt(129,function(){var t=0;switch(this.dma_channel_8bit){case 0:t|=1;break;case 1:t|=2;break;case 3:t|=8}switch(this.dma_channel_16bit){case 5:t|=32;break;case 6:t|=64;break;case 7:t|=128}return t});$t(129,function(t){t&1&&(this.dma_channel_8bit=0),t&2&&(this.dma_channel_8bit=1),t&8&&(this.dma_channel_8bit=3),t&32&&(this.dma_channel_16bit=5),t&64&&(this.dma_channel_16bit=6),t&128&&(this.dma_channel_16bit=7)});Bt(130,function(){for(var t=32,e=0;16>e;e++)t|=e*this.irq_triggered[e];return t});T.prototype.fm_default_write=function(t,e,i){a(i),a(t)};function Ot(t,e){e||(e=T.prototype.fm_default_write);for(var i=0;i<t.length;i++)Ui[t[i]]=e}function ue(t,e){for(var i=[];t<=e;t++)i.push(t);return i}var wt=new Uint8Array(32);wt[0]=0;wt[1]=1;wt[2]=2;wt[3]=3;wt[4]=4;wt[5]=5;wt[8]=6;wt[9]=7;wt[10]=8;wt[11]=9;wt[12]=10;wt[13]=11;wt[16]=12;wt[17]=13;wt[18]=14;wt[19]=15;wt[20]=16;wt[21]=17;Ot([1],function(t,e){this.fm_waveform_select_enable[e]=t&1,this.fm_update_waveforms()});Ot([2]);Ot([3]);Ot([4],function(){});Ot([5],function(t,e,i){e===0&&this.fm_default_write(t,e,i)});Ot([8],function(){});Ot(ue(32,53),function(){});Ot(ue(64,85),function(){});Ot(ue(96,117),function(){});Ot(ue(128,149),function(){});Ot(ue(160,168),function(){});Ot(ue(176,184),function(){});Ot([189],function(){});Ot(ue(192,200),function(){});Ot(ue(224,245),function(){});T.prototype.fm_update_waveforms=function(){};T.prototype.sampling_rate_change=function(t){this.sampling_rate=t,this.bus.send("dac-tell-sampling-rate",t)};T.prototype.get_channel_count=function(){return this.dsp_stereo?2:1};T.prototype.dma_transfer_size_set=function(){this.dma_sample_count=1+(this.write_buffer.shift()<<0)+(this.write_buffer.shift()<<8)};T.prototype.dma_transfer_start=function(){this.bytes_per_sample=1,this.dsp_16bit&&(this.bytes_per_sample*=2),this.dma_bytes_count=this.dma_sample_count*this.bytes_per_sample,this.dma_bytes_block=1024*this.bytes_per_sample,this.dma_bytes_block=Math.min(Math.max(this.dma_bytes_count>>2&-4,32),this.dma_bytes_block),this.dma_waiting_transfer=!0,this.dma.channel_mask[this.dma_channel]||this.dma_on_unmask(this.dma_channel)};T.prototype.dma_on_unmask=function(t){t===this.dma_channel&&this.dma_waiting_transfer&&(this.dma_waiting_transfer=!1,this.dma_bytes_left=this.dma_bytes_count,this.dma_paused=!1,this.bus.send("dac-enable"))};T.prototype.dma_transfer_next=function(){var t=Math.min(this.dma_bytes_left,this.dma_bytes_block),e=Math.floor(t/this.bytes_per_sample);this.dma.do_write(this.dma_syncbuffer,0,t,this.dma_channel,i=>{i||(this.dma_to_dac(e),this.dma_bytes_left-=t,this.dma_bytes_left||(this.raise_irq(this.dma_irq),this.dma_autoinit&&(this.dma_bytes_left=this.dma_bytes_count)))})};T.prototype.dma_to_dac=function(t){for(var e=this.dsp_16bit?32767.5:127.5,i=this.dsp_signed?0:-1,s=this.dsp_stereo?1:2,r=this.dsp_16bit?this.dsp_signed?this.dma_buffer_int16:this.dma_buffer_uint16:this.dsp_signed?this.dma_buffer_int8:this.dma_buffer_uint8,n=0,o=0;o<t;o++)for(var h=ys(r[o]/e+i,-1,1),_=0;_<s;_++)this.dac_buffers[n].push(h),n^=1;this.dac_send()};T.prototype.dac_handle_request=function(){!this.dma_bytes_left||this.dma_paused?this.dac_send():this.dma_transfer_next()};T.prototype.dac_send=function(){if(this.dac_buffers[0].length){var t=this.dac_buffers[0].shift_block(this.dac_buffers[0].length),e=this.dac_buffers[1].shift_block(this.dac_buffers[1].length);this.bus.send("dac-send-data",[t,e],[t.buffer,e.buffer])}};T.prototype.raise_irq=function(t){this.irq_triggered[t]=1,this.cpu.device_raise_irq(this.irq)};T.prototype.lower_irq=function(t){this.irq_triggered[t]=0,this.cpu.device_lower_irq(this.irq)};function ys(t,e,i){return(t<e)*e+(t>i)*i+(e<=t&&t<=i)*t}function Ue(t){this.message=t}Ue.prototype=Error();var mr={Uint8Array,Int8Array,Uint16Array,Int16Array,Uint32Array,Int32Array,Float32Array,Float64Array};function bi(t,e){if(typeof t!="object"||t===null)return t;if(Array.isArray(t))return t.map(r=>bi(r,e));if(t.constructor===Object&&console.log(t),t.BYTES_PER_ELEMENT){var i=new Uint8Array(t.buffer,t.byteOffset,t.length*t.BYTES_PER_ELEMENT);return{__state_type__:t.constructor.name.replace("bound ",""),buffer_id:e.push(i)-1}}t=t.get_state(),i=[];for(var s=0;s<t.length;s++)i[s]=bi(t[s],e);return i}function ki(t,e){if(typeof t!="object"||t===null)return t;if(Array.isArray(t)){for(let i=0;i<t.length;i++)t[i]=ki(t[i],e);return t}return new mr[t.__state_type__](e[t.buffer_id])}function gr(t,e){function i(f,g){let x=f.length;if(16>x)throw new Ue("Invalid length: "+x);if(f=new Int32Array(f.buffer,f.byteOffset,4),f[0]!==-2039052682)throw new Ue("Invalid header: "+a(f[0]>>>0));if(f[1]!==6)throw new Ue("Version mismatch: dump="+f[1]+" we=6");if(g&&f[2]!==x)throw new Ue("Length doesn't match header: real="+x+" header="+f[2]);return f[3]}function s(f){return f=new TextDecoder().decode(f),JSON.parse(f)}if(e=new Uint8Array(e),new Uint32Array(e.buffer,0,1)[0]===4247762216){var r=t.zstd_create_ctx(e.length);new Uint8Array(t.wasm_memory.buffer,t.zstd_get_src_ptr(r),e.length).set(e);var n=t.zstd_read(r,16),o=new Uint8Array(t.wasm_memory.buffer,n,16),h=i(o,!1);t.zstd_read_free(n,16),n=t.zstd_read(r,h),o=new Uint8Array(t.wasm_memory.buffer,n,h),o=s(o),t.zstd_read_free(n,h),n=o.state;var _=o.buffer_infos;o=[],h=16+h;for(var c of _){if(_=(h+3&-4)-h,1048576<c.length){var d=t.zstd_read(r,_);t.zstd_read_free(d,_),d=new Uint8Array(c.length),o.push(d.buffer);for(var p=0;p<c.length;){let f=Math.min(c.length-p,1048576),g=t.zstd_read(r,f);d.set(new Uint8Array(t.wasm_memory.buffer,g,f),p),t.zstd_read_free(g,f),p+=f}}else d=t.zstd_read(r,_+c.length),p=d+_,o.push(t.wasm_memory.buffer.slice(p,p+c.length)),t.zstd_read_free(d,_+c.length);h+=_+c.length}n=ki(n,o),t.set_state(n),t.zstd_free_ctx(r)}else{if(r=i(e,!0),0>r||r+12>=e.length)throw new Ue("Invalid info block length: "+r);c=e.subarray(16,16+r),n=s(c),c=n.state,n=n.buffer_infos;let f=16+r;f=f+3&-4,r=n.map(g=>{let x=f+g.offset;return e.buffer.slice(x,x+g.length)}),c=ki(c,r),t.set_state(c)}}function Pe(t,e,i,s,r){let n="";var o=[],h=e?"compiled":i?"jit exit":s?"unguarded register":r?"wasm size":"executed";for(let d=0;256>d;d++)for(let p=0;8>p;p++)for(let f of[!1,!0]){var _=t.wm.exports.get_opstats_buffer(e,i,s,r,d,!1,f,p);o.push({opcode:d,count:_,is_mem:f,fixed_g:p}),_=t.wm.exports.get_opstats_buffer(e,i,s,r,d,!0,f,p),o.push({opcode:3840|d,count:_,is_mem:f,fixed_g:p})}t=0,e=new Set([38,46,54,62,100,101,102,103,240,242,243]);for(let{count:d,opcode:p}of o)e.has(p)||(t+=d);if(t===0)return"";i=new Uint32Array(256),e=new Uint32Array(256);for(let{opcode:d,count:p}of o)(d&65280)===3840?e[d&255]+=p:i[d&255]+=p;n=n+`------------------
Total: `+(t+`
`);let c=1e7<t?1e3:1;for(s=Math.max.apply(Math,o.map(({count:d})=>Math.round(d/c))),s=String(s).length,n+=`Instruction counts ${h} (in ${c}):
`,r=0;256>r;r++)n+=r.toString(16).padStart(2,"0")+":"+hs(Math.round(i[r]/c),s),n=r%16===15?n+`
`:n+" ";for(n=n+`
Instruction counts ${h} (0f, in ${c}):
`,h=0;256>h;h++)n+=(h&255).toString(16).padStart(2,"0")+":"+hs(Math.round(e[h]/c),s),n=h%16===15?n+`
`:n+" ";n+=`
`,o=o.filter(({count:d})=>d).sort(({count:d},{count:p})=>p-d);for(let{opcode:d,is_mem:p,fixed_g:f,count:g}of o.slice(0,200))o=d.toString(16)+"_"+f+(p?"_m":"_r"),n+=o+":"+(g/t*100).toFixed(2)+" ";return n+`
`}function Lt(t){this.cpu=t,this.cmos_index=0,this.cmos_data=new Uint8Array(128),this.last_update=this.rtc_time=Date.now(),this.next_interrupt_alarm=this.next_interrupt=0,this.periodic_interrupt=!1,this.periodic_interrupt_time=.9765625,this.cmos_a=38,this.cmos_b=2,this.nmi_disabled=this.cmos_c=0,this.update_interrupt=!1,this.update_interrupt_time=0,t.io.register_write(112,this,function(e){this.cmos_index=e&127,this.nmi_disabled=e>>7}),t.io.register_write(113,this,this.cmos_port_write),t.io.register_read(113,this,this.cmos_port_read)}Lt.prototype.get_state=function(){var t=[];return t[0]=this.cmos_index,t[1]=this.cmos_data,t[2]=this.rtc_time,t[3]=this.last_update,t[4]=this.next_interrupt,t[5]=this.next_interrupt_alarm,t[6]=this.periodic_interrupt,t[7]=this.periodic_interrupt_time,t[8]=this.cmos_a,t[9]=this.cmos_b,t[10]=this.cmos_c,t[11]=this.nmi_disabled,t[12]=this.update_interrupt,t[13]=this.update_interrupt_time,t};Lt.prototype.set_state=function(t){this.cmos_index=t[0],this.cmos_data=t[1],this.rtc_time=t[2],this.last_update=t[3],this.next_interrupt=t[4],this.next_interrupt_alarm=t[5],this.periodic_interrupt=t[6],this.periodic_interrupt_time=t[7],this.cmos_a=t[8],this.cmos_b=t[9],this.cmos_c=t[10],this.nmi_disabled=t[11],this.update_interrupt=t[12]||!1,this.update_interrupt_time=t[13]||0};Lt.prototype.timer=function(t){t=Date.now(),this.rtc_time+=t-this.last_update,this.last_update=t,this.periodic_interrupt&&this.next_interrupt<t?(this.cpu.device_raise_irq(8),this.cmos_c|=192,this.next_interrupt+=this.periodic_interrupt_time*Math.ceil((t-this.next_interrupt)/this.periodic_interrupt_time)):this.next_interrupt_alarm&&this.next_interrupt_alarm<t?(this.cpu.device_raise_irq(8),this.cmos_c|=160,this.next_interrupt_alarm=0):this.update_interrupt&&this.update_interrupt_time<t&&(this.cpu.device_raise_irq(8),this.cmos_c|=144,this.update_interrupt_time=t+1e3);let e=100;return this.periodic_interrupt&&this.next_interrupt&&(e=Math.min(e,Math.max(0,this.next_interrupt-t))),this.next_interrupt_alarm&&(e=Math.min(e,Math.max(0,this.next_interrupt_alarm-t))),this.update_interrupt&&(e=Math.min(e,Math.max(0,this.update_interrupt_time-t))),e};Lt.prototype.bcd_pack=function(t){for(var e=0,i=0,s;t;)s=t%10,i|=s<<4*e,e++,t=(t-s)/10;return i};Lt.prototype.bcd_unpack=function(t){return(t&15)+10*(t>>4&15)};Lt.prototype.encode_time=function(t){return this.cmos_b&4?t:this.bcd_pack(t)};Lt.prototype.decode_time=function(t){return this.cmos_b&4?t:this.bcd_unpack(t)};Lt.prototype.cmos_port_read=function(){var t=this.cmos_index;switch(t){case 0:return a(this.encode_time(new Date(this.rtc_time).getUTCSeconds())),this.encode_time(new Date(this.rtc_time).getUTCSeconds());case 2:return a(this.encode_time(new Date(this.rtc_time).getUTCMinutes())),this.encode_time(new Date(this.rtc_time).getUTCMinutes());case 4:return a(this.encode_time(new Date(this.rtc_time).getUTCHours())),this.encode_time(new Date(this.rtc_time).getUTCHours());case 6:return a(this.encode_time(new Date(this.rtc_time).getUTCDay()+1)),this.encode_time(new Date(this.rtc_time).getUTCDay()+1);case 7:return a(this.encode_time(new Date(this.rtc_time).getUTCDate())),this.encode_time(new Date(this.rtc_time).getUTCDate());case 8:return a(this.encode_time(new Date(this.rtc_time).getUTCMonth()+1)),this.encode_time(new Date(this.rtc_time).getUTCMonth()+1);case 9:return a(this.encode_time(new Date(this.rtc_time).getUTCFullYear()%100)),this.encode_time(new Date(this.rtc_time).getUTCFullYear()%100);case 10:return 999<=Z.microtick()%1e3?this.cmos_a|128:this.cmos_a;case 11:return this.cmos_b;case 12:return this.cpu.device_lower_irq(8),t=this.cmos_c,this.cmos_c&=-241,t;case 13:return 0;case 50:case 55:return a(this.encode_time(new Date(this.rtc_time).getUTCFullYear()/100|0)),this.encode_time(new Date(this.rtc_time).getUTCFullYear()/100|0);default:return a(t),this.cmos_data[this.cmos_index]}};Lt.prototype.cmos_port_write=function(t){switch(this.cmos_index){case 10:this.cmos_a=t&127,this.periodic_interrupt_time=1e3/(32768>>(this.cmos_a&15)-1),a(this.cmos_a,2);break;case 11:if(this.cmos_b=t,this.cmos_b&128&&(this.cmos_b&=239),this.cmos_b&64&&(this.next_interrupt=Date.now()),this.cmos_b&32){t=new Date;let e=this.decode_time(this.cmos_data[1]),i=this.decode_time(this.cmos_data[3]),s=this.decode_time(this.cmos_data[5]);this.next_interrupt_alarm=+new Date(Date.UTC(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate(),s,i,e))}this.cmos_b&16&&(this.update_interrupt_time=Date.now()),a(this.cmos_b,2);break;case 1:case 3:case 5:this.cmos_write(this.cmos_index,t);break;default:a(this.cmos_index),a(t)}this.update_interrupt=(this.cmos_b&16)===16&&0<(this.cmos_a&15),this.periodic_interrupt=(this.cmos_b&64)===64&&0<(this.cmos_a&15)};Lt.prototype.cmos_read=function(t){return this.cmos_data[t]};Lt.prototype.cmos_write=function(t,e){a(t),a(e),this.cmos_data[t]=e};function Yt(t,e){this.cpu=t,this.bus=e,this.counter_start_time=new Float64Array(3),this.counter_start_value=new Uint16Array(3),this.counter_next_low=new Uint8Array(4),this.counter_enabled=new Uint8Array(4),this.counter_mode=new Uint8Array(4),this.counter_read_mode=new Uint8Array(4),this.counter_latch=new Uint8Array(4),this.counter_latch_value=new Uint16Array(3),this.counter_reload=new Uint16Array(3),t.io.register_read(97,this,function(){var i=Z.microtick(),s=66.66666666666667*i&1;return i=this.did_rollover(2,i),s<<4|i<<5}),t.io.register_write(97,this,function(i){i&1?this.bus.send("pcspeaker-enable"):this.bus.send("pcspeaker-disable")}),t.io.register_read(64,this,function(){return this.counter_read(0)}),t.io.register_read(65,this,function(){return this.counter_read(1)}),t.io.register_read(66,this,function(){return this.counter_read(2)}),t.io.register_write(64,this,function(i){this.counter_write(0,i)}),t.io.register_write(65,this,function(i){this.counter_write(1,i)}),t.io.register_write(66,this,function(i){this.counter_write(2,i),this.bus.send("pcspeaker-update",[this.counter_mode[2],this.counter_reload[2]])}),t.io.register_write(67,this,this.port43_write)}Yt.prototype.get_state=function(){var t=[];return t[0]=this.counter_next_low,t[1]=this.counter_enabled,t[2]=this.counter_mode,t[3]=this.counter_read_mode,t[4]=this.counter_latch,t[5]=this.counter_latch_value,t[6]=this.counter_reload,t[7]=this.counter_start_time,t[8]=this.counter_start_value,t};Yt.prototype.set_state=function(t){this.counter_next_low=t[0],this.counter_enabled=t[1],this.counter_mode=t[2],this.counter_read_mode=t[3],this.counter_latch=t[4],this.counter_latch_value=t[5],this.counter_reload=t[6],this.counter_start_time=t[7],this.counter_start_value=t[8]};Yt.prototype.timer=function(t,e){var i=100;return e||(this.counter_enabled[0]&&this.did_rollover(0,t)?(this.counter_start_value[0]=this.get_counter_value(0,t),this.counter_start_time[0]=t,this.cpu.device_lower_irq(0),this.cpu.device_raise_irq(0),this.counter_mode[0]===0&&(this.counter_enabled[0]=0)):this.cpu.device_lower_irq(0),this.counter_enabled[0]&&(i=(this.counter_start_value[0]-Math.floor(1193.1816666*(t-this.counter_start_time[0])))/1193.1816666)),i};Yt.prototype.get_counter_value=function(t,e){return this.counter_enabled[t]?(e=this.counter_start_value[t]-Math.floor(1193.1816666*(e-this.counter_start_time[t])),t=this.counter_reload[t],e>=t?e%=t:0>e&&(e=e%t+t),e):0};Yt.prototype.did_rollover=function(t,e){return e-=this.counter_start_time[t],0>e?!0:this.counter_start_value[t]<Math.floor(1193.1816666*e)};Yt.prototype.counter_read=function(t){var e=this.counter_latch[t];return e?(this.counter_latch[t]--,e===2?this.counter_latch_value[t]&255:this.counter_latch_value[t]>>8):(e=this.counter_next_low[t],this.counter_mode[t]===3&&(this.counter_next_low[t]^=1),t=this.get_counter_value(t,Z.microtick()),e?t&255:t>>8)};Yt.prototype.counter_write=function(t,e){this.counter_reload[t]=this.counter_next_low[t]?this.counter_reload[t]&-256|e:this.counter_reload[t]&255|e<<8,this.counter_read_mode[t]===3&&this.counter_next_low[t]||(this.counter_reload[t]||(this.counter_reload[t]=65535),this.counter_start_value[t]=this.counter_reload[t],this.counter_enabled[t]=!0,this.counter_start_time[t]=Z.microtick(),a(this.counter_reload[t])),this.counter_read_mode[t]===3&&(this.counter_next_low[t]^=1)};Yt.prototype.port43_write=function(t){var e=t>>1&7,i=t>>6&3;t=t>>4&3,i!==3&&(t===0?(this.counter_latch[i]=2,e=this.get_counter_value(i,Z.microtick()),this.counter_latch_value[i]=e?e-1:0):(6<=e&&(e&=-5),this.counter_next_low[i]=t===1?1:t===2?0:1,i===0&&this.cpu.device_lower_irq(0),e!==0&&e!==3&&e!==2&&a(e),this.counter_mode[i]=e,this.counter_read_mode[i]=t,i===2&&this.bus.send("pcspeaker-update",[this.counter_mode[2],this.counter_reload[2]])))};Yt.prototype.dump=function(){};function ws(t){if(typeof window<"u")if(window.AudioContext||window.webkitAudioContext){var e=window.AudioWorklet?Ei:Ii;this.bus=t,this.audio_context=window.AudioContext?new AudioContext:new webkitAudioContext,this.mixer=new qe(t,this.audio_context),this.pcspeaker=new vs(t,this.audio_context,this.mixer),this.dac=new e(t,this.audio_context,this.mixer),this.pcspeaker.start(),t.register("emulator-stopped",function(){this.audio_context.suspend()},this),t.register("emulator-started",function(){this.audio_context.resume()},this),t.register("speaker-confirm-initialized",function(){t.send("speaker-has-initialized")},this),t.send("speaker-has-initialized")}else console.warn("Web browser doesn't support Web Audio API")}ws.prototype.destroy=function(){this.audio_context&&this.audio_context.close(),this.audio_context=null,this.dac&&this.dac.node_processor&&this.dac.node_processor.port.close(),this.dac=null};function qe(t,e){function i(s){return function(r){s.gain.setValueAtTime(r,this.audio_context.currentTime)}}this.audio_context=e,this.sources=new Map,this.gain_right=this.gain_left=this.volume_right=this.volume_left=this.volume_both=1,this.node_treble_left=this.audio_context.createBiquadFilter(),this.node_treble_right=this.audio_context.createBiquadFilter(),this.node_treble_left.type="highshelf",this.node_treble_right.type="highshelf",this.node_treble_left.frequency.setValueAtTime(2e3,this.audio_context.currentTime),this.node_treble_right.frequency.setValueAtTime(2e3,this.audio_context.currentTime),this.node_bass_left=this.audio_context.createBiquadFilter(),this.node_bass_right=this.audio_context.createBiquadFilter(),this.node_bass_left.type="lowshelf",this.node_bass_right.type="lowshelf",this.node_bass_left.frequency.setValueAtTime(200,this.audio_context.currentTime),this.node_bass_right.frequency.setValueAtTime(200,this.audio_context.currentTime),this.node_gain_left=this.audio_context.createGain(),this.node_gain_right=this.audio_context.createGain(),this.node_merger=this.audio_context.createChannelMerger(2),this.input_left=this.node_treble_left,this.input_right=this.node_treble_right,this.node_treble_left.connect(this.node_bass_left),this.node_bass_left.connect(this.node_gain_left),this.node_gain_left.connect(this.node_merger,0,0),this.node_treble_right.connect(this.node_bass_right),this.node_bass_right.connect(this.node_gain_right),this.node_gain_right.connect(this.node_merger,0,1),this.node_merger.connect(this.audio_context.destination),t.register("mixer-connect",function(s){this.connect_source(s[0],s[1])},this),t.register("mixer-disconnect",function(s){this.disconnect_source(s[0],s[1])},this),t.register("mixer-volume",function(s){var r=s[0],n=s[1];s=Math.pow(10,s[2]/20),r=r===0?this:this.sources.get(r),r===void 0||r.set_volume(s,n)},this),t.register("mixer-gain-left",function(s){this.gain_left=Math.pow(10,s/20),this.update()},this),t.register("mixer-gain-right",function(s){this.gain_right=Math.pow(10,s/20),this.update()},this),t.register("mixer-treble-left",i(this.node_treble_left),this),t.register("mixer-treble-right",i(this.node_treble_right),this),t.register("mixer-bass-left",i(this.node_bass_left),this),t.register("mixer-bass-right",i(this.node_bass_right),this)}qe.prototype.add_source=function(t,e){return t=new Oe(this.audio_context,t,this.input_left,this.input_right),this.sources.has(e),this.sources.set(e,t),t};qe.prototype.connect_source=function(t,e){t=this.sources.get(t),t===void 0||t.connect(e)};qe.prototype.disconnect_source=function(t,e){t=this.sources.get(t),t===void 0||t.disconnect(e)};qe.prototype.set_volume=function(t,e){switch(e===void 0&&(e=2),e){case 0:this.volume_left=t;break;case 1:this.volume_right=t;break;case 2:this.volume_both=t;break;default:return}this.update()};qe.prototype.update=function(){var t=this.volume_both*this.volume_right*this.gain_right;this.node_gain_left.gain.setValueAtTime(this.volume_both*this.volume_left*this.gain_left,this.audio_context.currentTime),this.node_gain_right.gain.setValueAtTime(t,this.audio_context.currentTime)};function Oe(t,e,i,s){this.audio_context=t,this.connected_right=this.connected_left=!0,this.volume_right=this.volume_left=this.volume_both=this.gain_hidden=1,this.node_splitter=t.createChannelSplitter(2),this.node_gain_left=t.createGain(),this.node_gain_right=t.createGain(),e.connect(this.node_splitter),this.node_splitter.connect(this.node_gain_left,0),this.node_gain_left.connect(i),this.node_splitter.connect(this.node_gain_right,1),this.node_gain_right.connect(s)}Oe.prototype.update=function(){var t=this.connected_right*this.gain_hidden*this.volume_both*this.volume_right;this.node_gain_left.gain.setValueAtTime(this.connected_left*this.gain_hidden*this.volume_both*this.volume_left,this.audio_context.currentTime),this.node_gain_right.gain.setValueAtTime(t,this.audio_context.currentTime)};Oe.prototype.connect=function(t){var e=!t||t===2;(e||t===0)&&(this.connected_left=!0),(e||t===1)&&(this.connected_right=!0),this.update()};Oe.prototype.disconnect=function(t){var e=!t||t===2;(e||t===0)&&(this.connected_left=!1),(e||t===1)&&(this.connected_right=!1),this.update()};Oe.prototype.set_volume=function(t,e){switch(e===void 0&&(e=2),e){case 0:this.volume_left=t;break;case 1:this.volume_right=t;break;case 2:this.volume_both=t;break;default:return}this.update()};Oe.prototype.set_gain_hidden=function(t){this.gain_hidden=t};function vs(t,e,i){this.node_oscillator=e.createOscillator(),this.node_oscillator.type="square",this.node_oscillator.frequency.setValueAtTime(440,e.currentTime),this.mixer_connection=i.add_source(this.node_oscillator,1),this.mixer_connection.disconnect(),t.register("pcspeaker-enable",function(){i.connect_source(1)},this),t.register("pcspeaker-disable",function(){i.disconnect_source(1)},this),t.register("pcspeaker-update",function(s){var r=s[1],n=0;s[0]===3&&(n=Math.min(1.1931816665999999e6/r,this.node_oscillator.frequency.maxValue),n=Math.max(n,0)),this.node_oscillator.frequency.setValueAtTime(n,e.currentTime)},this)}vs.prototype.start=function(){this.node_oscillator.start()};function Ei(t,e,i){this.bus=t,this.audio_context=e,this.enabled=!1,this.sampling_rate=48e3,e=function(){function o(c){return c===0?1:(c*=Math.PI,Math.sin(c)/c)}function h(){var c=Reflect.construct(AudioWorkletProcessor,[],h);return c.kernel_size=3,c.queue_data=Array(1024),c.queue_start=0,c.queue_end=0,c.queue_length=0,c.queue_size=c.queue_data.length,c.queued_samples=0,c.source_buffer_previous=_,c.source_buffer_current=_,c.source_samples_per_destination=1,c.source_block_start=0,c.source_time=0,c.source_offset=0,c.port.onmessage=d=>{switch(d.data.type){case"queue":c.queue_push(d.data.value);break;case"sampling-rate":c.source_samples_per_destination=d.data.value/sampleRate}},c}var _=[new Float32Array(256),new Float32Array(256)];Reflect.setPrototypeOf(h.prototype,AudioWorkletProcessor.prototype),Reflect.setPrototypeOf(h,AudioWorkletProcessor),h.prototype.process=h.prototype.process=function(c,d){for(c=0;c<d[0][0].length;c++){for(var p=0,f=0,g=this.source_offset+this.kernel_size,x=this.source_offset-this.kernel_size+1;x<=g;x++){var b=this.source_block_start+x;p+=this.get_sample(b,0)*this.kernel(this.source_time-x),f+=this.get_sample(b,1)*this.kernel(this.source_time-x)}(isNaN(p)||isNaN(f))&&(p=f=0,this.dbg_log("ERROR: NaN values! Ignoring for now.")),d[0][0][c]=p,d[0][1][c]=f,this.source_time+=this.source_samples_per_destination,this.source_offset=Math.floor(this.source_time)}return d=this.source_offset,d+=this.kernel_size+2,this.source_time-=this.source_offset,this.source_block_start+=this.source_offset,this.source_offset=0,this.ensure_enough_data(d),!0},h.prototype.kernel=function(c){return o(c)*o(c/this.kernel_size)},h.prototype.get_sample=function(c,d){return 0>c?(c+=this.source_buffer_previous[0].length,this.source_buffer_previous[d][c]):this.source_buffer_current[d][c]},h.prototype.ensure_enough_data=function(c){var d=this.source_buffer_current[0].length;d-this.source_block_start<c&&(this.prepare_next_buffer(),this.source_block_start-=d)},h.prototype.prepare_next_buffer=function(){256>this.queued_samples&&this.queue_length&&this.dbg_log("Not enough samples - should not happen during midway of playback"),this.source_buffer_previous=this.source_buffer_current,this.source_buffer_current=this.queue_shift();var c=this.source_buffer_current[0].length;if(256>c){for(var d=this.queue_start,p=0;256>c&&p<this.queue_length;)c+=this.queue_data[d][0].length,d=d+1&this.queue_size-1,p++;c=Math.max(c,256),c=[new Float32Array(c),new Float32Array(c)],c[0].set(this.source_buffer_current[0]),c[1].set(this.source_buffer_current[1]),d=this.source_buffer_current[0].length;for(var f=0;f<p;f++){var g=this.queue_shift();c[0].set(g[0],d),c[1].set(g[1],d),d+=g[0].length}this.source_buffer_current=c}this.pump()},h.prototype.pump=function(){1024>this.queued_samples/this.source_samples_per_destination&&this.port.postMessage({type:"pump"})},h.prototype.queue_push=function(c){this.queue_length<this.queue_size&&(this.queue_data[this.queue_end]=c,this.queue_end=this.queue_end+1&this.queue_size-1,this.queue_length++,this.queued_samples+=c[0].length,this.pump())},h.prototype.queue_shift=function(){if(!this.queue_length)return _;var c=this.queue_data[this.queue_start];return this.queue_data[this.queue_start]=null,this.queue_start=this.queue_start+1&this.queue_size-1,this.queue_length--,this.queued_samples-=c[0].length,c},h.prototype.dbg_log=function(){},registerProcessor("dac-processor",h)}.toString();var s=e.indexOf("{")+1,r=e.lastIndexOf("}");e=e.substring(s,r),e=new Blob([e],{type:"application/javascript"});var n=URL.createObjectURL(e);this.node_processor=null,this.node_output=this.audio_context.createGain(),this.audio_context.audioWorklet.addModule(n).then(()=>{URL.revokeObjectURL(n),this.node_processor=new AudioWorkletNode(this.audio_context,"dac-processor",{numberOfInputs:0,numberOfOutputs:1,outputChannelCount:[2],parameterData:{},processorOptions:{}}),this.node_processor.port.postMessage({type:"sampling-rate",value:this.sampling_rate}),this.node_processor.port.onmessage=o=>{switch(o.data.type){case"pump":this.pump()}},this.node_processor.connect(this.node_output)}),this.mixer_connection=i.add_source(this.node_output,2),this.mixer_connection.set_gain_hidden(3),t.register("dac-send-data",function(o){this.queue(o)},this),t.register("dac-enable",function(){this.enabled=!0},this),t.register("dac-disable",function(){this.enabled=!1},this),t.register("dac-tell-sampling-rate",function(o){this.sampling_rate=o,this.node_processor&&this.node_processor.port.postMessage({type:"sampling-rate",value:o})},this)}Ei.prototype.queue=function(t){this.node_processor&&this.node_processor.port.postMessage({type:"queue",value:t},[t[0].buffer,t[1].buffer])};Ei.prototype.pump=function(){this.enabled&&this.bus.send("dac-request-data")};function Ii(t,e,i){this.bus=t,this.audio_context=e,this.enabled=!1,this.sampling_rate=22050,this.buffered_time=0,this.rate_ratio=1,this.node_lowpass=this.audio_context.createBiquadFilter(),this.node_lowpass.type="lowpass",this.node_output=this.node_lowpass,this.mixer_connection=i.add_source(this.node_output,2),this.mixer_connection.set_gain_hidden(3),t.register("dac-send-data",function(s){this.queue(s)},this),t.register("dac-enable",function(){this.enabled=!0,this.pump()},this),t.register("dac-disable",function(){this.enabled=!1},this),t.register("dac-tell-sampling-rate",function(s){this.sampling_rate=s,this.rate_ratio=Math.ceil(8e3/s),this.node_lowpass.frequency.setValueAtTime(s/2,this.audio_context.currentTime)},this)}Ii.prototype.queue=function(t){var e=t[0].length,i=e/this.sampling_rate;if(1<this.rate_ratio)for(var s=this.audio_context.createBuffer(2,e*this.rate_ratio,this.sampling_rate*this.rate_ratio),r=s.getChannelData(0),n=s.getChannelData(1),o=0,h=0;h<e;h++)for(var _=0;_<this.rate_ratio;_++,o++)r[o]=t[0][h],n[o]=t[1][h];else s=this.audio_context.createBuffer(2,e,this.sampling_rate),s.copyToChannel?(s.copyToChannel(t[0],0),s.copyToChannel(t[1],1)):(s.getChannelData(0).set(t[0]),s.getChannelData(1).set(t[1]));if(t=this.audio_context.createBufferSource(),t.buffer=s,t.connect(this.node_lowpass),t.addEventListener("ended",this.pump.bind(this)),s=this.audio_context.currentTime,this.buffered_time<s)for(this.buffered_time=s,s=.2-i,e=0;e<=s;)e+=i,this.buffered_time+=i,setTimeout(()=>this.pump(),1e3*e);t.start(this.buffered_time),this.buffered_time+=i,setTimeout(()=>this.pump(),0)};Ii.prototype.pump=function(){this.enabled&&(.2<this.buffered_time-this.audio_context.currentTime||this.bus.send("dac-request-data"))};function se(t,e,i){this.bus=e,this.socket=void 0,this.id=i||0,this.send_queue=[],this.url=t,this.reconnect_interval=1e4,this.last_connect_attempt=Date.now()-this.reconnect_interval,this.send_queue_limit=64,this.destroyed=!1,this.bus.register("net"+this.id+"-send",function(s){this.send(s)},this)}se.prototype.handle_message=function(t){this.bus&&this.bus.send("net"+this.id+"-receive",new Uint8Array(t.data))};se.prototype.handle_close=function(){this.destroyed||(this.connect(),setTimeout(this.connect.bind(this),this.reconnect_interval))};se.prototype.handle_open=function(){for(var t=0;t<this.send_queue.length;t++)this.send(this.send_queue[t]);this.send_queue=[]};se.prototype.handle_error=function(){};se.prototype.destroy=function(){this.destroyed=!0,this.socket&&this.socket.close()};se.prototype.connect=function(){if(typeof WebSocket<"u"){if(this.socket){var t=this.socket.readyState;if(t===0||t===1)return}if(t=Date.now(),!(this.last_connect_attempt+this.reconnect_interval>t)){this.last_connect_attempt=Date.now();try{this.socket=new WebSocket(this.url)}catch(e){console.error(e);return}this.socket.binaryType="arraybuffer",this.socket.onopen=this.handle_open.bind(this),this.socket.onmessage=this.handle_message.bind(this),this.socket.onclose=this.handle_close.bind(this),this.socket.onerror=this.handle_error.bind(this)}}};se.prototype.send=function(t){this.socket&&this.socket.readyState===1?this.socket.send(t):(this.send_queue.push(t),this.send_queue.length>2*this.send_queue_limit&&(this.send_queue=this.send_queue.slice(-this.send_queue_limit)),this.connect())};se.prototype.change_proxy=function(t){this.url=t,this.socket&&(this.socket.onclose=function(){},this.socket.onerror=function(){},this.socket.close(),this.socket=void 0)};var yr=new Date("1970-01-01T00:00:00Z").getTime(),wr=new Date("1900-01-01T00:00:00Z").getTime(),vr=yr-wr,br=Math.pow(2,32),kr=[118,56,54];function _s(t){return[0,1,2,3,4,5].map(e=>t[e].toString(16)).map(e=>e.length===1?"0"+e:e).join(":")}function Ne(t){return t[0]<<24|t[1]<<16|t[2]<<8|t[3]}var xi=class{constructor(e,i){e=Math.min(e,16),this.maximum_capacity=i?Math.max(i,e):0,this.length=this.head=this.tail=0,this.buffer=new Uint8Array(e)}write(e){let i=e.length;var s=this.length+i;let r=this.buffer.length;if(r<s){for(;r<s;)r*=2;if(this.maximum_capacity&&r>this.maximum_capacity)throw Error("stream capacity overflow in GrowableRingbuffer.write(), package dropped");s=new Uint8Array(r),this.peek(s),this.tail=0,this.head=this.length,this.buffer=s}s=this.buffer;let n=this.head+i;if(n>r){let o=r-this.head;s.set(e.subarray(0,o),this.head),s.set(e.subarray(o))}else s.set(e,this.head);this.head=n%r,this.length+=i}peek(e){let i=Math.min(this.length,e.length);if(i){let n=this.buffer;var s=n.length,r=this.tail+i;r>s?(r%=s,s-=this.tail,e.set(n.subarray(this.tail)),e.set(n.subarray(0,r),s)):e.set(n.subarray(this.tail,r))}return i}remove(e){return e>this.length&&(e=this.length),e&&(this.tail=(this.tail+e)%this.buffer.length,this.length-=e),e}};function bs(){let t=new Uint8Array(1518),e=t.buffer,i=t.byteOffset;return{eth_frame:t,eth_frame_view:new DataView(e),eth_payload_view:new DataView(e,i+14,1500),ipv4_payload_view:new DataView(e,i+34,1480),udp_payload_view:new DataView(e,i+42,1472),text_encoder:new TextEncoder}}function Tt(t,e,i,s){return s.eth_frame.set(e,i.byteOffset+t),e.length}function Ze(t,e,i,s){let r=i.byteOffset+(t&-2);for(s=s.eth_frame,i=i.byteOffset;i<r;i+=2)e+=s[i]<<8|s[i+1];for(t&1&&(e+=s[r]<<8);e>>>16;)e=(e&65535)+(e>>>16);return~e&65535}function pt(t,e){t.eth_frame.fill(0);var i=t.eth_frame,s=i.subarray,r=t.eth_frame_view;if(Tt(0,e.eth.dest,r,t),Tt(6,e.eth.src,r,t),r.setUint16(12,e.eth.ethertype),r=14,e.arp){var n=t.eth_payload_view;n.setUint16(0,e.arp.htype),n.setUint16(2,e.arp.ptype),n.setUint8(4,e.arp.sha.length),n.setUint8(5,e.arp.spa.length),n.setUint16(6,e.arp.oper),Tt(8,e.arp.sha,n,t),Tt(14,e.arp.spa,n,t),Tt(18,e.arp.tha,n,t),Tt(24,e.arp.tpa,n,t),r+=28}else if(e.ipv4){n=t.eth_payload_view;var o=20;if(e.icmp){var h=t.ipv4_payload_view;h.setUint8(0,e.icmp.type),h.setUint8(1,e.icmp.code),h.setUint16(2,0);var _=4+Tt(4,e.icmp.data,h,t);h.setUint16(2,Ze(_,0,h,t)),o+=_}else if(e.udp){h=t.ipv4_payload_view;var c=8;if(e.dhcp){_=c;var d=t.udp_payload_view;d.setUint8(0,e.dhcp.op),d.setUint8(1,e.dhcp.htype),d.setUint8(2,e.dhcp.hlen),d.setUint8(3,e.dhcp.hops),d.setUint32(4,e.dhcp.xid),d.setUint16(8,e.dhcp.secs),d.setUint16(10,e.dhcp.flags),d.setUint32(12,e.dhcp.ciaddr),d.setUint32(16,e.dhcp.yiaddr),d.setUint32(20,e.dhcp.siaddr),d.setUint32(24,e.dhcp.giaddr),Tt(28,e.dhcp.chaddr,d,t),d.setUint32(236,1669485411),c=240;for(var p of e.dhcp.options)c+=Tt(c,p,d,t);_+=c}else if(e.dns){p=c,c=t.udp_payload_view,c.setUint16(0,e.dns.id),c.setUint16(2,e.dns.flags),c.setUint16(4,e.dns.questions.length),c.setUint16(6,e.dns.answers.length);let x=12;for(var f=0;f<e.dns.questions.length;++f){var g=e.dns.questions[f];for(d of g.name){let b=t.text_encoder.encodeInto(d,t.eth_frame.subarray(c.byteOffset+(x+1))).written;c.setUint8(x,b),x+=1+b}c.setUint16(x,g.type),x+=2,c.setUint16(x,g.class),x+=2}for(f=0;f<e.dns.answers.length;++f){d=e.dns.answers[f];for(_ of d.name)g=t.text_encoder.encodeInto(_,t.eth_frame.subarray(c.byteOffset+(x+1))).written,c.setUint8(x,g),x+=1+g;c.setUint16(x,d.type),x+=2,c.setUint16(x,d.class),x+=2,c.setUint32(x,d.ttl),x+=4,c.setUint16(x,d.data.length),x+=2,x+=Tt(x,d.data,c,t)}_=p+x}else e.ntp?(_=c,d=t.udp_payload_view,d.setUint8(0,e.ntp.flags),d.setUint8(1,e.ntp.stratum),d.setUint8(2,e.ntp.poll),d.setUint8(3,e.ntp.precision),d.setUint32(4,e.ntp.root_delay),d.setUint32(8,e.ntp.root_disp),d.setUint32(12,e.ntp.ref_id),d.setUint32(16,e.ntp.ref_ts_i),d.setUint32(20,e.ntp.ref_ts_f),d.setUint32(24,e.ntp.ori_ts_i),d.setUint32(28,e.ntp.ori_ts_f),d.setUint32(32,e.ntp.rec_ts_i),d.setUint32(36,e.ntp.rec_ts_f),d.setUint32(40,e.ntp.trans_ts_i),d.setUint32(44,e.ntp.trans_ts_f),_+=48):_=c+Tt(0,e.udp.data,t.udp_payload_view,t);c=_,h.setUint16(0,e.udp.sport),h.setUint16(2,e.udp.dport),h.setUint16(4,c),h.setUint16(6,0),h.setUint16(6,Ze(c,(e.ipv4.src[0]<<8|e.ipv4.src[1])+(e.ipv4.src[2]<<8|e.ipv4.src[3])+(e.ipv4.dest[0]<<8|e.ipv4.dest[1])+(e.ipv4.dest[2]<<8|e.ipv4.dest[3])+17+c,h,t)),o+=c}else e.tcp&&(h=t.ipv4_payload_view,_=0,d=e.tcp,d.fin&&(_|=1),d.syn&&(_|=2),d.rst&&(_|=4),d.psh&&(_|=8),d.ack&&(_|=16),d.urg&&(_|=32),d.ece&&(_|=64),d.cwr&&(_|=128),h.setUint16(0,d.sport),h.setUint16(2,d.dport),h.setUint32(4,d.seq),h.setUint32(8,d.ackn),h.setUint8(12,80),h.setUint8(13,_),h.setUint16(14,d.winsize),h.setUint16(16,0),h.setUint16(18,d.urgent||0),_=20,e.tcp_data&&(_+=Tt(20,e.tcp_data,h,t)),h.setUint16(16,Ze(_,(e.ipv4.src[0]<<8|e.ipv4.src[1])+(e.ipv4.src[2]<<8|e.ipv4.src[3])+(e.ipv4.dest[0]<<8|e.ipv4.dest[1])+(e.ipv4.dest[2]<<8|e.ipv4.dest[3])+6+_,h,t)),o+=_);n.setUint8(0,69),n.setUint8(1,e.ipv4.tos||0),n.setUint16(2,o),n.setUint16(4,e.ipv4.id||0),n.setUint8(6,64),n.setUint8(8,e.ipv4.ttl||32),n.setUint8(9,e.ipv4.proto),n.setUint16(10,0),Tt(12,e.ipv4.src,n,t),Tt(16,e.ipv4.dest,n,t),n.setUint16(10,Ze(20,0,n,t)),r+=o}return s.call(i,0,r)}function xr(t,e){return fetch(`https://${e.doh_server||"cloudflare-dns.com"}/dns-query`,{method:"POST",headers:[["content-type","application/dns-message"]],body:t.udp.data}).then(async i=>{i={eth:{ethertype:2048,src:e.router_mac,dest:t.eth.src},ipv4:{proto:17,src:e.router_ip,dest:t.ipv4.src},udp:{sport:53,dport:t.udp.sport,data:new Uint8Array(await i.arrayBuffer())}},e.receive(pt(e.eth_encoder_buf,i))}),!0}function Ar(t,e){let i={};i.eth={ethertype:2048,src:e.router_mac,dest:t.eth.src},i.ipv4={proto:17,src:e.router_ip,dest:e.vm_ip},i.udp={sport:67,dport:68},i.dhcp={htype:1,hlen:6,hops:0,xid:t.dhcp.xid,secs:0,flags:0,ciaddr:0,yiaddr:Ne(e.vm_ip),siaddr:Ne(e.router_ip),giaddr:Ne(e.router_ip),chaddr:t.dhcp.chaddr};let s=[],r=t.dhcp.options.find(function(n){return n[0]===53});r&&r[2]===3&&(t.dhcp.op=3),t.dhcp.op===1&&(i.dhcp.op=2,s.push(new Uint8Array([53,1,2]))),t.dhcp.op===3&&(i.dhcp.op=2,s.push(new Uint8Array([53,1,5])),s.push(new Uint8Array([51,4,8,0,0,0]))),t=[e.router_ip[0],e.router_ip[1],e.router_ip[2],e.router_ip[3]],s.push(new Uint8Array([1,4,255,255,255,0])),e.masquerade&&(s.push(new Uint8Array([3,4].concat(t))),s.push(new Uint8Array([6,4].concat(t)))),s.push(new Uint8Array([54,4].concat(t))),s.push(new Uint8Array([60,3].concat(kr))),s.push(new Uint8Array([255,0])),i.dhcp.options=s,e.receive(pt(e.eth_encoder_buf,i))}function ks(t,e){let i={};var s=new DataView(t.buffer,t.byteOffset,t.byteLength).getUint16(12),r={ethertype:s,dest:t.subarray(0,6),dest_s:_s(t.subarray(0,6)),src:t.subarray(6,12),src_s:_s(t.subarray(6,12))};if(i.eth=r,t=t.subarray(14,t.length),s===2048){var n=new DataView(t.buffer,t.byteOffset,t.byteLength),o=t[0]>>4&15;r=t[0]&15;var h=n.getUint8(1),_=n.getUint16(2);let c=n.getUint8(8);if(s=n.getUint8(9),n=n.getUint16(10),o={version:o,ihl:r,tos:h,len:_,ttl:c,proto:s,ip_checksum:n,src:t.subarray(12,16),dest:t.subarray(16,20)},i.ipv4=o,r=t.subarray(4*r,_),s===1)t=new DataView(r.buffer,r.byteOffset,r.byteLength),t={type:t.getUint8(0),code:t.getUint8(1),checksum:t.getUint16(2),data:r.subarray(4)},i.icmp=t;else if(s===6)s=new DataView(r.buffer,r.byteOffset,r.byteLength),t={sport:s.getUint16(0),dport:s.getUint16(2),seq:s.getUint32(4),ackn:s.getUint32(8),doff:s.getUint8(12)>>4,winsize:s.getUint16(14),checksum:s.getUint16(16),urgent:s.getUint16(18)},s=s.getUint8(13),t.fin=!!(s&1),t.syn=!!(s&2),t.rst=!!(s&4),t.psh=!!(s&8),t.ack=!!(s&16),t.urg=!!(s&32),t.ece=!!(s&64),t.cwr=!!(s&128),i.tcp=t,i.tcp_data=r.subarray(4*t.doff);else if(s===17){if(t=new DataView(r.buffer,r.byteOffset,r.byteLength),t={sport:t.getUint16(0),dport:t.getUint16(2),len:t.getUint16(4),checksum:t.getUint16(6),data:r.subarray(8),data_s:new TextDecoder().decode(r.subarray(8))},t.dport===67||t.sport===67){for(r=r.subarray(8),s=new DataView(r.buffer,r.byteOffset,r.byteLength),r.subarray(44,236),s={op:s.getUint8(0),htype:s.getUint8(1),hlen:s.getUint8(2),hops:s.getUint8(3),xid:s.getUint32(4),secs:s.getUint16(8),flags:s.getUint16(10),ciaddr:s.getUint32(12),yiaddr:s.getUint32(16),siaddr:s.getUint32(20),giaddr:s.getUint32(24),chaddr:r.subarray(28,44),magic:s.getUint32(236),options:[]},r=r.subarray(240),_=0;_<r.length;++_)o=_,r[_]!==0&&(++_,h=r[_],_+=h,s.options.push(r.subarray(o,o+h+2)));i.dhcp=s,i.dhcp_options=s.options}else t.dport===53||t.sport===53?Ur(r.subarray(8),i):t.dport===123&&(s=r.subarray(8),s=new DataView(s.buffer,s.byteOffset,s.byteLength),i.ntp={flags:s.getUint8(0),stratum:s.getUint8(1),poll:s.getUint8(2),precision:s.getUint8(3),root_delay:s.getUint32(4),root_disp:s.getUint32(8),ref_id:s.getUint32(12),ref_ts_i:s.getUint32(16),ref_ts_f:s.getUint32(20),ori_ts_i:s.getUint32(24),ori_ts_f:s.getUint32(28),rec_ts_i:s.getUint32(32),rec_ts_f:s.getUint32(36),trans_ts_i:s.getUint32(40),trans_ts_f:s.getUint32(44)});i.udp=t}}else s===2054?(s=new DataView(t.buffer,t.byteOffset,t.byteLength),t={htype:s.getUint16(0),ptype:s.getUint16(2),oper:s.getUint16(6),sha:t.subarray(8,14),spa:t.subarray(14,18),tha:t.subarray(18,24),tpa:t.subarray(24,28)},i.arp=t):s!==34525&&a(s);if(i.ipv4)if(i.tcp)t=`${i.ipv4.src.join(".")}:${i.tcp.sport}:${i.ipv4.dest.join(".")}:${i.tcp.dport}`,(!i.tcp.syn||!e.on_tcp_connection(i,t))&&(e.tcp_conn[t]?e.tcp_conn[t].process(i):(t=i.tcp.ackn,(i.tcp.fin||i.tcp.syn)&&(t+=1),s={},s.eth={ethertype:2048,src:e.router_mac,dest:i.eth.src},s.ipv4={proto:6,src:i.ipv4.dest,dest:i.ipv4.src},s.tcp={sport:i.tcp.dport,dport:i.tcp.sport,seq:t,ackn:i.tcp.seq+(i.tcp.syn?1:0),winsize:i.tcp.winsize,rst:!0,ack:i.tcp.syn},e.receive(pt(e.eth_encoder_buf,s))));else if(i.udp)if(i.dns)if(e.dns_method==="static"){for(t={},t.eth={ethertype:2048,src:e.router_mac,dest:i.eth.src},t.ipv4={proto:17,src:e.router_ip,dest:i.ipv4.src},t.udp={sport:53,dport:i.udp.sport},s=[],r=0;r<i.dns.questions.length;++r)switch(_=i.dns.questions[r],_.type){case 1:s.push({name:_.name,type:_.type,class:_.class,ttl:600,data:[192,168,87,1]})}t.dns={id:i.dns.id,flags:33152,questions:i.dns.questions,answers:s},e.receive(pt(e.eth_encoder_buf,t))}else xr(i,e);else i.dhcp?Ar(i,e):i.ntp?(t=Date.now()+vr,s=t%1e3/1e3*br,r={},r.eth={ethertype:2048,src:e.router_mac,dest:i.eth.src},r.ipv4={proto:17,src:i.ipv4.dest,dest:i.ipv4.src},r.udp={sport:123,dport:i.udp.sport},r.ntp=Object.assign({},i.ntp),r.ntp.flags=36,r.ntp.poll=10,r.ntp.ori_ts_i=i.ntp.trans_ts_i,r.ntp.ori_ts_f=i.ntp.trans_ts_f,r.ntp.rec_ts_i=t/1e3,r.ntp.rec_ts_f=s,r.ntp.trans_ts_i=t/1e3,r.ntp.trans_ts_f=s,r.ntp.stratum=2,e.receive(pt(e.eth_encoder_buf,r))):i.udp.dport===8&&(t={},t.eth={ethertype:2048,src:e.router_mac,dest:i.eth.src},t.ipv4={proto:17,src:i.ipv4.dest,dest:i.ipv4.src},t.udp={sport:i.udp.dport,dport:i.udp.sport,data:new TextEncoder().encode(i.udp.data_s)},e.receive(pt(e.eth_encoder_buf,t)));else i.icmp&&i.icmp.type===8&&(t={},t.eth={ethertype:2048,src:e.router_mac,dest:i.eth.src},t.ipv4={proto:1,src:i.ipv4.dest,dest:i.ipv4.src},t.icmp={type:0,code:i.icmp.code,data:i.icmp.data},e.receive(pt(e.eth_encoder_buf,t)));else i.arp&&i.arp.oper===1&&i.arp.ptype===2048&&(t=Ne(i.arp.tpa)&4294967040,s=Ne(e.router_ip)&4294967040,!e.masquerade&&t!==s||t===s&&99<i.arp.tpa[3]||(t={},t.eth={ethertype:2054,src:e.router_mac,dest:i.eth.src},t.arp={htype:1,ptype:2048,oper:2,sha:e.router_mac,spa:i.arp.tpa,tha:i.eth.src,tpa:i.arp.spa},e.receive(pt(e.eth_encoder_buf,t))))}function Ur(t,e){function i(){let c=[],d;do d=s.getUint8(h),c.push(new TextDecoder().decode(t.subarray(h+1,h+1+d))),h+=d+1;while(0<d);return c}let s=new DataView(t.buffer,t.byteOffset,t.byteLength),r={id:s.getUint16(0),flags:s.getUint16(2),questions:[],answers:[]};var n=s.getUint16(4);let o=s.getUint16(6);s.getUint16(8),s.getUint16(10);let h=12;for(var _=0;_<n;_++)r.questions.push({name:i(),type:s.getInt16(h),class:s.getInt16(h+2)}),h+=4;for(n=0;n<o;n++){_={name:i(),type:s.getInt16(h),class:s.getUint16(h+2),ttl:s.getUint32(h+4)},h+=8;let c=s.getUint16(h);h+=2,_.data=t.subarray(h,h+c),h+=c,r.answers.push(_)}e.dns=r}function xs(t,e){var i=e.vm_ip.join(".");let s=e.router_ip.join("."),r=16383*Math.random()|0,n,o,h=0;do n=49152+(r+h)%16383,o=`${i}:${t}:${s}:${n}`;while(16383>++h&&e.tcp_conn[o]);if(e.tcp_conn[o])throw Error("pool of dynamic TCP port numbers exhausted, connection aborted");return i=new kt,i.tuple=o,i.hsrc=e.router_mac,i.psrc=e.router_ip,i.sport=n,i.hdest=e.vm_mac,i.dport=t,i.pdest=e.vm_ip,i.net=e,e.tcp_conn[o]=i,i.connect(),i}function Er(t,e){return new Promise(i=>{let s=xs(t,e);s.state="syn-probe",s.on("probe",i)})}function kt(){this.state="closed",this.net=null,this.send_buffer=new xi(2048,0),this.send_chunk_buf=new Uint8Array(1460),this.delayed_send_fin=this.in_active_close=!1,this.delayed_state=void 0,this.events_handlers={}}kt.prototype.on=function(t,e){this.events_handlers[t]=e};kt.prototype.emit=function(t,...e){this.events_handlers[t]&&this.events_handlers[t].apply(this,e)};kt.prototype.ipv4_reply=function(){let t={};return t.eth={ethertype:2048,src:this.hsrc,dest:this.hdest},t.ipv4={proto:6,src:this.psrc,dest:this.pdest},t.tcp={sport:this.sport,dport:this.dport,winsize:this.winsize,ackn:this.ack,seq:this.seq,ack:!0},t};kt.prototype.packet_reply=function(t,e){if(t={sport:t.tcp.dport,dport:t.tcp.sport,winsize:t.tcp.winsize,ackn:this.ack,seq:this.seq},e)for(let i in e)t[i]=e[i];return e=this.ipv4_reply(),e.tcp=t,e};kt.prototype.connect=function(){this.seq=1338,this.ack=1,this.start_seq=0,this.winsize=64240,this.state="syn-sent";let t=this.ipv4_reply();t.ipv4.id=2345,t.tcp={sport:this.sport,dport:this.dport,seq:1337,ackn:0,winsize:0,syn:!0},this.net.receive(pt(this.net.eth_encoder_buf,t))};kt.prototype.accept=function(t){this.seq=1338,this.ack=t.tcp.seq+1,this.start_seq=t.tcp.seq,this.hsrc=this.net.router_mac,this.psrc=t.ipv4.dest,this.sport=t.tcp.dport,this.hdest=t.eth.src,this.dport=t.tcp.sport,this.pdest=t.ipv4.src,this.winsize=t.tcp.winsize;let e=this.ipv4_reply();e.tcp={sport:this.sport,dport:this.dport,seq:1337,ackn:this.ack,winsize:t.tcp.winsize,syn:!0,ack:!0},this.state="established",this.net.receive(pt(this.net.eth_encoder_buf,e))};kt.prototype.process=function(t){if(this.state==="closed")t=this.packet_reply(t,{rst:!0}),this.net.receive(pt(this.net.eth_encoder_buf,t));else if(t.tcp.rst)this.state==="syn-probe"?this.emit("probe",!1):this.on_close(),this.release();else if(t.tcp.syn)this.state==="syn-sent"&&t.tcp.ack?(this.ack=t.tcp.seq+1,this.start_seq=t.tcp.seq,this.last_received_ackn=t.tcp.ackn,t=this.ipv4_reply(),this.net.receive(pt(this.net.eth_encoder_buf,t)),this.state="established",this.emit("connect")):this.state==="syn-probe"&&t.tcp.ack&&(this.emit("probe",!0),t=this.packet_reply(t,{rst:!0}),this.net.receive(pt(this.net.eth_encoder_buf,t)),this.release());else{if(t.tcp.ack){if(this.state==="syn-received")this.state="established";else if(this.state==="fin-wait-1")t.tcp.fin||(this.state="fin-wait-2");else if(this.state==="closing"||this.state==="last-ack"){this.release();return}}if(this.last_received_ackn===void 0)this.last_received_ackn=t.tcp.ackn;else{var e=t.tcp.ackn-this.last_received_ackn;if(0<e){if(this.last_received_ackn=t.tcp.ackn,this.send_buffer.remove(e),this.seq+=e,this.pending=!1,this.delayed_send_fin&&!this.send_buffer.length){this.delayed_send_fin=!1,this.state=this.delayed_state,t=this.ipv4_reply(),t.tcp.fin=!0,this.net.receive(pt(this.net.eth_encoder_buf,t));return}}else if(0>e){t=this.packet_reply(t,{rst:!0}),this.net.receive(pt(this.net.eth_encoder_buf,t)),this.on_close(),this.release();return}}t.tcp.fin?(++this.ack,e=this.packet_reply(t,{}),this.state==="established"?(e.tcp.ack=!0,this.state="close-wait",this.on_shutdown()):this.state==="fin-wait-1"?(t.tcp.ack?this.release():this.state="closing",e.tcp.ack=!0):this.state==="fin-wait-2"?(this.release(),e.tcp.ack=!0):(this.release(),this.on_close(),e.tcp.rst=!0),this.net.receive(pt(this.net.eth_encoder_buf,e))):this.ack!==t.tcp.seq?(t=this.packet_reply(t,{ack:!0}),this.net.receive(pt(this.net.eth_encoder_buf,t))):t.tcp.ack&&0<t.tcp_data.length&&(this.ack+=t.tcp_data.length,e=this.ipv4_reply(),this.net.receive(pt(this.net.eth_encoder_buf,e)),this.emit("data",t.tcp_data)),this.pump()}};kt.prototype.write=function(t){this.in_active_close||this.send_buffer.write(t),this.pump()};kt.prototype.writev=function(t){if(!this.in_active_close)for(let e of t)this.send_buffer.write(e);this.pump()};kt.prototype.close=function(){if(!this.in_active_close){if(this.in_active_close=!0,this.state==="established"||this.state==="syn-received")var t="fin-wait-1";else if(this.state==="close-wait")t="last-ack";else{this.release();return}this.send_buffer.length||this.pending?(this.delayed_send_fin=!0,this.delayed_state=t):(this.state=t,t=this.ipv4_reply(),t.tcp.fin=!0,this.net.receive(pt(this.net.eth_encoder_buf,t)))}this.pump()};kt.prototype.on_shutdown=function(){this.emit("shutdown")};kt.prototype.on_close=function(){this.emit("close")};kt.prototype.release=function(){this.net.tcp_conn[this.tuple]&&(this.state="closed",delete this.net.tcp_conn[this.tuple])};kt.prototype.pump=function(){if(this.send_buffer.length&&!this.pending){let t=this.send_chunk_buf,e=this.send_buffer.peek(t),i=this.ipv4_reply();i.tcp.psh=!0,i.tcp_data=t.subarray(0,e),this.net.receive(pt(this.net.eth_encoder_buf,i)),this.pending=!0}};function Gt(t,e){e=e||{},this.bus=t,this.id=e.id||0,this.router_mac=new Uint8Array((e.router_mac||"52:54:0:1:2:3").split(":").map(function(i){return parseInt(i,16)})),this.router_ip=new Uint8Array((e.router_ip||"192.168.86.1").split(".").map(function(i){return parseInt(i,10)})),this.vm_ip=new Uint8Array((e.vm_ip||"192.168.86.100").split(".").map(function(i){return parseInt(i,10)})),this.masquerade=e.masquerade===void 0||!!e.masquerade,this.vm_mac=new Uint8Array(6),this.dns_method=e.dns_method||"static",this.doh_server=e.doh_server,this.tcp_conn={},this.eth_encoder_buf=bs(),this.fetch=(...i)=>fetch(...i),this.cors_proxy=e.cors_proxy,this.bus.register("net"+this.id+"-mac",function(i){this.vm_mac=new Uint8Array(i.split(":").map(function(s){return parseInt(s,16)}))},this),this.bus.register("net"+this.id+"-send",function(i){this.send(i)},this)}Gt.prototype.destroy=function(){};Gt.prototype.on_tcp_connection=function(t,e){if(t.tcp.dport===80){let i=new kt;return i.state="syn-received",i.net=this,i.on("data",Ir),i.tuple=e,i.accept(t),this.tcp_conn[e]=i,!0}return!1};Gt.prototype.connect=function(t){return xs(t,this)};Gt.prototype.tcp_probe=function(t){return Er(t,this)};async function Ir(t){if(this.read=this.read||"",(this.read+=new TextDecoder().decode(t))&&this.read.indexOf(`\r
\r
`)!==-1){t=this.read.indexOf(`\r
\r
`);var e=this.read.substring(0,t).split(/\r\n/);t=this.read.substring(t+4),this.read="";let i=e[0].split(" "),s;s=/^https?:/.test(i[1])?new URL(i[1]):new URL("http://host"+i[1]),typeof window<"u"&&s.protocol==="http:"&&window.location.protocol==="https:"&&(s.protocol="https:");let r=new Headers;for(let h=1;h<e.length;++h){let _=this.net.parse_http_header(e[h]);if(!_){console.warn('The request contains an invalid header: "%s"',e[h]),this.net.respond_text_and_close(this,400,"Bad Request",`Invalid header in request: ${e[h]}`);return}_.key.toLowerCase()==="host"?s.host=_.value:r.append(_.key,_.value)}if(!this.net.cors_proxy&&/^\d+\.external$/.test(s.hostname))if(e=parseInt(s.hostname.split(".")[0],10),!isNaN(e)&&0<e&&65536>e)s.protocol="http:",s.hostname="localhost",s.port=e.toString(10);else{console.warn('Unknown port for localhost: "%s"',s.href),this.net.respond_text_and_close(this,400,"Bad Request",`Unknown port for localhost: ${s.href}`);return}this.name=s.href,e={method:i[0],headers:r},["put","post"].indexOf(e.method.toLowerCase())!==-1&&(e.body=t);let n=this.net.cors_proxy?this.net.cors_proxy+encodeURIComponent(s.href):s.href;new TextEncoder;let o=!1;this.net.fetch(n,e).then(h=>{let _=new Headers(h.headers);if(_.delete("content-encoding"),_.delete("keep-alive"),_.delete("content-length"),_.delete("transfer-encoding"),_.set("x-was-fetch-redirected",`${!!h.redirected}`),_.set("x-fetch-resp-url",h.url),_.set("connection","close"),this.write(this.net.form_response_head(h.status,h.statusText,_)),o=!0,h.body&&h.body.getReader){let c=h.body.getReader(),d=({value:p,done:f})=>{if(p&&this.write(p),f)this.close();else return c.read().then(d)};c.read().then(d)}else h.arrayBuffer().then(c=>{this.write(new Uint8Array(c)),this.close()})}).catch(h=>{console.warn("Fetch Failed: "+n+`
`+h),o||this.net.respond_text_and_close(this,502,"Fetch Error",`Fetch ${n} failed:

${h.stack||h.message}`),this.close()})}}Gt.prototype.fetch=async function(t,e){this.cors_proxy&&(t=this.cors_proxy+encodeURIComponent(t));try{let i=await fetch(t,e),s=await i.arrayBuffer();return[i,s]}catch(i){return console.warn("Fetch Failed: "+t+`
`+i),[{status:502,statusText:"Fetch Error",headers:new Headers({"Content-Type":"text/plain"})},new TextEncoder().encode(`Fetch ${t} failed:

${i.stack}`).buffer]}};Gt.prototype.form_response_head=function(t,e,i){t=[`HTTP/1.1 ${t} ${e}`];for(let[s,r]of i.entries())t.push(`${s}: ${r}`);return new TextEncoder().encode(t.join(`\r
`)+`\r
\r
`)};Gt.prototype.respond_text_and_close=function(t,e,i,s){let r=new Headers({"content-type":"text/plain","content-length":s.length.toString(10),connection:"close"});t.writev([this.form_response_head(e,i,r),new TextEncoder().encode(s)]),t.close()};Gt.prototype.parse_http_header=function(t){var e=t.match(/^([^:]*):(.*)$/);if(e&&(t=e[1],e=e[2].trim(),t.length!==0&&e.length!==0&&/^[\w-]+$/.test(t)&&/^[\x20-\x7E]+$/.test(e)))return{key:t,value:e}};Gt.prototype.send=function(t){ks(t,this)};Gt.prototype.receive=function(t){this.bus.send("net"+this.id+"-receive",new Uint8Array(t))};function re(t,e,i){this.register_ws(t),this.last_stream=1,this.connections={0:{congestion:0}},this.congested_buffer=[],i=i||{},this.bus=e,this.id=i.id||0,this.router_mac=new Uint8Array((i.router_mac||"52:54:0:1:2:3").split(":").map(function(s){return parseInt(s,16)})),this.router_ip=new Uint8Array((i.router_ip||"192.168.86.1").split(".").map(function(s){return parseInt(s,10)})),this.vm_ip=new Uint8Array((i.vm_ip||"192.168.86.100").split(".").map(function(s){return parseInt(s,10)})),this.masquerade=i.masquerade===void 0||!!i.masquerade,this.vm_mac=new Uint8Array(6),this.dns_method=i.dns_method||"doh",this.doh_server=i.doh_server,this.tcp_conn={},this.eth_encoder_buf=bs(),this.bus.register("net"+this.id+"-mac",function(s){this.vm_mac=new Uint8Array(s.split(":").map(function(r){return parseInt(r,16)}))},this),this.bus.register("net"+this.id+"-send",function(s){this.send(s)},this)}re.prototype.register_ws=function(t){this.wispws=new WebSocket(t.replace("wisp://","ws://").replace("wisps://","wss://")),this.wispws.binaryType="arraybuffer",this.wispws.onmessage=e=>{this.process_incoming_wisp_frame(new Uint8Array(e.data))},this.wispws.onclose=()=>{setTimeout(()=>{this.register_ws(t)},1e4)}};re.prototype.send_packet=function(t,e,i){this.connections[i]&&(0<this.connections[i].congestion?(e==="DATA"&&this.connections[i].congestion--,this.wispws.send(t)):(this.connections[i].congested=!0,this.congested_buffer.push({data:t,type:e})))};re.prototype.process_incoming_wisp_frame=function(t){let e=new DataView(t.buffer),i=e.getUint32(1,!0);switch(t[0]){case 2:if(this.connections[i])this.connections[i].data_callback(t.slice(5));else throw Error("Got a DATA packet but stream not registered. ID: "+i);break;case 3:if(this.connections[i]&&(this.connections[i].congestion=e.getUint32(5,!0)),this.connections[i].congested){for(let s of this.congested_buffer)this.send_packet(s.data,s.type,i);this.connections[i].congested=!1}break;case 4:this.connections[i]&&this.connections[i].close_callback(e.getUint8(5)),delete this.connections[i]}};re.prototype.send_wisp_frame=function(t){let e,i;switch(t.type){case"CONNECT":let s=new TextEncoder().encode(t.hostname);e=new Uint8Array(8+s.length),i=new DataView(e.buffer),i.setUint8(0,1),i.setUint32(1,t.stream_id,!0),i.setUint8(5,1),i.setUint16(6,t.port,!0),e.set(s,8),this.connections[t.stream_id]={data_callback:t.data_callback,close_callback:t.close_callback,congestion:this.connections[0].congestion};break;case"DATA":e=new Uint8Array(5+t.data.length),i=new DataView(e.buffer),i.setUint8(0,2),i.setUint32(1,t.stream_id,!0),e.set(t.data,5);break;case"CLOSE":e=new Uint8Array(6),i=new DataView(e.buffer),i.setUint8(0,4),i.setUint32(1,t.stream_id,!0),i.setUint8(5,t.reason)}this.send_packet(e,t.type,t.stream_id)};re.prototype.destroy=function(){this.wispws&&(this.wispws.onmessage=null,this.wispws.onclose=null,this.wispws.close(),this.wispws=null)};re.prototype.on_tcp_connection=function(t,e){let i=new kt;return i.state="syn-received",i.net=this,i.tuple=e,i.stream_id=this.last_stream++,this.tcp_conn[e]=i,i.on("data",s=>{s.length!==0&&this.send_wisp_frame({type:"DATA",stream_id:i.stream_id,data:s})}),i.on_close=()=>{this.send_wisp_frame({type:"CLOSE",stream_id:i.stream_id,reason:2})},i.on_shutdown=i.on_close,this.send_wisp_frame({type:"CONNECT",stream_id:i.stream_id,hostname:t.ipv4.dest.join("."),port:t.tcp.dport,data_callback:s=>{i.write(s)},close_callback:()=>{i.close()}}),i.accept(t),!0};re.prototype.send=function(t){ks(t,this)};re.prototype.receive=function(t){this.bus.send("net"+this.id+"-receive",new Uint8Array(t))};var Sr=typeof window<"u"&&0<=window.navigator.platform.toString().toLowerCase().search("win");function qr(t){function e(A){return A.shiftKey&&A.ctrlKey&&(A.keyCode===73||A.keyCode===74||A.keyCode===75)||!g.emu_enabled?!1:A.target?A.target.classList.contains("phone_keyboard")||A.target.nodeName!=="INPUT"&&A.target.nodeName!=="TEXTAREA":!0}function i(A){return!A.altKey&&c[56]&&h(56,!1),n(A,!1)}function s(A){return!A.altKey&&c[56]&&h(56,!1),n(A,!0)}function r(){for(var A=Object.keys(c),S,X=0;X<A.length;X++)S=+A[X],c[S]&&h(S,!1);c={}}function n(A,S){if(g.bus&&e(A))return A.preventDefault&&A.preventDefault(),Sr&&(d&&(clearTimeout(f),A.getModifierState&&A.getModifierState("AltGraph")&&p===S&&d.code==="ControlLeft"&&A.code==="AltRight"||o(d,p),d=null),A.code==="ControlLeft")?(d=A,p=S,f=setTimeout(()=>{o(d,p),d=null},10),!1):(o(A,S),!1)}function o(A,S){t:{if(A.code!==void 0){var X=F[A.code];if(X!==void 0)break t}X=x[A.keyCode]}X?h(X,S,A.repeat):console.log("Missing char in map: keyCode="+(A.keyCode||-1).toString(16)+" code="+A.code)}function h(A,S,X){if(S)c[A]&&!X&&h(A,!1);else if(!c[A])return;(c[A]=S)||(A|=128),255<A?(_(A>>8),_(A&255)):_(A)}function _(A){g.bus.send("keyboard-code",A)}var c={},d=null,p=!1,f=0,g=this;this.emu_enabled=!0;let x=new Uint16Array([0,0,0,0,0,0,0,0,14,15,0,0,0,28,0,0,42,29,56,0,58,0,0,0,0,0,0,1,0,0,0,0,57,57417,57425,57423,57415,57419,57416,57421,80,0,0,0,0,82,83,0,11,2,3,4,5,6,7,8,9,10,0,39,0,13,0,0,0,30,48,46,32,18,33,34,35,23,36,37,38,50,49,24,25,16,19,31,20,22,47,17,45,21,44,57435,57436,57437,0,0,82,79,80,81,75,76,77,71,72,73,0,0,0,0,0,0,59,60,61,62,63,64,65,66,67,68,87,88,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,69,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,12,0,0,0,0,0,0,0,0,0,0,0,0,39,13,51,12,52,53,41,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,26,43,27,40,0,57435,57400,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),b={8:8,10:13,32:32,39:222,44:188,45:189,46:190,47:191,48:48,49:49,50:50,51:51,52:52,53:53,54:54,55:55,56:56,57:57,59:186,61:187,91:219,92:220,93:221,96:192,97:65,98:66,99:67,100:68,101:69,102:70,103:71,104:72,105:73,106:74,107:75,108:76,109:77,110:78,111:79,112:80,113:81,114:82,115:83,116:84,117:85,118:86,119:87,120:88,121:89,122:90},w={33:49,34:222,35:51,36:52,37:53,38:55,40:57,41:48,42:56,43:187,58:186,60:188,62:190,63:191,64:50,65:65,66:66,67:67,68:68,69:69,70:70,71:71,72:72,73:73,74:74,75:75,76:76,77:77,78:78,79:79,80:80,81:81,82:82,83:83,84:84,85:85,86:86,87:87,88:88,89:89,90:90,94:54,95:189,123:219,124:220,125:221,126:192};var F={Escape:1,Digit1:2,Digit2:3,Digit3:4,Digit4:5,Digit5:6,Digit6:7,Digit7:8,Digit8:9,Digit9:10,Digit0:11,Minus:12,Equal:13,Backspace:14,Tab:15,KeyQ:16,KeyW:17,KeyE:18,KeyR:19,KeyT:20,KeyY:21,KeyU:22,KeyI:23,KeyO:24,KeyP:25,BracketLeft:26,BracketRight:27,Enter:28,ControlLeft:29,KeyA:30,KeyS:31,KeyD:32,KeyF:33,KeyG:34,KeyH:35,KeyJ:36,KeyK:37,KeyL:38,Semicolon:39,Quote:40,Backquote:41,ShiftLeft:42,Backslash:43,KeyZ:44,KeyX:45,KeyC:46,KeyV:47,KeyB:48,KeyN:49,KeyM:50,Comma:51,Period:52,Slash:53,IntlRo:53,ShiftRight:54,NumpadMultiply:55,AltLeft:56,Space:57,CapsLock:58,F1:59,F2:60,F3:61,F4:62,F5:63,F6:64,F7:65,F8:66,F9:67,F10:68,NumLock:69,ScrollLock:70,Numpad7:71,Numpad8:72,Numpad9:73,NumpadSubtract:74,Numpad4:75,Numpad5:76,Numpad6:77,NumpadAdd:78,Numpad1:79,Numpad2:80,Numpad3:81,Numpad0:82,NumpadDecimal:83,IntlBackslash:86,F11:87,F12:88,NumpadEnter:57372,ControlRight:57373,NumpadDivide:57397,AltRight:57400,Home:57415,ArrowUp:57416,PageUp:57417,ArrowLeft:57419,ArrowRight:57421,End:57423,ArrowDown:57424,PageDown:57425,Insert:57426,Delete:57427,OSLeft:57435,OSRight:57436,ContextMenu:57437};this.bus=t,this.destroy=function(){typeof window<"u"&&(window.removeEventListener("keyup",i,!1),window.removeEventListener("keydown",s,!1),window.removeEventListener("blur",r,!1))},this.init=function(){typeof window<"u"&&(this.destroy(),window.addEventListener("keyup",i,!1),window.addEventListener("keydown",s,!1),window.addEventListener("blur",r,!1))},this.init(),this.simulate_press=function(A){A={keyCode:A},n(A,!0),n(A,!1)},this.simulate_char=function(A){var S=A.charCodeAt(0);S in b?this.simulate_press(b[S]):S in w?(_(42),this.simulate_press(w[S]),_(170)):console.log("ascii -> keyCode not found: ",S,A)}}function Or(t,e){function i(w){if(!b.enabled||!b.emu_enabled)return!1;var F=e||document.body,A;if(!(A=document.pointerLockElement))t:{for(w=w.target;w.parentNode;){if(w===F){A=!0;break t}w=w.parentNode}A=!1}return A}function s(w){i(w)&&(w=w.changedTouches)&&w.length&&(w=w[w.length-1],g=w.clientX,x=w.clientY)}function r(){(d||f||p)&&(b.bus.send("mouse-click",[!1,!1,!1]),d=f=p=!1)}function n(w){if(b.bus&&i(w)&&b.is_running){var F=0,A=0,S=w.changedTouches;S?S.length&&(S=S[S.length-1],F=S.clientX-g,A=S.clientY-x,g=S.clientX,x=S.clientY,w.preventDefault()):typeof w.movementX=="number"?(F=w.movementX,A=w.movementY):typeof w.webkitMovementX=="number"?(F=w.webkitMovementX,A=w.webkitMovementY):typeof w.mozMovementX=="number"?(F=w.mozMovementX,A=w.mozMovementY):(F=w.clientX-g,A=w.clientY-x,g=w.clientX,x=w.clientY),b.bus.send("mouse-delta",[1*F,-(1*A)]),e&&b.bus.send("mouse-absolute",[w.pageX-e.offsetLeft,w.pageY-e.offsetTop,e.offsetWidth,e.offsetHeight])}}function o(w){i(w)&&_(w,!0)}function h(w){i(w)&&_(w,!1)}function _(w,F){b.bus&&(w.which===1?d=F:w.which===2?f=F:w.which===3&&(p=F),b.bus.send("mouse-click",[d,f,p]),w.preventDefault())}function c(w){if(i(w)){var F=w.wheelDelta||-w.detail;0>F?F=-1:0<F&&(F=1),b.bus.send("mouse-wheel",[F,0]),w.preventDefault()}}var d=!1,p=!1,f=!1,g=0,x=0,b=this;this.enabled=!1,this.emu_enabled=!0,this.bus=t,this.bus.register("mouse-enable",function(w){this.enabled=w},this),this.is_running=!1,this.bus.register("emulator-stopped",function(){this.is_running=!1},this),this.bus.register("emulator-started",function(){this.is_running=!0},this),this.destroy=function(){typeof window<"u"&&(window.removeEventListener("touchstart",s,!1),window.removeEventListener("touchend",r,!1),window.removeEventListener("touchmove",n,!1),window.removeEventListener("mousemove",n,!1),window.removeEventListener("mousedown",o,!1),window.removeEventListener("mouseup",h,!1),window.removeEventListener("wheel",c,{passive:!1}))},this.init=function(){typeof window<"u"&&(this.destroy(),window.addEventListener("touchstart",s,!1),window.addEventListener("touchend",r,!1),window.addEventListener("touchmove",n,!1),window.addEventListener("mousemove",n,!1),window.addEventListener("mousedown",o,!1),window.addEventListener("mouseup",h,!1),window.addEventListener("wheel",c,{passive:!1}))},this.init()}function Dr(){var t,e=0,i=0;this.put_char=function(s,r,n){t[s*e+r]=n},this.destroy=function(){},this.pause=function(){},this.continue=function(){},this.set_mode=function(){},this.set_font_bitmap=function(){},this.set_font_page=function(){},this.clear_screen=function(){},this.set_size_text=function(s,r){(s!==e||r!==i)&&(t=new Uint8Array(s*r),e=s,i=r)},this.set_size_graphical=function(){},this.set_scale=function(){},this.update_cursor_scanline=function(){},this.update_cursor=function(){},this.update_buffer=function(){},this.get_text_screen=function(){for(var s=[],r=0;r<i;r++)s.push(this.get_text_row(r));return s},this.get_text_row=function(s){return s*=e,String.fromCharCode.apply(String,t.subarray(s,s+e))},this.set_size_text(80,25)}function Tr(t,e){function i(h){o.bus&&o.enabled&&(o.send_char(h.which),h.preventDefault())}function s(h){var _=h.which;_===8?(o.send_char(127),h.preventDefault()):_===9&&(o.send_char(9),h.preventDefault())}function r(h){if(o.enabled){for(var _=h.clipboardData.getData("text/plain"),c=0;c<_.length;c++)o.send_char(_.charCodeAt(c));h.preventDefault()}}function n(h){h.target!==t&&t.blur()}var o=this;this.enabled=!0,this.bus=e,this.text="",this.text_new_line=!1,this.last_update=0,this.bus.register("serial0-output-byte",function(h){h=String.fromCharCode(h),this.show_char(h)},this),this.destroy=function(){t.removeEventListener("keypress",i,!1),t.removeEventListener("keydown",s,!1),t.removeEventListener("paste",r,!1),window.removeEventListener("mousedown",n,!1)},this.init=function(){this.destroy(),t.style.display="block",t.addEventListener("keypress",i,!1),t.addEventListener("keydown",s,!1),t.addEventListener("paste",r,!1),window.addEventListener("mousedown",n,!1)},this.init(),this.show_char=function(h){h==="\b"?(this.text=this.text.slice(0,-1),this.update()):h!=="\r"&&(this.text+=h,h===`
`&&(this.text_new_line=!0),this.update())},this.update=function(){var h=Date.now(),_=h-this.last_update;16>_?this.update_timer===void 0&&(this.update_timer=setTimeout(()=>{this.update_timer=void 0,this.last_update=Date.now(),this.render()},16-_)):(this.update_timer!==void 0&&(clearTimeout(this.update_timer),this.update_timer=void 0),this.last_update=h,this.render())},this.render=function(){t.value=this.text,this.text_new_line&&(this.text_new_line=!1,t.scrollTop=1e9)},this.send_char=function(h){o.bus&&o.bus.send("serial0-input",h)}}function Si(t,e){if(this.element=t,window.Terminal){var i=this.term=new window.Terminal({logLevel:"off",convertEol:"true"});i.write("This is the serial console. Whatever you type or paste here will be sent to COM1");var s=i.onData(function(r){for(let n=0;n<r.length;n++)e.send("serial0-input",r.charCodeAt(n))});e.register("serial0-output-byte",function(r){i.write(Uint8Array.of(r))},this),this.destroy=function(){s.dispose(),i.dispose()}}}Si.prototype.show=function(){this.term&&this.term.open(this.element)};function As(t,e){e=e.id||0,this.bus=t,this.bus_send_msgid=`net${e}-send`,this.bus_recv_msgid=`net${e}-receive`,this.channel=new BroadcastChannel(`v86-inbrowser-${e}`),this.is_open=!0,this.nic_to_hub_fn=i=>{this.channel.postMessage(i)},this.bus.register(this.bus_send_msgid,this.nic_to_hub_fn,this),this.hub_to_nic_fn=i=>{this.bus.send(this.bus_recv_msgid,i.data)},this.channel.addEventListener("message",this.hub_to_nic_fn)}As.prototype.destroy=function(){this.is_open&&(this.bus.unregister(this.bus_send_msgid,this.nic_to_hub_fn),this.channel.removeEventListener("message",this.hub_to_nic_fn),this.channel.close(),this.is_open=!1)};function Ge(){this.filedata=new Map}Ge.prototype.read=async function(t,e,i){return(t=this.filedata.get(t))?t.subarray(e,e+i):null};Ge.prototype.cache=async function(t,e){this.filedata.set(t,e)};Ge.prototype.uncache=function(t){this.filedata.delete(t)};function De(t,e){e.endsWith("/")||(e+="/"),this.storage=t,this.baseurl=e}De.prototype.load_from_server=function(t){return new Promise(e=>{Ct(this.baseurl+t,{done:async i=>{i=new Uint8Array(i),await this.cache(t,i),e(i)}})})};De.prototype.read=async function(t,e,i){let s=await this.storage.read(t,e,i);return s||(await this.load_from_server(t)).subarray(e,e+i)};De.prototype.cache=async function(t,e){return await this.storage.cache(t,e)};De.prototype.uncache=function(t){this.storage.uncache(t)};var zr=new TextDecoder,Rr=new TextEncoder;function st(t,e,i,s){for(var r,n=0,o=0;o<t.length;o++)switch(r=e[o],t[o]){case"w":i[s++]=r&255,i[s++]=r>>8&255,i[s++]=r>>16&255,i[s++]=r>>24&255,n+=4;break;case"d":i[s++]=r&255,i[s++]=r>>8&255,i[s++]=r>>16&255,i[s++]=r>>24&255,i[s++]=0,i[s++]=0,i[s++]=0,i[s++]=0,n+=8;break;case"h":i[s++]=r&255,i[s++]=r>>8,n+=2;break;case"b":i[s++]=r,n+=1;break;case"s":var h=s,_=0;i[s++]=0,i[s++]=0,n+=2,r=Rr.encode(r),n+=r.byteLength,_+=r.byteLength,i.set(r,s),s+=r.byteLength,i[h+0]=_&255,i[h+1]=_>>8&255;break;case"Q":st(["b","w","d"],[r.type,r.version,r.path],i,s),s+=13,n+=13}return n}function K(t,e,i){let s=i.offset;for(var r=[],n=0;n<t.length;n++)switch(t[n]){case"w":var o=e[s++];o+=e[s++]<<8,o+=e[s++]<<16,o+=e[s++]<<24>>>0,r.push(o);break;case"d":o=e[s++],o+=e[s++]<<8,o+=e[s++]<<16,o+=e[s++]<<24>>>0,s+=4,r.push(o);break;case"h":o=e[s++],r.push(o+(e[s++]<<8));break;case"b":r.push(e[s++]);break;case"s":o=e[s++],o+=e[s++]<<8;var h=e.slice(s,s+o);s+=o,r.push(zr.decode(h));break;case"Q":i.offset=s,o=K(["b","w","d"],e,i),s=i.offset,r.push({type:o[0],version:o[1],path:o[2]})}return i.offset=s,r}var cs=new TextEncoder;function D(t,e){this.inodes=[],this.events=[],this.storage=t,this.qidcounter=e||{last_qidnumber:0},this.inodedata={},this.total_size=274877906944,this.used_size=0,this.mounts=[],this.CreateDirectory("",-1)}D.prototype.get_state=function(){let t=[];t[0]=this.inodes,t[1]=this.qidcounter.last_qidnumber,t[2]=[];for(let[e,i]of Object.entries(this.inodedata))!(this.inodes[e].mode&16384)&&t[2].push([e,i]);return t[3]=this.total_size,t[4]=this.used_size,t=t.concat(this.mounts)};D.prototype.set_state=function(t){this.inodes=t[0].map(e=>{let i=new We(0);return i.set_state(e),i}),this.qidcounter.last_qidnumber=t[1],this.inodedata={};for(let[e,i]of t[2])i.buffer.byteLength!==i.byteLength&&(i=i.slice()),this.inodedata[e]=i;this.total_size=t[3],this.used_size=t[4],this.mounts=t.slice(5)};D.prototype.AddEvent=function(t,e){var i=this.inodes[t];i.status===0||i.status===2?e():this.is_forwarder(i)?this.follow_fs(i).AddEvent(i.foreign_id,e):this.events.push({id:t,OnEvent:e})};D.prototype.HandleEvent=function(t){var e=this.inodes[t];this.is_forwarder(e)&&this.follow_fs(e).HandleEvent(e.foreign_id),e=[];for(var i=0;i<this.events.length;i++)this.events[i].id===t?this.events[i].OnEvent():e.push(this.events[i]);this.events=e};D.prototype.load_from_json=function(t){if(t.version!==3)throw"The filesystem JSON format has changed. Please update your fs2json (https://github.com/copy/fs2json) and recreate the filesystem JSON.";var e=t.fsroot;for(this.used_size=t.size,t=0;t<e.length;t++)this.LoadRecursive(e[t],0)};D.prototype.LoadRecursive=function(t,e){var i=this.CreateInode();let s=t[0];i.size=t[1],i.mtime=t[2],i.ctime=i.mtime,i.atime=i.mtime,i.mode=t[3],i.uid=t[4],i.gid=t[5];var r=i.mode&61440;r===16384?(this.PushInode(i,e,s),this.LoadDir(this.inodes.length-1,t[6])):r===32768?(i.status=2,i.sha256sum=t[6],this.PushInode(i,e,s)):r===40960?(i.symlink=t[6],this.PushInode(i,e,s)):r!==49152&&a(r)};D.prototype.LoadDir=function(t,e){for(var i=0;i<e.length;i++)this.LoadRecursive(e[i],t)};D.prototype.should_be_linked=function(t){return!this.is_forwarder(t)||t.foreign_id===0};D.prototype.link_under_dir=function(t,e,i){let s=this.inodes[e],r=this.inodes[t];this.is_forwarder(r),this.IsDirectory(t),this.should_be_linked(s),r.direntries.has(i),r.direntries.set(i,e),s.nlinks++,this.IsDirectory(e)&&(s.direntries.has(".."),s.direntries.has(".")||s.nlinks++,s.direntries.set(".",e),s.direntries.set("..",t),r.nlinks++)};D.prototype.unlink_from_dir=function(t,e){let i=this.Search(t,e),s=this.inodes[i],r=this.inodes[t];this.is_forwarder(r),this.IsDirectory(t),r.direntries.delete(e)&&(s.nlinks--,this.IsDirectory(i)&&(s.direntries.get(".."),s.direntries.delete(".."),r.nlinks--))};D.prototype.PushInode=function(t,e,i){e!==-1?(this.inodes.push(t),t.fid=this.inodes.length-1,this.link_under_dir(e,t.fid,i)):this.inodes.length===0&&(this.inodes.push(t),t.direntries.set(".",0),t.direntries.set("..",0),t.nlinks=2)};function We(t){this.direntries=new Map,this.minor=this.major=this.mtime=this.atime=this.ctime=this.fid=this.gid=this.uid=this.size=this.status=0,this.symlink="",this.mode=493,this.qid={type:0,version:0,path:t},this.caps=void 0,this.nlinks=0,this.sha256sum="",this.locks=[],this.foreign_id=this.mount_id=-1}We.prototype.get_state=function(){let t=[];return t[0]=this.mode,t[1]=(this.mode&61440)===16384?[...this.direntries]:(this.mode&61440)===32768?this.sha256sum:(this.mode&61440)===40960?this.symlink:(this.mode&61440)===49152?[this.minor,this.major]:null,t[2]=this.locks,t[3]=this.status,t[4]=this.size,t[5]=this.uid,t[6]=this.gid,t[7]=this.fid,t[8]=this.ctime,t[9]=this.atime,t[10]=this.mtime,t[11]=this.qid.version,t[12]=this.qid.path,t[13]=this.nlinks,t};We.prototype.set_state=function(t){if(this.mode=t[0],(this.mode&61440)===16384){this.direntries=new Map;for(let[e,i]of t[1])this.direntries.set(e,i)}else(this.mode&61440)===32768?this.sha256sum=t[1]:(this.mode&61440)===40960?this.symlink=t[1]:(this.mode&61440)===49152&&([this.minor,this.major]=t[1]);this.locks=[];for(let e of t[2]){let i=new ie;i.set_state(e),this.locks.push(i)}this.status=t[3],this.size=t[4],this.uid=t[5],this.gid=t[6],this.fid=t[7],this.ctime=t[8],this.atime=t[9],this.mtime=t[10],this.qid.type=(this.mode&61440)>>8,this.qid.version=t[11],this.qid.path=t[12],this.nlinks=t[13]};D.prototype.divert=function(t,e){let i=this.Search(t,e),s=this.inodes[i],r=new We(-1);this.IsDirectory(i),Object.assign(r,s);let n=this.inodes.length;if(this.inodes.push(r),r.fid=n,this.is_forwarder(s)&&this.mounts[s.mount_id].backtrack.set(s.foreign_id,n),this.should_be_linked(s)&&(this.unlink_from_dir(t,e),this.link_under_dir(t,n,e)),this.IsDirectory(i)&&!this.is_forwarder(s))for(let[o,h]of r.direntries)o!=="."&&o!==".."&&this.IsDirectory(h)&&this.inodes[h].direntries.set("..",n);return this.inodedata[n]=this.inodedata[i],delete this.inodedata[i],s.direntries=new Map,s.nlinks=0,n};D.prototype.copy_inode=function(t,e){Object.assign(e,t,{fid:e.fid,direntries:e.direntries,nlinks:e.nlinks})};D.prototype.CreateInode=function(){let t=Math.round(Date.now()/1e3),e=new We(++this.qidcounter.last_qidnumber);return e.atime=e.ctime=e.mtime=t,e};D.prototype.CreateDirectory=function(t,e){var i=this.inodes[e];return 0<=e&&this.is_forwarder(i)?(e=i.foreign_id,t=this.follow_fs(i).CreateDirectory(t,e),this.create_forwarder(i.mount_id,t)):(i=this.CreateInode(),i.mode=16895,0<=e&&(i.uid=this.inodes[e].uid,i.gid=this.inodes[e].gid,i.mode=this.inodes[e].mode&511|16384),i.qid.type=64,this.PushInode(i,e,t),this.NotifyListeners(this.inodes.length-1,"newdir"),this.inodes.length-1)};D.prototype.CreateFile=function(t,e){var i=this.inodes[e];return this.is_forwarder(i)?(e=i.foreign_id,t=this.follow_fs(i).CreateFile(t,e),this.create_forwarder(i.mount_id,t)):(i=this.CreateInode(),i.uid=this.inodes[e].uid,i.gid=this.inodes[e].gid,i.qid.type=128,i.mode=this.inodes[e].mode&438|32768,this.PushInode(i,e,t),this.NotifyListeners(this.inodes.length-1,"newfile"),this.inodes.length-1)};D.prototype.CreateNode=function(t,e,i,s){var r=this.inodes[e];return this.is_forwarder(r)?(e=r.foreign_id,t=this.follow_fs(r).CreateNode(t,e,i,s),this.create_forwarder(r.mount_id,t)):(r=this.CreateInode(),r.major=i,r.minor=s,r.uid=this.inodes[e].uid,r.gid=this.inodes[e].gid,r.qid.type=192,r.mode=this.inodes[e].mode&438,this.PushInode(r,e,t),this.inodes.length-1)};D.prototype.CreateSymlink=function(t,e,i){var s=this.inodes[e];return this.is_forwarder(s)?(e=s.foreign_id,t=this.follow_fs(s).CreateSymlink(t,e,i),this.create_forwarder(s.mount_id,t)):(s=this.CreateInode(),s.uid=this.inodes[e].uid,s.gid=this.inodes[e].gid,s.qid.type=160,s.symlink=i,s.mode=40960,this.PushInode(s,e,t),this.inodes.length-1)};D.prototype.CreateTextFile=async function(t,e,i){var s=this.inodes[e];if(this.is_forwarder(s))return e=s.foreign_id,i=await this.follow_fs(s).CreateTextFile(t,e,i),this.create_forwarder(s.mount_id,i);for(s=this.CreateFile(t,e),e=this.inodes[s],t=new Uint8Array(i.length),e.size=i.length,e=0;e<i.length;e++)t[e]=i.charCodeAt(e);return await this.set_data(s,t),s};D.prototype.CreateBinaryFile=async function(t,e,i){var s=this.inodes[e];return this.is_forwarder(s)?(e=s.foreign_id,i=await this.follow_fs(s).CreateBinaryFile(t,e,i),this.create_forwarder(s.mount_id,i)):(s=this.CreateFile(t,e),t=this.inodes[s],e=new Uint8Array(i.length),e.set(i),await this.set_data(s,e),t.size=i.length,s)};D.prototype.OpenInode=function(t,e){var i=this.inodes[t];return this.is_forwarder(i)?this.follow_fs(i).OpenInode(i.foreign_id,e):((i.mode&61440)===16384&&this.FillDirectory(t),!0)};D.prototype.CloseInode=async function(t){var e=this.inodes[t];if(this.is_forwarder(e))return await this.follow_fs(e).CloseInode(e.foreign_id);e.status===2&&this.storage.uncache(e.sha256sum),e.status===4&&(e.status=-1,await this.DeleteData(t))};D.prototype.Rename=async function(t,e,i,s){if(t===i&&e===s)return 0;var r=this.Search(t,e);if(r===-1)return-2;var n=this.GetFullPath(t)+"/"+e;if(this.Search(i,s)!==-1){var o=this.Unlink(i,s);if(0>o)return o}var h=this.inodes[r],_=this.inodes[t];if(o=this.inodes[i],this.is_forwarder(_)||this.is_forwarder(o))if(this.is_forwarder(_)&&_.mount_id===o.mount_id){if(t=await this.follow_fs(_).Rename(_.foreign_id,e,o.foreign_id,s),0>t)return t}else{if(this.is_a_root(r)||!this.IsDirectory(r)&&1<this.GetInode(r).nlinks)return-1;_=this.divert(t,e);let c=this.GetInode(r),d=await this.Read(_,0,c.size);if(this.is_forwarder(o)?(i=this.follow_fs(o),s=this.IsDirectory(_)?i.CreateDirectory(s,o.foreign_id):i.CreateFile(s,o.foreign_id),i=i.GetInode(s),this.copy_inode(c,i),this.set_forwarder(r,o.mount_id,s)):(this.delete_forwarder(h),this.copy_inode(c,h),this.link_under_dir(i,r,s)),await this.ChangeSize(r,c.size),d&&d.length&&await this.Write(r,0,d.length,d),this.IsDirectory(r)){for(let p of this.GetChildren(_))if(o=await this.Rename(_,p,r,p),0>o)return o}if(await this.DeleteData(_),t=this.Unlink(t,e),0>t)return t}else this.unlink_from_dir(t,e),this.link_under_dir(i,r,s),h.qid.version++;return this.NotifyListeners(r,"rename",{oldpath:n}),0};D.prototype.Write=async function(t,e,i,s){this.NotifyListeners(t,"write");var r=this.inodes[t];if(this.is_forwarder(r))t=r.foreign_id,await this.follow_fs(r).Write(t,e,i,s);else{var n=await this.get_buffer(t);!n||n.length<e+i?(await this.ChangeSize(t,Math.floor(3*(e+i)/2)),r.size=e+i,n=await this.get_buffer(t)):r.size<e+i&&(r.size=e+i),s&&n.set(s.subarray(0,i),e),await this.set_data(t,n)}};D.prototype.Read=async function(t,e,i){let s=this.inodes[t];return this.is_forwarder(s)?(t=s.foreign_id,await this.follow_fs(s).Read(t,e,i)):await this.get_data(t,e,i)};D.prototype.Search=function(t,e){if(t=this.inodes[t],this.is_forwarder(t)){let i=t.foreign_id;return e=this.follow_fs(t).Search(i,e),e===-1?-1:this.get_forwarder(t.mount_id,e)}return e=t.direntries.get(e),e===void 0?-1:e};D.prototype.CountUsedInodes=function(){let t=this.inodes.length;for(let{fs:e,backtrack:i}of this.mounts)t+=e.CountUsedInodes(),t-=i.size;return t};D.prototype.CountFreeInodes=function(){let t=1048576;for(let{fs:e}of this.mounts)t+=e.CountFreeInodes();return t};D.prototype.GetTotalSize=function(){let t=this.used_size;for(let{fs:e}of this.mounts)t+=e.GetTotalSize();return t};D.prototype.GetSpace=function(){let t=this.total_size;for(let{fs:e}of this.mounts)t+=e.GetSpace();return this.total_size};D.prototype.GetDirectoryName=function(t){let e=this.inodes[this.GetParent(t)];if(this.is_forwarder(e))return this.follow_fs(e).GetDirectoryName(this.inodes[t].foreign_id);if(!e)return"";for(let[i,s]of e.direntries)if(s===t)return i;return""};D.prototype.GetFullPath=function(t){this.IsDirectory(t);for(var e="";t!==0;)e="/"+this.GetDirectoryName(t)+e,t=this.GetParent(t);return e.substring(1)};D.prototype.Link=function(t,e,i){if(this.IsDirectory(e))return-1;let s=this.inodes[t],r=this.inodes[e];return this.is_forwarder(s)?this.is_forwarder(r)&&r.mount_id===s.mount_id?this.follow_fs(s).Link(s.foreign_id,r.foreign_id,i):-1:this.is_forwarder(r)?-1:(this.link_under_dir(t,e,i),0)};D.prototype.Unlink=function(t,e){if(e==="."||e==="..")return-1;let i=this.Search(t,e),s=this.inodes[i],r=this.inodes[t];return this.is_forwarder(r)?(this.is_forwarder(s),t=r.foreign_id,this.follow_fs(r).Unlink(t,e)):this.IsDirectory(i)&&!this.IsEmpty(i)?-39:(this.unlink_from_dir(t,e),s.nlinks===0&&(s.status=4,this.NotifyListeners(i,"delete")),0)};D.prototype.DeleteData=async function(t){let e=this.inodes[t];this.is_forwarder(e)?await this.follow_fs(e).DeleteData(e.foreign_id):(e.size=0,delete this.inodedata[t])};D.prototype.get_buffer=async function(t){let e=this.inodes[t];return this.inodedata[t]?this.inodedata[t]:e.status===2?await this.storage.read(e.sha256sum,0,e.size):null};D.prototype.get_data=async function(t,e,i){let s=this.inodes[t];return this.inodedata[t]?this.inodedata[t].subarray(e,e+i):s.status===2?await this.storage.read(s.sha256sum,e,i):null};D.prototype.set_data=async function(t,e){this.inodedata[t]=e,this.inodes[t].status===2&&(this.inodes[t].status=0,this.storage.uncache(this.inodes[t].sha256sum))};D.prototype.GetInode=function(t){return isNaN(t),t=this.inodes[t],this.is_forwarder(t)?this.follow_fs(t).GetInode(t.foreign_id):t};D.prototype.ChangeSize=async function(t,e){var i=this.GetInode(t),s=await this.get_data(t,0,i.size);if(e!==i.size){var r=new Uint8Array(e);i.size=e,s&&r.set(s.subarray(0,Math.min(s.length,i.size)),0),await this.set_data(t,r)}};D.prototype.SearchPath=function(t){t=t.replace("//","/"),t=t.split("/"),0<t.length&&t[t.length-1].length===0&&t.pop(),0<t.length&&t[0].length===0&&t.shift();let e=t.length;var i=-1,s=0;let r=null;for(var n=0;n<e;n++)if(i=s,s=this.Search(i,t[n]),!r&&this.is_forwarder(this.inodes[i])&&(r="/"+t.slice(n).join("/")),s===-1)return n<e-1?{id:-1,parentid:-1,name:t[n],forward_path:r}:{id:-1,parentid:i,name:t[n],forward_path:r};return{id:s,parentid:i,name:t[n],forward_path:r}};D.prototype.GetRecursiveList=function(t,e){if(this.is_forwarder(this.inodes[t])){let i=this.follow_fs(this.inodes[t]),s=this.inodes[t].mount_id,r=e.length;for(i.GetRecursiveList(this.inodes[t].foreign_id,e),t=r;t<e.length;t++)e[t].parentid=this.get_forwarder(s,e[t].parentid)}else for(let[i,s]of this.inodes[t].direntries)i!=="."&&i!==".."&&(e.push({parentid:t,name:i}),this.IsDirectory(s)&&this.GetRecursiveList(s,e))};D.prototype.RecursiveDelete=function(t){var e=[];if(t=this.SearchPath(t),t.id!==-1)for(this.GetRecursiveList(t.id,e),t=e.length-1;0<=t;t--)this.Unlink(e[t].parentid,e[t].name)};D.prototype.DeleteNode=function(t){var e=this.SearchPath(t);e.id!==-1&&((this.inodes[e.id].mode&61440)===32768?this.Unlink(e.parentid,e.name):(this.inodes[e.id].mode&61440)===16384&&(this.RecursiveDelete(t),this.Unlink(e.parentid,e.name)))};D.prototype.NotifyListeners=function(){};D.prototype.Check=function(){for(var t=1;t<this.inodes.length;t++)if(this.inodes[t].status!==-1&&(this.GetInode(t),this.IsDirectory(t))){let e=this.GetInode(t);this.IsDirectory(t)&&this.GetParent(t);for(let[i]of e.direntries)for(let s of i);}};D.prototype.FillDirectory=function(t){var e=this.inodes[t];if(this.is_forwarder(e))this.follow_fs(e).FillDirectory(e.foreign_id);else{var i=0;for(let s of e.direntries.keys())i+=24+cs.encode(s).length;t=this.inodedata[t]=new Uint8Array(i),e.size=i,i=0;for(let[s,r]of e.direntries)e=this.GetInode(r),i+=st(["Q","d","b","s"],[e.qid,i+13+8+1+2+cs.encode(s).length,e.mode>>12,s],t,i)}};D.prototype.RoundToDirentry=function(t,e){if(t=this.inodedata[t],e>=t.length)return t.length;let i=0;for(;;){let s=K(["Q","d"],t,{offset:i})[1];if(s>e)break;i=s}return i};D.prototype.IsDirectory=function(t){return t=this.inodes[t],this.is_forwarder(t)?this.follow_fs(t).IsDirectory(t.foreign_id):(t.mode&61440)===16384};D.prototype.IsEmpty=function(t){if(t=this.inodes[t],this.is_forwarder(t))return this.follow_fs(t).IsDirectory(t.foreign_id);for(let e of t.direntries.keys())if(e!=="."&&e!=="..")return!1;return!0};D.prototype.GetChildren=function(t){if(this.IsDirectory(t),t=this.inodes[t],this.is_forwarder(t))return this.follow_fs(t).GetChildren(t.foreign_id);let e=[];for(let i of t.direntries.keys())i!=="."&&i!==".."&&e.push(i);return e};D.prototype.GetParent=function(t){if(this.IsDirectory(t),t=this.inodes[t],this.should_be_linked(t))return t.direntries.get("..");let e=this.follow_fs(t).GetParent(t.foreign_id);return this.get_forwarder(t.mount_id,e)};D.prototype.PrepareCAPs=function(t){return t=this.GetInode(t),t.caps||(t.caps=new Uint8Array(20),t.caps[0]=0,t.caps[1]=0,t.caps[2]=0,t.caps[3]=2,t.caps[4]=255,t.caps[5]=255,t.caps[6]=255,t.caps[7]=255,t.caps[8]=255,t.caps[9]=255,t.caps[10]=255,t.caps[11]=255,t.caps[12]=63,t.caps[13]=0,t.caps[14]=0,t.caps[15]=0,t.caps[16]=63,t.caps[17]=0,t.caps[18]=0,t.caps[19]=0),t.caps.length};function qi(t){this.fs=t,this.backtrack=new Map}qi.prototype.get_state=function(){let t=[];return t[0]=this.fs,t[1]=[...this.backtrack],t};qi.prototype.set_state=function(t){this.fs=t[0],this.backtrack=new Map(t[1])};D.prototype.set_forwarder=function(t,e,i){let s=this.inodes[t];this.is_forwarder(s)&&this.mounts[s.mount_id].backtrack.delete(s.foreign_id),s.status=5,s.mount_id=e,s.foreign_id=i,this.mounts[e].backtrack.set(i,t)};D.prototype.create_forwarder=function(t,e){let i=this.CreateInode(),s=this.inodes.length;return this.inodes.push(i),i.fid=s,this.set_forwarder(s,t,e),s};D.prototype.is_forwarder=function(t){return t.status===5};D.prototype.is_a_root=function(t){return this.GetInode(t).fid===0};D.prototype.get_forwarder=function(t,e){let i=this.mounts[t].backtrack.get(e);return i===void 0?this.create_forwarder(t,e):i};D.prototype.delete_forwarder=function(t){this.is_forwarder(t),t.status=-1,this.mounts[t.mount_id].backtrack.delete(t.foreign_id)};D.prototype.follow_fs=function(t){let e=this.mounts[t.mount_id];return this.is_forwarder(t),e.fs};D.prototype.Mount=function(t,e){if(t=this.SearchPath(t),t.parentid===-1)return-2;if(t.id!==-1)return-17;if(t.forward_path){var i=this.inodes[t.parentid];return e=this.follow_fs(i).Mount(t.forward_path,e),0>e?e:this.get_forwarder(i.mount_id,e)}return i=this.mounts.length,this.mounts.push(new qi(e)),e=this.create_forwarder(i,0),this.link_under_dir(t.parentid,e,t.name),e};function ie(){this.type=2,this.start=0,this.length=1/0,this.proc_id=-1,this.client_id=""}ie.prototype.get_state=function(){let t=[];return t[0]=this.type,t[1]=this.start,t[2]=this.length===1/0?0:this.length,t[3]=this.proc_id,t[4]=this.client_id,t};ie.prototype.set_state=function(t){this.type=t[0],this.start=t[1],this.length=t[2]===0?1/0:t[2],this.proc_id=t[3],this.client_id=t[4]};ie.prototype.clone=function(){let t=new ie;return t.set_state(this.get_state()),t};ie.prototype.conflicts_with=function(t){return!(this.proc_id===t.proc_id&&this.client_id===t.client_id||this.type===2||t.type===2||this.type!==1&&t.type!==1||this.start+this.length<=t.start||t.start+t.length<=this.start)};ie.prototype.is_alike=function(t){return t.proc_id===this.proc_id&&t.client_id===this.client_id&&t.type===this.type};ie.prototype.may_merge_after=function(t){return this.is_alike(t)&&t.start+t.length===this.start};D.prototype.DescribeLock=function(t,e,i,s,r){let n=new ie;return n.type=t,n.start=e,n.length=i,n.proc_id=s,n.client_id=r,n};D.prototype.GetLock=function(t,e){if(t=this.inodes[t],this.is_forwarder(t)){var i=t.foreign_id;return this.follow_fs(t).GetLock(i,e)}for(i of t.locks)if(e.conflicts_with(i))return i.clone();return null};D.prototype.Lock=function(t,e,i){let s=this.inodes[t];if(this.is_forwarder(s))return t=s.foreign_id,this.follow_fs(s).Lock(t,e,i);if(e=e.clone(),e.type!==2&&this.GetLock(t,e))return 1;for(i=0;i<s.locks.length;i++){if(t=s.locks[i],t.start+t.length<=e.start)continue;if(e.start+e.length<=t.start)break;if(t.proc_id!==e.proc_id||t.client_id!==e.client_id){t.conflicts_with(e);continue}var r=e.start+e.length;let n=e.start-t.start,o=t.start+t.length-r;if(0<n&&0<o&&t.type===e.type)return 0;if(0<n&&(t.length=n),0>=n&&0<o)t.start=r,t.length=o;else if(0<o){for(;i<s.locks.length&&s.locks[i].start<r;)i++;s.locks.splice(i,0,this.DescribeLock(t.type,r,o,t.proc_id,t.client_id))}else 0>=n&&(s.locks.splice(i,1),i--)}if(e.type!==2){for(i=e,t=!1,r=0;r<s.locks.length&&(i.may_merge_after(s.locks[r])&&(s.locks[r].length+=e.length,i=s.locks[r],t=!0),!(e.start<=s.locks[r].start));r++);for(t||(s.locks.splice(r,0,i),r++);r<s.locks.length;r++)if(s.locks[r].is_alike(i)){s.locks[r].may_merge_after(i)&&(i.length+=s.locks[r].length,s.locks.splice(r,1));break}}return 0};D.prototype.read_dir=function(t){if(t=this.SearchPath(t),t.id!==-1)return t=this.GetInode(t.id),Array.from(t.direntries.keys()).filter(e=>e!=="."&&e!=="..")};D.prototype.read_file=function(t){if(t=this.SearchPath(t),t.id===-1)return Promise.resolve(null);let e=this.GetInode(t.id);return this.Read(t.id,0,e.size)};function N(t){this.cpu_is_running=!1,this.cpu_exception_hook=function(){};var e=ps.create();this.bus=e[0],this.emulator_bus=e[1];var i,s;let r=new WebAssembly.Table({element:"anyfunc",initial:1924});e={cpu_exception_hook:o=>this.cpu_exception_hook(o),run_hardware_timers:function(o,h){return i.run_hardware_timers(o,h)},cpu_event_halt:()=>{this.emulator_bus.send("cpu-event-halt")},abort:function(){},microtick:Z.microtick,get_rand_int:function(){return Xe()},apic_acknowledge_irq:function(){return i.devices.apic.acknowledge_irq()},stop_idling:function(){return i.stop_idling()},io_port_read8:function(o){return i.io.port_read8(o)},io_port_read16:function(o){return i.io.port_read16(o)},io_port_read32:function(o){return i.io.port_read32(o)},io_port_write8:function(o,h){i.io.port_write8(o,h)},io_port_write16:function(o,h){i.io.port_write16(o,h)},io_port_write32:function(o,h){i.io.port_write32(o,h)},mmap_read8:function(o){return i.mmap_read8(o)},mmap_read16:function(o){return i.mmap_read16(o)},mmap_read32:function(o){return i.mmap_read32(o)},mmap_write8:function(o,h){i.mmap_write8(o,h)},mmap_write16:function(o,h){i.mmap_write16(o,h)},mmap_write32:function(o,h){i.mmap_write32(o,h)},mmap_write64:function(o,h,_){i.mmap_write64(o,h,_)},mmap_write128:function(o,h,_,c,d){i.mmap_write128(o,h,_,c,d)},log_from_wasm:function(o,h){String.fromCharCode(...new Uint8Array(s.buffer,o>>>0,h>>>0))},console_log_from_wasm:function(o,h){o=String.fromCharCode(...new Uint8Array(s.buffer,o>>>0,h>>>0)),console.error(o)},dbg_trace_from_wasm:function(){},codegen_finalize:(o,h,_,c,d)=>{i.codegen_finalize(o,h,_,c,d)},jit_clear_func:o=>i.jit_clear_func(o),jit_clear_all_funcs:()=>i.jit_clear_all_funcs(),__indirect_function_table:r};let n=t.wasm_fn;n||(n=o=>new Promise(h=>{let _="v86.wasm",c="v86-fallback.wasm";t.wasm_path?(_=t.wasm_path,c=_.replace("v86.wasm","v86-fallback.wasm")):typeof window>"u"&&typeof __dirname=="string"?(_=__dirname+"/"+_,c=__dirname+"/"+c):(_="build/"+_,c="build/"+c),Ct(_,{done:async d=>{try{let{instance:p}=await WebAssembly.instantiate(d,o);this.wasm_source=d,h(p.exports)}catch{Ct(c,{done:async f=>{let{instance:g}=await WebAssembly.instantiate(f,o);this.wasm_source=f,h(g.exports)}})}},progress:d=>{this.emulator_bus.send("download-progress",{file_index:0,file_count:1,file_name:_,lengthComputable:d.lengthComputable,total:d.total,loaded:d.loaded})}})})),n({env:e}).then(o=>{s=o.memory,o.rust_init(),o=this.v86=new Z(this.emulator_bus,{exports:o,wasm_table:r}),i=o.cpu,this.continue_init(o,t)}),this.zstd_worker=null,this.zstd_worker_request_id=0}N.prototype.continue_init=async function(t,e){function i(f,g){switch(f){case"hda":r.hda=this.disk_images.hda=g;break;case"hdb":r.hdb=this.disk_images.hdb=g;break;case"cdrom":r.cdrom=this.disk_images.cdrom=g;break;case"fda":r.fda=this.disk_images.fda=g;break;case"fdb":r.fdb=this.disk_images.fdb=g;break;case"multiboot":r.multiboot=this.disk_images.multiboot=g.buffer;break;case"bzimage":r.bzimage=this.disk_images.bzimage=g.buffer;break;case"initrd":r.initrd=this.disk_images.initrd=g.buffer;break;case"bios":r.bios=g.buffer;break;case"vga_bios":r.vga_bios=g.buffer;break;case"initial_state":r.initial_state=g.buffer;break;case"fs9p_json":r.fs9p_json=g}}async function s(){if(r.fs9p&&r.fs9p_json&&!r.initial_state&&(r.fs9p.load_from_json(r.fs9p_json),e.bzimage_initrd_from_filesystem)){let{bzimage_path:f,initrd_path:g}=this.get_bzimage_initrd_from_filesystem(r.fs9p),[x,b]=await Promise.all([r.fs9p.read_file(g),r.fs9p.read_file(f)]);i.call(this,"initrd",new lt(x.buffer)),i.call(this,"bzimage",new lt(b.buffer))}this.serial_adapter&&this.serial_adapter.show&&this.serial_adapter.show(),this.v86.init(r),r.initial_state&&(t.restore_state(r.initial_state),r.initial_state=void 0),e.autostart&&this.v86.run(),this.emulator_bus.send("emulator-loaded")}this.bus.register("emulator-stopped",function(){this.cpu_is_running=!1,this.screen_adapter.pause()},this),this.bus.register("emulator-started",function(){this.cpu_is_running=!0,this.screen_adapter.continue()},this);var r={};this.disk_images={fda:void 0,fdb:void 0,hda:void 0,hdb:void 0,cdrom:void 0};var n=e.boot_order?e.boot_order:e.fda?801:e.hda?786:291;r.acpi=e.acpi,r.disable_jit=e.disable_jit,r.load_devices=!0,r.memory_size=e.memory_size||67108864,r.vga_memory_size=e.vga_memory_size||8388608,r.boot_order=n,r.fastboot=e.fastboot||!1,r.fda=void 0,r.fdb=void 0,r.uart1=e.uart1,r.uart2=e.uart2,r.uart3=e.uart3,r.cmdline=e.cmdline,r.preserve_mac_from_state_image=e.preserve_mac_from_state_image,r.mac_address_translation=e.mac_address_translation,r.cpuid_level=e.cpuid_level,r.virtio_balloon=e.virtio_balloon,r.virtio_console=e.virtio_console,r.screen_options=e.screen_options,(n=e.network_relay_url||e.net_device&&e.net_device.relay_url)&&(n==="fetch"?this.network_adapter=new Gt(this.bus,e.net_device):n==="inbrowser"?this.network_adapter=new As(this.bus,e.net_device):n.startsWith("wisp://")||n.startsWith("wisps://")?this.network_adapter=new re(n,this.bus,e.net_device):this.network_adapter=new se(n,this.bus)),r.net_device=e.net_device||{type:"ne2k"},n=e.screen||{},e.screen_container&&(n.container=e.screen_container),e.disable_keyboard||(this.keyboard_adapter=new qr(this.bus)),e.disable_mouse||(this.mouse_adapter=new Or(this.bus,n.container)),this.screen_adapter=n.container?new fr(n,()=>this.v86.cpu.devices.vga&&this.v86.cpu.devices.vga.screen_fill_buffer()):new Dr,r.screen=this.screen_adapter,r.screen_options=n,e.serial_container&&(this.serial_adapter=new Tr(e.serial_container,this.bus)),e.serial_container_xtermjs&&(this.serial_adapter=new Si(e.serial_container_xtermjs,this.bus)),e.disable_speaker||(this.speaker_adapter=new ws(this.bus));var o=[];if(n=(f,g)=>{g&&(g.get&&g.set&&g.load?o.push({name:f,loadable:g}):((f==="bios"||f==="vga_bios"||f==="initial_state"||f==="multiboot"||f==="bzimage"||f==="initrd")&&(g.async=!1),(f==="fda"||f==="fdb")&&(g.async=!1),g.url&&!g.async?o.push({name:f,url:g.url,size:g.size}):o.push({name:f,loadable:Ai(g,this.zstd_decompress_worker.bind(this))})))},e.state&&console.warn("Warning: Unknown option 'state'. Did you mean 'initial_state'?"),n("bios",e.bios),n("vga_bios",e.vga_bios),n("cdrom",e.cdrom),n("hda",e.hda),n("hdb",e.hdb),n("fda",e.fda),n("fdb",e.fdb),n("initial_state",e.initial_state),n("multiboot",e.multiboot),n("bzimage",e.bzimage),n("initrd",e.initrd),e.filesystem&&e.filesystem.handle9p&&(r.handle9p=e.filesystem.handle9p),e.filesystem&&e.filesystem.proxy_url&&(r.proxy9p=e.filesystem.proxy_url),e.filesystem&&!e.filesystem.handle9p&&!e.filesystem.proxy_url){n=e.filesystem.basefs;var h=e.filesystem.baseurl;let f=new Ge;if(h&&(f=new De(f,h)),r.fs9p=this.fs9p=new D(f),n){if(typeof n=="object"){var _=n.size;n=n.url}o.push({name:"fs9p_json",url:n,size:_,as_json:!0})}}var c=this,d=o.length,p=function(f){if(f===d)setTimeout(s.bind(this),0);else{var g=o[f];g.loadable?(g.loadable.onload=function(){i.call(this,g.name,g.loadable),p(f+1)}.bind(this),g.loadable.load()):Ct(g.url,{done:function(x){g.url.endsWith(".zst")&&g.name!=="initial_state"&&(x=this.zstd_decompress(g.size,new Uint8Array(x))),i.call(this,g.name,g.as_json?x:new lt(x)),p(f+1)}.bind(this),progress:function(x){x.target.status===200?c.emulator_bus.send("download-progress",{file_index:f,file_count:d,file_name:g.url,lengthComputable:x.lengthComputable,total:x.total||g.size,loaded:x.loaded}):c.emulator_bus.send("download-error",{file_index:f,file_count:d,file_name:g.url,request:x.target})},as_json:g.as_json})}}.bind(this);p(0)};N.prototype.zstd_decompress=function(t,e){let i=this.v86.cpu;this.zstd_context=i.zstd_create_ctx(e.length),new Uint8Array(i.wasm_memory.buffer).set(e,i.zstd_get_src_ptr(this.zstd_context)),e=i.zstd_read(this.zstd_context,t);let s=i.wasm_memory.buffer.slice(e,e+t);return i.zstd_read_free(e,t),i.zstd_free_ctx(this.zstd_context),this.zstd_context=null,s};N.prototype.zstd_decompress_worker=async function(t,e){if(!this.zstd_worker){let i=URL.createObjectURL(new Blob(["("+function(){let s;globalThis.onmessage=function(r){if(s){var{src:n,decompressed_size:o,id:h}=r.data;r=s.exports;var _=r.zstd_create_ctx(n.length);new Uint8Array(r.memory.buffer).set(n,r.zstd_get_src_ptr(_));var c=r.zstd_read(_,o),d=r.memory.buffer.slice(c,c+o);r.zstd_read_free(c,o),r.zstd_free_ctx(_),postMessage({result:d,id:h},[d])}else _=Object.fromEntries("cpu_exception_hook run_hardware_timers cpu_event_halt microtick get_rand_int apic_acknowledge_irq stop_idling io_port_read8 io_port_read16 io_port_read32 io_port_write8 io_port_write16 io_port_write32 mmap_read8 mmap_read16 mmap_read32 mmap_write8 mmap_write16 mmap_write32 mmap_write64 mmap_write128 codegen_finalize jit_clear_func jit_clear_all_funcs".split(" ").map(p=>[p,()=>console.error("zstd worker unexpectedly called "+p)])),_.__indirect_function_table=new WebAssembly.Table({element:"anyfunc",initial:1024}),_.abort=()=>{throw Error("zstd worker aborted")},_.log_from_wasm=_.console_log_from_wasm=(p,f)=>{console.log(String.fromCharCode(...new Uint8Array(s.exports.memory.buffer,p,f)))},_.dbg_trace_from_wasm=()=>console.trace(),s=new WebAssembly.Instance(new WebAssembly.Module(r.data),{env:_})}}.toString()+")()"],{type:"text/javascript"}));this.zstd_worker=new Worker(i),URL.revokeObjectURL(i),this.zstd_worker.postMessage(this.wasm_source,[this.wasm_source])}return new Promise(i=>{let s=this.zstd_worker_request_id++,r=async n=>{n.data.id===s&&(this.zstd_worker.removeEventListener("message",r),i(n.data.result))};this.zstd_worker.addEventListener("message",r),this.zstd_worker.postMessage({src:e,decompressed_size:t,id:s},[e.buffer])})};N.prototype.get_bzimage_initrd_from_filesystem=function(t){let e=(t.read_dir("/")||[]).map(r=>"/"+r);t=(t.read_dir("/boot/")||[]).map(r=>"/boot/"+r);let i,s;for(let r of[].concat(e,t)){let n=/old/i.test(r)||/fallback/i.test(r),o=/vmlinuz/i.test(r)||/bzimage/i.test(r),h=/initrd/i.test(r)||/initramfs/i.test(r);!o||s&&n||(s=r),!h||i&&n||(i=r)}return i&&s||(console.log("Failed to find bzimage or initrd in filesystem. Files:"),console.log(e.join(" ")),console.log(t.join(" "))),{initrd_path:i,bzimage_path:s}};N.prototype.run=async function(){this.v86.run()};N.prototype.stop=async function(){this.cpu_is_running&&await new Promise(t=>{let e=()=>{this.remove_listener("emulator-stopped",e),t()};this.add_listener("emulator-stopped",e),this.v86.stop()})};N.prototype.destroy=async function(){await this.stop(),this.v86.destroy(),this.keyboard_adapter&&this.keyboard_adapter.destroy(),this.network_adapter&&this.network_adapter.destroy(),this.mouse_adapter&&this.mouse_adapter.destroy(),this.screen_adapter&&this.screen_adapter.destroy(),this.serial_adapter&&this.serial_adapter.destroy(),this.speaker_adapter&&this.speaker_adapter.destroy()};N.prototype.restart=function(){this.v86.restart()};N.prototype.add_listener=function(t,e){this.bus.register(t,e,this)};N.prototype.remove_listener=function(t,e){this.bus.unregister(t,e)};N.prototype.restore_state=async function(t){this.v86.restore_state(t)};N.prototype.save_state=async function(){return this.v86.save_state()};N.prototype.get_instruction_counter=function(){return this.v86?this.v86.cpu.instruction_counter[0]>>>0:0};N.prototype.is_running=function(){return this.cpu_is_running};N.prototype.set_fda=async function(t){if(t.url&&!t.async)Ct(t.url,{done:e=>{this.v86.cpu.devices.fdc.set_fda(new lt(e))}});else{let e=Ai(t,this.zstd_decompress_worker.bind(this));e.onload=()=>{this.v86.cpu.devices.fdc.set_fda(e)},await e.load()}};N.prototype.eject_fda=function(){this.v86.cpu.devices.fdc.eject_fda()};N.prototype.set_cdrom=async function(t){if(t.url&&!t.async)Ct(t.url,{done:e=>{this.v86.cpu.devices.cdrom.set_cdrom(new lt(e))}});else{let e=Ai(t,this.zstd_decompress_worker.bind(this));e.onload=()=>{this.v86.cpu.devices.cdrom.set_cdrom(e)},await e.load()}};N.prototype.eject_cdrom=function(){this.v86.cpu.devices.cdrom.eject()};N.prototype.keyboard_send_scancodes=function(t){for(var e=0;e<t.length;e++)this.bus.send("keyboard-code",t[e])};N.prototype.keyboard_send_keys=function(t){for(var e=0;e<t.length;e++)this.keyboard_adapter.simulate_press(t[e])};N.prototype.keyboard_send_text=function(t){for(var e=0;e<t.length;e++)this.keyboard_adapter.simulate_char(t[e])};N.prototype.screen_make_screenshot=function(){return this.screen_adapter?this.screen_adapter.make_screenshot():null};N.prototype.screen_set_scale=function(t,e){this.screen_adapter&&this.screen_adapter.set_scale(t,e)};N.prototype.screen_go_fullscreen=function(){if(this.screen_adapter){var t=document.getElementById("screen_container");if(t){var e=t.requestFullScreen||t.webkitRequestFullscreen||t.mozRequestFullScreen||t.msRequestFullScreen;e&&(e.call(t),(t=document.getElementsByClassName("phone_keyboard")[0])&&t.focus());try{navigator.keyboard.lock()}catch{}this.lock_mouse()}}};N.prototype.lock_mouse=async function(){let t=document.body;try{await t.requestPointerLock({unadjustedMovement:!0})}catch{await t.requestPointerLock()}};N.prototype.mouse_set_enabled=function(t){this.mouse_adapter&&(this.mouse_adapter.emu_enabled=t)};N.prototype.mouse_set_status=N.prototype.mouse_set_enabled;N.prototype.keyboard_set_enabled=function(t){this.keyboard_adapter&&(this.keyboard_adapter.emu_enabled=t)};N.prototype.keyboard_set_status=N.prototype.keyboard_set_enabled;N.prototype.serial0_send=function(t){for(var e=0;e<t.length;e++)this.bus.send("serial0-input",t.charCodeAt(e))};N.prototype.serial_send_bytes=function(t,e){for(var i=0;i<e.length;i++)this.bus.send("serial"+t+"-input",e[i])};N.prototype.serial_set_modem_status=function(t,e){this.bus.send("serial"+t+"-modem-status-input",e)};N.prototype.serial_set_carrier_detect=function(t,e){this.bus.send("serial"+t+"-carrier-detect-input",e)};N.prototype.serial_set_ring_indicator=function(t,e){this.bus.send("serial"+t+"-ring-indicator-input",e)};N.prototype.serial_set_data_set_ready=function(t,e){this.bus.send("serial"+t+"-data-set-ready-input",e)};N.prototype.serial_set_clear_to_send=function(t,e){this.bus.send("serial"+t+"-clear-to-send-input",e)};N.prototype.mount_fs=async function(t,e,i){var s=new Ge;if(e&&(s=new De(s,e)),s=new D(s,this.fs9p.qidcounter),e&&s.load_from_json(i),t=this.fs9p.Mount(t,s),t===-2)throw new ii;if(t===-17)throw new Us;if(0>t)throw Error("Failed to mount. Error number: "+-t)};N.prototype.create_file=async function(t,e){var i=this.fs9p;if(i){var s=t.split("/");if(s=s[s.length-1],t=i.SearchPath(t).parentid,s!==""&&t!==-1)await i.CreateBinaryFile(s,t,e);else return Promise.reject(new ii)}};N.prototype.read_file=async function(t){var e=this.fs9p;if(e)return(t=await e.read_file(t))?t:Promise.reject(new ii)};N.prototype.automatically=function(t){let e=i=>{let s=i[0];if(s){var r=i.slice(1);s.sleep?setTimeout(()=>e(r),1e3*s.sleep):s.vga_text?this.wait_until_vga_screen_contains(s.vga_text).then(()=>e(r)):s.keyboard_send?(Array.isArray(s.keyboard_send)?this.keyboard_send_scancodes(s.keyboard_send):this.keyboard_send_text(s.keyboard_send),e(r)):s.call&&(s.call(),e(r))}};e(t)};N.prototype.wait_until_vga_screen_contains=function(t){return new Promise(e=>{function i(o){return typeof t=="string"?o.includes(t):t.test(o)}function s(o){[o]=o,r.add(o)}for(let o of this.screen_adapter.get_text_screen())if(i(o)){e(!0);return}let r=new Set,n=()=>{for(let o of r){let h=this.screen_adapter.get_text_row(o);if(i(h)){this.remove_listener("screen-put-char",s),e();return}}r.clear(),setTimeout(n,100)};n(),this.add_listener("screen-put-char",s)})};N.prototype.read_memory=function(t,e){return this.v86.cpu.read_blob(t,e)};N.prototype.write_memory=function(t,e){this.v86.cpu.write_blob(t,e)};N.prototype.set_serial_container_xtermjs=function(t){this.serial_adapter&&this.serial_adapter.destroy&&this.serial_adapter.destroy(),this.serial_adapter=new Si(t,this.bus),this.serial_adapter.show()};N.prototype.get_instruction_stats=function(){var t=this.v86.cpu,e="",i="COMPILE COMPILE_SKIPPED_NO_NEW_ENTRY_POINTS COMPILE_WRONG_ADDRESS_SPACE COMPILE_CUT_OFF_AT_END_OF_PAGE COMPILE_WITH_LOOP_SAFETY COMPILE_PAGE COMPILE_PAGE/COMPILE COMPILE_BASIC_BLOCK COMPILE_DUPLICATED_BASIC_BLOCK COMPILE_WASM_BLOCK COMPILE_WASM_LOOP COMPILE_DISPATCHER COMPILE_ENTRY_POINT COMPILE_WASM_TOTAL_BYTES COMPILE_WASM_TOTAL_BYTES/COMPILE_PAGE RUN_INTERPRETED RUN_INTERPRETED_NEW_PAGE RUN_INTERPRETED_PAGE_HAS_CODE RUN_INTERPRETED_PAGE_HAS_ENTRY_AFTER_PAGE_WALK RUN_INTERPRETED_NEAR_END_OF_PAGE RUN_INTERPRETED_DIFFERENT_STATE RUN_INTERPRETED_DIFFERENT_STATE_CPL3 RUN_INTERPRETED_DIFFERENT_STATE_FLAT RUN_INTERPRETED_DIFFERENT_STATE_IS32 RUN_INTERPRETED_DIFFERENT_STATE_SS32 RUN_INTERPRETED_MISSED_COMPILED_ENTRY_RUN_INTERPRETED RUN_INTERPRETED_STEPS RUN_FROM_CACHE RUN_FROM_CACHE_STEPS RUN_FROM_CACHE_STEPS/RUN_FROM_CACHE RUN_FROM_CACHE_STEPS/RUN_INTERPRETED_STEPS DIRECT_EXIT INDIRECT_JUMP INDIRECT_JUMP_NO_ENTRY NORMAL_PAGE_CHANGE NORMAL_FALLTHRU NORMAL_FALLTHRU_WITH_TARGET_BLOCK NORMAL_BRANCH NORMAL_BRANCH_WITH_TARGET_BLOCK CONDITIONAL_JUMP CONDITIONAL_JUMP_PAGE_CHANGE CONDITIONAL_JUMP_EXIT CONDITIONAL_JUMP_FALLTHRU CONDITIONAL_JUMP_FALLTHRU_WITH_TARGET_BLOCK CONDITIONAL_JUMP_BRANCH CONDITIONAL_JUMP_BRANCH_WITH_TARGET_BLOCK DISPATCHER_SMALL DISPATCHER_LARGE LOOP LOOP_SAFETY CONDITION_OPTIMISED CONDITION_UNOPTIMISED CONDITION_UNOPTIMISED_PF CONDITION_UNOPTIMISED_UNHANDLED_L CONDITION_UNOPTIMISED_UNHANDLED_LE FAILED_PAGE_CHANGE SAFE_READ_FAST SAFE_READ_SLOW_PAGE_CROSSED SAFE_READ_SLOW_NOT_VALID SAFE_READ_SLOW_NOT_USER SAFE_READ_SLOW_IN_MAPPED_RANGE SAFE_WRITE_FAST SAFE_WRITE_SLOW_PAGE_CROSSED SAFE_WRITE_SLOW_NOT_VALID SAFE_WRITE_SLOW_NOT_USER SAFE_WRITE_SLOW_IN_MAPPED_RANGE SAFE_WRITE_SLOW_READ_ONLY SAFE_WRITE_SLOW_HAS_CODE SAFE_READ_WRITE_FAST SAFE_READ_WRITE_SLOW_PAGE_CROSSED SAFE_READ_WRITE_SLOW_NOT_VALID SAFE_READ_WRITE_SLOW_NOT_USER SAFE_READ_WRITE_SLOW_IN_MAPPED_RANGE SAFE_READ_WRITE_SLOW_READ_ONLY SAFE_READ_WRITE_SLOW_HAS_CODE PAGE_FAULT TLB_MISS MAIN_LOOP MAIN_LOOP_IDLE DO_MANY_CYCLES CYCLE_INTERNAL INVALIDATE_ALL_MODULES_NO_FREE_WASM_INDICES INVALIDATE_MODULE_WRITTEN_WHILE_COMPILED INVALIDATE_MODULE_UNUSED_AFTER_OVERWRITE INVALIDATE_MODULE_DIRTY_PAGE INVALIDATE_PAGE_HAD_CODE INVALIDATE_PAGE_HAD_ENTRY_POINTS DIRTY_PAGE_DID_NOT_HAVE_CODE RUN_FROM_CACHE_EXIT_SAME_PAGE RUN_FROM_CACHE_EXIT_NEAR_END_OF_PAGE RUN_FROM_CACHE_EXIT_DIFFERENT_PAGE CLEAR_TLB FULL_CLEAR_TLB TLB_FULL TLB_GLOBAL_FULL MODRM_SIMPLE_REG MODRM_SIMPLE_REG_WITH_OFFSET MODRM_SIMPLE_CONST_OFFSET MODRM_COMPLEX SEG_OFFSET_OPTIMISED SEG_OFFSET_NOT_OPTIMISED SEG_OFFSET_NOT_OPTIMISED_ES SEG_OFFSET_NOT_OPTIMISED_FS SEG_OFFSET_NOT_OPTIMISED_GS SEG_OFFSET_NOT_OPTIMISED_NOT_FLAT".split(" "),s=0;let r={};for(let o=0;o<i.length;o++){let h=i[o];var n=void 0;if(h.includes("/")){s++;let[_,c]=h.split("/");n=r[_]/r[c]}else n=r[h]=t.wm.exports.profiler_stat_get(o-s),n=1e8<=n?Math.round(n/1e6)+"m":1e5<=n?Math.round(n/1e3)+"k":n;e+=h+"="+n+`
`}return e+=`
`,i=t.wm.exports.get_valid_tlb_entries_count(),s=t.wm.exports.get_valid_global_tlb_entries_count(),e=e+("TLB_ENTRIES="+i+" ("+s+" global, "+(i-s)+` non-global)
WASM_TABLE_FREE=`)+(t.wm.exports.jit_get_wasm_table_index_free_list_count()+`
`),e+="JIT_CACHE_SIZE="+t.wm.exports.jit_get_cache_size()+`
`,e+="FLAT_SEGMENTS="+t.wm.exports.has_flat_segmentation()+`
`,e+="wasm memory size: "+(t.wasm_memory.buffer.byteLength>>20)+`m
`,e=e+`Config:
JIT_DISABLED=`+(t.wm.exports.get_jit_config(0)+`
`),e+="MAX_PAGES="+t.wm.exports.get_jit_config(1)+`
`,e+="JIT_USE_LOOP_SAFETY="+!!t.wm.exports.get_jit_config(2)+`
`,e+="MAX_EXTRA_BASIC_BLOCKS="+t.wm.exports.get_jit_config(3)+`
`,t=[Pe(t,!1,!1,!1,!1),Pe(t,!0,!1,!1,!1),Pe(t,!1,!0,!1,!1),Pe(t,!1,!1,!0,!1),Pe(t,!1,!1,!1,!0)].join(`

`),e+t};function Us(t){this.message=t||"File already exists"}Us.prototype=Error.prototype;function ii(t){this.message=t||"File not found"}ii.prototype=Error.prototype;typeof Le<"u"&&typeof Le.exports<"u"?Le.exports.V86=N:typeof window<"u"?window.V86=N:typeof importScripts=="function"&&(self.V86=N);function Z(t,e){this.stopping=this.running=!1,this.idle=!0,this.tick_counter=0,this.worker=null,this.cpu=new M(t,e,()=>{this.idle&&this.next_tick(0)}),this.bus=t,this.register_yield()}Z.prototype.run=function(){this.stopping=!1,this.running||(this.running=!0,this.bus.send("emulator-started")),this.next_tick(0)};Z.prototype.do_tick=function(){if(this.stopping||!this.running)this.stopping=this.running=!1,this.bus.send("emulator-stopped");else{this.idle=!1;var t=this.cpu.main_loop();this.next_tick(t)}};Z.prototype.next_tick=function(t){let e=++this.tick_counter;this.idle=!0,this.yield(t,e)};Z.prototype.yield_callback=function(t){t===this.tick_counter&&this.do_tick()};Z.prototype.stop=function(){this.running&&(this.stopping=!0)};Z.prototype.destroy=function(){this.unregister_yield()};Z.prototype.restart=function(){this.cpu.reset_cpu(),this.cpu.load_bios()};Z.prototype.init=function(t){this.cpu.init(t,this.bus),this.bus.send("emulator-ready")};if(typeof process<"u")Z.prototype.yield=function(t,e){1>t?global.setImmediate(i=>this.yield_callback(i),e):setTimeout(i=>this.yield_callback(i),t,e)},Z.prototype.register_yield=function(){},Z.prototype.unregister_yield=function(){};else if(typeof Worker<"u"){let t=function(){let e;globalThis.onmessage=function(i){let s=i.data.t;e=e&&clearTimeout(e),1>s?postMessage(i.data.tick):e=setTimeout(()=>postMessage(i.data.tick),s)}};Z.prototype.register_yield=function(){let e=URL.createObjectURL(new Blob(["("+t.toString()+")()"],{type:"text/javascript"}));this.worker=new Worker(e),this.worker.onmessage=i=>this.yield_callback(i.data),URL.revokeObjectURL(e)},Z.prototype.yield=function(e,i){this.worker.postMessage({t:e,tick:i})},Z.prototype.unregister_yield=function(){this.worker&&this.worker.terminate(),this.worker=null}}else Z.prototype.yield=function(t){setTimeout(()=>{this.do_tick()},t)},Z.prototype.register_yield=function(){},Z.prototype.unregister_yield=function(){};Z.prototype.save_state=function(){for(var t=[],e=bi(this.cpu,t),i=[],s=0,r=0;r<t.length;r++){var n=t[r].byteLength;i[r]={offset:s,length:n},s+=n,s=s+3&-4}r=JSON.stringify({buffer_infos:i,state:e}),r=new TextEncoder().encode(r),e=16+r.length,e=e+3&-4,n=e+s,s=new ArrayBuffer(n);var o=new Int32Array(s,0,4);for(new Uint8Array(s,16,r.length).set(r),e=new Uint8Array(s,e),o[0]=-2039052682,o[1]=6,o[2]=n,o[3]=r.length,r=0;r<t.length;r++)e.set(t[r],i[r].offset);return s};Z.prototype.restore_state=function(t){return gr(this.cpu,t)};if(typeof performance=="object"&&performance.now)Z.microtick=performance.now.bind(performance);else if(typeof St=="function"){let{performance:t}=St("perf_hooks");Z.microtick=t.now.bind(t)}else Z.microtick=typeof process=="object"&&process.hrtime?function(){var t=process.hrtime();return 1e3*t[0]+t[1]/1e6}:Date.now;function At(t){this.cpu=t,this.timer_divider=this.apic_id=0,this.timer_divider_shift=1,this.timer_current_count=this.timer_initial_count=0,this.next_tick=Z.microtick(),this.lvt_error=this.lvt_int1=this.lvt_int0=this.lvt_perf_counter=this.lvt_thermal_sensor=this.lvt_timer=65536,this.icr1=this.icr0=this.tpr=0,this.irr=new Int32Array(8),this.isr=new Int32Array(8),this.tmr=new Int32Array(8),this.spurious_vector=254,this.destination_format=-1,this.read_error=this.error=this.local_destination=0,t.io.mmap_register(4276092928,1048576,e=>{a(e>>>0);var i=e&3;return this.read32(e&-4)>>8*i&255},(e,i)=>{a(e),a(i)},e=>this.read32(e),(e,i)=>this.write32(e,i))}At.prototype.read32=function(t){switch(t=t-4276092928|0,t){case 32:return this.apic_id;case 48:return 327700;case 128:return this.tpr;case 208:return this.local_destination;case 224:return this.destination_format;case 240:return this.spurious_vector;case 256:case 272:case 288:case 304:case 320:case 336:case 352:case 368:return t=t-256>>4,a(this.isr[t]>>>0,8),this.isr[t];case 384:case 400:case 416:case 432:case 448:case 464:case 480:case 496:return t=t-384>>4,a(this.tmr[t]>>>0,8),this.tmr[t];case 512:case 528:case 544:case 560:case 576:case 592:case 608:case 624:return t=t-512>>4,a(this.irr[t]>>>0,8),this.irr[t];case 640:return a(this.read_error>>>0,8),this.read_error;case 768:return this.icr0;case 784:return this.icr1;case 800:return this.lvt_timer;case 816:return this.lvt_thermal_sensor;case 832:return this.lvt_perf_counter;case 848:return this.lvt_int0;case 864:return this.lvt_int1;case 880:return this.lvt_error;case 992:return this.timer_divider;case 896:return this.timer_initial_count;case 912:return a(this.timer_current_count>>>0,8),this.timer_current_count;default:return a(t),0}};At.prototype.write32=function(t,e){switch(t=t-4276092928|0,t){case 32:a(e>>>8,8),this.apic_id=e;break;case 48:a(e>>>0,8);break;case 128:this.tpr=e&255,this.check_vector();break;case 176:e=this.highest_isr(),e!==-1&&(this.register_clear_bit(this.isr,e),this.register_get_bit(this.tmr,e)&&this.cpu.devices.ioapic.remote_eoi(e),this.check_vector());break;case 208:a(e>>>0,8),this.local_destination=e&4278190080;break;case 224:a(e>>>0,8),this.destination_format=e|16777215;break;case 240:a(e>>>0,8),this.spurious_vector=e;break;case 640:a(e>>>0,8),this.read_error=this.error,this.error=0;break;case 768:t=e&255;var i=e>>8&7,s=e>>11&1,r=e>>15&1,n=e>>18&3,o=this.icr1>>>24;a(e,8),a(t,2),this.icr0=e&-4097,n===0?this.route(t,i,r,o,s):n===1?this.deliver(t,0,r):n===2&&this.deliver(t,i,r);break;case 784:a(e>>>0,8),this.icr1=e;break;case 800:a(e>>>0,8),this.lvt_timer=e;break;case 816:a(e>>>0,8),this.lvt_thermal_sensor=e;break;case 832:a(e>>>0,8),this.lvt_perf_counter=e;break;case 848:a(e>>>0,8),this.lvt_int0=e;break;case 864:a(e>>>0,8),this.lvt_int1=e;break;case 880:a(e>>>0,8),this.lvt_error=e;break;case 992:a(e>>>0,8),this.timer_divider=e,e=e&3|(e&8)>>1,this.timer_divider_shift=e===7?0:e+1;break;case 896:a(e>>>0,8),this.timer_initial_count=e>>>0,this.timer_current_count=e>>>0,this.next_tick=Z.microtick(),this.timer_active=!0;break;case 912:a(e>>>0,8);break;default:a(t),a(e>>>0,8)}};At.prototype.timer=function(t){if(this.timer_current_count===0)return 100;let e=1e6/(1<<this.timer_divider_shift);return t=(t-this.next_tick)*e>>>0,this.next_tick+=t/e,this.timer_current_count-=t,0>=this.timer_current_count&&(t=this.lvt_timer&393216,t===131072?(this.timer_current_count%=this.timer_initial_count,0>=this.timer_current_count&&(this.timer_current_count+=this.timer_initial_count),!(this.lvt_timer&65536)&&this.deliver(this.lvt_timer&255,0,!1)):t===0&&(this.timer_current_count=0,!(this.lvt_timer&65536)&&this.deliver(this.lvt_timer&255,0,!1))),Math.max(0,this.timer_current_count/e)};At.prototype.route=function(t,e,i){this.deliver(t,e,i)};At.prototype.deliver=function(t,e,i){e!==5&&e!==4&&(this.register_get_bit(this.irr,t)?a(t,2):(this.register_set_bit(this.irr,t),i?this.register_set_bit(this.tmr,t):this.register_clear_bit(this.tmr,t),this.check_vector()))};At.prototype.highest_irr=function(){return this.register_get_highest_bit(this.irr)};At.prototype.highest_isr=function(){return this.register_get_highest_bit(this.isr)};At.prototype.check_vector=function(){var t=this.highest_irr();t!==-1&&(this.highest_isr()>=t||(t&240)<=(this.tpr&240)||this.cpu.handle_irqs())};At.prototype.acknowledge_irq=function(){var t=this.highest_irr();return t===-1||this.highest_isr()>=t||(t&240)<=(this.tpr&240)?-1:(this.register_clear_bit(this.irr,t),this.register_set_bit(this.isr,t),this.check_vector(),t)};At.prototype.get_state=function(){var t=[];return t[0]=this.apic_id,t[1]=this.timer_divider,t[2]=this.timer_divider_shift,t[3]=this.timer_initial_count,t[4]=this.timer_current_count,t[5]=this.next_tick,t[6]=this.lvt_timer,t[7]=this.lvt_perf_counter,t[8]=this.lvt_int0,t[9]=this.lvt_int1,t[10]=this.lvt_error,t[11]=this.tpr,t[12]=this.icr0,t[13]=this.icr1,t[14]=this.irr,t[15]=this.isr,t[16]=this.tmr,t[17]=this.spurious_vector,t[18]=this.destination_format,t[19]=this.local_destination,t[20]=this.error,t[21]=this.read_error,t[22]=this.lvt_thermal_sensor,t};At.prototype.set_state=function(t){this.apic_id=t[0],this.timer_divider=t[1],this.timer_divider_shift=t[2],this.timer_initial_count=t[3],this.timer_current_count=t[4],this.next_tick=t[5],this.lvt_timer=t[6],this.lvt_perf_counter=t[7],this.lvt_int0=t[8],this.lvt_int1=t[9],this.lvt_error=t[10],this.tpr=t[11],this.icr0=t[12],this.icr1=t[13],this.irr=t[14],this.isr=t[15],this.tmr=t[16],this.spurious_vector=t[17],this.destination_format=t[18],this.local_destination=t[19],this.error=t[20],this.read_error=t[21],this.lvt_thermal_sensor=t[22]||65536};At.prototype.register_get_bit=function(t,e){return t[e>>5]>>(e&31)&1};At.prototype.register_set_bit=function(t,e){t[e>>5]|=1<<(e&31)};At.prototype.register_clear_bit=function(t,e){t[e>>5]&=~(1<<(e&31))};At.prototype.register_get_highest_bit=function(t){for(var e=7;0<=e;e--){var i=t[e];if(i)return Ee(i>>>0)|e<<5}return-1};function ne(t){this.cpu=t,this.ioredtbl_config=new Int32Array(24),this.ioredtbl_destination=new Int32Array(24);for(var e=0;e<this.ioredtbl_config.length;e++)this.ioredtbl_config[e]=65536;this.irq_value=this.irr=this.ioapic_id=this.ioregsel=0,t.io.mmap_register(4273995776,131072,i=>(i=i-4273995776|0,16<=i&&20>i?(i-=16,a(this.ioregsel),this.read(this.ioregsel)>>8*i&255):(a(i>>>0),0)),i=>{a(i>>>0)},i=>(i=i-4273995776|0,i===0?this.ioregsel:i===16?this.read(this.ioregsel):(a(i>>>0),0)),(i,s)=>{i=i-4273995776|0,i===0?this.ioregsel=s:i===16?this.write(this.ioregsel,s):(a(i>>>0),a(s>>>0,8))})}ne.prototype.remote_eoi=function(t){for(var e=0;24>e;e++){var i=this.ioredtbl_config[e];(i&255)===t&&i&16384&&(a(e),this.ioredtbl_config[e]&=-16385,this.check_irq(e))}};ne.prototype.check_irq=function(t){var e=1<<t;if(this.irr&e){var i=this.ioredtbl_config[t];if(!(i&65536)){var s=i>>8&7,r=this.ioredtbl_destination[t]>>>24;if(!(i&32768))this.irr&=~e;else if(this.ioredtbl_config[t]|=16384,i&16384)return;s!==0&&s!==1||this.cpu.devices.apic.route(i&255,s,(i&32768)===32768,r,i>>11&1),this.ioredtbl_config[t]&=-4097}}};ne.prototype.set_irq=function(t){if(!(24<=t)){var e=1<<t;!(this.irq_value&e)&&(this.irq_value|=e,(this.ioredtbl_config[t]&98304)!==65536&&(this.irr|=e,this.check_irq(t)))}};ne.prototype.clear_irq=function(t){if(!(24<=t)){var e=1<<t;(this.irq_value&e)===e&&(this.irq_value&=~e,this.ioredtbl_config[t]&32768&&(this.irr&=~e))}};ne.prototype.read=function(t){if(t===0)return this.ioapic_id<<24;if(t===1)return 1507345;if(t===2)return this.ioapic_id<<24;if(16<=t&&64>t){var e=t-16>>1;return t=t&1?this.ioredtbl_destination[e]:this.ioredtbl_config[e],a(e),a(t,8),t}return a(t),0};ne.prototype.write=function(t,e){if(t===0)this.ioapic_id=e>>>24&15;else if(t!==1&&t!==2)if(16<=t&&64>t){var i=t-16>>1;t&1?(this.ioredtbl_destination[i]=e&4278190080,a(e>>>0,8),a(i),a(e>>>24,2)):(this.ioredtbl_config[i]=e&110591|this.ioredtbl_config[i]&-110592,t=e&255,a(e>>>0,8),a(i),a(t,2),this.check_irq(i))}else a(t),a(e>>>0,8)};ne.prototype.get_state=function(){var t=[];return t[0]=this.ioredtbl_config,t[1]=this.ioredtbl_destination,t[2]=this.ioregsel,t[3]=this.ioapic_id,t[4]=this.irr,t[5]=this.irq_value,t};ne.prototype.set_state=function(t){this.ioredtbl_config=t[0],this.ioredtbl_destination=t[1],this.ioregsel=t[2],this.ioapic_id=t[3],this.irr=t[4],this.irq_value=t[5]};function Ve(t){this.cpu=t;var e=t.io;t.devices.pci.register_device({pci_id:56,pci_space:[134,128,19,113,7,0,128,2,8,0,128,6,0,0,128,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,9,1,0,0],pci_bars:[],name:"acpi"}),this.timer_imprecision_offset=this.timer_last_value=0,this.status=1,this.pm1_enable=this.pm1_status=0,this.last_timer=this.get_timer(Z.microtick()),this.gpe=new Uint8Array(4),e.register_read(45056,this,void 0,function(){return this.pm1_status}),e.register_write(45056,this,void 0,function(i){a(i,4),this.pm1_status&=~i}),e.register_read(45058,this,void 0,function(){return this.pm1_enable}),e.register_write(45058,this,void 0,function(i){a(i),this.pm1_enable=i}),e.register_read(45060,this,void 0,function(){return this.status}),e.register_write(45060,this,void 0,function(i){a(i),this.status=i}),e.register_read(45064,this,void 0,void 0,function(){return this.get_timer(Z.microtick())&16777215}),e.register_read(45024,this,function(){return this.gpe[0]}),e.register_read(45025,this,function(){return this.gpe[1]}),e.register_read(45026,this,function(){return this.gpe[2]}),e.register_read(45027,this,function(){return this.gpe[3]}),e.register_write(45024,this,function(i){a(i),this.gpe[0]=i}),e.register_write(45025,this,function(i){a(i),this.gpe[1]=i}),e.register_write(45026,this,function(i){a(i),this.gpe[2]=i}),e.register_write(45027,this,function(i){a(i),this.gpe[3]=i})}Ve.prototype.timer=function(t){t=this.get_timer(t);var e=((t^this.last_timer)&8388608)!==0;return this.pm1_enable&1&&e?(this.pm1_status|=1,this.cpu.device_raise_irq(9)):this.cpu.device_lower_irq(9),this.last_timer=t,100};Ve.prototype.get_timer=function(t){return t=Math.round(3579.545*t),t===this.timer_last_value?3579.545>this.timer_imprecision_offset&&this.timer_imprecision_offset++:this.timer_last_value+this.timer_imprecision_offset<=t&&(this.timer_imprecision_offset=0,this.timer_last_value=t),this.timer_last_value+this.timer_imprecision_offset};Ve.prototype.get_state=function(){var t=[];return t[0]=this.status,t[1]=this.pm1_status,t[2]=this.pm1_enable,t[3]=this.gpe,t};Ve.prototype.set_state=function(t){this.status=t[0],this.pm1_status=t[1],this.pm1_enable=t[2],this.gpe=t[3]};function Mt(t,e,i){switch(this.bus=i,this.cpu=t,this.ints=4,this.line_control=this.baud_rate=0,this.lsr=96,this.ier=this.fifo_control=0,this.iir=1,this.irq=this.scratch_register=this.modem_status=this.modem_control=0,this.input=[],this.current_line="",e){case 1016:this.com=0,this.irq=4;break;case 760:this.com=1,this.irq=3;break;case 1e3:this.com=2,this.irq=4;break;case 744:this.irq=this.com=3;break;default:""+a(e),this.com=0,this.irq=4}this.bus.register("serial"+this.com+"-input",function(s){this.data_received(s)},this),this.bus.register("serial"+this.com+"-modem-status-input",function(s){this.set_modem_status(s)},this),this.bus.register("serial"+this.com+"-carrier-detect-input",function(s){this.set_modem_status(s?this.modem_status|136:this.modem_status&-137)},this),this.bus.register("serial"+this.com+"-ring-indicator-input",function(s){this.set_modem_status(s?this.modem_status|68:this.modem_status&-69)},this),this.bus.register("serial"+this.com+"-data-set-ready-input",function(s){this.set_modem_status(s?this.modem_status|34:this.modem_status&-35)},this),this.bus.register("serial"+this.com+"-clear-to-send-input",function(s){this.set_modem_status(s?this.modem_status|17:this.modem_status&-18)},this),t=t.io,t.register_write(e,this,function(s){this.write_data(s)},function(s){this.write_data(s&255),this.write_data(s>>8)}),t.register_write(e|1,this,function(s){this.line_control&128?(this.baud_rate=this.baud_rate&255|s<<8,a(this.baud_rate)):(!(this.ier&2)&&s&2&&this.ThrowInterrupt(2),this.ier=s&15,a(s),this.CheckInterrupt())}),t.register_read(e,this,function(){if(this.line_control&128)return this.baud_rate&255;let s=0;return this.input.length!==0&&(s=this.input.shift(),a(s)),this.input.length===0&&(this.lsr&=-2,this.ClearInterrupt(12),this.ClearInterrupt(4)),s}),t.register_read(e|1,this,function(){return this.line_control&128?this.baud_rate>>8:this.ier&15}),t.register_read(e|2,this,function(){var s=this.iir&15;return a(this.iir),this.iir===2&&this.ClearInterrupt(2),this.fifo_control&1&&(s|=192),s}),t.register_write(e|2,this,function(s){a(s),this.fifo_control=s}),t.register_read(e|3,this,function(){return a(this.line_control),this.line_control}),t.register_write(e|3,this,function(s){a(s),this.line_control=s}),t.register_read(e|4,this,function(){return this.modem_control}),t.register_write(e|4,this,function(s){a(s),this.modem_control=s}),t.register_read(e|5,this,function(){return a(this.lsr),this.lsr}),t.register_write(e|5,this,function(){}),t.register_read(e|6,this,function(){return a(this.modem_status),this.modem_status&=240}),t.register_write(e|6,this,function(s){a(s),this.set_modem_status(s)}),t.register_read(e|7,this,function(){return this.scratch_register}),t.register_write(e|7,this,function(s){this.scratch_register=s})}Mt.prototype.get_state=function(){var t=[];return t[0]=this.ints,t[1]=this.baud_rate,t[2]=this.line_control,t[3]=this.lsr,t[4]=this.fifo_control,t[5]=this.ier,t[6]=this.iir,t[7]=this.modem_control,t[8]=this.modem_status,t[9]=this.scratch_register,t[10]=this.irq,t};Mt.prototype.set_state=function(t){this.ints=t[0],this.baud_rate=t[1],this.line_control=t[2],this.lsr=t[3],this.fifo_control=t[4],this.ier=t[5],this.iir=t[6],this.modem_control=t[7],this.modem_status=t[8],this.scratch_register=t[9],this.irq=t[10]};Mt.prototype.CheckInterrupt=function(){this.ints&4096&&this.ier&1?(this.iir=12,this.cpu.device_raise_irq(this.irq)):this.ints&16&&this.ier&1?(this.iir=4,this.cpu.device_raise_irq(this.irq)):this.ints&4&&this.ier&2?(this.iir=2,this.cpu.device_raise_irq(this.irq)):this.ints&1&&this.ier&8?(this.iir=0,this.cpu.device_raise_irq(this.irq)):(this.iir=1,this.cpu.device_lower_irq(this.irq))};Mt.prototype.ThrowInterrupt=function(t){this.ints|=1<<t,this.CheckInterrupt()};Mt.prototype.ClearInterrupt=function(t){this.ints&=~(1<<t),this.CheckInterrupt()};Mt.prototype.data_received=function(t){a(t),this.input.push(t),this.lsr|=1,this.fifo_control&1?this.ThrowInterrupt(12):this.ThrowInterrupt(4)};Mt.prototype.write_data=function(t){this.line_control&128?this.baud_rate=this.baud_rate&-256|t:(a(t),this.ThrowInterrupt(2),this.bus.send("serial"+this.com+"-output-byte",t))};Mt.prototype.set_modem_status=function(t){a(t);let e=this.modem_status&15,i=(this.modem_status^t)>>4;this.modem_status=t,this.modem_status=this.modem_status|i|e};function Wt(t){this.pci_addr=new Uint8Array(4),this.pci_value=new Uint8Array(4),this.pci_response=new Uint8Array(4),this.pci_status=new Uint8Array(4),this.pci_addr32=new Int32Array(this.pci_addr.buffer),this.pci_value32=new Int32Array(this.pci_value.buffer),this.pci_response32=new Int32Array(this.pci_response.buffer),this.pci_status32=new Int32Array(this.pci_status.buffer),this.device_spaces=[],this.devices=[],this.cpu=t;for(var e=0;256>e;e++)this.device_spaces[e]=void 0,this.devices[e]=void 0;this.io=t.io,t.io.register_write(3324,this,function(i){this.pci_write8(this.pci_addr32[0],i)},function(i){this.pci_write16(this.pci_addr32[0],i)},function(i){this.pci_write32(this.pci_addr32[0],i)}),t.io.register_write(3325,this,function(i){this.pci_write8(this.pci_addr32[0]+1|0,i)}),t.io.register_write(3326,this,function(i){this.pci_write8(this.pci_addr32[0]+2|0,i)},function(i){this.pci_write16(this.pci_addr32[0]+2|0,i)}),t.io.register_write(3327,this,function(i){this.pci_write8(this.pci_addr32[0]+3|0,i)}),t.io.register_read_consecutive(3324,this,function(){return this.pci_response[0]},function(){return this.pci_response[1]},function(){return this.pci_response[2]},function(){return this.pci_response[3]}),t.io.register_read_consecutive(3320,this,function(){return this.pci_status[0]},function(){return this.pci_status[1]},function(){return this.pci_status[2]},function(){return this.pci_status[3]}),t.io.register_write_consecutive(3320,this,function(i){this.pci_addr[0]=i&252},function(i){(this.pci_addr[1]&6)===2&&(i&6)===6?t.reboot_internal():this.pci_addr[1]=i},function(i){this.pci_addr[2]=i},function(i){this.pci_addr[3]=i,this.pci_query()}),this.register_device({pci_id:0,pci_space:[134,128,55,18,0,0,0,0,2,0,0,6,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,16,0,0,0,0,0,0],pci_bars:[],name:"82441FX PMC"}),this.isa_bridge={pci_id:8,pci_space:[134,128,0,112,7,0,0,2,0,0,1,6,0,0,128,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],pci_bars:[],name:"82371SB PIIX3 ISA"},this.isa_bridge_space=this.register_device(this.isa_bridge),this.isa_bridge_space8=new Uint8Array(this.isa_bridge_space.buffer)}Wt.prototype.get_state=function(){for(var t=[],e=0;256>e;e++)t[e]=this.device_spaces[e];return t[256]=this.pci_addr,t[257]=this.pci_value,t[258]=this.pci_response,t[259]=this.pci_status,t};Wt.prototype.set_state=function(t){for(var e=0;256>e;e++){var i=this.devices[e],s=t[e];if(i&&s){for(var r=0;r<i.pci_bars.length;r++){var n=s[4+r];if(n&1){var o=i.pci_bars[r];this.set_io_bars(o,o.original_bar&65534,n&65534)}}this.device_spaces[e].set(s)}else s&&a(e,2)}this.pci_addr.set(t[256]),this.pci_value.set(t[257]),this.pci_response.set(t[258]),this.pci_status.set(t[259])};Wt.prototype.pci_query=function(){var t=this.pci_addr[2]<<8|this.pci_addr[1],e=this.pci_addr[0]&252,i=t>>3&31;a(t,4),a(i,2),a(e,2),t=this.device_spaces[t],t!==void 0?(this.pci_status32[0]=-2147483648,this.pci_response32[0]=e<t.byteLength?t[e>>2]:0,a(this.pci_addr32[0]>>>0,8),a(this.pci_response32[0]>>>0,8)):(this.pci_response32[0]=-1,this.pci_status32[0]=0)};Wt.prototype.pci_write8=function(t,e){var i=t>>8&65535;t&=255;var s=new Uint8Array(this.device_spaces[i].buffer);a(t),a(i>>3,2),a(t,4),a(e,2),s[t]=e};Wt.prototype.pci_write16=function(t,e){var i=t>>8&65535;t&=255;var s=new Uint16Array(this.device_spaces[i].buffer);16<=t&&44>t?a(t):(a(t),a(i>>3,2),a(t,4),a(e,4),s[t>>>1]=e)};Wt.prototype.pci_write32=function(t,e){var i=t>>8&65535;t&=255;var s=this.device_spaces[i],r=this.devices[i];if(s)if(16<=t&&40>t){if(r=r.pci_bars[t-16>>2],a(s[t>>2]),a(e>>>0),a(i>>3,2),r){i=t>>2;var n=s[i]&1;if((e|3|r.size-1)===-1?(e=~(r.size-1)|n,n===0&&(s[i]=e)):n===0&&(s[i]=r.original_bar),n===1){n=s[i]&65534;var o=e&65534;a(n>>>0,8),a(o>>>0,8),this.set_io_bars(r,n,o),s[i]=e|1}}else s[t>>2]=0;a(s[t>>2]>>>0)}else t===48?(a(i>>3,2),a(e>>>0,8),s[t>>2]=r.pci_rom_size?(e|2047)===-1?-r.pci_rom_size|0:r.pci_rom_address|0:0):t===4?(a(i>>3,2),a(t,4),a(e>>>0,8)):(a(i>>3,2),a(t,4),a(e>>>0,8),s[t>>>2]=e)};Wt.prototype.register_device=function(t){var e=t.pci_id;a(e);var i=new Int32Array(64);i.set(new Int32Array(new Uint8Array(t.pci_space).buffer)),this.device_spaces[e]=i,this.devices[e]=t,e=i.slice(4,10);for(var s=0;s<t.pci_bars.length;s++){var r=t.pci_bars[s];if(r){var n=e[s],o=n&1;if(a(n),r.original_bar=n,r.entries=[],o!==0)for(n&=-2,o=0;o<r.size;o++)r.entries[o]=this.io.ports[n+o]}}return i};Wt.prototype.set_io_bars=function(t,e,i){var s=t.size;a(e),a(i);for(var r=this.io.ports,n=0;n<s;n++){4096<=e+n&&(r[e+n]=this.io.create_empty_entry());var o=t.entries[n];4096<=i+n&&(r[i+n]=o)}};Wt.prototype.raise_irq=function(t){this.cpu.device_raise_irq(this.isa_bridge_space8[96+((this.device_spaces[t][15]>>8&255)-1+((t>>3)-1&255)&3)])};Wt.prototype.lower_irq=function(t){this.cpu.device_lower_irq(this.isa_bridge_space8[96+((this.device_spaces[t][15]>>8&255)+(t>>3&255)-2&3)])};function Es(t,e,i){t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&(t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],t[4]=i[4],t[5]=i[5]),t[6]===e[0]&&t[7]===e[1]&&t[8]===e[2]&&t[9]===e[3]&&t[10]===e[4]&&t[11]===e[5]&&(t[6]=i[0],t[7]=i[1],t[8]=i[2],t[9]=i[3],t[10]=i[4],t[11]=i[5]);var s=t[12]<<8|t[13];if(s===2048){if(t=t.subarray(14),t[0]>>4===4&&t[9]===17){t=t.subarray(20),s=t[0]<<8|t[1];var r=t[2]<<8|t[3];if(a(t[6]<<8|t[7],4),s===67||r===67)if(s=t.subarray(8),r=s[236]<<24|s[237]<<16|s[238]<<8|s[239],r!==1669485411)a(r,8);else for(s[28]===e[0]&&s[29]===e[1]&&s[30]===e[2]&&s[31]===e[3]&&s[32]===e[4]&&s[33]===e[5]&&(s[28]=i[0],s[29]=i[1],s[30]=i[2],s[31]=i[3],s[32]=i[4],s[33]=i[5],t[6]=t[7]=0),r=240;r<s.length;){let n=s[r++];if(n===255)break;let o=s[r++];n===61&&s[r+0]===1&&s[r+1]===e[0]&&s[r+2]===e[1]&&s[r+3]===e[2]&&s[r+4]===e[3]&&s[r+5]===e[4]&&s[r+6]===e[5]&&(s[r+1]=i[0],s[r+2]=i[1],s[r+3]=i[2],s[r+4]=i[3],s[r+5]=i[4],s[r+6]=i[5],t[6]=t[7]=0),r+=o}}}else s===2054&&(t=t.subarray(14),Ht(t.subarray(8,14)),Ht(t.subarray(18,24)),t[8]===e[0]&&t[9]===e[1]&&t[10]===e[2]&&t[11]===e[3]&&t[12]===e[4]&&t[13]===e[5]&&(t[8]=i[0],t[9]=i[1],t[10]=i[2],t[11]=i[3],t[12]=i[4],t[13]=i[5]))}function Ht(t){return[t[0].toString(16).padStart(2,"0"),t[1].toString(16).padStart(2,"0"),t[2].toString(16).padStart(2,"0"),t[3].toString(16).padStart(2,"0"),t[4].toString(16).padStart(2,"0"),t[5].toString(16).padStart(2,"0")].join(":")}function zt(t,e,i,s,r){for(this.cpu=t,this.pci=t.devices.pci,this.id=r||0,this.preserve_mac_from_state_image=i,this.mac_address_translation=s,this.bus=e,this.bus.register("net"+this.id+"-receive",function(n){this.receive(n)},this),this.port=768+256*this.id,this.name="ne2k",this.pci_space=[236,16,41,128,3,1,0,0,0,0,0,2,0,0,0,0,this.port&255|1,this.port>>8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,244,26,0,17,0,0,184,254,0,0,0,0,0,0,0,0,0,1,0,0],this.pci_id=(this.id===0?5:7+this.id)<<3,this.pci_bars=[{size:32}],this.imr=this.isr=0,this.cr=1,this.tpsr=this.tcnt=this.rcnt=this.dcfg=0,this.memory=new Uint8Array(32768),this.txcr=this.rxcr=0,this.tsr=1,this.mac=new Uint8Array([0,34,21,255*Math.random()|0,255*Math.random()|0,255*Math.random()|0]),this.bus.send("net"+this.id+"-mac",Ht(this.mac)),this.mar=Uint8Array.of(255,255,255,255,255,255,255,255),this.mac_address_in_state=null,e=0;6>e;e++)this.memory[e<<1]=this.memory[e<<1|1]=this.mac[e];this.memory[28]=this.memory[29]=87,this.memory[30]=this.memory[31]=87,""+Ht(this.mac),this.rsar=0,this.pstart=64,this.pstop=128,this.boundary=this.curpg=76,e=t.io,e.register_read(this.port|0,this,function(){return this.cr}),e.register_write(this.port|0,this,function(n){this.cr=n,a(n,2),a(this.txcr,2),this.cr&1||(n&24&&this.rcnt===0&&this.do_interrupt(64),n&4&&(n=this.tpsr<<8,n=this.memory.subarray(n,n+this.tcnt),this.mac_address_in_state&&(n=new Uint8Array(n),Es(n,this.mac_address_in_state,this.mac)),this.bus.send("net"+this.id+"-send",n),this.bus.send("eth-transmit-end",[n.length]),this.cr&=-5,this.do_interrupt(2),a(n.byteLength)))}),e.register_read(this.port|13,this,function(){return this.get_page()===1?this.mar[5]:0}),e.register_read(this.port|14,this,function(){return this.get_page()===1?this.mar[6]:0},function(){return this.get_page(),0}),e.register_read(this.port|15,this,function(){return this.get_page()===1?this.mar[7]:0}),e.register_read(this.port|31,this,function(){return this.get_page(),this.do_interrupt(128),0}),e.register_write(this.port|31,this,function(n){this.get_page(),a(n,2)}),e.register_read(this.port|1,this,function(){var n=this.get_page();return n===0?this.pstart:n===1?this.mac[0]:n===2?this.pstart:0}),e.register_write(this.port|1,this,function(n){var o=this.get_page();o===0?(a(n,2),this.pstart=n):o===1?(a(n),this.mac[0]=n):a(n)}),e.register_read(this.port|2,this,function(){var n=this.get_page();return n===0?this.pstop:n===1?this.mac[1]:n===2?this.pstop:0}),e.register_write(this.port|2,this,function(n){var o=this.get_page();o===0?(a(n,2),n>this.memory.length>>8&&(n=this.memory.length>>8,a(n)),this.pstop=n):o===1?(a(n),this.mac[1]=n):a(n)}),e.register_read(this.port|7,this,function(){var n=this.get_page();return n===0?(a(this.isr,2),this.isr):n===1?(a(this.curpg,2),this.curpg):0}),e.register_write(this.port|7,this,function(n){var o=this.get_page();o===0?(a(n,2),this.isr&=~n,this.update_irq()):o===1&&(a(n,2),this.curpg=n)}),e.register_write(this.port|13,this,function(n){this.get_page()===0&&(this.txcr=n),a(n,2)}),e.register_write(this.port|14,this,function(n){this.get_page()===0?(a(n,2),this.dcfg=n):a(n,2)}),e.register_read(this.port|10,this,function(){var n=this.get_page();return n===0?80:n===1?this.mar[2]:0}),e.register_write(this.port|10,this,function(n){this.get_page()===0?(a(n,2),this.rcnt=this.rcnt&65280|n&255):a(n,2)}),e.register_read(this.port|11,this,function(){var n=this.get_page();return n===0?67:n===1?this.mar[3]:0}),e.register_write(this.port|11,this,function(n){this.get_page()===0?(a(n,2),this.rcnt=this.rcnt&255|n<<8&65280):a(n,2)}),e.register_read(this.port|8,this,function(){var n=this.get_page();return n===0?this.rsar&255:n===1?this.mar[0]:0}),e.register_write(this.port|8,this,function(n){this.get_page()===0?(a(n,2),this.rsar=this.rsar&65280|n&255):a(n,2)}),e.register_read(this.port|9,this,function(){var n=this.get_page();return n===0?this.rsar>>8&255:n===1?this.mar[1]:0}),e.register_write(this.port|9,this,function(n){this.get_page()===0?(a(n,2),this.rsar=this.rsar&255|n<<8&65280):a(n,2)}),e.register_write(this.port|15,this,function(n){this.get_page()===0?(a(n,2),a(this.isr,2),this.imr=n,this.update_irq()):a(n,2)}),e.register_read(this.port|3,this,function(){var n=this.get_page();return n===0?(a(this.boundary,2),this.boundary):n===1?this.mac[2]:0}),e.register_write(this.port|3,this,function(n){var o=this.get_page();o===0?(a(n,2),this.boundary=n):o===1?(a(n),this.mac[2]=n):a(n)}),e.register_read(this.port|4,this,function(){var n=this.get_page();return n===0?this.tsr:n===1?this.mac[3]:0}),e.register_write(this.port|4,this,function(n){var o=this.get_page();o===0?(a(n,2),this.tpsr=n):o===1?(a(n),this.mac[3]=n):a(n)}),e.register_read(this.port|5,this,function(){var n=this.get_page();return n===0?0:n===1?this.mac[4]:0}),e.register_write(this.port|5,this,function(n){var o=this.get_page();o===0?(a(n,2),this.tcnt=this.tcnt&-256|n):o===1?(a(n),this.mac[4]=n):a(n)}),e.register_read(this.port|6,this,function(){var n=this.get_page();return n===0?0:n===1?this.mac[5]:0}),e.register_write(this.port|6,this,function(n){var o=this.get_page();o===0?(a(n,2),this.tcnt=this.tcnt&255|n<<8):o===1?(a(n),this.mac[5]=n):a(n)}),e.register_read(this.port|12,this,function(){var n=this.get_page();return n===0?9:n===1?this.mar[4]:0}),e.register_write(this.port|12,this,function(n){this.get_page()===0?(a(n,2),this.rxcr=n):a(n)}),e.register_read(this.port|16,this,this.data_port_read8,this.data_port_read16,this.data_port_read32),e.register_write(this.port|16,this,this.data_port_write16,this.data_port_write16,this.data_port_write32),t.devices.pci.register_device(this)}zt.prototype.get_state=function(){var t=[];return t[0]=this.isr,t[1]=this.imr,t[2]=this.cr,t[3]=this.dcfg,t[4]=this.rcnt,t[5]=this.tcnt,t[6]=this.tpsr,t[7]=this.rsar,t[8]=this.pstart,t[9]=this.curpg,t[10]=this.boundary,t[11]=this.pstop,t[12]=this.rxcr,t[13]=this.txcr,t[14]=this.tsr,t[15]=this.mac,t[16]=this.memory,t};zt.prototype.set_state=function(t){this.isr=t[0],this.imr=t[1],this.cr=t[2],this.dcfg=t[3],this.rcnt=t[4],this.tcnt=t[5],this.tpsr=t[6],this.rsar=t[7],this.pstart=t[8],this.curpg=t[9],this.boundary=t[10],this.pstop=t[11],this.rxcr=t[12],this.txcr=t[13],this.tsr=t[14],this.preserve_mac_from_state_image?(this.mac=t[15],this.memory=t[16]):this.mac_address_translation&&(this.mac_address_in_state=t[15],this.memory=t[16],Ht(this.mac_address_in_state),Ht(this.mac)),this.bus.send("net"+this.id+"-mac",Ht(this.mac))};zt.prototype.do_interrupt=function(t){a(t,2),this.isr|=t,this.update_irq()};zt.prototype.update_irq=function(){this.imr&this.isr?this.pci.raise_irq(this.pci_id):this.pci.lower_irq(this.pci_id)};zt.prototype.data_port_write=function(t){(16>=this.rsar||16384<=this.rsar&&32768>this.rsar)&&(this.memory[this.rsar]=t),this.rsar++,this.rcnt--,this.rsar>=this.pstop<<8&&(this.rsar+=this.pstart-this.pstop<<8),this.rcnt===0&&this.do_interrupt(64)};zt.prototype.data_port_write16=function(t){this.data_port_write(t),this.dcfg&1&&this.data_port_write(t>>8)};zt.prototype.data_port_write32=function(t){this.data_port_write(t),this.data_port_write(t>>8),this.data_port_write(t>>16),this.data_port_write(t>>24)};zt.prototype.data_port_read=function(){let t=0;return 32768>this.rsar&&(t=this.memory[this.rsar]),this.rsar++,this.rcnt--,this.rsar>=this.pstop<<8&&(this.rsar+=this.pstart-this.pstop<<8),this.rcnt===0&&this.do_interrupt(64),t};zt.prototype.data_port_read8=function(){return this.data_port_read16()&255};zt.prototype.data_port_read16=function(){return this.dcfg&1?this.data_port_read()|this.data_port_read()<<8:this.data_port_read()};zt.prototype.data_port_read32=function(){return this.data_port_read()|this.data_port_read()<<8|this.data_port_read()<<16|this.data_port_read()<<24};zt.prototype.receive=function(t){if(!(this.cr&1)&&(this.bus.send("eth-receive-end",[t.length]),this.rxcr&16||this.rxcr&4&&t[0]===255&&t[1]===255&&t[2]===255&&t[3]===255&&t[4]===255&&t[5]===255||!(this.rxcr&8&&(t[0]&1)===1||t[0]!==this.mac[0]||t[1]!==this.mac[1]||t[2]!==this.mac[2]||t[3]!==this.mac[3]||t[4]!==this.mac[4]||t[5]!==this.mac[5]))){this.mac_address_in_state&&(t=new Uint8Array(t),Es(t,this.mac,this.mac_address_in_state));var e=this.curpg<<8,i=Math.max(60,t.length)+4,s=e+4,r=this.curpg+1+(i>>8),n=e+i,o=1+(i>>8),h=this.boundary>this.curpg?this.boundary-this.curpg:this.pstop-this.curpg+this.boundary-this.pstart;h<o&&this.boundary!==0?(a(this.pstart),a(this.pstop),a(this.curpg),a(o),a(this.boundary),a(h)):(n>this.pstop<<8?(n=(this.pstop<<8)-s,this.memory.set(t.subarray(0,n),s),this.memory.set(t.subarray(n),this.pstart<<8),a(n)):(this.memory.set(t,s),60>t.length&&this.memory.fill(0,s+t.length,s+60)),r>=this.pstop&&(r+=this.pstart-this.pstop),this.memory[e]=1,this.memory[e+1]=r,this.memory[e+2]=i,this.memory[e+3]=i>>8,this.curpg=r,a(e),a(i),a(r),this.do_interrupt(1))}};zt.prototype.get_page=function(){return this.cr>>6&3};function oe(t,e){this.bus=e,this.rows=25,this.cols=80,this.ports=4,e=[{size_supported:16,notify_offset:0},{size_supported:16,notify_offset:1},{size_supported:16,notify_offset:2},{size_supported:16,notify_offset:3}];for(let i=1;i<this.ports;++i)e.push({size_supported:16,notify_offset:0}),e.push({size_supported:8,notify_offset:1});this.virtio=new vt(t,{name:"virtio-console",pci_id:96,device_id:4163,subsystem_device_id:3,common:{initial_port:47104,queues:e,features:[0,1,32],on_driver_ok:()=>{}},notification:{initial_port:47360,single_handler:!1,handlers:[()=>{},i=>{let s=this.virtio.queues[i],r=3<i?i-3>>1:0;for(;s.has_request();){let n=s.pop_request(),o=new Uint8Array(n.length_readable);n.get_next_blob(o),this.bus.send("virtio-console"+r+"-output-bytes",o),this.Ack(i,n)}},i=>{if(i===2)for(i=this.virtio.queues[i];i.count_requests()>i.size-2;)i.pop_request()},i=>{if(i===3)for(var s=this.virtio.queues[i];s.has_request();){var r=s.pop_request(),n=new Uint8Array(r.length_readable);r.get_next_blob(n);var o=K(["w","h","h"],n,{offset:0});switch(n=o[0],o=o[1],this.Ack(i,r),o){case 0:for(r=0;r<this.ports;++r)this.SendEvent(r,1,0);break;case 3:this.Ack(i,r),this.SendEvent(n,4,1),this.SendName(n,"virtio-"+n),this.SendEvent(n,6,1);break;case 6:this.Ack(i,r),n===0&&this.SendWindowSize(n);break;default:return}}}]},isr_status:{initial_port:46848},device_specific:{initial_port:46592,struct:[{bytes:2,name:"cols",read:()=>this.cols,write:()=>{}},{bytes:2,name:"rows",read:()=>this.rows,write:()=>{}},{bytes:4,name:"max_nr_ports",read:()=>this.ports,write:()=>{}},{bytes:4,name:"emerg_wr",read:()=>0,write:()=>{}}]}});for(let i=0;i<this.ports;++i){let s=i===0?0:2*i+2;this.bus.register("virtio-console"+i+"-input-bytes",function(r){var n=this.virtio.queues[s];n.has_request()&&(n=n.pop_request(),this.Send(s,n,new Uint8Array(r)))},this),this.bus.register("virtio-console"+i+"-resize",function(r){i===0&&(this.cols=r[0],this.rows=r[1]),this.virtio.queues[2].is_configured()&&this.virtio.queues[2].has_request()&&this.SendWindowSize(i,r[0],r[1])},this)}}oe.prototype.SendWindowSize=function(t,e,i){i=i||this.rows,e=e||this.cols;let s=this.virtio.queues[2].pop_request(),r=new Uint8Array(12);st(["w","h","h","h","h"],[t,5,0,i,e],r,0),this.Send(2,s,r)};oe.prototype.SendName=function(t,e){let i=this.virtio.queues[2].pop_request();e=new TextEncoder().encode(e);let s=new Uint8Array(8+e.length+1);for(st(["w","h","h"],[t,7,1],s,0),t=0;t<e.length;++t)s[t+8]=e[t];s[8+e.length]=0,this.Send(2,i,s)};oe.prototype.get_state=function(){let t=[];return t[0]=this.virtio,t[1]=this.rows,t[2]=this.cols,t[3]=this.ports,t};oe.prototype.set_state=function(t){this.virtio.set_state(t[0]),this.rows=t[1],this.cols=t[2],this.ports=t[3]};oe.prototype.reset=function(){this.virtio.reset()};oe.prototype.SendEvent=function(t,e,i){let s=this.virtio.queues[2].pop_request(),r=new Uint8Array(8);st(["w","h","h"],[t,e,i],r,0),this.Send(2,s,r)};oe.prototype.Send=function(t,e,i){e.set_next_blob(i),this.virtio.queues[t].push_reply(e),this.virtio.queues[t].flush_replies()};oe.prototype.Ack=function(t,e){e.set_next_blob(new Uint8Array(0)),this.virtio.queues[t].push_reply(e),this.virtio.queues[t].flush_replies()};function Ut(t,e){this.cpu=t,this.bus=e,this.reset(),this.bus.register("keyboard-code",function(i){this.kbd_send_code(i)},this),this.bus.register("mouse-click",function(i){this.mouse_send_click(i[0],i[1],i[2])},this),this.bus.register("mouse-delta",function(i){this.mouse_send_delta(i[0],i[1])},this),this.bus.register("mouse-wheel",function(i){this.wheel_movement-=i[0],this.wheel_movement-=2*i[1],this.wheel_movement=Math.min(7,Math.max(-8,this.wheel_movement)),this.send_mouse_packet(0,0)},this),t.io.register_read(96,this,this.port60_read),t.io.register_read(100,this,this.port64_read),t.io.register_write(96,this,this.port60_write),t.io.register_write(100,this,this.port64_write)}Ut.prototype.reset=function(){this.use_mouse=this.enable_mouse_stream=!1,this.have_mouse=!0,this.mouse_clicks=this.mouse_delta_y=this.mouse_delta_x=0,this.have_keyboard=!0,this.next_read_resolution=this.next_read_rate=this.next_handle_scan_code_set=this.next_read_led=this.next_read_sample=this.next_is_mouse_command=this.enable_keyboard_stream=!1,this.kbd_buffer=new Fe(1024),this.last_port60_byte=0,this.sample_rate=100,this.mouse_id=this.mouse_detect_state=0,this.mouse_reset_workaround=!1,this.wheel_movement=0,this.resolution=4,this.scaling2=!1,this.last_mouse_packet=-1,this.mouse_buffer=new Fe(1024),this.next_byte_is_aux=this.next_byte_is_ready=!1,this.command_register=5,this.controller_output_port=0,this.read_controller_output_port=this.read_command_register=this.read_output_register=!1};Ut.prototype.get_state=function(){var t=[];return t[0]=this.enable_mouse_stream,t[1]=this.use_mouse,t[2]=this.have_mouse,t[3]=this.mouse_delta_x,t[4]=this.mouse_delta_y,t[5]=this.mouse_clicks,t[6]=this.have_keyboard,t[7]=this.enable_keyboard_stream,t[8]=this.next_is_mouse_command,t[9]=this.next_read_sample,t[10]=this.next_read_led,t[11]=this.next_handle_scan_code_set,t[12]=this.next_read_rate,t[13]=this.next_read_resolution,t[15]=this.last_port60_byte,t[16]=this.sample_rate,t[17]=this.resolution,t[18]=this.scaling2,t[20]=this.command_register,t[21]=this.read_output_register,t[22]=this.read_command_register,t[23]=this.controller_output_port,t[24]=this.read_controller_output_port,t[25]=this.mouse_id,t[26]=this.mouse_detect_state,t[27]=this.mouse_reset_workaround,t};Ut.prototype.set_state=function(t){this.enable_mouse_stream=t[0],this.use_mouse=t[1],this.have_mouse=t[2],this.mouse_delta_x=t[3],this.mouse_delta_y=t[4],this.mouse_clicks=t[5],this.have_keyboard=t[6],this.enable_keyboard_stream=t[7],this.next_is_mouse_command=t[8],this.next_read_sample=t[9],this.next_read_led=t[10],this.next_handle_scan_code_set=t[11],this.next_read_rate=t[12],this.next_read_resolution=t[13],this.last_port60_byte=t[15],this.sample_rate=t[16],this.resolution=t[17],this.scaling2=t[18],this.command_register=t[20],this.read_output_register=t[21],this.read_command_register=t[22],this.controller_output_port=t[23],this.read_controller_output_port=t[24],this.mouse_id=t[25]||0,this.mouse_detect_state=t[26]||0,this.mouse_reset_workaround=t[27]||!1,this.next_byte_is_aux=this.next_byte_is_ready=!1,this.kbd_buffer.clear(),this.mouse_buffer.clear(),this.bus.send("mouse-enable",this.use_mouse)};Ut.prototype.raise_irq=function(){this.next_byte_is_ready||(this.kbd_buffer.length?this.kbd_irq():this.mouse_buffer.length&&this.mouse_irq())};Ut.prototype.mouse_irq=function(){this.next_byte_is_aux=this.next_byte_is_ready=!0,this.command_register&2&&(this.cpu.device_lower_irq(12),this.cpu.device_raise_irq(12))};Ut.prototype.kbd_irq=function(){this.next_byte_is_ready=!0,this.next_byte_is_aux=!1,this.command_register&1&&(this.cpu.device_lower_irq(1),this.cpu.device_raise_irq(1))};Ut.prototype.kbd_send_code=function(t){this.enable_keyboard_stream&&(a(t),this.kbd_buffer.push(t),this.raise_irq())};Ut.prototype.mouse_send_delta=function(t,e){this.have_mouse&&this.use_mouse&&(this.mouse_delta_x+=1*t,this.mouse_delta_y+=1*e,this.enable_mouse_stream&&(t=this.mouse_delta_x|0,e=this.mouse_delta_y|0,t||e))&&(this.mouse_delta_x-=t,this.mouse_delta_y-=e,this.send_mouse_packet(t,e))};Ut.prototype.mouse_send_click=function(t,e,i){this.have_mouse&&this.use_mouse&&(this.mouse_clicks=t|i<<1|e<<2,this.enable_mouse_stream&&this.send_mouse_packet(0,0))};Ut.prototype.send_mouse_packet=function(t,e){var i=(0>e)<<5|(0>t)<<4|8|this.mouse_clicks;this.last_mouse_packet=Date.now(),this.mouse_buffer.push(i),this.mouse_buffer.push(t),this.mouse_buffer.push(e),this.mouse_id===4?(this.mouse_buffer.push(0|this.wheel_movement&15),this.wheel_movement=0):this.mouse_id===3&&(this.mouse_buffer.push(this.wheel_movement&255),this.wheel_movement=0),this.raise_irq()};Ut.prototype.apply_scaling2=function(t){var e=t>>31;switch(Math.abs(t)){case 0:case 1:case 3:return t;case 2:return e;case 4:return 6*e;case 5:return 9*e;default:return t<<1}};Ut.prototype.port60_read=function(){return this.next_byte_is_ready=!1,!this.kbd_buffer.length&&!this.mouse_buffer.length?this.last_port60_byte:(this.next_byte_is_aux?(this.cpu.device_lower_irq(12),this.last_port60_byte=this.mouse_buffer.shift()):(this.cpu.device_lower_irq(1),this.last_port60_byte=this.kbd_buffer.shift()),a(this.last_port60_byte),(this.kbd_buffer.length||this.mouse_buffer.length)&&this.raise_irq(),this.last_port60_byte)};Ut.prototype.port64_read=function(){var t=16;return this.next_byte_is_ready&&(t|=1),this.next_byte_is_aux&&(t|=32),a(t),t};Ut.prototype.port60_write=function(t){if(a(t),this.read_command_register)this.command_register=t,this.read_command_register=!1,a(this.command_register);else if(this.read_output_register)this.read_output_register=!1,this.mouse_buffer.clear(),this.mouse_buffer.push(t),this.mouse_irq();else if(this.next_read_sample){switch(this.next_read_sample=!1,this.mouse_buffer.clear(),this.mouse_buffer.push(250),this.sample_rate=t,this.mouse_detect_state){case-1:t===60?(this.mouse_reset_workaround=!0,this.mouse_detect_state=0):(this.mouse_reset_workaround=!1,this.mouse_detect_state=t===200?1:0);break;case 0:t===200&&(this.mouse_detect_state=1);break;case 1:this.mouse_detect_state=t===100?2:t===200?3:0;break;case 2:t===80&&(this.mouse_id=3),this.mouse_detect_state=-1;break;case 3:t===80&&(this.mouse_id=4),this.mouse_detect_state=-1}a(t),a(this.mouse_id),this.sample_rate||(this.sample_rate=100),this.mouse_irq()}else if(this.next_read_resolution)this.next_read_resolution=!1,this.mouse_buffer.clear(),this.mouse_buffer.push(250),this.resolution=3<t?4:1<<t,this.mouse_irq();else if(this.next_read_led)this.next_read_led=!1,this.kbd_buffer.push(250),this.kbd_irq();else if(this.next_handle_scan_code_set)this.next_handle_scan_code_set=!1,this.kbd_buffer.push(250),this.kbd_irq(),t||this.kbd_buffer.push(1);else if(this.next_read_rate)this.next_read_rate=!1,this.kbd_buffer.push(250),this.kbd_irq();else if(this.next_is_mouse_command){if(this.next_is_mouse_command=!1,a(t),this.have_mouse){switch(this.kbd_buffer.clear(),this.mouse_buffer.clear(),this.mouse_buffer.push(250),t){case 230:this.scaling2=!1;break;case 231:this.scaling2=!0;break;case 232:this.next_read_resolution=!0;break;case 233:this.send_mouse_packet(0,0);break;case 235:this.send_mouse_packet(0,0);break;case 242:a(this.mouse_id),this.mouse_buffer.push(this.mouse_id),this.mouse_clicks=this.mouse_delta_x=this.mouse_delta_y=0,this.raise_irq();break;case 243:this.next_read_sample=!0;break;case 244:this.use_mouse=this.enable_mouse_stream=!0,this.bus.send("mouse-enable",!0),this.mouse_clicks=this.mouse_delta_x=this.mouse_delta_y=0;break;case 245:this.enable_mouse_stream=!1;break;case 246:this.enable_mouse_stream=!1,this.sample_rate=100,this.scaling2=!1,this.resolution=4;break;case 255:this.mouse_buffer.push(170),this.mouse_buffer.push(0),this.use_mouse=!0,this.bus.send("mouse-enable",!0),this.enable_mouse_stream=!1,this.sample_rate=100,this.scaling2=!1,this.resolution=4,this.mouse_reset_workaround||(this.mouse_id=0),this.mouse_clicks=this.mouse_delta_x=this.mouse_delta_y=0;break;default:a(t)}this.mouse_irq()}}else if(this.read_controller_output_port)this.read_controller_output_port=!1,this.controller_output_port=t;else{switch(a(t),this.mouse_buffer.clear(),this.kbd_buffer.clear(),this.kbd_buffer.push(250),t){case 237:this.next_read_led=!0;break;case 240:this.next_handle_scan_code_set=!0;break;case 242:this.kbd_buffer.push(171),this.kbd_buffer.push(131);break;case 243:this.next_read_rate=!0;break;case 244:this.enable_keyboard_stream=!0;break;case 245:this.enable_keyboard_stream=!1;break;case 246:break;case 255:this.kbd_buffer.clear(),this.kbd_buffer.push(250),this.kbd_buffer.push(170),this.kbd_buffer.push(0);break;default:a(t)}this.kbd_irq()}};Ut.prototype.port64_write=function(t){switch(a(t),t){case 32:this.kbd_buffer.clear(),this.mouse_buffer.clear(),this.kbd_buffer.push(this.command_register),this.kbd_irq();break;case 96:this.read_command_register=!0;break;case 209:this.read_controller_output_port=!0;break;case 211:this.read_output_register=!0;break;case 212:this.next_is_mouse_command=!0;break;case 167:this.command_register|=32;break;case 168:this.command_register&=-33;break;case 169:this.kbd_buffer.clear(),this.mouse_buffer.clear(),this.kbd_buffer.push(0),this.kbd_irq();break;case 170:this.kbd_buffer.clear(),this.mouse_buffer.clear(),this.kbd_buffer.push(85),this.kbd_irq();break;case 171:this.kbd_buffer.clear(),this.mouse_buffer.clear(),this.kbd_buffer.push(0),this.kbd_irq();break;case 173:this.command_register|=16;break;case 174:this.command_register&=-17;break;case 254:this.cpu.reboot_internal();break;default:a(t)}};var Se=DataView.prototype,Me={size:1,get:Se.getUint8,set:Se.setUint8},_e={size:2,get:Se.getUint16,set:Se.setUint16},rt={size:4,get:Se.getUint32,set:Se.setUint32},Is=Oi([{magic:rt},{class:Me},{data:Me},{version0:Me},{osabi:Me},{abiversion:Me},{pad0:function(t){return{size:t,get:()=>-1}}(7)},{type:_e},{machine:_e},{version1:rt},{entry:rt},{phoff:rt},{shoff:rt},{flags:rt},{ehsize:_e},{phentsize:_e},{phnum:_e},{shentsize:_e},{shnum:_e},{shstrndx:_e}]);console.assert(Is.reduce((t,e)=>t+e.size,0)===52);var Ss=Oi([{type:rt},{offset:rt},{vaddr:rt},{paddr:rt},{filesz:rt},{memsz:rt},{flags:rt},{align:rt}]);console.assert(Ss.reduce((t,e)=>t+e.size,0)===32);var qs=Oi([{name:rt},{type:rt},{flags:rt},{addr:rt},{offset:rt},{size:rt},{link:rt},{info:rt},{addralign:rt},{entsize:rt}]);console.assert(qs.reduce((t,e)=>t+e.size,0)===40);function Oi(t){return t.map(function(e){var i=Object.keys(e);return console.assert(i.length===1),i=i[0],e=e[i],console.assert(0<e.size),{name:i,type:e,size:e.size,get:e.get,set:e.set}})}function Os(t,e){let i={},s=0;for(let r of e)e=r.get.call(t,s,!0),console.assert(i[r.name]===void 0),i[r.name]=e,s+=r.size;return[i,s]}function ds(t,e,i){let s=[],r=0;for(var n=0;n<i;n++){let[o,h]=Os(new DataView(t.buffer,t.byteOffset+r,void 0),e);s.push(o),r+=h}return[s,r]}function ht(t,e){this.io=t.io,this.cpu=t,this.dma=t.devices.dma,this.bytes_expecting=0,this.receiving_command=new Uint8Array(10),this.receiving_index=0,this.next_command=null,this.response_data=new Uint8Array(10),this.last_head=this.last_cylinder=this.drive=this.status_reg2=this.status_reg1=this.status_reg0=this.response_length=this.response_index=0,this.last_sector=1,this.dir=this.dor=0,this.fdb_image=this.fda_image=null,e?this.set_fda(e):(this.eject_fda(),this.cpu.devices.rtc.cmos_write(16,64)),this.io.register_read(1008,this,this.port3F0_read),this.io.register_read(1010,this,this.port3F2_read),this.io.register_read(1012,this,this.port3F4_read),this.io.register_read(1013,this,this.port3F5_read),this.io.register_read(1015,this,this.port3F7_read),this.io.register_write(1010,this,this.port3F2_write),this.io.register_write(1012,this,this.port3F4_write),this.io.register_write(1013,this,this.port3F5_write)}ht.prototype.eject_fda=function(){this.fda_image=null,this.number_of_cylinders=this.number_of_heads=this.sectors_per_track=0,this.dir=128};ht.prototype.set_fda=function(t){var e={163840:{type:1,tracks:40,sectors:8,heads:1},184320:{type:1,tracks:40,sectors:9,heads:1},204800:{type:1,tracks:40,sectors:10,heads:1},327680:{type:1,tracks:40,sectors:8,heads:2},368640:{type:1,tracks:40,sectors:9,heads:2},409600:{type:1,tracks:40,sectors:10,heads:2},737280:{type:3,tracks:80,sectors:9,heads:2},1228800:{type:2,tracks:80,sectors:15,heads:2},1474560:{type:4,tracks:80,sectors:18,heads:2},1763328:{type:5,tracks:82,sectors:21,heads:2},2949120:{type:5,tracks:80,sectors:36,heads:2},512:{type:1,tracks:1,sectors:1,heads:1}};let i=t.byteLength,s=e[i];s||(i=1474560<t.byteLength?2949120:1474560,s=e[i],e=new Uint8Array(i),e.set(new Uint8Array(t.buffer)),t=new lt(e.buffer)),this.sectors_per_track=s.sectors,this.number_of_heads=s.heads,this.number_of_cylinders=s.tracks,this.fda_image=t,this.dir=128,this.cpu.devices.rtc.cmos_write(16,s.type<<4)};ht.prototype.get_state=function(){var t=[];return t[0]=this.bytes_expecting,t[1]=this.receiving_command,t[2]=this.receiving_index,t[4]=this.response_data,t[5]=this.response_index,t[6]=this.response_length,t[8]=this.status_reg0,t[9]=this.status_reg1,t[10]=this.status_reg2,t[11]=this.drive,t[12]=this.last_cylinder,t[13]=this.last_head,t[14]=this.last_sector,t[15]=this.dor,t[16]=this.sectors_per_track,t[17]=this.number_of_heads,t[18]=this.number_of_cylinders,t};ht.prototype.set_state=function(t){this.bytes_expecting=t[0],this.receiving_command=t[1],this.receiving_index=t[2],this.next_command=t[3],this.response_data=t[4],this.response_index=t[5],this.response_length=t[6],this.status_reg0=t[8],this.status_reg1=t[9],this.status_reg2=t[10],this.drive=t[11],this.last_cylinder=t[12],this.last_head=t[13],this.last_sector=t[14],this.dor=t[15],this.sectors_per_track=t[16],this.number_of_heads=t[17],this.number_of_cylinders=t[18]};ht.prototype.port3F0_read=function(){return 0};ht.prototype.port3F4_read=function(){var t=128;return this.response_index<this.response_length&&(t|=80),!(this.dor&8)&&(t|=32),t};ht.prototype.port3F7_read=function(){return this.dir};ht.prototype.port3F5_read=function(){return this.response_index<this.response_length?(this.cpu.device_lower_irq(6),this.response_data[this.response_index++]):255};ht.prototype.port3F4_write=function(t){a(t),t&128&&(this.status_reg0=192,this.cpu.device_raise_irq(6))};ht.prototype.port3F5_write=function(t){if(""+a(t),0<this.bytes_expecting)this.receiving_command[this.receiving_index++]=t,this.bytes_expecting--,this.bytes_expecting===0&&this.next_command.call(this,this.receiving_command);else{switch(t){case 3:this.next_command=this.fix_drive_data,this.bytes_expecting=2;break;case 19:this.next_command=this.configure,this.bytes_expecting=3;break;case 4:case 20:this.next_command=this.check_drive_status,this.bytes_expecting=1;break;case 5:case 69:case 197:this.next_command=function(e){this.do_sector(!0,e)},this.bytes_expecting=8;break;case 6:case 70:case 198:case 230:this.next_command=function(e){this.do_sector(!1,e)},this.bytes_expecting=8;break;case 7:this.next_command=this.calibrate,this.bytes_expecting=1;break;case 8:this.check_interrupt_status();break;case 74:this.next_command=this.read_sector_id,this.bytes_expecting=1;break;case 15:this.bytes_expecting=2,this.next_command=this.seek;break;case 14:case 16:this.status_reg0=128,this.response_data[0]=this.status_reg0,this.response_index=0,this.response_length=1,this.bytes_expecting=0;break;default:""+a(t)}this.receiving_index=0}};ht.prototype.port3F2_read=function(){return this.dor};ht.prototype.port3F2_write=function(t){!(this.dor&4)&&t&4&&(this.status_reg0=192,t&8&&this.cpu.device_raise_irq(6)),a(t>>4),a(t),this.dor=t};ht.prototype.check_drive_status=function(){this.status_reg1=this.fda_image?0:5,this.response_index=0,this.response_length=1,this.response_data[0]=0};ht.prototype.seek=function(t){if(!(t[0]&3)){var e=t[1];t=t[0]>>2&1,e!==this.last_cylinder&&(this.dir=0),this.status_reg1=this.fda_image?0:5,this.status_reg0=32,this.last_cylinder=e,this.last_head=t}this.raise_irq()};ht.prototype.calibrate=function(t){this.seek([t[0],0])};ht.prototype.check_interrupt_status=function(){this.response_index=0,this.response_length=2,this.response_data[0]=this.status_reg0,this.response_data[1]=this.last_cylinder};ht.prototype.do_sector=function(t,e){var i=e[2],s=e[1],r=e[3],n=128<<e[4],o=e[5]-e[3]+1,h=((i+this.number_of_heads*s)*this.sectors_per_track+r-1)*n;a(h),a(o*n),this.fda_image?(this.status_reg1=0,t?this.dma.do_write(this.fda_image,h,o*n,2,this.done.bind(this,e,s,i,r)):this.dma.do_read(this.fda_image,h,o*n,2,this.done.bind(this,e,s,i,r))):this.status_reg1=5};ht.prototype.done=function(t,e,i,s,r){r||(s++,s>this.sectors_per_track&&(s=1,i++,i>=this.number_of_heads&&(i=0,e++)),e!==this.last_cylinder&&(this.dir=0),this.status_reg0=32,this.last_cylinder=e,this.last_head=i,this.last_sector=s,this.response_index=0,this.response_length=7,this.response_data[0]=i<<2|32,this.response_data[1]=0,this.response_data[2]=0,this.response_data[3]=e,this.response_data[4]=i,this.response_data[5]=s,this.response_data[6]=t[4],this.raise_irq())};ht.prototype.fix_drive_data=function(t){t.slice(0,this.bytes_expecting)};ht.prototype.configure=function(t){t.slice(0,this.bytes_expecting)};ht.prototype.read_sector_id=function(){this.response_index=0,this.response_length=7,this.response_data[0]=0,this.response_data[1]=0,this.response_data[2]=0,this.response_data[3]=0,this.response_data[4]=0,this.response_data[5]=0,this.response_data[6]=0,this.raise_irq()};ht.prototype.raise_irq=function(){this.dor&8&&this.cpu.device_raise_irq(6)};var us={70:{name:"GET CONFIGURATION",flags:0},74:{name:"GET EVENT STATUS NOTIFICATION",flags:0},18:{name:"INQUIRY",flags:0},189:{name:"MECHANISM STATUS",flags:0},26:{name:"MODE SENSE (6)",flags:0},90:{name:"MODE SENSE (10)",flags:0},69:{name:"PAUSE",flags:1},30:{name:"PREVENT ALLOW MEDIUM REMOVAL",flags:0},40:{name:"READ",flags:1},37:{name:"READ CAPACITY",flags:1},190:{name:"READ CD",flags:1},81:{name:"READ DISK INFORMATION",flags:1},66:{name:"READ SUBCHANNEL",flags:1},67:{name:"READ TOC PMA ATIP",flags:1},82:{name:"READ TRACK INFORMATION",flags:1},3:{name:"REQUEST SENSE",flags:0},27:{name:"START STOP UNIT",flags:0},0:{name:"TEST UNIT READY",flags:1}};function si(t,e,i){this.cpu=t,this.bus=e,this.secondary=this.primary=void 0,e=i&&i[0][0];let s=i&&i[1][0];if(e||s){e&&(this.primary=new qt(this,0,i[0],496,1014,14)),s&&(this.secondary=new qt(this,1,i[1],368,886,15)),i=e?this.primary.command_base:0;let r=e?this.primary.control_base:0,n=s?this.secondary.command_base:0,o=s?this.secondary.control_base:0;this.name="ide",this.pci_id=240,this.pci_space=[134,128,16,112,5,0,160,2,0,128,1,1,0,0,0,0,i&255|1,i>>8,0,0,r&255|1,r>>8,0,0,n&255|1,n>>8,0,0,o&255|1,o>>8,0,0,1,180,0,0,0,0,0,0,0,0,0,0,67,16,212,130,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.pci_bars=[e?{size:8}:void 0,e?{size:1}:void 0,s?{size:8}:void 0,s?{size:1}:void 0,{size:16}],t.devices.pci.register_device(this)}Object.seal(this)}si.prototype.get_state=function(){let t=[];return t[0]=this.primary,t[1]=this.secondary,t};si.prototype.set_state=function(t){this.primary&&this.primary.set_state(t[0]),this.secondary&&this.secondary.set_state(t[1])};function qt(t,e,i,s,r,n){this.controller=t,this.channel_nr=e,this.cpu=t.cpu,this.bus=t.bus,this.command_base=s,this.control_base=r,this.irq=n,this.name="ide"+e,s=i?i[0]:void 0,i=i?i[1]:void 0,this.master=new B(this,0,s?.buffer,s?.is_cdrom),this.slave=new B(this,1,i?.buffer,i?.is_cdrom),this.current_interface=this.master,this.device_control_reg=2,this.dma_command=this.dma_status=this.prdt_addr=0,t=t.cpu,t.io.register_read(this.command_base|0,this,function(){return this.current_interface.read_data(1)},function(){return this.current_interface.read_data(2)},function(){return this.current_interface.read_data(4)}),t.io.register_read(this.command_base|1,this,function(){return this.current_interface.error_reg&255}),t.io.register_read(this.command_base|2,this,function(){return this.current_interface.sector_count_reg&255}),t.io.register_read(this.command_base|3,this,function(){return this.current_interface.lba_low_reg&255}),t.io.register_read(this.command_base|4,this,function(){return this.current_interface.lba_mid_reg&255}),t.io.register_read(this.command_base|5,this,function(){return this.current_interface.lba_high_reg&255}),t.io.register_read(this.command_base|6,this,function(){return this.current_interface.device_reg&255}),t.io.register_read(this.command_base|7,this,function(){let o=this.read_status();return this.cpu.device_lower_irq(this.irq),o}),t.io.register_write(this.command_base|0,this,function(o){this.current_interface.write_data_port8(o)},function(o){this.current_interface.write_data_port16(o)},function(o){this.current_interface.write_data_port32(o)}),t.io.register_write(this.command_base|1,this,function(o){this.current_interface.features_reg=(this.current_interface.features_reg<<8|o)&65535}),t.io.register_write(this.command_base|2,this,function(o){this.current_interface.sector_count_reg=(this.current_interface.sector_count_reg<<8|o)&65535}),t.io.register_write(this.command_base|3,this,function(o){this.current_interface.lba_low_reg=(this.current_interface.lba_low_reg<<8|o)&65535}),t.io.register_write(this.command_base|4,this,function(o){this.current_interface.lba_mid_reg=(this.current_interface.lba_mid_reg<<8|o)&65535}),t.io.register_write(this.command_base|5,this,function(o){this.current_interface.lba_high_reg=(this.current_interface.lba_high_reg<<8|o)&65535}),t.io.register_write(this.command_base|6,this,function(o){let h=o&16;(h&&this.current_interface===this.master||!h&&this.current_interface===this.slave)&&(this.current_interface=h?this.slave:this.master),this.current_interface.device_reg=o,this.current_interface.is_lba=o>>6&1,this.current_interface.head=o&15}),t.io.register_write(this.command_base|7,this,function(o){this.current_interface.status_reg&=-34,this.current_interface.ata_command(o),this.cpu.device_lower_irq(this.irq)}),t.io.register_read(this.control_base|0,this,this.read_status),t.io.register_write(this.control_base|0,this,this.write_control),e=46080+8*e,t.io.register_read(e|0,this,this.dma_read_command8,void 0,this.dma_read_command),t.io.register_write(e|0,this,this.dma_write_command8,void 0,this.dma_write_command),t.io.register_read(e|2,this,this.dma_read_status),t.io.register_write(e|2,this,this.dma_write_status),t.io.register_read(e|4,this,void 0,void 0,this.dma_read_addr),t.io.register_write(e|4,this,void 0,void 0,this.dma_set_addr)}qt.prototype.read_status=function(){return this.current_interface.drive_connected?this.current_interface.status_reg:0};qt.prototype.write_control=function(t){t&4&&(this.cpu.device_lower_irq(this.irq),this.master.device_reset(),this.slave.device_reset()),this.device_control_reg=t};qt.prototype.dma_read_addr=function(){return this.prdt_addr};qt.prototype.dma_set_addr=function(t){this.prdt_addr=t};qt.prototype.dma_read_status=function(){return this.dma_status};qt.prototype.dma_write_status=function(t){this.dma_status&=~(t&6)};qt.prototype.dma_read_command=function(){return this.dma_read_command8()|this.dma_read_status()<<16};qt.prototype.dma_read_command8=function(){return this.dma_command};qt.prototype.dma_write_command=function(t){this.dma_write_command8(t&255),this.dma_write_status(t>>16&255)};qt.prototype.dma_write_command8=function(t){let e=this.dma_command;if(this.dma_command=t&9,(e&1)!==(t&1))if(!(t&1))this.dma_status&=-2;else switch(this.dma_status|=1,this.current_interface.current_command){case 200:case 37:this.current_interface.do_ata_read_sectors_dma();break;case 202:case 53:this.current_interface.do_ata_write_sectors_dma();break;case 160:this.current_interface.do_atapi_dma();break;default:a(this.current_interface.current_command),this.dma_status&=-2,this.dma_status|=2,this.push_irq()}};qt.prototype.push_irq=function(){!(this.device_control_reg&2)&&(this.dma_status|=4,this.cpu.device_raise_irq(this.irq))};qt.prototype.get_state=function(){var t=[];return t[0]=this.master,t[1]=this.slave,t[2]=this.command_base,t[3]=this.irq,t[5]=this.control_base,t[7]=this.name,t[8]=this.device_control_reg,t[9]=this.prdt_addr,t[10]=this.dma_status,t[11]=this.current_interface===this.master,t[12]=this.dma_command,t};qt.prototype.set_state=function(t){this.master.set_state(t[0]),this.slave.set_state(t[1]),this.command_base=t[2],this.irq=t[3],this.control_base=t[5],this.name=t[7],this.device_control_reg=t[8],this.prdt_addr=t[9],this.dma_status=t[10],this.current_interface=t[11]?this.master:this.slave,this.dma_command=t[12]};function B(t,e,i,s){this.channel=t,this.name=t.name+"."+e,this.bus=t.bus,this.channel_nr=t.channel_nr,this.interface_nr=e,this.cpu=t.cpu,this.buffer=null,this.drive_connected=s||!!i,this.sector_size=s?2048:512,this.is_atapi=s,this.sector_count=0,this.head_count=this.is_atapi?1:0,this.device_reg=this.head=this.lba_high_reg=this.lba_mid_reg=this.features_reg=this.lba_low_reg=this.sector_count_reg=this.is_lba=this.cylinder_count=this.sectors_per_track=0,this.status_reg=80,this.sectors_per_drq=128,this.data_pointer=this.error_reg=0,this.data=new Uint8Array(65536),this.data16=new Uint16Array(this.data.buffer),this.data32=new Int32Array(this.data.buffer),this.data_end=this.data_length=0,this.current_command=-1,this.last_io_id=this.write_dest=0,this.in_progress_io_ids=new Set,this.cancelled_io_ids=new Set,this.current_atapi_command=-1,this.atapi_add_sense=this.atapi_sense_key=0,this.medium_changed=!1,this.set_disk_buffer(i),Object.seal(this)}B.prototype.has_disk=function(){return!!this.buffer};B.prototype.eject=function(){this.is_atapi&&this.buffer&&(this.medium_changed=!0,this.buffer=null,this.status_reg=89,this.error_reg=96,this.push_irq())};B.prototype.set_cdrom=function(t){this.is_atapi&&t&&(this.set_disk_buffer(t),this.medium_changed=!0)};B.prototype.set_disk_buffer=function(t){if(t){if(this.buffer=t,this.is_atapi&&(this.status_reg=89,this.error_reg=96),this.sector_count=this.buffer.byteLength/this.sector_size,this.sector_count!==(this.sector_count|0)&&(this.sector_count=Math.ceil(this.sector_count)),this.is_atapi?(this.head_count=1,this.sectors_per_track=2048):(this.head_count=16,this.sectors_per_track=63),this.cylinder_count=this.sector_count/this.head_count/this.sectors_per_track,this.cylinder_count!==(this.cylinder_count|0)&&(this.cylinder_count=Math.floor(this.cylinder_count)),this.interface_nr===0){t=this.cpu.devices.rtc,t.cmos_write(57,t.cmos_read(57)|1<<4*this.channel_nr),t.cmos_write(18,t.cmos_read(18)&15|240);let e=this.channel_nr===0?27:36;t.cmos_write(e+0,this.cylinder_count&255),t.cmos_write(e+1,this.cylinder_count>>8&255),t.cmos_write(e+2,this.head_count&255),t.cmos_write(e+3,255),t.cmos_write(e+4,255),t.cmos_write(e+5,200),t.cmos_write(e+6,this.cylinder_count&255),t.cmos_write(e+7,this.cylinder_count>>8&255),t.cmos_write(e+8,this.sectors_per_track&255)}this.channel.cpu&&this.push_irq()}};B.prototype.device_reset=function(){this.is_atapi?(this.status_reg=0,this.lba_low_reg=this.error_reg=this.sector_count_reg=1,this.lba_mid_reg=20,this.lba_high_reg=235):(this.status_reg=81,this.lba_low_reg=this.error_reg=this.sector_count_reg=1,this.lba_high_reg=this.lba_mid_reg=0),this.cancel_io_operations()};B.prototype.push_irq=function(){this.channel.push_irq()};B.prototype.ata_abort_command=function(){this.error_reg=4,this.status_reg=65,this.push_irq()};B.prototype.capture_regs=function(){return`ST=${a(this.status_reg&255)} ER=${a(this.error_reg&255)} SC=${a(this.sector_count_reg&255)} LL=${a(this.lba_low_reg&255)} LM=${a(this.lba_mid_reg&255)} LH=${a(this.lba_high_reg&255)} FE=${a(this.features_reg&255)}`};B.prototype.ata_command=function(t){if(this.drive_connected||t===144)switch(this.current_command=t,this.error_reg=0,t){case 8:this.data_length=this.data_end=this.data_pointer=0,this.device_reset(),this.push_irq();break;case 16:this.lba_mid_reg=0,this.status_reg=80,this.push_irq();break;case 248:t=this.sector_count-1,this.lba_low_reg=t&255,this.lba_mid_reg=t>>8&255,this.lba_high_reg=t>>16&255,this.device_reg=this.device_reg&240|t>>24&15,this.status_reg=80,this.push_irq();break;case 39:t=this.sector_count-1,this.lba_low_reg=t&255,this.lba_mid_reg=t>>8&255,this.lba_high_reg=t>>16&255,this.lba_low_reg|=t>>24<<8&65280,this.status_reg=80,this.push_irq();break;case 32:this.is_atapi?(this.lba_mid_reg=20,this.lba_high_reg=235,this.ata_abort_command()):this.ata_read_sectors(t);break;case 36:case 41:case 196:this.is_atapi?this.ata_abort_command():this.ata_read_sectors(t);break;case 48:case 52:case 57:case 197:this.is_atapi?this.ata_abort_command():this.ata_write_sectors(t);break;case 144:this.channel.master.status_reg=80,this.channel.master.error_reg=1,this.channel.master.push_irq(),this.channel.slave.drive_connected&&(this.channel.slave.status_reg=80,this.channel.slave.error_reg=1,this.channel.slave.push_irq());break;case 145:this.status_reg=80,this.push_irq();break;case 160:this.is_atapi?(this.data_allocate(12),this.data_end=12,this.sector_count_reg=1,this.status_reg=88,this.push_irq()):this.ata_abort_command();break;case 161:this.is_atapi?(this.create_identify_packet(),this.status_reg=88,this.push_irq()):this.ata_abort_command();break;case 198:a(this.sector_count_reg&255),this.sectors_per_drq=this.sector_count_reg&255,this.status_reg=80,this.push_irq();break;case 200:case 37:this.ata_read_sectors_dma(t);break;case 202:case 53:this.ata_write_sectors_dma(t);break;case 64:this.status_reg=80,this.push_irq();break;case 218:this.is_atapi&&(this.buffer||(this.error_reg|=2),this.medium_changed&&(this.error_reg|=32,this.medium_changed=!1),this.error_reg|=64),this.status_reg=80,this.push_irq();break;case 224:this.status_reg=80,this.push_irq();break;case 225:this.status_reg=80,this.push_irq();break;case 231:this.status_reg=80,this.push_irq();break;case 234:this.status_reg=80,this.push_irq();break;case 236:this.is_atapi?(this.lba_mid_reg=20,this.lba_high_reg=235,this.ata_abort_command()):(this.create_identify_packet(),this.status_reg=88,this.push_irq());break;case 239:this.status_reg=80,this.push_irq();break;case 222:this.status_reg=64,this.push_irq();break;case 245:this.status_reg=80,this.push_irq();break;case 249:this.ata_abort_command();break;case 0:this.ata_abort_command();break;default:a(t),this.capture_regs(),this.ata_abort_command()}else a(t)};B.prototype.atapi_handle=function(){var t=this.data[0],e=us[t]?us[t].flags:0;if(this.data_pointer=0,this.current_atapi_command=t,t!==3&&(this.atapi_add_sense=this.atapi_sense_key=0),!this.buffer&&e&1)this.atapi_check_condition_response(2,58),this.push_irq();else{switch(t){case 0:this.buffer?(this.data_allocate(0),this.data_end=this.data_length,this.status_reg=80):this.atapi_check_condition_response(2,58);break;case 3:this.data_allocate(this.data[4]),this.data_end=this.data_length,this.status_reg=88,this.data[0]=240,this.data[2]=this.atapi_sense_key,this.data[7]=8,this.data[12]=this.atapi_add_sense,this.atapi_add_sense=this.atapi_sense_key=0;break;case 18:t=this.data[4],this.status_reg=88,a(this.data[1],2),this.data.set([5,128,1,49,31,0,0,0,83,79,78,89,32,32,32,32,67,68,45,82,79,77,32,67,68,85,45,49,48,48,48,32,49,46,49,97]),this.data_end=this.data_length=Math.min(36,t);break;case 26:this.data_allocate(this.data[4]),this.data_end=this.data_length,this.status_reg=88;break;case 30:this.data_allocate(0),this.data_end=this.data_length,this.status_reg=80;break;case 37:t=this.sector_count-1,this.data_set(new Uint8Array([t>>24&255,t>>16&255,t>>8&255,t&255,0,0,this.sector_size>>8&255,this.sector_size&255])),this.data_end=this.data_length,this.status_reg=88;break;case 40:this.features_reg&1?this.atapi_read_dma(this.data):this.atapi_read(this.data);break;case 66:t=this.data[8],this.data_allocate(Math.min(8,t)),this.data_end=this.data_length,this.status_reg=88;break;case 67:t=this.data[8]|this.data[7]<<8,e=this.data[9]>>6,a(e,2),a(this.data[6]),this.data_allocate(t),this.data_end=this.data_length,e===0?(t=this.sector_count,this.data.set(new Uint8Array([0,18,1,1,0,20,1,0,0,0,0,0,0,22,170,0,t>>24,t>>16&255,t>>8&255,t&255]))):e===1&&this.data.set(new Uint8Array([0,10,1,1,0,0,0,0,0,0,0,0])),this.status_reg=88;break;case 70:t=Math.min(this.data[8]|this.data[7]<<8,32),this.data_allocate(t),this.data_end=this.data_length,this.data[0]=t-4>>24&255,this.data[1]=t-4>>16&255,this.data[2]=t-4>>8&255,this.data[3]=t-4&255,this.data[6]=8,this.data[10]=3,this.status_reg=88;break;case 81:this.data_allocate(0),this.data_end=this.data_length,this.status_reg=80;break;case 82:this.atapi_check_condition_response(5,36);break;case 90:t=this.data[8]|this.data[7]<<8,e=this.data[2],a(e),e===42&&this.data_allocate(Math.min(30,t)),this.data_end=this.data_length,this.status_reg=88;break;case 189:this.data_allocate(this.data[9]|this.data[8]<<8),this.data_end=this.data_length,this.data[5]=1,this.status_reg=88;break;case 27:t=this.data[4]&3,a(this.data[1]&1),a(t),this.buffer&&t===2&&(this.medium_changed=!0,this.buffer=null),this.status_reg=80,this.data_allocate(0),this.data_end=this.data_length;break;case 69:case 74:this.atapi_check_condition_response(5,36);break;case 190:this.data_allocate(0),this.data_end=this.data_length,this.status_reg=80;break;default:a(this.data[0]),this.atapi_check_condition_response(5,36)}this.sector_count_reg=this.sector_count_reg&-8|2,!(this.status_reg&128)&&this.push_irq(),!(this.status_reg&128)&&this.data_length===0&&(this.sector_count_reg|=1,this.status_reg&=-9)}};B.prototype.atapi_check_condition_response=function(t,e){this.data_allocate(0),this.data_end=this.data_length,this.status_reg=65,this.error_reg=t<<4,this.sector_count_reg=this.sector_count_reg&-8|3,this.atapi_sense_key=t,this.atapi_add_sense=e};B.prototype.do_write=function(){this.status_reg=80;var t=this.data.subarray(0,this.data_length);this.ata_advance(this.current_command,this.data_length/512),this.push_irq(),this.buffer.set(this.write_dest,t,function(){}),this.report_write(this.data_length)};B.prototype.atapi_read=function(t){var e=(t[7]<<8|t[8])*this.sector_size;t=(t[2]<<24|t[3]<<16|t[4]<<8|t[5])*this.sector_size,this.data_length=0;var i=this.lba_high_reg<<8&65280|this.lba_mid_reg&255;this.lba_mid_reg=this.lba_high_reg=0,i===65535&&i--,i>e&&(i=e),this.buffer?t>=this.buffer.byteLength?(this.name+""+a(t+e)+a(this.buffer.byteLength),this.status_reg=255,this.push_irq()):e===0?(this.status_reg=80,this.data_pointer=0):(e=Math.min(e,this.buffer.byteLength-t),this.status_reg=208,this.report_read_start(),this.read_buffer(t,e,s=>{this.data_set(s),this.status_reg=88,this.sector_count_reg=this.sector_count_reg&-8|2,this.push_irq(),this.data_end=i&=-4,this.data_end>this.data_length&&(this.data_end=this.data_length),this.lba_mid_reg=this.data_end&255,this.lba_high_reg=this.data_end>>8&255,this.report_read_end(e)})):(this.status_reg=255,this.error_reg=65,this.push_irq())};B.prototype.atapi_read_dma=function(t){var e=t[2]<<24|t[3]<<16|t[4]<<8|t[5],i=t[7]<<8|t[8];t=t[1];var s=i*this.sector_size,r=e*this.sector_size;this.name+""+a(e)+a(i)+a(s)+a(t),r>=this.buffer.byteLength?(this.name+""+a(r+s)+a(this.buffer.byteLength),this.status_reg=255,this.push_irq()):(this.status_reg=208,this.report_read_start(),this.read_buffer(r,s,n=>{this.report_read_end(s),this.status_reg=88,this.sector_count_reg=this.sector_count_reg&-8|2,this.data_set(n),this.do_atapi_dma()}))};B.prototype.do_atapi_dma=function(){if(this.channel.dma_status&1&&this.status_reg&8){var t=this.channel.prdt_addr,e=0,i=this.data;do{var s=this.cpu.read32s(t),r=this.cpu.read16(t+4),n=this.cpu.read8(t+7)&128;if(r||(r=65536),this.cpu.write_blob(i.subarray(e,Math.min(e+r,this.data_length)),s),e+=r,t+=8,e>=this.data_length&&!n)break}while(!n);this.status_reg=80,this.channel.dma_status&=-2,this.sector_count_reg=this.sector_count_reg&-8|3,this.push_irq()}};B.prototype.read_data=function(t){if(this.data_pointer<this.data_end){a(this.data_pointer);var e=t===1?this.data[this.data_pointer]:t===2?this.data16[this.data_pointer>>>1]:this.data32[this.data_pointer>>>2];return this.data_pointer+=t,this.data_pointer>=this.data_end&&this.read_end(),e}return this.data_pointer+=t,0};B.prototype.read_end=function(){if(this.current_command===160)if(this.data_end===this.data_length)this.status_reg=80,this.sector_count_reg=this.sector_count_reg&-8|3,this.push_irq();else{this.status_reg=88,this.sector_count_reg=this.sector_count_reg&-8|2,this.push_irq();var t=this.lba_high_reg<<8&65280|this.lba_mid_reg&255;this.data_end+t>this.data_length?(this.lba_mid_reg=this.data_length-this.data_end&255,this.lba_high_reg=this.data_length-this.data_end>>8&255,this.data_end=this.data_length):this.data_end+=t}else this.error_reg=0,this.data_pointer>=this.data_length?this.status_reg=80:(t=this.current_command===41||this.current_command===196?Math.min(this.sectors_per_drq,(this.data_length-this.data_end)/512):1,this.ata_advance(this.current_command,t),this.data_end+=512*t,this.status_reg=88,this.push_irq())};B.prototype.write_data_port=function(t,e){this.data_pointer>=this.data_end?(a(t),a(this.data_end),a(this.data_pointer)):(e===1?this.data[this.data_pointer++]=t:e===2?(this.data16[this.data_pointer>>>1]=t,this.data_pointer+=2):(this.data32[this.data_pointer>>>2]=t,this.data_pointer+=4),this.data_pointer===this.data_end&&this.write_end())};B.prototype.write_data_port8=function(t){this.write_data_port(t,1)};B.prototype.write_data_port16=function(t){this.write_data_port(t,2)};B.prototype.write_data_port32=function(t){this.write_data_port(t,4)};B.prototype.write_end=function(){this.current_command===160?this.atapi_handle():this.data_pointer>=this.data_length?this.do_write():(a(this.current_command),this.status_reg=88,this.data_end+=512,this.push_irq())};B.prototype.ata_advance=function(t,e){this.sector_count_reg-=e,t===36||t===41||t===37||t===52||t===57||t===53?(t=e+this.get_lba48(),this.lba_low_reg=t&255|t>>16&65280,this.lba_mid_reg=t>>8&255,this.lba_high_reg=t>>16&255):this.is_lba?(t=e+this.get_lba28(),this.lba_low_reg=t&255,this.lba_mid_reg=t>>8&255,this.lba_high_reg=t>>16&255,this.head=this.head&-16|t&15):(t=e+this.get_chs(),e=t/(this.head_count*this.sectors_per_track)|0,this.lba_mid_reg=e&255,this.lba_high_reg=e>>8&255,this.head=(t/this.sectors_per_track|0)%this.head_count&15,this.lba_low_reg=t%this.sectors_per_track+1&255,this.get_chs())};B.prototype.ata_read_sectors=function(t){var e=t===36||t===41,i=this.get_count(e);e=this.get_lba(e);var s=t===32||t===36,r=i*this.sector_size;e*=this.sector_size,e+r>this.buffer.byteLength?(this.status_reg=255,this.push_irq()):(this.status_reg=192,this.report_read_start(),this.read_buffer(e,r,n=>{this.data_set(n),this.status_reg=88,this.data_end=s?512:Math.min(r,512*this.sectors_per_drq),this.ata_advance(t,s?1:Math.min(i,this.sectors_per_track)),this.push_irq(),this.report_read_end(r)}))};B.prototype.ata_read_sectors_dma=function(t){t=t===37;var e=this.get_count(t);this.get_lba(t)*this.sector_size+e*this.sector_size>this.buffer.byteLength?(this.status_reg=255,this.push_irq()):(this.status_reg=88,this.channel.dma_status|=1)};B.prototype.do_ata_read_sectors_dma=function(){var t=this.current_command===37,e=this.get_count(t);t=this.get_lba(t);var i=e*this.sector_size;t*=this.sector_size,this.report_read_start(),this.read_buffer(t,i,s=>{var r=this.channel.prdt_addr,n=0;do{var o=this.cpu.read32s(r),h=this.cpu.read16(r+4),_=this.cpu.read8(r+7)&128;h||(h=65536),this.cpu.write_blob(s.subarray(n,n+h),o),n+=h,r+=8}while(!_);this.ata_advance(this.current_command,e),this.status_reg=80,this.channel.dma_status&=-2,this.current_command=-1,this.report_read_end(i),this.push_irq()})};B.prototype.ata_write_sectors=function(t){var e=t===52||t===57,i=this.get_count(e);e=this.get_lba(e),t=t===48||t===52,i*=this.sector_size,e*=this.sector_size,e+i>this.buffer.byteLength?(this.status_reg=255,this.push_irq()):(this.status_reg=88,this.data_allocate_noclear(i),this.data_end=t?512:Math.min(i,512*this.sectors_per_drq),this.write_dest=e)};B.prototype.ata_write_sectors_dma=function(t){t=t===53;var e=this.get_count(t);this.get_lba(t)*this.sector_size+e*this.sector_size>this.buffer.byteLength?(this.status_reg=255,this.push_irq()):(this.status_reg=88,this.channel.dma_status|=1)};B.prototype.do_ata_write_sectors_dma=function(){var t=this.current_command===53,e=this.get_count(t),i=this.get_lba(t);t=e*this.sector_size,i*=this.sector_size;var s=this.channel.prdt_addr,r=0;let n=new Uint8Array(t);do{var o=this.cpu.read32s(s),h=this.cpu.read16(s+4),_=this.cpu.read8(s+7)&128;h||(h=65536),o=this.cpu.mem8.subarray(o,o+h),n.set(o,r),r+=h,s+=8}while(!_);this.buffer.set(i,n,()=>{this.ata_advance(this.current_command,e),this.status_reg=80,this.push_irq(),this.channel.dma_status&=-2,this.current_command=-1}),this.report_write(t)};B.prototype.get_chs=function(){return((this.lba_mid_reg&255|this.lba_high_reg<<8&65280)*this.head_count+this.head)*this.sectors_per_track+(this.lba_low_reg&255)-1};B.prototype.get_lba28=function(){return this.lba_low_reg&255|this.lba_mid_reg<<8&65280|this.lba_high_reg<<16&16711680|(this.head&15)<<24};B.prototype.get_lba48=function(){return(this.lba_low_reg&255|this.lba_mid_reg<<8&65280|this.lba_high_reg<<16&16711680|this.lba_low_reg>>8<<24&4278190080)>>>0};B.prototype.get_lba=function(t){return t?this.get_lba48():this.is_lba?this.get_lba28():this.get_chs()};B.prototype.get_count=function(t){return t?(t=this.sector_count_reg,t===0&&(t=65536)):(t=this.sector_count_reg&255,t===0&&(t=256)),t};B.prototype.create_identify_packet=function(){let t=Math.min(16383,this.cylinder_count),e=(o,h,_,c)=>{h<<=1;var d=_<<1;for(_=h+d,o.fill(32,h,d),d=0;d<c.length&&h<_;d++)d&1?(o[h]=c.charCodeAt(d),h+=2):o[h+1]=c.charCodeAt(d)},i=this.is_atapi?34112:64,s=this.current_command===160?0:1031,r=this.is_atapi?16928:16384,n=this.is_atapi?20480:29696;this.data.fill(0,0,512),this.data_set([i&255,i>>8&255,t&255,t>>8&255,0,0,this.head_count&255,this.head_count>>8&255,this.sectors_per_track/512&255,this.sectors_per_track/512>>8&255,0,2,this.sectors_per_track&255,this.sectors_per_track>>8&255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,0,0,2,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,128,0,1,0,0,2,0,0,0,2,0,2,7,0,t&255,t>>8&255,this.head_count&255,this.head_count>>8&255,this.sectors_per_track,0,this.sector_count&255,this.sector_count>>8&255,this.sector_count>>16&255,this.sector_count>>24&255,0,0,this.sector_count&255,this.sector_count>>8&255,this.sector_count>>16&255,this.sector_count>>24&255,0,0,s&255,s>>8&255,0,0,30,0,30,0,30,0,30,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,r&255,r>>8&255,n&255,n>>8&255,0,64,r&255,r>>8&255,n&255,n>>8&255,0,64,0,0,0,0,0,0,0,0,0,0,1,96,0,0,0,0,0,0,0,0,0,0,0,0,this.sector_count&255,this.sector_count>>8&255,this.sector_count>>16&255,this.sector_count>>24&255]),e(this.data,10,10,`8086-86${this.channel_nr}${this.interface_nr}`),e(this.data,23,4,"1.00"),e(this.data,27,20,this.is_atapi?"v86 ATAPI CD-ROM":"v86 ATA HD"),this.data_end=this.data_length=512};B.prototype.data_allocate=function(t){this.data_allocate_noclear(t),this.data32.fill(0,0,t+3>>2)};B.prototype.data_allocate_noclear=function(t){this.data.length<t&&(this.data=new Uint8Array(t+3&-4),this.data16=new Uint16Array(this.data.buffer),this.data32=new Int32Array(this.data.buffer)),this.data_length=t,this.data_pointer=0};B.prototype.data_set=function(t){this.data_allocate_noclear(t.length),this.data.set(t)};B.prototype.report_read_start=function(){this.bus.send("ide-read-start")};B.prototype.report_read_end=function(t){this.bus.send("ide-read-end",[this.channel_nr,t,t/this.sector_size|0])};B.prototype.report_write=function(t){this.bus.send("ide-write-end",[this.channel_nr,t,t/this.sector_size|0])};B.prototype.read_buffer=function(t,e,i){let s=this.last_io_id++;this.in_progress_io_ids.add(s),this.buffer.get(t,e,r=>{this.cancelled_io_ids.delete(s)?this.in_progress_io_ids.has(s):(this.in_progress_io_ids.delete(s),i(r))})};B.prototype.cancel_io_operations=function(){for(let t of this.in_progress_io_ids)this.cancelled_io_ids.add(t);this.in_progress_io_ids.clear()};B.prototype.get_state=function(){var t=[];return t[0]=this.sector_count_reg,t[1]=this.cylinder_count,t[2]=this.lba_high_reg,t[3]=this.lba_mid_reg,t[4]=this.data_pointer,t[5]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=this.device_reg,t[10]=this.error_reg,t[11]=this.head,t[12]=this.head_count,t[13]=this.is_atapi,t[14]=this.is_lba,t[15]=this.features_reg,t[16]=this.data,t[17]=this.data_length,t[18]=this.lba_low_reg,t[19]=this.sector_count,t[20]=this.sector_size,t[21]=this.sectors_per_drq,t[22]=this.sectors_per_track,t[23]=this.status_reg,t[24]=this.write_dest,t[25]=this.current_command,t[26]=this.data_end,t[27]=this.current_atapi_command,t[28]=this.buffer,t};B.prototype.set_state=function(t){this.sector_count_reg=t[0],this.cylinder_count=t[1],this.lba_high_reg=t[2],this.lba_mid_reg=t[3],this.data_pointer=t[4],this.device_reg=t[9],this.error_reg=t[10],this.head=t[11],this.head_count=t[12],this.is_atapi=t[13],this.is_lba=t[14],this.features_reg=t[15],this.data=t[16],this.data_length=t[17],this.lba_low_reg=t[18],this.sector_count=t[19],this.sector_size=t[20],this.sectors_per_drq=t[21],this.sectors_per_track=t[22],this.status_reg=t[23],this.write_dest=t[24],this.current_command=t[25],this.data_end=t[26],this.current_atapi_command=t[27],this.data16=new Uint16Array(this.data.buffer),this.data32=new Int32Array(this.data.buffer),this.buffer&&this.buffer.set_state(t[28]),this.drive_connected=this.is_atapi||this.buffer,this.medium_changed=!1};function Te(t,e,i){for(this.bus=e,this.id=t.devices.net?1:0,this.status=this.pairs=1,this.preserve_mac_from_state_image=i,this.mac=new Uint8Array([0,34,21,255*Math.random()|0,255*Math.random()|0,255*Math.random()|0]),this.bus.send("net"+this.id+"-mac",Ht(this.mac)),e=[],i=0;i<this.pairs;++i)e.push({size_supported:1024,notify_offset:0}),e.push({size_supported:1024,notify_offset:1});e.push({size_supported:16,notify_offset:2}),this.virtio=new vt(t,{name:"virtio-net",pci_id:80,device_id:4161,subsystem_device_id:1,common:{initial_port:51200,queues:e,features:[5,16,22,3,17,23,32],on_driver_ok:()=>{}},notification:{initial_port:51456,single_handler:!1,handlers:[()=>{},s=>{let r=this.virtio.queues[s];for(;r.has_request();){let n=r.pop_request(),o=new Uint8Array(n.length_readable);n.get_next_blob(o),this.bus.send("net"+this.id+"-send",o.subarray(12)),this.bus.send("eth-transmit-end",[o.length-12]),this.virtio.queues[s].push_reply(n)}this.virtio.queues[s].flush_replies()},s=>{if(s===2*this.pairs)for(var r=this.virtio.queues[s];r.has_request();){let n=r.pop_request(),o=new Uint8Array(n.length_readable);n.get_next_blob(o);let h=K(["b","b"],o,{offset:0});switch(h[0]<<8|h[1]){case 1024:K(["h"],o,{offset:2}),this.Send(s,n,new Uint8Array([0]));break;case 257:this.mac=o.subarray(2,8),this.Send(s,n,new Uint8Array([0])),this.bus.send("net"+this.id+"-mac",Ht(this.mac));break;default:this.Send(s,n,new Uint8Array([1]));return}}}]},isr_status:{initial_port:50944},device_specific:{initial_port:50688,struct:[0,1,2,3,4,5].map((s,r)=>({bytes:1,name:"mac_"+r,read:()=>this.mac[r],write:()=>{}})).concat([{bytes:2,name:"status",read:()=>this.status,write:()=>{}},{bytes:2,name:"max_pairs",read:()=>this.pairs,write:()=>{}},{bytes:2,name:"mtu",read:()=>1500,write:()=>{}}])}}),this.bus.register("net"+this.id+"-receive",s=>{this.bus.send("eth-receive-end",[s.length]);let r=new Uint8Array(12+s.byteLength);new DataView(r.buffer,r.byteOffset,r.byteLength).setInt16(10,1),r.set(s,12),s=this.virtio.queues[0],s.has_request()?(s=s.pop_request(),s.set_next_blob(r),this.virtio.queues[0].push_reply(s),this.virtio.queues[0].flush_replies()):console.log("No buffer to write into!")},this)}Te.prototype.get_state=function(){let t=[];return t[0]=this.virtio,t[1]=this.id,t[2]=this.mac,t};Te.prototype.set_state=function(t){this.virtio.set_state(t[0]),this.id=t[1],this.preserve_mac_from_state_image&&(this.mac=t[2],this.bus.send("net"+this.id+"-mac",Ht(this.mac)))};Te.prototype.reset=function(){this.virtio.reset()};Te.prototype.Send=function(t,e,i){e.set_next_blob(i),this.virtio.queues[t].push_reply(e),this.virtio.queues[t].flush_replies()};Te.prototype.Ack=function(t,e){this.virtio.queues[t].push_reply(e),this.virtio.queues[t].flush_replies()};var Ds=Uint32Array.from([655360,655360,720896,753664]),Di=Uint32Array.from([131072,65536,32768,32768]);function q(t,e,i,s){this.cpu=t,this.bus=e,this.screen=i,this.vga_memory_size=s,this.cursor_address=0,this.cursor_scanline_start=14,this.cursor_scanline_end=15,this.max_cols=80,this.max_rows=25,this.virtual_height=this.virtual_width=this.screen_height=this.screen_width=0,this.layers=[],this.start_address_latched=this.start_address=0,this.crtc=new Uint8Array(25),this.line_compare=this.offset_register=this.preset_row_scan=this.underline_location_register=this.vertical_blank_start=this.vertical_display_enable_end=this.horizontal_blank_start=this.horizontal_display_enable_end=this.crtc_mode=0,this.graphical_mode=!1,this.vga256_palette=new Int32Array(256),this.latch_dword=0,this.svga_version=45253,this.svga_height=this.svga_width=0,this.svga_enabled=!1,this.svga_bpp=32,this.svga_offset_y=this.svga_offset_x=this.svga_offset=this.svga_bank_offset=0,this.vga_memory_size=this.vga_memory_size===void 0||262144>this.vga_memory_size?262144:268435456<this.vga_memory_size?268435456:lr(this.vga_memory_size),this.pci_space=[52,18,17,17,3,1,0,0,0,0,0,3,0,0,0,0,8,14680064,57344,224,0,0,0,0,0,0,191,254,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,244,26,0,17,0,0,190,254,0,0,0,0,0,0,0,0,0,0,0,0],this.pci_id=144,this.pci_bars=[{size:this.vga_memory_size}],this.pci_rom_size=65536,this.pci_rom_address=4272947200,this.name="vga",this.dac_state=this.dac_color_index_read=this.dac_color_index_write=this.index_crtc=0,this.dac_mask=255,this.dac_map=new Uint8Array(16),this.attribute_controller_index=-1,this.palette_source=32,this.color_select=this.horizontal_panning=this.color_plane_enable=this.attribute_mode=0,this.sequencer_index=-1,this.plane_write_bm=15,this.clocking_mode=this.sequencer_memory_mode=0,this.graphics_index=-1,this.planar_rotate_reg=this.planar_mode=this.plane_read=this.character_map_select=0,this.planar_bitmap=255,this.max_scan_line=this.color_dont_care=this.color_compare=this.miscellaneous_graphics_register=this.planar_setreset_enable=this.planar_setreset=0,this.port_3DA_value=this.miscellaneous_output_register=255,this.font_page_ab_enabled=!1,e=t.io,e.register_write(960,this,this.port3C0_write),e.register_read(960,this,this.port3C0_read,this.port3C0_read16),e.register_read(961,this,this.port3C1_read),e.register_write(962,this,this.port3C2_write),e.register_write_consecutive(964,this,this.port3C4_write,this.port3C5_write),e.register_read(964,this,this.port3C4_read),e.register_read(965,this,this.port3C5_read),e.register_write_consecutive(974,this,this.port3CE_write,this.port3CF_write),e.register_read(974,this,this.port3CE_read),e.register_read(975,this,this.port3CF_read),e.register_read(966,this,this.port3C6_read),e.register_write(966,this,this.port3C6_write),e.register_write(967,this,this.port3C7_write),e.register_read(967,this,this.port3C7_read),e.register_write(968,this,this.port3C8_write),e.register_read(968,this,this.port3C8_read),e.register_write(969,this,this.port3C9_write),e.register_read(969,this,this.port3C9_read),e.register_read(972,this,this.port3CC_read),e.register_write(980,this,this.port3D4_write,this.port3D4_write16),e.register_write(981,this,this.port3D5_write,this.port3D5_write16),e.register_read(980,this,this.port3D4_read),e.register_read(981,this,this.port3D5_read,this.port3D5_read16),e.register_write(948,this,this.port3D4_write,this.port3D4_write16),e.register_write(949,this,this.port3D5_write,this.port3D5_write16),e.register_read(948,this,this.port3D4_read),e.register_read(949,this,this.port3D5_read,this.port3D5_read16),e.register_read(970,this,function(){return 0}),e.register_read(986,this,this.port3DA_read),e.register_read(954,this,this.port3DA_read),this.dispi_index=-1,this.dispi_enable_value=0,e.register_write(462,this,void 0,this.port1CE_write),e.register_write(463,this,void 0,this.port1CF_write),e.register_read(463,this,void 0,this.port1CF_read),i=t.svga_allocate_memory(this.vga_memory_size)>>>0,this.svga_memory=P(Uint8Array,t.wasm_memory,i,this.vga_memory_size),this.diff_addr_min=this.vga_memory_size,this.diff_addr_max=0,this.diff_plot_min=this.vga_memory_size,this.diff_plot_max=0,this.image_data=null,this.vga_memory=new Uint8Array(262144),this.plane0=new Uint8Array(this.vga_memory.buffer,0,65536),this.plane1=new Uint8Array(this.vga_memory.buffer,65536,65536),this.plane2=new Uint8Array(this.vga_memory.buffer,131072,65536),this.plane3=new Uint8Array(this.vga_memory.buffer,196608,65536),this.pixel_buffer=new Uint8Array(524288),e.mmap_register(655360,131072,r=>this.vga_memory_read(r),(r,n)=>this.vga_memory_write(r,n)),t.devices.pci.register_device(this)}q.prototype.get_state=function(){var t=[];return t[0]=this.vga_memory_size,t[1]=this.cursor_address,t[2]=this.cursor_scanline_start,t[3]=this.cursor_scanline_end,t[4]=this.max_cols,t[5]=this.max_rows,t[6]=this.vga_memory,t[7]=this.dac_state,t[8]=this.start_address,t[9]=this.graphical_mode,t[10]=this.vga256_palette,t[11]=this.latch_dword,t[12]=this.color_compare,t[13]=this.color_dont_care,t[14]=this.miscellaneous_graphics_register,t[15]=this.svga_width,t[16]=this.svga_height,t[17]=this.crtc_mode,t[18]=this.svga_enabled,t[19]=this.svga_bpp,t[20]=this.svga_bank_offset,t[21]=this.svga_offset,t[22]=this.index_crtc,t[23]=this.dac_color_index_write,t[24]=this.dac_color_index_read,t[25]=this.dac_map,t[26]=this.sequencer_index,t[27]=this.plane_write_bm,t[28]=this.sequencer_memory_mode,t[29]=this.graphics_index,t[30]=this.plane_read,t[31]=this.planar_mode,t[32]=this.planar_rotate_reg,t[33]=this.planar_bitmap,t[34]=this.max_scan_line,t[35]=this.miscellaneous_output_register,t[36]=this.port_3DA_value,t[37]=this.dispi_index,t[38]=this.dispi_enable_value,t[39]=this.svga_memory,t[41]=this.attribute_controller_index,t[42]=this.offset_register,t[43]=this.planar_setreset,t[44]=this.planar_setreset_enable,t[45]=this.start_address_latched,t[46]=this.crtc,t[47]=this.horizontal_display_enable_end,t[48]=this.horizontal_blank_start,t[49]=this.vertical_display_enable_end,t[50]=this.vertical_blank_start,t[51]=this.underline_location_register,t[52]=this.preset_row_scan,t[53]=this.offset_register,t[54]=this.palette_source,t[55]=this.attribute_mode,t[56]=this.color_plane_enable,t[57]=this.horizontal_panning,t[58]=this.color_select,t[59]=this.clocking_mode,t[60]=this.line_compare,t[61]=this.pixel_buffer,t[62]=this.dac_mask,t[63]=this.character_map_select,t[64]=this.font_page_ab_enabled,t};q.prototype.set_state=function(t){this.vga_memory_size=t[0],this.cursor_address=t[1],this.cursor_scanline_start=t[2],this.cursor_scanline_end=t[3],this.max_cols=t[4],this.max_rows=t[5],t[6]&&this.vga_memory.set(t[6]),this.dac_state=t[7],this.start_address=t[8],this.graphical_mode=t[9],this.vga256_palette=t[10],this.latch_dword=t[11],this.color_compare=t[12],this.color_dont_care=t[13],this.miscellaneous_graphics_register=t[14],this.svga_width=t[15],this.svga_height=t[16],this.crtc_mode=t[17],this.svga_enabled=t[18],this.svga_bpp=t[19],this.svga_bank_offset=t[20],this.svga_offset=t[21],this.index_crtc=t[22],this.dac_color_index_write=t[23],this.dac_color_index_read=t[24],this.dac_map=t[25],this.sequencer_index=t[26],this.plane_write_bm=t[27],this.sequencer_memory_mode=t[28],this.graphics_index=t[29],this.plane_read=t[30],this.planar_mode=t[31],this.planar_rotate_reg=t[32],this.planar_bitmap=t[33],this.max_scan_line=t[34],this.miscellaneous_output_register=t[35],this.port_3DA_value=t[36],this.dispi_index=t[37],this.dispi_enable_value=t[38],this.svga_memory.set(t[39]),this.attribute_controller_index=t[41],this.offset_register=t[42],this.planar_setreset=t[43],this.planar_setreset_enable=t[44],this.start_address_latched=t[45],this.crtc.set(t[46]),this.horizontal_display_enable_end=t[47],this.horizontal_blank_start=t[48],this.vertical_display_enable_end=t[49],this.vertical_blank_start=t[50],this.underline_location_register=t[51],this.preset_row_scan=t[52],this.offset_register=t[53],this.palette_source=t[54],this.attribute_mode=t[55],this.color_plane_enable=t[56],this.horizontal_panning=t[57],this.color_select=t[58],this.clocking_mode=t[59],this.line_compare=t[60],t[61]&&this.pixel_buffer.set(t[61]),this.dac_mask=t[62]===void 0?255:t[62],this.character_map_select=t[63]===void 0?0:t[63],this.font_page_ab_enabled=t[64]===void 0?0:t[64],this.screen.set_mode(this.graphical_mode),this.graphical_mode?(this.screen_height=this.screen_width=0,this.svga_enabled?(this.set_size_graphical(this.svga_width,this.svga_height,this.svga_width,this.svga_height,this.svga_bpp),this.update_layers()):(this.update_vga_size(),this.update_layers(),this.complete_replot())):(this.set_font_bitmap(!0),this.set_size_text(this.max_cols,this.max_rows),this.set_font_page(),this.update_cursor_scanline(),this.update_cursor()),this.complete_redraw()};q.prototype.vga_memory_read=function(t){if(this.svga_enabled)return this.cpu.read8((t-655360|this.svga_bank_offset)+3758096384|0);var e=this.miscellaneous_graphics_register>>2&3;return t-=Ds[e],0>t||t>=Di[e]?(a(t),0):(this.latch_dword=this.plane0[t],this.latch_dword|=this.plane1[t]<<8,this.latch_dword|=this.plane2[t]<<16,this.latch_dword|=this.plane3[t]<<24,this.planar_mode&8?(e=255,this.color_dont_care&1&&(e&=this.plane0[t]^~(this.color_compare&1?255:0)),this.color_dont_care&2&&(e&=this.plane1[t]^~(this.color_compare&2?255:0)),this.color_dont_care&4&&(e&=this.plane2[t]^~(this.color_compare&4?255:0)),this.color_dont_care&8&&(e&=this.plane3[t]^~(this.color_compare&8?255:0)),e):(e=this.plane_read,this.graphical_mode?this.sequencer_memory_mode&8?(e=t&3,t&=-4):this.planar_mode&16&&(e=t&1,t&=-2):e&=3,this.vga_memory[e<<16|t]))};q.prototype.vga_memory_write=function(t,e){if(this.svga_enabled)this.cpu.write8((t-655360|this.svga_bank_offset)+3758096384|0,e);else{var i=this.miscellaneous_graphics_register>>2&3;t-=Ds[i],0>t||t>=Di[i]?(a(t),a(e)):this.graphical_mode?this.vga_memory_write_graphical(t,e):this.plane_write_bm&3?this.vga_memory_write_text_mode(t,e):this.plane_write_bm&4&&(this.plane2[t]=e)}};q.prototype.vga_memory_write_graphical=function(t,e){var i=this.planar_mode&3,s=this.apply_feed(this.planar_bitmap),r=this.apply_expand(this.planar_setreset),n=this.apply_expand(this.planar_setreset_enable);switch(i){case 0:e=this.apply_rotate(e);var o=this.apply_feed(e);o=this.apply_setreset(o,n),o=this.apply_logical(o,this.latch_dword),o=this.apply_bitmask(o,s);break;case 1:o=this.latch_dword;break;case 2:o=this.apply_expand(e),o=this.apply_logical(o,this.latch_dword),o=this.apply_bitmask(o,s);break;case 3:e=this.apply_rotate(e),s&=this.apply_feed(e),o=this.apply_bitmask(r,s)}switch(e=15,this.sequencer_memory_mode&12){case 0:e=5<<(t&1),t&=-2;break;case 8:case 12:e=1<<(t&3),t&=-4}e&=this.plane_write_bm,e&1&&(this.plane0[t]=o>>0&255),e&2&&(this.plane1[t]=o>>8&255),e&4&&(this.plane2[t]=o>>16&255),e&8&&(this.plane3[t]=o>>24&255),t=this.vga_addr_to_pixel(t),this.partial_replot(t,t+7)};q.prototype.apply_feed=function(t){return t|t<<8|t<<16|t<<24};q.prototype.apply_expand=function(t){return(t&1?255:0)|(t&2?255:0)<<8|(t&4?255:0)<<16|(t&8?255:0)<<24};q.prototype.apply_rotate=function(t){return(t|t<<8)>>>(this.planar_rotate_reg&7)&255};q.prototype.apply_setreset=function(t,e){var i=this.apply_expand(this.planar_setreset);return(t|e&i)&(~e|i)};q.prototype.apply_logical=function(t,e){switch(this.planar_rotate_reg&24){case 8:return t&e;case 16:return t|e;case 24:return t^e}return t};q.prototype.apply_bitmask=function(t,e){return e&t|~e&this.latch_dword};q.prototype.text_mode_redraw=function(){let t=this.scan_line_to_screen_row(this.line_compare),e=Math.max(0,2*(2*this.offset_register-this.max_cols)),i=this.attribute_mode&8,s=this.font_page_ab_enabled?7:15,r=i?7:15,n=this.screen.FLAG_BLINKING,o=this.screen.FLAG_FONT_PAGE_B,h=this.start_address<<1;for(let _=0;_<this.max_rows;_++){_===t&&(h=0);for(let c=0;c<this.max_cols;c++){let d=this.vga_memory[h],p=this.vga_memory[h|1],f=(i&&p&128?n:0)|(!this.font_page_ab_enabled||p&8?0:o);this.bus.send("screen-put-char",[_,c,d]),this.screen.put_char(_,c,d,f,this.vga256_palette[this.dac_mask&this.dac_map[p>>4&r]],this.vga256_palette[this.dac_mask&this.dac_map[p&s]]),h+=2}h+=e}};q.prototype.vga_memory_write_text_mode=function(t,e){this.vga_memory[t]=e;var i=Math.max(this.max_cols,2*this.offset_register);let s;if(t>>1>=this.start_address){var r=(t>>1)-this.start_address;s=r/i|0,i=r%i}else r=t>>1,s=(r/i|0)+this.scan_line_to_screen_row(this.line_compare),i=r%i;if(!(i>=this.max_cols||s>=this.max_rows)){t&1?(r=e,e=this.vga_memory[t&-2]):r=this.vga_memory[t|1];var n=this.attribute_mode&8;t=(n&&r&128?this.screen.FLAG_BLINKING:0)|(!this.font_page_ab_enabled||r&8?0:this.screen.FLAG_FONT_PAGE_B);var o=this.font_page_ab_enabled?7:15;n=n?7:15,this.bus.send("screen-put-char",[s,i,e]),this.screen.put_char(s,i,e,t,this.vga256_palette[this.dac_mask&this.dac_map[r>>4&n]],this.vga256_palette[this.dac_mask&this.dac_map[r&o]])}};q.prototype.update_cursor=function(){var t=Math.max(this.max_cols,2*this.offset_register);let e;this.cursor_address>=this.start_address?(e=(this.cursor_address-this.start_address)/t|0,t=(this.cursor_address-this.start_address)%t):(e=(this.cursor_address/t|0)+this.scan_line_to_screen_row(this.line_compare),t=this.cursor_address%t),this.screen.update_cursor(e,t)};q.prototype.complete_redraw=function(){this.graphical_mode?this.svga_enabled?this.cpu.svga_mark_dirty():(this.diff_addr_min=0,this.diff_addr_max=524288):this.text_mode_redraw()};q.prototype.complete_replot=function(){this.graphical_mode&&!this.svga_enabled&&(this.diff_plot_min=0,this.diff_plot_max=524288,this.complete_redraw())};q.prototype.partial_redraw=function(t,e){t<this.diff_addr_min&&(this.diff_addr_min=t),e>this.diff_addr_max&&(this.diff_addr_max=e)};q.prototype.partial_replot=function(t,e){t<this.diff_plot_min&&(this.diff_plot_min=t),e>this.diff_plot_max&&(this.diff_plot_max=e),this.partial_redraw(t,e)};q.prototype.reset_diffs=function(){this.diff_addr_min=this.vga_memory_size,this.diff_addr_max=0,this.diff_plot_min=this.vga_memory_size,this.diff_plot_max=0};q.prototype.destroy=function(){};q.prototype.vga_bytes_per_line=function(){var t=this.offset_register<<2;return this.underline_location_register&64?t<<=1:this.crtc_mode&64&&(t>>>=1),t};q.prototype.vga_addr_shift_count=function(){var t=128+(~this.underline_location_register&this.crtc_mode&64);return t-=this.underline_location_register&64,t-=this.attribute_mode&64,t>>>6};q.prototype.vga_addr_to_pixel=function(t){var e=this.vga_addr_shift_count();if(~this.crtc_mode&3){var i=t-this.start_address;i&=this.crtc_mode<<13|-24577,i<<=e;var s=i/this.virtual_width|0;switch(i%=this.virtual_width,this.crtc_mode&3){case 2:s=s<<1|t>>13&1;break;case 1:s=s<<1|t>>14&1;break;case 0:s=s<<2|t>>13&3}return s*this.virtual_width+i+(this.start_address<<e)}return t<<e};q.prototype.scan_line_to_screen_row=function(t){return this.max_scan_line&128&&(t>>>=1),t=Math.ceil(t/(1+(this.max_scan_line&31))),this.crtc_mode&1||(t<<=1),this.crtc_mode&2||(t<<=1),t};q.prototype.set_size_text=function(t,e){this.max_cols=t,this.max_rows=e,this.screen.set_size_text(t,e),this.bus.send("screen-set-size",[t,e,0])};q.prototype.set_size_graphical=function(t,e,i,s,r){if(i=Math.max(i,1),s=Math.max(s,1),this.screen_width!==t||this.screen_height!==e||this.virtual_width!==i||this.virtual_height!==s){if(this.screen_width=t,this.screen_height=e,this.virtual_width=i,this.virtual_height=s,typeof ImageData<"u"){let n=i*s,o=this.cpu.svga_allocate_dest_buffer(n)>>>0;this.dest_buffet_offset=o,this.image_data=new ImageData(new Uint8ClampedArray(this.cpu.wasm_memory.buffer,o,4*n),i,s),this.cpu.svga_mark_dirty()}this.screen.set_size_graphical(t,e,i,s),this.bus.send("screen-set-size",[t,e,r])}};q.prototype.update_vga_size=function(){if(!this.svga_enabled){var t=Math.min(1+this.horizontal_display_enable_end,this.horizontal_blank_start),e=Math.min(1+this.vertical_display_enable_end,this.vertical_blank_start);if(t&&e)if(this.graphical_mode){t<<=3;var i=this.offset_register<<4,s=4;this.attribute_mode&64?(t>>>=1,i>>>=1,s=8):this.attribute_mode&2&&(s=1),e=this.scan_line_to_screen_row(e);var r=Di[0];let n=this.vga_bytes_per_line();this.set_size_graphical(t,e,i,n?Math.ceil(r/n):e,s),this.update_vertical_retrace(),this.update_layers()}else this.max_scan_line&128&&(e>>>=1),i=e/(1+(this.max_scan_line&31))|0,t&&i&&this.set_size_text(t,i)}};q.prototype.update_layers=function(){if(this.graphical_mode||this.text_mode_redraw(),this.svga_enabled)this.layers=[];else if(this.virtual_width&&this.screen_width)if(!this.palette_source||this.clocking_mode&32)this.layers=[],this.screen.clear_screen();else{var t=this.start_address_latched,e=this.horizontal_panning;this.attribute_mode&64&&(e>>>=1);var i=this.preset_row_scan>>5&3,s=this.vga_addr_to_pixel(t+i);t=s/this.virtual_width|0;var r=s%this.virtual_width+e;s=this.scan_line_to_screen_row(1+this.line_compare),s=Math.min(s,this.screen_height);var n=this.screen_height-s;this.layers=[],r=-r;for(var o=0;r<this.screen_width;r+=this.virtual_width,o++)this.layers.push({image_data:this.image_data,screen_x:r,screen_y:0,buffer_x:0,buffer_y:t+o,buffer_width:this.virtual_width,buffer_height:s});for(t=0,this.attribute_mode&32||(t=this.vga_addr_to_pixel(i)+e),r=-t,o=0;r<this.screen_width;r+=this.virtual_width,o++)this.layers.push({image_data:this.image_data,screen_x:r,screen_y:s,buffer_x:0,buffer_y:o,buffer_width:this.virtual_width,buffer_height:n})}};q.prototype.update_vertical_retrace=function(){this.port_3DA_value|=8,this.start_address_latched!==this.start_address&&(this.start_address_latched=this.start_address,this.update_layers())};q.prototype.update_cursor_scanline=function(){var t=this.max_scan_line&31;let e=Math.min(t,this.cursor_scanline_start&31);t=Math.min(t,this.cursor_scanline_end&31),this.screen.update_cursor_scanline(e,t,!(this.cursor_scanline_start&32)&&e<t)};q.prototype.port3C0_write=function(t){if(this.attribute_controller_index===-1)a(t),this.attribute_controller_index=t&31,a(this.attribute_controller_index),this.palette_source!==(t&32)&&(this.palette_source=t&32,this.update_layers());else{if(16>this.attribute_controller_index)a(this.attribute_controller_index),a(t),this.dac_map[this.attribute_controller_index]=t,this.attribute_mode&64||this.complete_redraw();else switch(this.attribute_controller_index){case 16:if(a(t),this.attribute_mode!==t){var e=this.attribute_mode;this.attribute_mode=t;let i=(t&1)!==0;this.svga_enabled||this.graphical_mode===i||(this.graphical_mode=i,this.screen.set_mode(this.graphical_mode)),(e^t)&64&&this.complete_replot(),this.update_vga_size(),this.complete_redraw(),this.set_font_bitmap(!1)}break;case 18:a(t),this.color_plane_enable!==t&&(this.color_plane_enable=t,this.complete_redraw());break;case 19:a(t),this.horizontal_panning!==t&&(this.horizontal_panning=t&15,this.update_layers());break;case 20:a(t),this.color_select!==t&&(this.color_select=t,this.complete_redraw());break;default:a(this.attribute_controller_index),a(t)}this.attribute_controller_index=-1}};q.prototype.port3C0_read=function(){return(this.attribute_controller_index|this.palette_source)&255};q.prototype.port3C0_read16=function(){return this.port3C0_read()|this.port3C1_read()<<8&65280};q.prototype.port3C1_read=function(){if(16>this.attribute_controller_index)return a(this.attribute_controller_index),a(this.dac_map[this.attribute_controller_index]),this.dac_map[this.attribute_controller_index]&255;switch(this.attribute_controller_index){case 16:return a(this.attribute_mode),this.attribute_mode;case 18:return a(this.color_plane_enable),this.color_plane_enable;case 19:return a(this.horizontal_panning),this.horizontal_panning;case 20:return a(this.color_select),this.color_select;default:a(this.attribute_controller_index)}return 255};q.prototype.port3C2_write=function(t){a(t),this.miscellaneous_output_register=t};q.prototype.port3C4_write=function(t){this.sequencer_index=t};q.prototype.port3C4_read=function(){return this.sequencer_index};q.prototype.port3C5_write=function(t){switch(this.sequencer_index){case 1:a(t);var e=this.clocking_mode;this.clocking_mode=t,(e^t)&32&&this.update_layers(),this.set_font_bitmap(!1);break;case 2:a(t),e=this.plane_write_bm,this.plane_write_bm=t,this.graphical_mode||!(e&4)||this.plane_write_bm&4||this.set_font_bitmap(!0);break;case 3:a(t),e=this.character_map_select,this.character_map_select=t,this.graphical_mode||e===t||this.set_font_page();break;case 4:a(t),this.sequencer_memory_mode=t;break;default:a(this.sequencer_index),a(t)}};q.prototype.port3C5_read=function(){switch(a(this.sequencer_index),this.sequencer_index){case 1:return this.clocking_mode;case 2:return this.plane_write_bm;case 3:return this.character_map_select;case 4:return this.sequencer_memory_mode;case 6:return 18}return 0};q.prototype.port3C6_write=function(t){this.dac_mask!==t&&(this.dac_mask=t,this.complete_redraw())};q.prototype.port3C6_read=function(){return this.dac_mask};q.prototype.port3C7_write=function(t){a(t),this.dac_color_index_read=3*t,this.dac_state&=0};q.prototype.port3C7_read=function(){return this.dac_state};q.prototype.port3C8_write=function(t){this.dac_color_index_write=3*t,this.dac_state|=3};q.prototype.port3C8_read=function(){return this.dac_color_index_write/3&255};q.prototype.port3C9_write=function(t){var e=this.dac_color_index_write/3|0,i=this.dac_color_index_write%3,s=this.vga256_palette[e];if(!(this.dispi_enable_value&32)){t&=63;let r=t&1;t=t<<2|r<<1|r}i===0?s=s&-16711681|t<<16:i===1?s=s&-65281|t<<8:(s=s&-256|t,a(e),a(s)),this.vga256_palette[e]!==s&&(this.vga256_palette[e]=s,this.complete_redraw()),this.dac_color_index_write++};q.prototype.port3C9_read=function(){var t=this.vga256_palette[this.dac_color_index_read/3|0]>>8*(2-this.dac_color_index_read%3)&255;return this.dac_color_index_read++,this.dispi_enable_value&32?t:t>>2};q.prototype.port3CC_read=function(){return this.miscellaneous_output_register};q.prototype.port3CE_write=function(t){this.graphics_index=t};q.prototype.port3CE_read=function(){return this.graphics_index};q.prototype.port3CF_write=function(t){switch(this.graphics_index){case 0:this.planar_setreset=t,a(t);break;case 1:this.planar_setreset_enable=t,a(t);break;case 2:this.color_compare=t,a(t);break;case 3:this.planar_rotate_reg=t,a(t);break;case 4:this.plane_read=t,a(t);break;case 5:var e=this.planar_mode;this.planar_mode=t,a(t),(e^t)&96&&this.complete_replot();break;case 6:a(t),this.miscellaneous_graphics_register!==t&&(this.miscellaneous_graphics_register=t,this.update_vga_size());break;case 7:this.color_dont_care=t,a(t);break;case 8:this.planar_bitmap=t,a(t);break;default:a(this.graphics_index),a(t)}};q.prototype.port3CF_read=function(){switch(a(this.graphics_index),this.graphics_index){case 0:return this.planar_setreset;case 1:return this.planar_setreset_enable;case 2:return this.color_compare;case 3:return this.planar_rotate_reg;case 4:return this.plane_read;case 5:return this.planar_mode;case 6:return this.miscellaneous_graphics_register;case 7:return this.color_dont_care;case 8:return this.planar_bitmap}return 0};q.prototype.port3D4_write=function(t){this.index_crtc=t};q.prototype.port3D4_write16=function(t){this.port3D4_write(t&255),this.port3D5_write(t>>8&255)};q.prototype.port3D4_read=function(){return this.index_crtc};q.prototype.port3D5_write=function(t){switch(this.index_crtc){case 1:a(t),this.horizontal_display_enable_end!==t&&(this.horizontal_display_enable_end=t,this.update_vga_size());break;case 2:this.horizontal_blank_start!==t&&(this.horizontal_blank_start=t,this.update_vga_size());break;case 7:a(t);var e=this.vertical_display_enable_end;this.vertical_display_enable_end&=255,this.vertical_display_enable_end=this.vertical_display_enable_end|t<<3&512|t<<7&256,e!==this.vertical_display_enable_end&&this.update_vga_size(),this.line_compare=this.line_compare&767|t<<4&256,e=this.vertical_blank_start,this.vertical_blank_start=this.vertical_blank_start&767|t<<5&256,e!==this.vertical_blank_start&&this.update_vga_size(),this.update_layers();break;case 8:a(t),this.preset_row_scan=t,this.update_layers();break;case 9:a(t);var i=this.max_scan_line;this.max_scan_line=t,this.line_compare=this.line_compare&511|t<<3&512,e=this.vertical_blank_start,this.vertical_blank_start=this.vertical_blank_start&511|t<<4&512,((i^this.max_scan_line)&159||e!==this.vertical_blank_start)&&this.update_vga_size(),this.update_cursor_scanline(),this.update_layers(),this.set_font_bitmap(!1);break;case 10:a(t),this.cursor_scanline_start=t,this.update_cursor_scanline();break;case 11:a(t),this.cursor_scanline_end=t,this.update_cursor_scanline();break;case 12:(this.start_address>>8&255)!==t&&(this.start_address=this.start_address&255|t<<8,this.update_layers(),~this.crtc_mode&3&&this.complete_replot()),a(t),a(this.start_address,4);break;case 13:(this.start_address&255)!==t&&(this.start_address=this.start_address&65280|t,this.update_layers(),~this.crtc_mode&3&&this.complete_replot()),a(t),a(this.start_address,4);break;case 14:a(t),this.cursor_address=this.cursor_address&255|t<<8,this.update_cursor();break;case 15:a(t),this.cursor_address=this.cursor_address&65280|t,this.update_cursor();break;case 18:a(t),(this.vertical_display_enable_end&255)!==t&&(this.vertical_display_enable_end=this.vertical_display_enable_end&768|t,this.update_vga_size());break;case 19:a(t),this.offset_register!==t&&(this.offset_register=t,this.update_vga_size(),~this.crtc_mode&3&&this.complete_replot());break;case 20:a(t),this.underline_location_register!==t&&(e=this.underline_location_register,this.underline_location_register=t,this.update_vga_size(),(e^t)&64&&this.complete_replot());break;case 21:a(t),(this.vertical_blank_start&255)!==t&&(this.vertical_blank_start=this.vertical_blank_start&768|t,this.update_vga_size());break;case 23:a(t),this.crtc_mode!==t&&(e=this.crtc_mode,this.crtc_mode=t,this.update_vga_size(),(e^t)&67&&this.complete_replot());break;case 24:a(t),this.line_compare=this.line_compare&768|t,this.update_layers();break;default:this.index_crtc<this.crtc.length&&(this.crtc[this.index_crtc]=t),a(this.index_crtc),a(t)}};q.prototype.port3D5_write16=function(t){a(t,4),this.port3D5_write(t&255)};q.prototype.port3D5_read=function(){switch(a(this.index_crtc),this.index_crtc){case 1:return this.horizontal_display_enable_end;case 2:return this.horizontal_blank_start;case 7:return this.vertical_display_enable_end>>7&2|this.vertical_blank_start>>5&8|this.line_compare>>4&16|this.vertical_display_enable_end>>3&64;case 8:return this.preset_row_scan;case 9:return this.max_scan_line;case 10:return this.cursor_scanline_start;case 11:return this.cursor_scanline_end;case 12:return this.start_address&255;case 13:return this.start_address>>8;case 14:return this.cursor_address>>8;case 15:return this.cursor_address&255;case 18:return this.vertical_display_enable_end&255;case 19:return this.offset_register;case 20:return this.underline_location_register;case 21:return this.vertical_blank_start&255;case 23:return this.crtc_mode;case 24:return this.line_compare&255}return this.index_crtc<this.crtc.length?this.crtc[this.index_crtc]:0};q.prototype.port3D5_read16=function(){return this.port3D5_read()};q.prototype.port3DA_read=function(){var t=this.port_3DA_value;return this.graphical_mode?(this.port_3DA_value^=1,this.port_3DA_value&=1):(this.port_3DA_value&1&&(this.port_3DA_value^=8),this.port_3DA_value^=1),this.attribute_controller_index=-1,t};q.prototype.port1CE_write=function(t){this.dispi_index=t};q.prototype.port1CF_write=function(t){a(this.dispi_index),a(t);let e=this.svga_enabled;switch(this.dispi_index){case 0:45248<=t&&45253>=t?this.svga_version=t:a(t);break;case 1:this.svga_width=t,2560<this.svga_width&&(this.svga_width=2560);break;case 2:this.svga_height=t,1600<this.svga_height&&(this.svga_height=1600);break;case 3:this.svga_bpp=t;break;case 4:(this.svga_enabled=(t&1)===1)&&!(t&128)&&this.svga_memory.fill(0),this.dispi_enable_value=t;break;case 5:a(t<<16),this.svga_bank_offset=t<<16;break;case 8:a(t),this.svga_offset_x!==t&&(this.svga_offset_x=t,this.svga_offset=this.svga_offset_y*this.svga_width+this.svga_offset_x,this.complete_redraw());break;case 9:a(t*this.svga_width),a(t),this.svga_offset_y!==t&&(this.svga_offset_y=t,this.svga_offset=this.svga_offset_y*this.svga_width+this.svga_offset_x,this.complete_redraw());break;default:a(this.dispi_index)}!this.svga_enabled||this.svga_width&&this.svga_height||(this.svga_enabled=!1),this.svga_enabled&&!e&&(this.svga_offset_y=this.svga_offset_x=this.svga_offset=0,this.graphical_mode=!0,this.screen.set_mode(this.graphical_mode),this.set_size_graphical(this.svga_width,this.svga_height,this.svga_width,this.svga_height,this.svga_bpp)),this.svga_enabled||(this.svga_bank_offset=0),this.update_layers()};q.prototype.port1CF_read=function(){return a(this.dispi_index),this.svga_register_read(this.dispi_index)};q.prototype.svga_register_read=function(t){switch(t){case 0:return this.svga_version;case 1:return this.dispi_enable_value&2?2560:this.svga_width;case 2:return this.dispi_enable_value&2?1600:this.svga_height;case 3:return this.dispi_enable_value&2?32:this.svga_bpp;case 4:return this.dispi_enable_value;case 5:return this.svga_bank_offset>>>16;case 6:return this.screen_width?this.screen_width:1;case 8:return this.svga_offset_x;case 9:return this.svga_offset_y;case 10:return this.vga_memory_size/65536|0;default:a(this.dispi_index)}return 255};q.prototype.vga_replot=function(){for(var t=this.diff_plot_min&-16,e=Math.min(this.diff_plot_max|15,524287),i=this.vga_addr_shift_count(),s=~this.crtc_mode&3,r=this.planar_mode&96,n=this.attribute_mode&64;t<=e;){var o=t>>>i;if(s){var h=t/this.virtual_width|0,_=t-this.virtual_width*h;switch(s){case 1:o=(h&1)<<13,h>>>=1;break;case 2:o=(h&1)<<14,h>>>=1;break;case 3:o=(h&3)<<13,h>>>=2}o|=(h*this.virtual_width+_>>>i)+this.start_address}h=this.plane0[o],_=this.plane1[o];var c=this.plane2[o],d=this.plane3[o];switch(o=new Uint8Array(8),r){case 0:h<<=0,_<<=1,c<<=2,d<<=3;for(var p=7;0<=p;p--)o[7-p]=h>>p&1|_>>p&2|c>>p&4|d>>p&8;break;case 32:o[0]=h>>6&3|c>>4&12,o[1]=h>>4&3|c>>2&12,o[2]=h>>2&3|c>>0&12,o[3]=h>>0&3|c<<2&12,o[4]=_>>6&3|d>>4&12,o[5]=_>>4&3|d>>2&12,o[6]=_>>2&3|d>>0&12,o[7]=_>>0&3|d<<2&12;break;case 64:case 96:o[0]=h>>4&15,o[1]=h>>0&15,o[2]=_>>4&15,o[3]=_>>0&15,o[4]=c>>4&15,o[5]=c>>0&15,o[6]=d>>4&15,o[7]=d>>0&15}if(n)for(h=p=0;4>p;p++,t++,h+=2)this.pixel_buffer[t]=o[h]<<4|o[h+1];else for(p=0;8>p;p++,t++)this.pixel_buffer[t]=o[p]}};q.prototype.vga_redraw=function(){var t=this.diff_addr_min,e=Math.min(this.diff_addr_max,524287);let i=new Int32Array(this.cpu.wasm_memory.buffer,this.dest_buffet_offset,this.virtual_width*this.virtual_height);var s=255,r=0;if(this.attribute_mode&128&&(s&=207,r|=this.color_select<<4&48),this.attribute_mode&64)for(;t<=e;t++){var n=this.pixel_buffer[t]&s|r;n=this.vga256_palette[n],i[t]=n&65280|n<<16|n>>16|4278190080}else for(s&=63,r|=this.color_select<<4&192;t<=e;t++)n=this.dac_map[this.pixel_buffer[t]&this.color_plane_enable]&s|r,n=this.vga256_palette[n],i[t]=n&65280|n<<16|n>>16|4278190080};q.prototype.screen_fill_buffer=function(){if(this.graphical_mode){if(this.image_data.data.byteLength===0){var t=new Uint8ClampedArray(this.cpu.wasm_memory.buffer,this.dest_buffet_offset,4*this.virtual_width*this.virtual_height);this.image_data=new ImageData(t,this.virtual_width,this.virtual_height),this.update_layers()}if(this.svga_enabled){t=0;let s=this.svga_height;if(this.svga_bpp===8){let r=new Int32Array(this.cpu.wasm_memory.buffer,this.dest_buffet_offset,this.screen_width*this.screen_height),n=new Uint8Array(this.cpu.wasm_memory.buffer,this.svga_memory.byteOffset,this.vga_memory_size);for(var e=0;e<r.length;e++){var i=this.vga256_palette[n[e]];r[e]=i&65280|i<<16|i>>16|4278190080}}else this.cpu.svga_fill_pixel_buffer(this.svga_bpp,this.svga_offset),e=this.svga_bpp===15?2:this.svga_bpp/8,t=((this.cpu.svga_dirty_bitmap_min_offset[0]/e|0)-this.svga_offset)/this.svga_width|0,s=(((this.cpu.svga_dirty_bitmap_max_offset[0]/e|0)-this.svga_offset)/this.svga_width|0)+1;t<s&&(t=Math.max(t,0),s=Math.min(s,this.svga_height),this.screen.update_buffer([{image_data:this.image_data,screen_x:0,screen_y:t,buffer_x:0,buffer_y:t,buffer_width:this.svga_width,buffer_height:s-t}]))}else this.vga_replot(),this.vga_redraw(),this.screen.update_buffer(this.layers);this.reset_diffs()}this.update_vertical_retrace()};q.prototype.set_font_bitmap=function(t){let e=this.max_scan_line&31;if(e&&!this.graphical_mode){let i=!!(this.clocking_mode&8);this.screen.set_font_bitmap(e+1,!i&&!(this.clocking_mode&1),i,!!(this.attribute_mode&4),this.plane2,t)}};q.prototype.set_font_page=function(){let t=[0,2,4,6,1,3,5,7],e=(this.character_map_select&12)>>2|(this.character_map_select&32)>>3,i=this.character_map_select&3|(this.character_map_select&16)>>2;this.font_page_ab_enabled=e!==i,this.screen.set_font_page(t[e],t[i]),this.complete_redraw()};var Cr="SWAP_IN SWAP_OUT MAJFLT MINFLT MEMFREE MEMTOT AVAIL CACHES HTLB_PGALLOC HTLB_PGFAIL".split(" ");function pe(t,e){this.bus=e,this.zeroed=this.fp_cmd=this.actual=this.num_pages=0,this.virtio=new vt(t,{name:"virtio-balloon",pci_id:88,device_id:4165,subsystem_device_id:5,common:{initial_port:55296,queues:[{size_supported:32,notify_offset:0},{size_supported:32,notify_offset:0},{size_supported:2,notify_offset:1},{size_supported:64,notify_offset:2}],features:[1,3,32],on_driver_ok:()=>{}},notification:{initial_port:55552,single_handler:!1,handlers:[i=>{let s=this.virtio.queues[i];for(;s.has_request();){var r=s.pop_request();let n=new Uint8Array(r.length_readable);r.get_next_blob(n),this.virtio.queues[i].push_reply(r),r=n.byteLength/4,this.actual+=i===0?r:-r}this.virtio.queues[i].flush_replies()},i=>{var s=this.virtio.queues[i];if(s.has_request()){s=s.pop_request();let r=new Uint8Array(s.length_readable);s.get_next_blob(r);let n={};for(let o=0;o<s.length_readable;o+=10){let[h,_]=K(["h","d"],r,{offset:o});n[Cr[h]]=_}this.virtio.queues[i].push_reply(s),this.stats_cb&&this.stats_cb(n)}},i=>{let s=this.virtio.queues[i];for(;s.has_request();){let n=s.pop_request();if(0<n.length_readable){var r=new Uint8Array(n.length_readable);n.get_next_blob(r),[r]=K(["w"],r,{offset:0}),r===0&&(this.free_cb&&this.free_cb(this.zeroed),1<this.fp_cmd&&(this.fp_cmd=1),this.virtio.notify_config_changes())}if(0<n.length_writable)for(new Uint8Array(0),r=0;r<n.write_buffers.length;++r){let o=n.write_buffers[r];this.zeroed+=o.len,this.virtio.cpu.zero_memory(o.addr_low,o.len)}this.virtio.queues[i].push_reply(n)}this.virtio.queues[i].flush_replies()}]},isr_status:{initial_port:55040},device_specific:{initial_port:54784,struct:[{bytes:4,name:"num_pages",read:()=>this.num_pages,write:()=>{}},{bytes:4,name:"actual",read:()=>this.actual,write:()=>{}},{bytes:4,name:"free_page_hint_cmd_id",read:()=>this.fp_cmd,write:()=>{}}]}})}pe.prototype.Inflate=function(t){this.num_pages+=t,this.virtio.notify_config_changes()};pe.prototype.Deflate=function(t){this.num_pages-=t,this.virtio.notify_config_changes()};pe.prototype.Cleanup=function(t){this.fp_cmd=2,this.free_cb=t,this.zeroed=0,this.virtio.notify_config_changes()};pe.prototype.get_state=function(){let t=[];return t[0]=this.virtio,t[1]=this.num_pages,t[2]=this.actual,t};pe.prototype.set_state=function(t){this.virtio.set_state(t[0]),this.num_pages=t[1],this.actual=t[2]};pe.prototype.GetStats=function(t){for(this.stats_cb=t,t=this.virtio.queues[2];t.has_request();){let e=t.pop_request();this.virtio.queues[2].push_reply(e)}this.virtio.queues[2].flush_replies()};pe.prototype.Reset=function(){};function Pr(t,e,i,s){var r=new Uint8Array(e);let n=new Uint16Array(e);var o=new Uint32Array(e),h=r[497]||4,_=n[255];if(_!==43605)a(_);else if(_=n[257]|n[258]<<16,_!==1400005704)a(_);else{_=n[259];var c=r[529],d=n[283],p=o[139],f=o[140],g=r[565],x=518<=_?o[142]:255,b=o[146],w=o[147],F=o[150],A=o[151],S=o[152];for(a(_),a(c),a(d),a(o[133]),a(p),a(f),a(g),a(x),a(b),a(w),a(A),a(F),a(S),r[528]=255,r[529]=c&-97|128,n[274]=56832,n[253]=65535,a(56832),s+="\0",a(581632),o[138]=581632,r=0;r<s.length;r++)t[581632+r]=s.charCodeAt(r);for(h=512*(h+1),a(h),s=new Uint8Array(e,0,h),e=new Uint8Array(e,h),r=h=0,i&&(h=67108864,r=i.byteLength,t.set(new Uint8Array(i),h)),o[134]=h,o[135]=r,t.set(s,524288),t.set(e,1048576),t=new Uint8Array(512),new Uint16Array(t.buffer)[0]=43605,t[2]=1,i=3,t[i++]=250,t[i++]=184,t[i++]=32768,t[i++]=128,t[i++]=142,t[i++]=192,t[i++]=142,t[i++]=216,t[i++]=142,t[i++]=224,t[i++]=142,t[i++]=232,t[i++]=142,t[i++]=208,t[i++]=188,t[i++]=57344,t[i++]=224,t[i++]=234,t[i++]=0,t[i++]=0,t[i++]=32800,t[i++]=128,o=t[i]=0,e=0;e<t.length;e++)o+=t[e];return t[i]=-o,{name:"genroms/kernel.bin",data:t}}}function M(t,e,i){this.stop_idling=i,this.wm=e,this.wasm_patch(),this.create_jit_imports(),this.wasm_memory=e=this.wm.exports.memory,this.memory_size=P(Uint32Array,e,812,1),this.mem8=new Uint8Array(0),this.mem32s=new Int32Array(this.mem8.buffer),this.segment_is_null=P(Uint8Array,e,724,8),this.segment_offsets=P(Int32Array,e,736,8),this.segment_limits=P(Uint32Array,e,768,8),this.segment_access_bytes=P(Uint8Array,e,512,8),this.protected_mode=P(Int32Array,e,800,1),this.idtr_size=P(Int32Array,e,564,1),this.idtr_offset=P(Int32Array,e,568,1),this.gdtr_size=P(Int32Array,e,572,1),this.gdtr_offset=P(Int32Array,e,576,1),this.tss_size_32=P(Int32Array,e,1128,1),this.page_fault=P(Uint32Array,e,540,8),this.cr=P(Int32Array,e,580,8),this.cpl=P(Uint8Array,e,612,1),this.is_32=P(Int32Array,e,804,1),this.stack_size_32=P(Int32Array,e,808,1),this.in_hlt=P(Uint8Array,e,616,1),this.last_virt_eip=P(Int32Array,e,620,1),this.eip_phys=P(Int32Array,e,624,1),this.sysenter_cs=P(Int32Array,e,636,1),this.sysenter_esp=P(Int32Array,e,640,1),this.sysenter_eip=P(Int32Array,e,644,1),this.prefixes=P(Int32Array,e,648,1),this.flags=P(Int32Array,e,120,1),this.flags_changed=P(Int32Array,e,100,1),this.last_op_size=P(Int32Array,e,96,1),this.last_op1=P(Int32Array,e,104,1),this.last_result=P(Int32Array,e,112,1),this.current_tsc=P(Uint32Array,e,960,2),this.devices={},this.instruction_pointer=P(Int32Array,e,556,1),this.previous_ip=P(Int32Array,e,560,1),this.apic_enabled=P(Uint8Array,e,548,1),this.acpi_enabled=P(Uint8Array,e,552,1),this.memory_map_read8=[],this.memory_map_write8=[],this.memory_map_read32=[],this.memory_map_write32=[],this.bios={main:null,vga:null},this.instruction_counter=P(Uint32Array,e,664,1),this.reg32=P(Int32Array,e,64,8),this.fpu_st=P(Int32Array,e,1152,32),this.fpu_stack_empty=P(Uint8Array,e,816,1),this.fpu_stack_empty[0]=255,this.fpu_stack_ptr=P(Uint8Array,e,1032,1),this.fpu_stack_ptr[0]=0,this.fpu_control_word=P(Uint16Array,e,1036,1),this.fpu_control_word[0]=895,this.fpu_status_word=P(Uint16Array,e,1040,1),this.fpu_status_word[0]=0,this.fpu_ip=P(Int32Array,e,1048,1),this.fpu_ip[0]=0,this.fpu_ip_selector=P(Int32Array,e,1052,1),this.fpu_ip_selector[0]=0,this.fpu_opcode=P(Int32Array,e,1044,1),this.fpu_opcode[0]=0,this.fpu_dp=P(Int32Array,e,1056,1),this.fpu_dp[0]=0,this.fpu_dp_selector=P(Int32Array,e,1060,1),this.fpu_dp_selector[0]=0,this.reg_xmm32s=P(Int32Array,e,832,32),this.mxcsr=P(Int32Array,e,824,1),this.sreg=P(Uint16Array,e,668,8),this.dreg=P(Int32Array,e,684,8),this.reg_pdpte=P(Int32Array,e,968,8),this.svga_dirty_bitmap_min_offset=P(Uint32Array,e,716,1),this.svga_dirty_bitmap_max_offset=P(Uint32Array,e,720,1),this.fw_value=[],this.fw_pointer=0,this.option_roms=[],this.io=void 0,this.bus=t,this.set_tsc(0,0)}M.prototype.mmap_read8=function(t){return this.memory_map_read8[t>>>17](t)};M.prototype.mmap_write8=function(t,e){this.memory_map_write8[t>>>17](t,e)};M.prototype.mmap_read16=function(t){var e=this.memory_map_read8[t>>>17];return e(t)|e(t+1|0)<<8};M.prototype.mmap_write16=function(t,e){var i=this.memory_map_write8[t>>>17];i(t,e&255),i(t+1|0,e>>8)};M.prototype.mmap_read32=function(t){return this.memory_map_read32[t>>>17](t)};M.prototype.mmap_write32=function(t,e){this.memory_map_write32[t>>>17](t,e)};M.prototype.mmap_write64=function(t,e,i){var s=this.memory_map_write32[t>>>17];s(t,e),s(t+4,i)};M.prototype.mmap_write128=function(t,e,i,s,r){var n=this.memory_map_write32[t>>>17];n(t,e),n(t+4,i),n(t+8,s),n(t+12,r)};M.prototype.write_blob=function(t,e){t.length&&(this.in_mapped_range(e),this.in_mapped_range(e+t.length-1),this.jit_dirty_cache(e,e+t.length),this.mem8.set(t,e))};M.prototype.read_blob=function(t,e){return e&&(this.in_mapped_range(t),this.in_mapped_range(t+e-1)),this.mem8.subarray(t,t+e)};M.prototype.clear_opstats=function(){new Uint8Array(this.wasm_memory.buffer,32768,131072).fill(0),this.wm.exports.profiler_init()};M.prototype.create_jit_imports=function(){let t=Object.create(null);t.m=this.wm.exports.memory;for(let e of Object.keys(this.wm.exports))e.startsWith("_")||e.startsWith("zstd")||e.endsWith("_js")||(t[e]=this.wm.exports[e]);this.jit_imports=t};M.prototype.wasm_patch=function(){let t=i=>this.wm.exports[i],e=i=>{let s=t(i);return console.assert(s,"Missing import: "+i),s};this.reset_cpu=e("reset_cpu"),this.getiopl=e("getiopl"),this.get_eflags=e("get_eflags"),this.handle_irqs=e("handle_irqs"),this.main_loop=e("main_loop"),this.set_jit_config=e("set_jit_config"),this.read8=e("read8"),this.read16=e("read16"),this.read32s=e("read32s"),this.write8=e("write8"),this.write16=e("write16"),this.write32=e("write32"),this.in_mapped_range=e("in_mapped_range"),this.fpu_load_tag_word=e("fpu_load_tag_word"),this.fpu_load_status_word=e("fpu_load_status_word"),this.fpu_get_sti_f64=e("fpu_get_sti_f64"),this.translate_address_system_read=e("translate_address_system_read_js"),this.get_seg_cs=e("get_seg_cs"),this.get_real_eip=e("get_real_eip"),this.clear_tlb=e("clear_tlb"),this.full_clear_tlb=e("full_clear_tlb"),this.update_state_flags=e("update_state_flags"),this.set_tsc=e("set_tsc"),this.store_current_tsc=e("store_current_tsc"),this.set_cpuid_level=e("set_cpuid_level"),this.pic_set_irq=e("pic_set_irq"),this.pic_clear_irq=e("pic_clear_irq"),this.jit_clear_cache=e("jit_clear_cache_js"),this.jit_dirty_cache=e("jit_dirty_cache"),this.codegen_finalize_finished=e("codegen_finalize_finished"),this.allocate_memory=e("allocate_memory"),this.zero_memory=e("zero_memory"),this.is_memory_zeroed=e("is_memory_zeroed"),this.svga_allocate_memory=e("svga_allocate_memory"),this.svga_allocate_dest_buffer=e("svga_allocate_dest_buffer"),this.svga_fill_pixel_buffer=e("svga_fill_pixel_buffer"),this.svga_mark_dirty=e("svga_mark_dirty"),this.get_pic_addr_master=e("get_pic_addr_master"),this.get_pic_addr_slave=e("get_pic_addr_slave"),this.zstd_create_ctx=e("zstd_create_ctx"),this.zstd_get_src_ptr=e("zstd_get_src_ptr"),this.zstd_free_ctx=e("zstd_free_ctx"),this.zstd_read=e("zstd_read"),this.zstd_read_free=e("zstd_read_free"),this.port20_read=e("port20_read"),this.port21_read=e("port21_read"),this.portA0_read=e("portA0_read"),this.portA1_read=e("portA1_read"),this.port20_write=e("port20_write"),this.port21_write=e("port21_write"),this.portA0_write=e("portA0_write"),this.portA1_write=e("portA1_write"),this.port4D0_read=e("port4D0_read"),this.port4D1_read=e("port4D1_read"),this.port4D0_write=e("port4D0_write"),this.port4D1_write=e("port4D1_write")};M.prototype.jit_force_generate=function(t){this.jit_force_generate_unsafe&&this.jit_force_generate_unsafe(t)};M.prototype.jit_clear_func=function(t){this.wm.wasm_table.set(t+1024,null)};M.prototype.jit_clear_all_funcs=function(){let t=this.wm.wasm_table;for(let e=0;900>e;e++)t.set(1024+e,null)};M.prototype.get_state=function(){var t=[];t[0]=this.memory_size[0],t[1]=new Uint8Array([...this.segment_is_null,...this.segment_access_bytes]),t[2]=this.segment_offsets,t[3]=this.segment_limits,t[4]=this.protected_mode[0],t[5]=this.idtr_offset[0],t[6]=this.idtr_size[0],t[7]=this.gdtr_offset[0],t[8]=this.gdtr_size[0],t[9]=this.page_fault[0],t[10]=this.cr,t[11]=this.cpl[0],t[13]=this.is_32[0],t[16]=this.stack_size_32[0],t[17]=this.in_hlt[0],t[18]=this.last_virt_eip[0],t[19]=this.eip_phys[0],t[22]=this.sysenter_cs[0],t[23]=this.sysenter_eip[0],t[24]=this.sysenter_esp[0],t[25]=this.prefixes[0],t[26]=this.flags[0],t[27]=this.flags_changed[0],t[28]=this.last_op1[0],t[30]=this.last_op_size[0],t[37]=this.instruction_pointer[0],t[38]=this.previous_ip[0],t[39]=this.reg32,t[40]=this.sreg,t[41]=this.dreg,t[42]=this.reg_pdpte,this.store_current_tsc(),t[43]=this.current_tsc,t[45]=this.devices.virtio_9p,t[46]=this.devices.apic,t[47]=this.devices.rtc,t[48]=this.devices.pci,t[49]=this.devices.dma,t[50]=this.devices.acpi,t[52]=this.devices.vga,t[53]=this.devices.ps2,t[54]=this.devices.uart0,t[55]=this.devices.fdc,this.devices.ide.secondary?t[85]=this.devices.ide:this.devices.ide.primary?.master.is_atapi?t[56]=this.devices.ide.primary:t[57]=this.devices.ide.primary,t[58]=this.devices.pit,t[59]=this.devices.net,t[60]=this.get_state_pic(),t[61]=this.devices.sb16,t[62]=this.fw_value,t[63]=this.devices.ioapic,t[64]=this.tss_size_32[0],t[66]=this.reg_xmm32s,t[67]=this.fpu_st,t[68]=this.fpu_stack_empty[0],t[69]=this.fpu_stack_ptr[0],t[70]=this.fpu_control_word[0],t[71]=this.fpu_ip[0],t[72]=this.fpu_ip_selector[0],t[73]=this.fpu_dp[0],t[74]=this.fpu_dp_selector[0],t[75]=this.fpu_opcode[0];let{packed_memory:e,bitmap:i}=this.pack_memory();return t[77]=e,t[78]=new Uint8Array(i.get_buffer()),t[79]=this.devices.uart1,t[80]=this.devices.uart2,t[81]=this.devices.uart3,t[82]=this.devices.virtio_console,t[83]=this.devices.virtio_net,t[84]=this.devices.virtio_balloon,t};M.prototype.get_state_pic=function(){let t=new Uint8Array(this.wasm_memory.buffer,this.get_pic_addr_master(),13),e=new Uint8Array(this.wasm_memory.buffer,this.get_pic_addr_slave(),13),i=[],s=[];return i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3],i[4]=t[4],i[5]=s,i[6]=t[6],i[7]=t[7],i[8]=t[8],i[9]=t[9],i[10]=t[10],i[11]=t[11],i[12]=t[12],s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=e[3],s[4]=e[4],s[5]=null,s[6]=e[6],s[7]=e[7],s[8]=e[8],s[9]=e[9],s[10]=e[10],s[11]=e[11],s[12]=e[12],i};M.prototype.set_state=function(t){if(this.memory_size[0]=t[0],this.mem8.length!==this.memory_size[0]&&console.warn("Note: Memory size mismatch. we="+this.mem8.length+" state="+this.memory_size[0]),t[1].length===8?(this.segment_is_null.set(t[1]),this.segment_access_bytes.fill(242),this.segment_access_bytes[1]=250):t[1].length===16&&(this.segment_is_null.set(t[1].subarray(0,8)),this.segment_access_bytes.set(t[1].subarray(8,16))),this.segment_offsets.set(t[2]),this.segment_limits.set(t[3]),this.protected_mode[0]=t[4],this.idtr_offset[0]=t[5],this.idtr_size[0]=t[6],this.gdtr_offset[0]=t[7],this.gdtr_size[0]=t[8],this.page_fault[0]=t[9],this.cr.set(t[10]),this.cpl[0]=t[11],this.is_32[0]=t[13],this.stack_size_32[0]=t[16],this.in_hlt[0]=t[17],this.last_virt_eip[0]=t[18],this.eip_phys[0]=t[19],this.sysenter_cs[0]=t[22],this.sysenter_eip[0]=t[23],this.sysenter_esp[0]=t[24],this.prefixes[0]=t[25],this.flags[0]=t[26],this.flags_changed[0]=t[27],this.last_op1[0]=t[28],this.last_op_size[0]=t[30],this.instruction_pointer[0]=t[37],this.previous_ip[0]=t[38],this.reg32.set(t[39]),this.sreg.set(t[40]),this.dreg.set(t[41]),t[42]&&this.reg_pdpte.set(t[42]),this.set_tsc(t[43][0],t[43][1]),this.devices.virtio_9p&&this.devices.virtio_9p.set_state(t[45]),this.devices.apic&&this.devices.apic.set_state(t[46]),this.devices.rtc&&this.devices.rtc.set_state(t[47]),this.devices.dma&&this.devices.dma.set_state(t[49]),this.devices.acpi&&this.devices.acpi.set_state(t[50]),this.devices.vga&&this.devices.vga.set_state(t[52]),this.devices.ps2&&this.devices.ps2.set_state(t[53]),this.devices.uart0&&this.devices.uart0.set_state(t[54]),this.devices.fdc&&this.devices.fdc.set_state(t[55]),t[56]||t[57]){var e=[[void 0,void 0],[void 0,void 0]];e[0][0]=t[56]?{is_cdrom:!0,buffer:this.devices.cdrom.buffer}:{is_cdrom:!1,buffer:this.devices.ide.primary.master.buffer},this.devices.ide=new si(this,this.devices.ide.bus,e),this.devices.cdrom=t[56]?this.devices.ide.primary.master:void 0,this.devices.ide.primary.set_state(t[56]||t[57])}else t[85]&&this.devices.ide.set_state(t[85]);this.devices.pci&&this.devices.pci.set_state(t[48]),this.devices.pit&&this.devices.pit.set_state(t[58]),this.devices.net&&this.devices.net.set_state(t[59]),this.set_state_pic(t[60]),this.devices.sb16&&this.devices.sb16.set_state(t[61]),this.devices.uart1&&this.devices.uart1.set_state(t[79]),this.devices.uart2&&this.devices.uart2.set_state(t[80]),this.devices.uart3&&this.devices.uart3.set_state(t[81]),this.devices.virtio_console&&this.devices.virtio_console.set_state(t[82]),this.devices.virtio_net&&this.devices.virtio_net.set_state(t[83]),this.devices.virtio_balloon&&this.devices.virtio_balloon.set_state(t[84]),this.fw_value=t[62],this.devices.ioapic&&this.devices.ioapic.set_state(t[63]),this.tss_size_32[0]=t[64],this.reg_xmm32s.set(t[66]),this.fpu_st.set(t[67]),this.fpu_stack_empty[0]=t[68],this.fpu_stack_ptr[0]=t[69],this.fpu_control_word[0]=t[70],this.fpu_ip[0]=t[71],this.fpu_ip_selector[0]=t[72],this.fpu_dp[0]=t[73],this.fpu_dp_selector[0]=t[74],this.fpu_opcode[0]=t[75],e=new je(t[78].buffer),this.unpack_memory(e,t[77]),this.update_state_flags(),this.full_clear_tlb(),this.jit_clear_cache()};M.prototype.set_state_pic=function(t){let e=new Uint8Array(this.wasm_memory.buffer,this.get_pic_addr_master(),13),i=new Uint8Array(this.wasm_memory.buffer,this.get_pic_addr_slave(),13);e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4];let s=t[5];e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],i[0]=s[0],i[1]=s[1],i[2]=s[2],i[3]=s[3],i[4]=s[4],i[6]=s[6],i[7]=s[7],i[8]=s[8],i[9]=s[9],i[10]=s[10],i[11]=s[11],i[12]=s[12]};M.prototype.pack_memory=function(){for(var t=this.mem8.length>>12,e=[],i=0;i<t;i++)this.is_memory_zeroed(i<<12,4096)||e.push(i);t=new je(t),i=new Uint8Array(e.length<<12);for(let[s,r]of e.entries())t.set(r,1),e=r<<12,e=this.mem8.subarray(e,e+4096),i.set(e,s<<12);return{bitmap:t,packed_memory:i}};M.prototype.unpack_memory=function(t,e){this.zero_memory(0,this.memory_size[0]);let i=this.memory_size[0]>>12,s=0;for(let n=0;n<i;n++)if(t.get(n)){var r=s<<12;r=e.subarray(r,r+4096),this.mem8.set(r,n<<12),s++}};M.prototype.reboot_internal=function(){this.reset_cpu(),this.fw_value=[],this.devices.virtio_9p&&this.devices.virtio_9p.reset(),this.devices.virtio_console&&this.devices.virtio_console.reset(),this.devices.virtio_net&&this.devices.virtio_net.reset(),this.devices.ps2&&this.devices.ps2.reset(),this.load_bios()};M.prototype.reset_memory=function(){this.mem8.fill(0)};M.prototype.create_memory=function(t,e){t<e?t=e:0>(t|0)&&(t=Math.pow(2,31)-131072),t=(t-1|131071)+1|0,console.assert(this.memory_size[0]===0,"Expected uninitialised memory"),this.memory_size[0]=t,e=this.allocate_memory(t),this.mem8=P(Uint8Array,this.wasm_memory,e,t),this.mem32s=P(Uint32Array,this.wasm_memory,e,t>>2)};M.prototype.init=function(t,e){this.create_memory(t.memory_size||67108864,t.initrd?67108864:1048576),t.disable_jit&&this.set_jit_config(0,1),t.cpuid_level&&this.set_cpuid_level(t.cpuid_level),this.acpi_enabled[0]=+t.acpi,this.reset_cpu();var i=new ft(this);if(this.io=i,this.bios.main=t.bios,this.bios.vga=t.vga_bios,this.load_bios(),t.bzimage){let r=Pr(this.mem8,t.bzimage,t.initrd,t.cmdline||"");r&&this.option_roms.push(r)}i.register_read(179,this,function(){return 0});var s=0;i.register_read(146,this,function(){return s}),i.register_write(146,this,function(r){s=r}),i.register_read(1297,this,function(){return this.fw_pointer<this.fw_value.length?this.fw_value[this.fw_pointer++]:0}),i.register_write(1296,this,void 0,function(r){function n(_){return new Uint8Array(Int32Array.of(_).buffer)}function o(_){return _>>8|_<<8&65280}function h(_){return _<<24|_<<8&16711680|_>>8&65280|_>>>24}if(""+a(r),this.fw_pointer=0,r===0)this.fw_value=n(1431127377);else if(r===1)this.fw_value=n(0);else if(r===3)this.fw_value=n(this.memory_size[0]);else if(r===5)this.fw_value=n(1);else if(r===15)this.fw_value=n(1);else if(r===13)this.fw_value=new Uint8Array(16);else if(r===25){r=new Int32Array(4+64*this.option_roms.length);let _=new Uint8Array(r.buffer);r[0]=h(this.option_roms.length);for(let c=0;c<this.option_roms.length;c++){let{name:d,data:p}=this.option_roms[c],f=4+64*c;r[f+0>>2]=h(p.length),r[f+4>>2]=o(49152+c);for(let g=0;g<d.length;g++)_[f+8+g]=d.charCodeAt(g)}this.fw_value=_}else 32768<=r&&49152>r?this.fw_value=n(0):49152<=r&&r-49152<this.option_roms.length?this.fw_value=this.option_roms[r-49152].data:(""+a(r),this.fw_value=n(0))}),i.register_read(32,this,this.port20_read),i.register_read(33,this,this.port21_read),i.register_read(160,this,this.portA0_read),i.register_read(161,this,this.portA1_read),i.register_write(32,this,this.port20_write),i.register_write(33,this,this.port21_write),i.register_write(160,this,this.portA0_write),i.register_write(161,this,this.portA1_write),i.register_read(1232,this,this.port4D0_read),i.register_read(1233,this,this.port4D1_read),i.register_write(1232,this,this.port4D0_write),i.register_write(1233,this,this.port4D1_write),this.devices={},t.load_devices&&(this.devices.pci=new Wt(this),this.acpi_enabled[0]&&(this.devices.ioapic=new ne(this),this.devices.apic=new At(this),this.devices.acpi=new Ve(this)),this.devices.rtc=new Lt(this),this.fill_cmos(this.devices.rtc,t),this.devices.dma=new nt(this),this.devices.vga=new q(this,e,t.screen,t.vga_memory_size||8388608),this.devices.ps2=new Ut(this,e),this.devices.uart0=new Mt(this,1016,e),t.uart1&&(this.devices.uart1=new Mt(this,760,e)),t.uart2&&(this.devices.uart2=new Mt(this,1e3,e)),t.uart3&&(this.devices.uart3=new Mt(this,744,e)),this.devices.fdc=new ht(this,t.fda,t.fdb),i=[[void 0,void 0],[void 0,void 0]],t.hda&&(i[0][0]={buffer:t.hda},i[0][1]={buffer:t.hdb}),i[1][0]={is_cdrom:!0,buffer:t.cdrom},this.devices.ide=new si(this,e,i),this.devices.cdrom=this.devices.ide.secondary.master,this.devices.pit=new Yt(this,e),t.net_device.type==="ne2k"?this.devices.net=new zt(this,e,t.preserve_mac_from_state_image,t.mac_address_translation):t.net_device.type==="virtio"&&(this.devices.virtio_net=new Te(this,e,t.preserve_mac_from_state_image)),t.fs9p?this.devices.virtio_9p=new Zt(t.fs9p,this,e):t.handle9p?this.devices.virtio_9p=new ri(t.handle9p,this):t.proxy9p&&(this.devices.virtio_9p=new Ft(t.proxy9p,this)),t.virtio_console&&(this.devices.virtio_console=new oe(this,e)),t.virtio_balloon&&(this.devices.virtio_balloon=new pe(this,e)),this.devices.sb16=new T(this,e)),t.multiboot&&(t=this.load_multiboot_option_rom(t.multiboot,t.initrd,t.cmdline))&&(this.bios.main?this.option_roms.push(t):this.reg32[0]=this.io.port_read32(244)),this.debug_init()};M.prototype.load_multiboot=function(t){this.load_multiboot_option_rom(t,void 0,"")&&(this.reg32[0]=this.io.port_read32(244))};M.prototype.load_multiboot_option_rom=function(t,e,i){if(8192>t.byteLength){var s=new Int32Array(2048);new Uint8Array(s.buffer).set(new Uint8Array(t))}else s=new Int32Array(t,0,2048);for(var r=0;8192>r;r+=4){if(s[r>>2]===464367618){var n=s[r+4>>2];if(464367618+n+s[r+8>>2]|0)continue}else continue;""+a(n>>>0,8);var o=this;this.io.register_read(244,this,function(){return 0},function(){return 0},function(){var d=31860,p=0;if(i){p|=4,o.write32(31760,d),i+="\0";var f=new TextEncoder().encode(i);o.write_blob(f,d),d+=f.length}if(n&2){p|=64,f=0,o.write32(31788,0),o.write32(31792,d);var g=0,x=!1;for(let w=0;4294967296>w;w+=131072)x&&o.memory_map_read8[w>>>17]!==void 0?(o.write32(d,20),o.write32(d+4,g),o.write32(d+8,0),o.write32(d+12,w-g),o.write32(d+16,0),o.write32(d+20,1),d+=24,f+=24,x=!1):x||o.memory_map_read8[w>>>17]!==void 0||(g=w,x=!0);o.write32(31788,f)}if(o.write32(31744,p),f=p=0,n&65536){x=s[r+12>>2],p=s[r+16>>2];var b=s[r+20>>2];f=s[r+24>>2],g=s[r+28>>2],a(x,8),a(p,8),a(b,8),a(f,8),a(g,8),x=new Uint8Array(t,r-(x-p),b===0?void 0:b-p),o.write_blob(x,p),p=g|0,f=Math.max(b,f)}else if(s[0]===1179403647){g=new DataView(t);let[w,F]=Os(g,Is);console.assert(F===52),console.assert(w.magic===1179403647,"Bad magic"),console.assert(w.class===1,"Unimplemented: 64 bit elf"),console.assert(w.data===1,"Unimplemented: big endian"),console.assert(w.version0===1,"Bad version0"),console.assert(w.type===2,"Unimplemented type"),console.assert(w.version1===1,"Bad version1"),console.assert(w.ehsize===52,"Bad header size"),console.assert(w.phentsize===32,"Bad program header size"),console.assert(w.shentsize===40,"Bad section header size"),[p]=ds(new DataView(g.buffer,g.byteOffset+w.phoff,w.phentsize*w.phnum),Ss,w.phnum),ds(new DataView(g.buffer,g.byteOffset+w.shoff,w.shentsize*w.shnum),qs,w.shnum),g=w,x=p,p=g.entry;for(b of x)b.type!==0&&(b.type===1?b.paddr+b.memsz<o.memory_size[0]?(b.filesz&&(x=new Uint8Array(t,b.offset,b.filesz),o.write_blob(x,b.paddr)),f=Math.max(f,b.paddr+b.memsz),p===g.entry&&b.vaddr<=p&&b.vaddr+b.memsz>p&&(p=p-b.vaddr+b.paddr)):a(b.paddr):b.type===2||b.type===3||b.type===4||b.type===6||b.type===7||b.type===1685382480||b.type===1685382481||b.type===1685382482||b.type===1685382483||a(b.type))}for(e&&(o.write32(31764,1),o.write32(31768,d),b=f,b&4095&&(b=(b&-4096)+4096),f=b+e.byteLength,o.write32(d,b),o.write32(d+4,f),o.write32(d+8,0),o.write32(d+12,0),o.write_blob(new Uint8Array(e),b)),o.reg32[3]=31744,o.cr[0]=1,o.protected_mode[0]=1,o.flags[0]=2,o.is_32[0]=1,o.stack_size_32[0]=1,d=0;6>d;d++)o.segment_is_null[d]=0,o.segment_offsets[d]=0,o.segment_limits[d]=4294967295,o.sreg[d]=45058;return o.instruction_pointer[0]=o.get_seg_cs()+p|0,o.update_state_flags(),o.dump_state(),o.dump_regs_short(),732803074}),this.io.register_write_consecutive(244,this,function(d){throw console.log("Test exited with code "+a(d,2)),"HALT"},function(){},function(){},function(){});for(let d=0;15>=d;d++){let p=function(f){a(d),a(f,2),f?this.device_raise_irq(d):this.device_lower_irq(d)};this.io.register_write(8192+d,this,p,p,p)}let _=new Uint8Array(512);new Uint16Array(_.buffer)[0]=43605,_[2]=1;var h=3;_[h++]=102,_[h++]=229,_[h++]=244;let c=_[h]=0;for(let d=0;d<_.length;d++)c+=_[d];return _[h]=-c,{name:"genroms/multiboot.bin",data:_}}};M.prototype.fill_cmos=function(t,e){var i=e.boot_order||291;t.cmos_write(56,1|i>>4&240),t.cmos_write(61,i&255),t.cmos_write(21,128),t.cmos_write(22,2),i=0,1048576<=this.memory_size[0]&&(i=this.memory_size[0]-1048576>>10,i=Math.min(i,65535)),t.cmos_write(23,i&255),t.cmos_write(24,i>>8&255),t.cmos_write(48,i&255),t.cmos_write(49,i>>8&255),i=0,16777216<=this.memory_size[0]&&(i=this.memory_size[0]-16777216>>16,i=Math.min(i,65535)),t.cmos_write(52,i&255),t.cmos_write(53,i>>8&255),t.cmos_write(91,0),t.cmos_write(92,0),t.cmos_write(93,0),t.cmos_write(20,47),t.cmos_write(95,0),e.fastboot&&t.cmos_write(63,1)};M.prototype.load_bios=function(){var t=this.bios.main,e=this.bios.vga;if(t){var i=new Uint8Array(t);if(this.write_blob(i,1048576-t.byteLength),e){var s=new Uint8Array(e);this.write_blob(s,786432),this.io.mmap_register(4272947200,1048576,function(r){return r=r-4272947200|0,r<s.length?s[r]:0},function(){})}this.io.mmap_register(4293918720,1048576,function(r){return this.mem8[r&1048575]}.bind(this),function(r,n){this.mem8[r&1048575]=n}.bind(this))}};M.prototype.codegen_finalize=function(t,e,i,s,r){let n=new Uint8Array(this.wasm_memory.buffer,s>>>0,r>>>0);WebAssembly.instantiate(n,{e:this.jit_imports}).then(o=>{this.wm.wasm_table.set(t+1024,o.instance.exports.f),this.codegen_finalize_finished(t,e,i),this.test_hook_did_finalize_wasm&&this.test_hook_did_finalize_wasm(n)})};M.prototype.log_uncompiled_code=function(){};M.prototype.dump_function_code=function(){};M.prototype.run_hardware_timers=function(t,e){let i=this.devices.pit.timer(e,!1),s=this.devices.rtc.timer(e,!1),r=100,n=100;return t&&(r=this.devices.acpi.timer(e),n=this.devices.apic.timer(e)),Math.min(i,s,r,n)};M.prototype.device_raise_irq=function(t){this.pic_set_irq(t),this.devices.ioapic&&this.devices.ioapic.set_irq(t)};M.prototype.device_lower_irq=function(t){this.pic_clear_irq(t),this.devices.ioapic&&this.devices.ioapic.clear_irq(t)};M.prototype.debug_init=function(){};M.prototype.dump_stack=function(){};M.prototype.debug_get_state=function(){};M.prototype.dump_state=function(){};M.prototype.get_regs_short=function(){};M.prototype.dump_regs_short=function(){};M.prototype.dump_gdt_ldt=function(){};M.prototype.dump_idt=function(){};M.prototype.dump_page_structures=function(){if(this.cr[4]&32)for(var t=0;4>t;t++){var e=this.read32s(this.cr[3]+8*t);e&1&&this.dump_page_directory(e&4294963200,!0,t<<30)}else this.dump_page_directory(this.cr[3],!1,0)};M.prototype.dump_page_directory=function(){};M.prototype.get_memory_dump=function(){};M.prototype.memory_hex_dump=function(){};M.prototype.used_memory_dump=function(){};M.prototype.debug_interrupt=function(){};M.prototype.debug_dump_code=function(){};M.prototype.dump_wasm=function(){};function vt(t,e){this.cpu=t,this.pci=t.devices.pci,this.device_id=e.device_id,this.pci_space=[244,26,e.device_id&255,e.device_id>>8,7,5,16,0,1,0,2,0,0,0,0,0,1,168,0,0,0,16,191,254,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,244,26,e.subsystem_device_id&255,e.subsystem_device_id>>8,0,0,0,0,64,0,0,0,0,0,0,0,0,1,0,0],this.pci_space=this.pci_space.concat(Array(256-this.pci_space.length).fill(0)),this.pci_id=e.pci_id,this.pci_bars=[],this.name=e.name,this.driver_feature_select=this.device_feature_select=0,this.device_feature=new Uint32Array(4),this.driver_feature=new Uint32Array(4);for(var i of e.common.features)this.device_feature[i>>>5]|=1<<(i&31),this.driver_feature[i>>>5]|=1<<(i&31);e.common.features.includes(32),this.features_ok=!0,this.device_status=0,this.config_has_changed=!1,this.config_generation=0,this.queues=[];for(let s of e.common.queues)this.queues.push(new ot(t,this,s));this.queue_select=0,this.queue_selected=this.queues[0],this.isr_status=0,i=[],i.push(this.create_common_capability(e.common)),i.push(this.create_notification_capability(e.notification)),i.push(this.create_isr_capability(e.isr_status)),e.device_specific&&i.push(this.create_device_specific_capability(e.device_specific)),this.init_capabilities(i),t.devices.pci.register_device(this),this.reset()}vt.prototype.create_common_capability=function(t){return{type:1,bar:0,port:t.initial_port,use_mmio:!1,offset:0,extra:new Uint8Array(0),struct:[{bytes:4,name:"device_feature_select",read:()=>this.device_feature_select,write:e=>{this.device_feature_select=e}},{bytes:4,name:"device_feature",read:()=>this.device_feature[this.device_feature_select]||0,write:()=>{}},{bytes:4,name:"driver_feature_select",read:()=>this.driver_feature_select,write:e=>{this.driver_feature_select=e}},{bytes:4,name:"driver_feature",read:()=>this.driver_feature[this.driver_feature_select]||0,write:e=>{let i=this.device_feature[this.driver_feature_select];this.driver_feature_select<this.driver_feature.length&&(this.driver_feature[this.driver_feature_select]=e&i),this.features_ok=this.features_ok&&!(e&~i)}},{bytes:2,name:"msix_config",read:()=>65535,write:()=>{}},{bytes:2,name:"num_queues",read:()=>this.queues.length,write:()=>{}},{bytes:1,name:"device_status",read:()=>this.device_status,write:e=>{e===0&&this.reset(),e&~this.device_status&4&&this.device_status&64&&this.notify_config_changes(),this.features_ok||(e&=-9),this.device_status=e,e&~this.device_status&4&&t.on_driver_ok()}},{bytes:1,name:"config_generation",read:()=>this.config_generation,write:()=>{}},{bytes:2,name:"queue_select",read:()=>this.queue_select,write:e=>{this.queue_select=e,this.queue_selected=this.queue_select<this.queues.length?this.queues[this.queue_select]:null}},{bytes:2,name:"queue_size",read:()=>this.queue_selected?this.queue_selected.size:0,write:e=>{this.queue_selected&&(e&e-1&&(e=1<<Ee(e-1)+1),e>this.queue_selected.size_supported&&(e=this.queue_selected.size_supported),this.queue_selected.set_size(e))}},{bytes:2,name:"queue_msix_vector",read:()=>65535,write:()=>{}},{bytes:2,name:"queue_enable",read:()=>this.queue_selected?this.queue_selected.enabled|0:0,write:e=>{this.queue_selected&&e===1&&this.queue_selected.is_configured()&&this.queue_selected.enable()}},{bytes:2,name:"queue_notify_off",read:()=>this.queue_selected?this.queue_selected.notify_offset:0,write:()=>{}},{bytes:4,name:"queue_desc (low dword)",read:()=>this.queue_selected?this.queue_selected.desc_addr:0,write:e=>{this.queue_selected&&(this.queue_selected.desc_addr=e)}},{bytes:4,name:"queue_desc (high dword)",read:()=>0,write:()=>{}},{bytes:4,name:"queue_avail (low dword)",read:()=>this.queue_selected?this.queue_selected.avail_addr:0,write:e=>{this.queue_selected&&(this.queue_selected.avail_addr=e)}},{bytes:4,name:"queue_avail (high dword)",read:()=>0,write:()=>{}},{bytes:4,name:"queue_used (low dword)",read:()=>this.queue_selected?this.queue_selected.used_addr:0,write:e=>{this.queue_selected&&(this.queue_selected.used_addr=e)}},{bytes:4,name:"queue_used (high dword)",read:()=>0,write:()=>{}}]}};vt.prototype.create_notification_capability=function(t){let e=[],i;i=t.single_handler?0:2;for(let[s,r]of t.handlers.entries())e.push({bytes:2,name:"notify"+s,read:()=>65535,write:r||(()=>{})});return{type:2,bar:1,port:t.initial_port,use_mmio:!1,offset:0,extra:new Uint8Array([i&255,i>>8&255,i>>16&255,i>>24]),struct:e}};vt.prototype.create_isr_capability=function(t){return{type:3,bar:2,port:t.initial_port,use_mmio:!1,offset:0,extra:new Uint8Array(0),struct:[{bytes:1,name:"isr_status",read:()=>{let e=this.isr_status;return this.lower_irq(),e},write:()=>{}}]}};vt.prototype.create_device_specific_capability=function(t){return{type:4,bar:3,port:t.initial_port,use_mmio:!1,offset:0,extra:new Uint8Array(0),struct:t.struct}};vt.prototype.init_capabilities=function(t){let e=this.pci_space[52]=64;var i=e;for(let r of t){t=16+r.extra.length,i=e,e=i+t;var s=r.struct.reduce((n,o)=>n+o.bytes,0);s+=r.offset,s=16>s?16:1<<Ee(s-1)+1,this.pci_bars[r.bar]={size:s},this.pci_space[i]=9,this.pci_space[i+1]=e,this.pci_space[i+2]=t,this.pci_space[i+3]=r.type,this.pci_space[i+4]=r.bar,this.pci_space[i+5]=0,this.pci_space[i+6]=0,this.pci_space[i+7]=0,this.pci_space[i+8]=r.offset&255,this.pci_space[i+9]=r.offset>>>8&255,this.pci_space[i+10]=r.offset>>>16&255,this.pci_space[i+11]=r.offset>>>24,this.pci_space[i+12]=s&255,this.pci_space[i+13]=s>>>8&255,this.pci_space[i+14]=s>>>16&255,this.pci_space[i+15]=s>>>24;for(let[n,o]of r.extra.entries())this.pci_space[i+16+n]=o;i=16+4*r.bar,this.pci_space[i]=r.port&254|!r.use_mmio,this.pci_space[i+1]=r.port>>>8&255,this.pci_space[i+2]=r.port>>>16&255,this.pci_space[i+3]=r.port>>>24&255,i=r.port+r.offset;for(let n of r.struct){let o=n.read;if(t=n.write,!r.use_mmio){s=function(_){return o(_&-2)>>((_&1)<<3)&255};let h=function(_){return o(_&-4)>>((_&3)<<3)&255};switch(n.bytes){case 4:this.cpu.io.register_read(i,this,h,void 0,o),this.cpu.io.register_read(i+1,this,h),this.cpu.io.register_read(i+2,this,h),this.cpu.io.register_read(i+3,this,h),this.cpu.io.register_write(i,this,void 0,void 0,t);break;case 2:this.cpu.io.register_read(i,this,s,o),this.cpu.io.register_read(i+1,this,s),this.cpu.io.register_write(i,this,void 0,t);break;case 1:this.cpu.io.register_read(i,this,o),this.cpu.io.register_write(i,this,t)}}i+=n.bytes}}this.pci_space[e]=9,this.pci_space[e+1]=0,this.pci_space[e+2]=20,this.pci_space[e+3]=5,this.pci_space[e+4]=0,this.pci_space[e+5]=0,this.pci_space[e+6]=0,this.pci_space[e+7]=0,this.pci_space[e+8]=0,this.pci_space[e+9]=0,this.pci_space[e+10]=0,this.pci_space[e+11]=0,this.pci_space[e+12]=0,this.pci_space[e+13]=0,this.pci_space[e+14]=0,this.pci_space[e+15]=0,this.pci_space[e+16]=0,this.pci_space[e+17]=0,this.pci_space[e+18]=0,this.pci_space[e+19]=0};vt.prototype.get_state=function(){let t=[];return t[0]=this.device_feature_select,t[1]=this.driver_feature_select,t[2]=this.device_feature,t[3]=this.driver_feature,t[4]=this.features_ok,t[5]=this.device_status,t[6]=this.config_has_changed,t[7]=this.config_generation,t[8]=this.isr_status,t[9]=this.queue_select,t=t.concat(this.queues)};vt.prototype.set_state=function(t){this.device_feature_select=t[0],this.driver_feature_select=t[1],this.device_feature=t[2],this.driver_feature=t[3],this.features_ok=t[4],this.device_status=t[5],this.config_has_changed=t[6],this.config_generation=t[7],this.isr_status=t[8],this.queue_select=t[9];let e=0;for(let i of t.slice(10))this.queues[e].set_state(i),e++;this.queue_selected=this.queues[this.queue_select]||null};vt.prototype.reset=function(){this.driver_feature_select=this.device_feature_select=0,this.driver_feature.set(this.device_feature),this.features_ok=!0,this.queue_select=this.device_status=0,this.queue_selected=this.queues[0];for(let t of this.queues)t.reset();this.config_has_changed=!1,this.config_generation=0,this.lower_irq()};vt.prototype.notify_config_changes=function(){this.config_has_changed=!0,this.device_status&4&&this.raise_irq(2)};vt.prototype.update_config_generation=function(){this.config_has_changed&&(this.config_generation++,this.config_generation&=255,this.config_has_changed=!1)};vt.prototype.is_feature_negotiated=function(t){return 0<(this.driver_feature[t>>>5]&1<<(t&31))};vt.prototype.needs_reset=function(){this.device_status|=64,this.device_status&4&&this.notify_config_changes()};vt.prototype.raise_irq=function(t){a(t),this.isr_status|=t,this.pci.raise_irq(this.pci_id)};vt.prototype.lower_irq=function(){this.isr_status=0,this.pci.lower_irq(this.pci_id)};function ot(t,e,i){this.cpu=t,this.virtio=e,this.size_supported=this.size=i.size_supported,this.mask=this.size-1,this.enabled=!1,this.notify_offset=i.notify_offset,this.num_staged_replies=this.used_addr=this.avail_last_idx=this.avail_addr=this.desc_addr=0,this.reset()}ot.prototype.get_state=function(){let t=[];return t[0]=this.size,t[1]=this.size_supported,t[2]=this.enabled,t[3]=this.notify_offset,t[4]=this.desc_addr,t[5]=this.avail_addr,t[6]=this.avail_last_idx,t[7]=this.used_addr,t[8]=this.num_staged_replies,t[9]=1,t};ot.prototype.set_state=function(t){this.size=t[0],this.size_supported=t[1],this.enabled=t[2],this.notify_offset=t[3],this.desc_addr=t[4],this.avail_addr=t[5],this.avail_last_idx=t[6],this.used_addr=t[7],this.num_staged_replies=t[8],this.mask=this.size-1,this.fix_wrapping=t[9]!==1};ot.prototype.reset=function(){this.enabled=!1,this.num_staged_replies=this.used_addr=this.avail_last_idx=this.avail_addr=this.desc_addr=0,this.set_size(this.size_supported)};ot.prototype.is_configured=function(){return this.desc_addr&&this.avail_addr&&this.used_addr};ot.prototype.enable=function(){this.is_configured(),this.enabled=!0};ot.prototype.set_size=function(t){this.size=t,this.mask=t-1};ot.prototype.count_requests=function(){return this.fix_wrapping&&(this.fix_wrapping=!1,this.avail_last_idx=(this.avail_get_idx()&~this.mask)+(this.avail_last_idx&this.mask)),this.avail_get_idx()-this.avail_last_idx&65535};ot.prototype.has_request=function(){return this.count_requests()!==0};ot.prototype.pop_request=function(){this.has_request();var t=this.avail_get_entry(this.avail_last_idx);return t=new Ti(this,t),this.avail_last_idx=this.avail_last_idx+1&65535,t};ot.prototype.push_reply=function(t){let e=this.used_get_idx()+this.num_staged_replies&this.mask;this.used_set_entry(e,t.head_idx,t.length_written),this.num_staged_replies++};ot.prototype.flush_replies=function(){if(this.num_staged_replies!==0){var t=this.used_get_idx()+this.num_staged_replies&65535;this.used_set_idx(t),this.num_staged_replies=0,this.virtio.is_feature_negotiated(29)?(this.avail_get_used_event(),this.virtio.raise_irq(1)):~this.avail_get_flags()&1&&this.virtio.raise_irq(1)}};ot.prototype.notify_me_after=function(t){t=this.avail_get_idx()+t&65535,this.used_set_avail_event(t)};ot.prototype.get_descriptor=function(t,e){return{addr_low:this.cpu.read32s(t+16*e),addr_high:this.cpu.read32s(t+16*e+4),len:this.cpu.read32s(t+16*e+8),flags:this.cpu.read16(t+16*e+12),next:this.cpu.read16(t+16*e+14)}};ot.prototype.avail_get_flags=function(){return this.cpu.read16(this.avail_addr)};ot.prototype.avail_get_idx=function(){return this.cpu.read16(this.avail_addr+2)};ot.prototype.avail_get_entry=function(t){return this.cpu.read16(this.avail_addr+4+2*(t&this.mask))};ot.prototype.avail_get_used_event=function(){return this.cpu.read16(this.avail_addr+4+2*this.size)};ot.prototype.used_get_flags=function(){return this.cpu.read16(this.used_addr)};ot.prototype.used_set_flags=function(t){this.cpu.write16(this.used_addr,t)};ot.prototype.used_get_idx=function(){return this.cpu.read16(this.used_addr+2)};ot.prototype.used_set_idx=function(t){this.cpu.write16(this.used_addr+2,t)};ot.prototype.used_set_entry=function(t,e,i){this.cpu.write32(this.used_addr+4+8*t,e),this.cpu.write32(this.used_addr+8+8*t,i)};ot.prototype.used_set_avail_event=function(t){this.cpu.write16(this.used_addr+4+8*this.size,t)};function Ti(t,e){this.cpu=t.cpu,this.virtio=t.virtio,this.head_idx=e,this.read_buffers=[],this.length_readable=this.read_buffer_offset=this.read_buffer_idx=0,this.write_buffers=[],this.length_writable=this.length_written=this.write_buffer_offset=this.write_buffer_idx=0;let i=t.desc_addr,s=0,r=t.size,n=!1,o=this.virtio.is_feature_negotiated(28);do{let h=t.get_descriptor(i,e);if(a(h.addr_high,8),a(h.addr_low,8),a(h.len,8),a(h.flags,4),a(h.next,4),o&&h.flags&4)i=h.addr_low,s=e=0,r=h.len/16;else{if(h.flags&2)n=!0,this.write_buffers.push(h),this.length_writable+=h.len;else{if(n)break;this.read_buffers.push(h),this.length_readable+=h.len}if(s++,s>r)break;if(h.flags&1)e=h.next;else break}}while(!0)}Ti.prototype.get_next_blob=function(t){let e=0,i=t.length;for(;i&&this.read_buffer_idx!==this.read_buffers.length;){var s=this.read_buffers[this.read_buffer_idx];let r=s.addr_low+this.read_buffer_offset;s=s.len-this.read_buffer_offset,s>i?(s=i,this.read_buffer_offset+=i):(this.read_buffer_idx++,this.read_buffer_offset=0),t.set(this.cpu.read_blob(r,s),e),e+=s,i-=s}return e};Ti.prototype.set_next_blob=function(t){let e=0,i=t.length;for(;i&&this.write_buffer_idx!==this.write_buffers.length;){var s=this.write_buffers[this.write_buffer_idx];let r=s.addr_low+this.write_buffer_offset;s=s.len-this.write_buffer_offset,s>i?(s=i,this.write_buffer_offset+=i):(this.write_buffer_idx++,this.write_buffer_offset=0),this.cpu.write_blob(t.subarray(e,e+s),r),e+=s,i-=s}return this.length_written+=e,e};function zi(t,e){this.configspace_tagname=[104,111,115,116,57,112],this.configspace_taglen=this.configspace_tagname.length,this.virtio=new vt(t,{name:"virtio-9p",pci_id:48,device_id:4169,subsystem_device_id:9,common:{initial_port:43008,queues:[{size_supported:32,notify_offset:0}],features:[0,32,29,28],on_driver_ok:()=>{}},notification:{initial_port:43264,single_handler:!1,handlers:[i=>{if(i===0){for(;this.virtqueue.has_request();)i=this.virtqueue.pop_request(),e(i);this.virtqueue.notify_me_after(0)}}]},isr_status:{initial_port:42752},device_specific:{initial_port:42496,struct:[{bytes:2,name:"mount tag length",read:()=>this.configspace_taglen,write:()=>{}}].concat(Array.from(Array(254).keys()).map(i=>({bytes:1,name:"mount tag name "+i,read:()=>this.configspace_tagname[i]||0,write:()=>{}})))}}),this.virtqueue=this.virtio.queues[0]}function Zt(t,e,i){this.fs=t,this.bus=i,this.VERSION="9P2000.L",this.msize=this.BLOCKSIZE=8192,this.replybuffer=new Uint8Array(2*this.msize),this.replybuffersize=0,this.fids=[],this.device=new zi(e,this.ReceiveRequest.bind(this))}Zt.prototype.get_state=function(){var t=[];return t[0]=this.device.configspace_tagname,t[1]=this.device.configspace_taglen,t[2]=this.device.virtio,t[3]=this.VERSION,t[4]=this.BLOCKSIZE,t[5]=this.msize,t[6]=this.replybuffer,t[7]=this.replybuffersize,t[8]=this.fids.map(function(e){return[e.inodeid,e.type,e.uid,e.dbg_name]}),t[9]=this.fs,t};Zt.prototype.set_state=function(t){this.device.configspace_tagname=t[0],this.device.configspace_taglen=t[1],this.device.virtio.set_state(t[2]),this.device.virtqueue=this.device.virtio.queues[0],this.VERSION=t[3],this.BLOCKSIZE=t[4],this.msize=t[5],this.replybuffer=t[6],this.replybuffersize=t[7],this.fids=t[8].map(function(e){return{inodeid:e[0],type:e[1],uid:e[2],dbg_name:e[3]}}),this.fs.set_state(t[9])};Zt.prototype.Createfid=function(t,e,i,s){return{inodeid:t,type:e,uid:i,dbg_name:s}};Zt.prototype.update_dbg_name=function(t,e){for(let i of this.fids)i.inodeid===t&&(i.dbg_name=e)};Zt.prototype.reset=function(){this.fids=[],this.device.virtio.reset()};Zt.prototype.BuildReply=function(t,e,i){st(["w","b","h"],[i+7,t+1,e],this.replybuffer,0),this.replybuffersize=i+7};Zt.prototype.SendError=function(t,e,i){e=st(["w"],[i],this.replybuffer,7),this.BuildReply(6,t,e)};Zt.prototype.SendReply=function(t){t.set_next_blob(this.replybuffer.subarray(0,this.replybuffersize)),this.device.virtqueue.push_reply(t),this.device.virtqueue.flush_replies()};Zt.prototype.ReceiveRequest=async function(t){var e=new Uint8Array(t.length_readable);t.get_next_blob(e);var i={offset:0},s=K(["w","b","h"],e,i),r=s[0],n=s[1],o=s[2];switch(n){case 8:r=this.fs.GetTotalSize();var h=this.fs.GetSpace();s=[16914839],s[1]=this.BLOCKSIZE,s[2]=Math.floor(h/s[1]),s[3]=s[2]-Math.floor(r/s[1]),s[4]=s[2]-Math.floor(r/s[1]),s[5]=this.fs.CountUsedInodes(),s[6]=this.fs.CountFreeInodes(),s[7]=0,s[8]=256,r=st("wwddddddw".split(""),s,this.replybuffer,7),this.BuildReply(n,o,r),this.SendReply(t);break;case 112:case 12:s=K(["w","w"],e,i),r=s[0],i=s[1],e=this.fids[r].inodeid;var _=this.fs.GetInode(e);h=this.fs.OpenInode(e,i),this.fs.AddEvent(this.fids[r].inodeid,function(){var f=[];f[0]=_.qid,f[1]=this.msize-24,st(["Q","w"],f,this.replybuffer,7),this.BuildReply(n,o,17),this.SendReply(t)}.bind(this));break;case 70:if(s=K(["w","w","s"],e,i),e=s[0],r=s[1],h=s[2],h=this.fs.Link(this.fids[e].inodeid,this.fids[r].inodeid,h),0>h){this.SendError(o,h===-1?"Operation not permitted":"Unknown error: "+-h,-h),this.SendReply(t);break}this.BuildReply(n,o,0),this.SendReply(t);break;case 16:s=K(["w","s","s","w"],e,i),r=s[0],h=s[1];var c=s[3];e=this.fs.CreateSymlink(h,this.fids[r].inodeid,s[2]),_=this.fs.GetInode(e),_.uid=this.fids[r].uid,_.gid=c,st(["Q"],[_.qid],this.replybuffer,7),this.BuildReply(n,o,13),this.SendReply(t);break;case 18:s=K("wswwww".split(""),e,i),r=s[0],h=s[1],i=s[2],e=s[3];var d=s[4];c=s[5],e=this.fs.CreateNode(h,this.fids[r].inodeid,e,d),_=this.fs.GetInode(e),_.mode=i,_.uid=this.fids[r].uid,_.gid=c,st(["Q"],[_.qid],this.replybuffer,7),this.BuildReply(n,o,13),this.SendReply(t);break;case 22:s=K(["w"],e,i),r=s[0],_=this.fs.GetInode(this.fids[r].inodeid),r=st(["s"],[_.symlink],this.replybuffer,7),this.BuildReply(n,o,r),this.SendReply(t);break;case 72:s=K(["w","s","w","w"],e,i),r=s[0],h=s[1],i=s[2],c=s[3],e=this.fs.CreateDirectory(h,this.fids[r].inodeid),_=this.fs.GetInode(e),_.mode=i|16384,_.uid=this.fids[r].uid,_.gid=c,st(["Q"],[_.qid],this.replybuffer,7),this.BuildReply(n,o,13),this.SendReply(t);break;case 14:s=K(["w","s","w","w","w"],e,i),r=s[0],h=s[1],e=s[2],i=s[3],c=s[4],this.bus.send("9p-create",[h,this.fids[r].inodeid]),e=this.fs.CreateFile(h,this.fids[r].inodeid),this.fids[r].inodeid=e,this.fids[r].type=1,this.fids[r].dbg_name=h,_=this.fs.GetInode(e),_.uid=this.fids[r].uid,_.gid=c,_.mode=i|32768,st(["Q","w"],[_.qid,this.msize-24],this.replybuffer,7),this.BuildReply(n,o,17),this.SendReply(t);break;case 52:s=K("wbwddws".split(""),e,i),r=s[0],e=s[2],h=s[4]===0?1/0:s[4],s=this.fs.DescribeLock(s[1],s[3],h,s[5],s[6]),h=this.fs.Lock(this.fids[r].inodeid,s,e),st(["b"],[h],this.replybuffer,7),this.BuildReply(n,o,1),this.SendReply(t);break;case 54:s=K("wbddws".split(""),e,i),r=s[0],h=s[3]===0?1/0:s[3],s=this.fs.DescribeLock(s[1],s[2],h,s[4],s[5]),h=this.fs.GetLock(this.fids[r].inodeid,s),h||(h=s,h.type=2),r=st(["b","d","d","w","s"],[h.type,h.start,h.length===1/0?0:h.length,h.proc_id,h.client_id],this.replybuffer,7),this.BuildReply(n,o,r),this.SendReply(t);break;case 24:if(s=K(["w","d"],e,i),r=s[0],_=this.fs.GetInode(this.fids[r].inodeid),!_||_.status===4){this.SendError(o,"No such file or directory",2),this.SendReply(t);break}s[0]=s[1],s[1]=_.qid,s[2]=_.mode,s[3]=_.uid,s[4]=_.gid,s[5]=_.nlinks,s[6]=_.major<<8|_.minor,s[7]=_.size,s[8]=this.BLOCKSIZE,s[9]=Math.floor(_.size/512+1),s[10]=_.atime,s[11]=0,s[12]=_.mtime,s[13]=0,s[14]=_.ctime,s[15]=0,s[16]=0,s[17]=0,s[18]=0,s[19]=0,st("dQwwwddddddddddddddd".split(""),s,this.replybuffer,7),this.BuildReply(n,o,153),this.SendReply(t);break;case 26:s=K("wwwwwddddd".split(""),e,i),r=s[0],_=this.fs.GetInode(this.fids[r].inodeid),s[1]&1&&(_.mode=s[2]),s[1]&2&&(_.uid=s[3]),s[1]&4&&(_.gid=s[4]),s[1]&16&&(_.atime=Math.floor(new Date().getTime()/1e3)),s[1]&32&&(_.mtime=Math.floor(new Date().getTime()/1e3)),s[1]&64&&(_.ctime=Math.floor(new Date().getTime()/1e3)),s[1]&128&&(_.atime=s[6]),s[1]&256&&(_.mtime=s[8]),s[1]&8&&await this.fs.ChangeSize(this.fids[r].inodeid,s[5]),this.BuildReply(n,o,0),this.SendReply(t);break;case 50:s=K(["w","d"],e,i),r=s[0],this.BuildReply(n,o,0),this.SendReply(t);break;case 40:case 116:if(s=K(["w","d","w"],e,i),r=s[0],h=s[1],c=s[2],_=this.fs.GetInode(this.fids[r].inodeid),!_||_.status===4){this.SendError(o,"No such file or directory",2),this.SendReply(t);break}if(this.fids[r].type===2)for(_.caps.length<h+c&&(c=_.caps.length-h),s=0;s<c;s++)this.replybuffer[11+s]=_.caps[h+s];else this.fs.OpenInode(this.fids[r].inodeid,void 0),s=this.fids[r].inodeid,c=Math.min(c,this.replybuffer.length-11),_.size<h+c?c=_.size-h:n===40&&(c=this.fs.RoundToDirentry(s,h+c)-h),h>_.size&&(c=0),this.bus.send("9p-read-start",[this.fids[r].dbg_name]),s=await this.fs.Read(s,h,c),this.bus.send("9p-read-end",[this.fids[r].dbg_name,c]),s&&this.replybuffer.set(s,11);st(["w"],[c],this.replybuffer,7),this.BuildReply(n,o,4+c),this.SendReply(t);break;case 118:if(s=K(["w","d","w"],e,i),r=s[0],h=s[1],c=s[2],s=this.fids[r].dbg_name,this.fids[r].type===2){this.SendError(o,"Setxattr not supported",95),this.SendReply(t);break}else await this.fs.Write(this.fids[r].inodeid,h,c,e.subarray(i.offset));this.bus.send("9p-write-end",[s,c]),st(["w"],[c],this.replybuffer,7),this.BuildReply(n,o,4),this.SendReply(t);break;case 74:if(s=K(["w","s","w","s"],e,i),h=await this.fs.Rename(this.fids[s[0]].inodeid,s[1],this.fids[s[2]].inodeid,s[3]),0>h){this.SendError(o,h===-2?"No such file or directory":h===-1?"Operation not permitted":h===-39?"Directory not empty":"Unknown error: "+-h,-h),this.SendReply(t);break}this.BuildReply(n,o,0),this.SendReply(t);break;case 76:if(s=K(["w","s","w"],e,i),i=s[0],h=s[1],e=s[2],r=this.fs.Search(this.fids[i].inodeid,h),r===-1){this.SendError(o,"No such file or directory",2),this.SendReply(t);break}if(h=this.fs.Unlink(this.fids[i].inodeid,h),0>h){this.SendError(o,h===-39?"Directory not empty":h===-1?"Operation not permitted":"Unknown error: "+-h,-h),this.SendReply(t);break}this.BuildReply(n,o,0),this.SendReply(t);break;case 100:r=K(["w","s"],e,i),this.msize!==r[0]&&(this.msize=r[0],this.replybuffer=new Uint8Array(Math.min(16777216,2*this.msize))),r=st(["w","s"],[this.msize,this.VERSION],this.replybuffer,7),this.BuildReply(n,o,r),this.SendReply(t);break;case 104:s=K(["w","w","s","s","w"],e,i),r=s[0],h=s[4],""+r+a(s[1])+s[2]+s[3],this.fids[r]=this.Createfid(0,1,h,""),_=this.fs.GetInode(this.fids[r].inodeid),st(["Q"],[_.qid],this.replybuffer,7),this.BuildReply(n,o,13),this.SendReply(t),this.bus.send("9p-attach");break;case 108:s=K(["h"],e,i),this.BuildReply(n,o,0),this.SendReply(t);break;case 110:if(s=K(["w","w","h"],e,i),r=s[0],c=s[1],d=s[2],d===0){this.fids[c]=this.Createfid(this.fids[r].inodeid,1,this.fids[r].uid,this.fids[r].dbg_name),st(["h"],[0],this.replybuffer,7),this.BuildReply(n,o,2),this.SendReply(t);break}for(h=[],s=0;s<d;s++)h.push("s");i=K(h,e,i),e=this.fids[r].inodeid,h=9;var p=0;for(s=0;s<d&&(e=this.fs.Search(e,i[s]),e!==-1);s++)h+=st(["Q"],[this.fs.GetInode(e).qid],this.replybuffer,h),p++,this.fids[c]=this.Createfid(e,1,this.fids[r].uid,i[s]);st(["h"],[p],this.replybuffer,7),this.BuildReply(n,o,h-7),this.SendReply(t);break;case 120:s=K(["w"],e,i),this.fids[s[0]]&&0<=this.fids[s[0]].inodeid&&(await this.fs.CloseInode(this.fids[s[0]].inodeid),this.fids[s[0]].inodeid=-1,this.fids[s[0]].type=-1),this.BuildReply(n,o,0),this.SendReply(t);break;case 32:s=K(["w","s","d","w"],e,i),r=s[0],h=s[1],e=s[3],this.fids[r].type=2,this.BuildReply(n,o,0),this.SendReply(t);break;case 30:s=K(["w","w","s"],e,i),r=s[0],h=s[2],this.SendError(o,"Setxattr not supported",95),this.SendReply(t)}};function ri(t,e){this.handle_fn=t,this.tag_bufchain=new Map,this.device=new zi(e,async i=>{let s=new Uint8Array(i.length_readable);i.get_next_blob(s);var r=K(["w","b","h"],s,{offset:0})[2];this.tag_bufchain.set(r,i),this.handle_fn(s,n=>{var o=K(["w","b","h"],n,{offset:0})[2];let h=this.tag_bufchain.get(o);h?(h.set_next_blob(n),this.device.virtqueue.push_reply(h),this.device.virtqueue.flush_replies(),this.tag_bufchain.delete(o)):console.error("No bufchain found for tag: "+o)})})}ri.prototype.get_state=function(){var t=[];return t[0]=this.device.configspace_tagname,t[1]=this.device.configspace_taglen,t[2]=this.device.virtio,t[3]=this.tag_bufchain,t};ri.prototype.set_state=function(t){this.device.configspace_tagname=t[0],this.device.configspace_taglen=t[1],this.device.virtio.set_state(t[2]),this.device.virtqueue=this.device.virtio.queues[0],this.tag_bufchain=t[3]};ri.prototype.reset=function(){this.device.virtio.reset()};function Ft(t,e){this.socket=void 0,this.cpu=e,this.send_queue=[],this.url=t,this.reconnect_interval=1e4,this.last_connect_attempt=Date.now()-this.reconnect_interval,this.send_queue_limit=64,this.destroyed=!1,this.tag_bufchain=new Map,this.device=new zi(e,async i=>{let s=new Uint8Array(i.length_readable);i.get_next_blob(s);let r=K(["w","b","h"],s,{offset:0})[2];this.tag_bufchain.set(r,i),this.send(s)})}Ft.prototype.get_state=function(){var t=[];return t[0]=this.device.configspace_tagname,t[1]=this.device.configspace_taglen,t[2]=this.device.virtio,t[3]=this.tag_bufchain,t};Ft.prototype.set_state=function(t){this.device.configspace_tagname=t[0],this.device.configspace_taglen=t[1],this.device.virtio.set_state(t[2]),this.device.virtqueue=this.device.virtio.queues[0],this.tag_bufchain=t[3]};Ft.prototype.reset=function(){this.device.virtio.reset()};Ft.prototype.handle_message=function(t){t=new Uint8Array(t.data);let e=K(["w","b","h"],t,{offset:0})[2],i=this.tag_bufchain.get(e);i?(i.set_next_blob(t),this.device.virtqueue.push_reply(i),this.device.virtqueue.flush_replies(),this.tag_bufchain.delete(e)):console.error("Virtio9pProxy: No bufchain found for tag: "+e)};Ft.prototype.handle_close=function(){this.destroyed||(this.connect(),setTimeout(this.connect.bind(this),this.reconnect_interval))};Ft.prototype.handle_open=function(){for(var t=0;t<this.send_queue.length;t++)this.send(this.send_queue[t]);this.send_queue=[]};Ft.prototype.handle_error=function(){};Ft.prototype.destroy=function(){this.destroyed=!0,this.socket&&this.socket.close()};Ft.prototype.connect=function(){if(typeof WebSocket<"u"){if(this.socket){var t=this.socket.readyState;if(t===0||t===1)return}if(t=Date.now(),!(this.last_connect_attempt+this.reconnect_interval>t)){this.last_connect_attempt=Date.now();try{this.socket=new WebSocket(this.url)}catch(e){console.error(e);return}this.socket.binaryType="arraybuffer",this.socket.onopen=this.handle_open.bind(this),this.socket.onmessage=this.handle_message.bind(this),this.socket.onclose=this.handle_close.bind(this),this.socket.onerror=this.handle_error.bind(this)}}};Ft.prototype.send=function(t){this.socket&&this.socket.readyState===1?this.socket.send(t):(this.send_queue.push(t),this.send_queue.length>2*this.send_queue_limit&&(this.send_queue=this.send_queue.slice(-this.send_queue_limit)),this.connect())};Ft.prototype.change_proxy=function(t){this.url=t,this.socket&&(this.socket.onclose=function(){},this.socket.onerror=function(){},this.socket.close(),this.socket=void 0)};var $n=Le.exports.V86,{V86:Ts,CPU:Yn}=Le.exports;var Mr=Object.create,Vs=Object.defineProperty,Lr=Object.getOwnPropertyDescriptor,Fr=Object.getOwnPropertyNames,Nr=Object.getPrototypeOf,jr=Object.prototype.hasOwnProperty,Br=(t=>typeof St<"u"?St:typeof Proxy<"u"?new Proxy(t,{get:(e,i)=>(typeof St<"u"?St:e)[i]}):t)(function(t){if(typeof St<"u")return St.apply(this,arguments);throw Error('Dynamic require of "'+t+'" is not supported')}),Gr=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports),Wr=(t,e,i,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of Fr(e))!jr.call(t,r)&&r!==i&&Vs(t,r,{get:()=>e[r],enumerable:!(s=Lr(e,r))||s.enumerable});return t},Hs=(t,e,i)=>(i=t!=null?Mr(Nr(t)):{},Wr(e||!t||!t.__esModule?Vs(i,"default",{value:t,enumerable:!0}):i,t)),Ks=Gr((t,e)=>{"use strict";e.exports=function(){throw new Error("ws does not work in the browser. Browser clients must use the native WebSocket object")}});(function(){if(typeof global<"u"&&!global.TextEncoder){let{TextEncoder:t,TextDecoder:e}=Br("util");global.TextEncoder=t,global.TextDecoder=e}})();var Ni;try{Ni=new TextDecoder}catch{}var z,ye,y=0,$s=[],Vr=105,Hr=57342,Kr=57343,zs=57337,Rs=6,ze={},ji=$s,Bi=0,Y={},_t,di,ui=0,Ke=0,yt,Vt,ct=[],Gi=[],Rt,Dt,He,Cs={useRecords:!1,mapsAsObjects:!0},$e=!1,Ys=class Wi{constructor(e){if(e&&((e.keyMap||e._keyMap)&&!e.useRecords&&(e.useRecords=!1,e.mapsAsObjects=!0),e.useRecords===!1&&e.mapsAsObjects===void 0&&(e.mapsAsObjects=!0),e.getStructures&&(e.getShared=e.getStructures),e.getShared&&!e.structures&&((e.structures=[]).uninitialized=!0),e.keyMap)){this.mapKey=new Map;for(let[i,s]of Object.entries(e.keyMap))this.mapKey.set(s,i)}Object.assign(this,e)}decodeKey(e){return this.keyMap&&this.mapKey.get(e)||e}encodeKey(e){return this.keyMap&&this.keyMap.hasOwnProperty(e)?this.keyMap[e]:e}encodeKeys(e){if(!this._keyMap)return e;let i=new Map;for(let[s,r]of Object.entries(e))i.set(this._keyMap.hasOwnProperty(s)?this._keyMap[s]:s,r);return i}decodeKeys(e){if(!this._keyMap||e.constructor.name!="Map")return e;if(!this._mapKey){this._mapKey=new Map;for(let[s,r]of Object.entries(this._keyMap))this._mapKey.set(r,s)}let i={};return e.forEach((s,r)=>i[Nt(this._mapKey.has(r)?this._mapKey.get(r):r)]=s),i}mapDecode(e,i){let s=this.decode(e);if(this._keyMap)switch(s.constructor.name){case"Array":return s.map(r=>this.decodeKeys(r))}return s}decode(e,i){if(z)return Qs(()=>($i(),this?this.decode(e,i):Wi.prototype.decode.call(Cs,e,i)));ye=i>-1?i:e.length,y=0,Bi=0,Ke=0,di=null,ji=$s,yt=null,z=e;try{Dt=e.dataView||(e.dataView=new DataView(e.buffer,e.byteOffset,e.byteLength))}catch(s){throw z=null,e instanceof Uint8Array?s:new Error("Source must be a Uint8Array or Buffer but was a "+(e&&typeof e=="object"?e.constructor.name:typeof e))}if(this instanceof Wi){if(Y=this,Rt=this.sharedValues&&(this.pack?new Array(this.maxPrivatePackedValues||16).concat(this.sharedValues):this.sharedValues),this.structures)return _t=this.structures,ni();(!_t||_t.length>0)&&(_t=[])}else Y=Cs,(!_t||_t.length>0)&&(_t=[]),Rt=null;return ni()}decodeMultiple(e,i){let s,r=0;try{let n=e.length;$e=!0;let o=this?this.decode(e,n):Qi.decode(e,n);if(i){if(i(o)===!1)return;for(;y<n;)if(r=y,i(ni())===!1)return}else{for(s=[o];y<n;)r=y,s.push(ni());return s}}catch(n){throw n.lastPosition=r,n.values=s,n}finally{$e=!1,$i()}}};function ni(){try{let t=$();if(yt){if(y>=yt.postBundlePosition){let e=new Error("Unexpected bundle position");throw e.incomplete=!0,e}y=yt.postBundlePosition,yt=null}if(y==ye)_t=null,z=null,Vt&&(Vt=null);else if(y>ye){let e=new Error("Unexpected end of CBOR data");throw e.incomplete=!0,e}else if(!$e)throw new Error("Data read, but end of buffer not reached");return t}catch(t){throw $i(),(t instanceof RangeError||t.message.startsWith("Unexpected end of buffer"))&&(t.incomplete=!0),t}}function $(){let t=z[y++],e=t>>5;if(t=t&31,t>23)switch(t){case 24:t=z[y++];break;case 25:if(e==7)return Xr();t=Dt.getUint16(y),y+=2;break;case 26:if(e==7){let i=Dt.getFloat32(y);if(Y.useFloat32>2){let s=Ji[(z[y]&127)<<1|z[y+1]>>7];return y+=4,(s*i+(i>0?.5:-.5)>>0)/s}return y+=4,i}t=Dt.getUint32(y),y+=4;break;case 27:if(e==7){let i=Dt.getFloat64(y);return y+=8,i}if(e>1){if(Dt.getUint32(y)>0)throw new Error("JavaScript does not support arrays, maps, or strings with length over 4294967295");t=Dt.getUint32(y+4)}else Y.int64AsNumber?(t=Dt.getUint32(y)*4294967296,t+=Dt.getUint32(y+4)):t=Dt.getBigUint64(y);y+=8;break;case 31:switch(e){case 2:case 3:throw new Error("Indefinite length not supported for byte or text strings");case 4:let i=[],s,r=0;for(;(s=$())!=ze;)i[r++]=s;return e==4?i:e==3?i.join(""):Buffer.concat(i);case 5:let n;if(Y.mapsAsObjects){let o={};if(Y.keyMap)for(;(n=$())!=ze;)o[Nt(Y.decodeKey(n))]=$();else for(;(n=$())!=ze;)o[Nt(n)]=$();return o}else{He&&(Y.mapsAsObjects=!0,He=!1);let o=new Map;if(Y.keyMap)for(;(n=$())!=ze;)o.set(Y.decodeKey(n),$());else for(;(n=$())!=ze;)o.set(n,$());return o}case 7:return ze;default:throw new Error("Invalid major type for indefinite length "+e)}default:throw new Error("Unknown token "+t)}switch(e){case 0:return t;case 1:return~t;case 2:return Zr(t);case 3:if(Ke>=y)return di.slice(y-ui,(y+=t)-ui);if(Ke==0&&ye<140&&t<32){let r=t<16?Zs(t):Yr(t);if(r!=null)return r}return $r(t);case 4:let i=new Array(t);for(let r=0;r<t;r++)i[r]=$();return i;case 5:if(Y.mapsAsObjects){let r={};if(Y.keyMap)for(let n=0;n<t;n++)r[Nt(Y.decodeKey($()))]=$();else for(let n=0;n<t;n++)r[Nt($())]=$();return r}else{He&&(Y.mapsAsObjects=!0,He=!1);let r=new Map;if(Y.keyMap)for(let n=0;n<t;n++)r.set(Y.decodeKey($()),$());else for(let n=0;n<t;n++)r.set($(),$());return r}case 6:if(t>=zs){let r=_t[t&8191];if(r)return r.read||(r.read=Vi(r)),r.read();if(t<65536){if(t==Kr){let n=Ce(),o=$(),h=$();Ki(o,h);let _={};if(Y.keyMap)for(let c=2;c<n;c++){let d=Y.decodeKey(h[c-2]);_[Nt(d)]=$()}else for(let c=2;c<n;c++){let d=h[c-2];_[Nt(d)]=$()}return _}else if(t==Hr){let n=Ce(),o=$();for(let h=2;h<n;h++)Ki(o++,$());return $()}else if(t==zs)return rn();if(Y.getShared&&(Xi(),r=_t[t&8191],r))return r.read||(r.read=Vi(r)),r.read()}}let s=ct[t];if(s)return s.handlesRead?s($):s($());{let r=$();for(let n=0;n<Gi.length;n++){let o=Gi[n](t,r);if(o!==void 0)return o}return new we(r,t)}case 7:switch(t){case 20:return!1;case 21:return!0;case 22:return null;case 23:return;case 31:default:let r=(Rt||ge())[t];if(r!==void 0)return r;throw new Error("Unknown token "+t)}default:if(isNaN(t)){let r=new Error("Unexpected end of CBOR data");throw r.incomplete=!0,r}throw new Error("Unknown CBOR token "+t)}}var Ps=/^[a-zA-Z_$][a-zA-Z\d_$]*$/;function Vi(t){function e(){let i=z[y++];if(i=i&31,i>23)switch(i){case 24:i=z[y++];break;case 25:i=Dt.getUint16(y),y+=2;break;case 26:i=Dt.getUint32(y),y+=4;break;default:throw new Error("Expected array header, but got "+z[y-1])}let s=this.compiledReader;for(;s;){if(s.propertyCount===i)return s($);s=s.next}if(this.slowReads++>=3){let n=this.length==i?this:this.slice(0,i);return s=Y.keyMap?new Function("r","return {"+n.map(o=>Y.decodeKey(o)).map(o=>Ps.test(o)?Nt(o)+":r()":"["+JSON.stringify(o)+"]:r()").join(",")+"}"):new Function("r","return {"+n.map(o=>Ps.test(o)?Nt(o)+":r()":"["+JSON.stringify(o)+"]:r()").join(",")+"}"),this.compiledReader&&(s.next=this.compiledReader),s.propertyCount=i,this.compiledReader=s,s($)}let r={};if(Y.keyMap)for(let n=0;n<i;n++)r[Nt(Y.decodeKey(this[n]))]=$();else for(let n=0;n<i;n++)r[Nt(this[n])]=$();return r}return t.slowReads=0,e}function Nt(t){return t==="__proto__"?"__proto_":t}var $r=Hi;function Hi(t){let e;if(t<16&&(e=Zs(t)))return e;if(t>64&&Ni)return Ni.decode(z.subarray(y,y+=t));let i=y+t,s=[];for(e="";y<i;){let r=z[y++];if(!(r&128))s.push(r);else if((r&224)===192){let n=z[y++]&63;s.push((r&31)<<6|n)}else if((r&240)===224){let n=z[y++]&63,o=z[y++]&63;s.push((r&31)<<12|n<<6|o)}else if((r&248)===240){let n=z[y++]&63,o=z[y++]&63,h=z[y++]&63,_=(r&7)<<18|n<<12|o<<6|h;_>65535&&(_-=65536,s.push(_>>>10&1023|55296),_=56320|_&1023),s.push(_)}else s.push(r);s.length>=4096&&(e+=bt.apply(String,s),s.length=0)}return s.length>0&&(e+=bt.apply(String,s)),e}var bt=String.fromCharCode;function Yr(t){let e=y,i=new Array(t);for(let s=0;s<t;s++){let r=z[y++];if((r&128)>0){y=e;return}i[s]=r}return bt.apply(String,i)}function Zs(t){if(t<4)if(t<2){if(t===0)return"";{let e=z[y++];if((e&128)>1){y-=1;return}return bt(e)}}else{let e=z[y++],i=z[y++];if((e&128)>0||(i&128)>0){y-=2;return}if(t<3)return bt(e,i);let s=z[y++];if((s&128)>0){y-=3;return}return bt(e,i,s)}else{let e=z[y++],i=z[y++],s=z[y++],r=z[y++];if((e&128)>0||(i&128)>0||(s&128)>0||(r&128)>0){y-=4;return}if(t<6){if(t===4)return bt(e,i,s,r);{let n=z[y++];if((n&128)>0){y-=5;return}return bt(e,i,s,r,n)}}else if(t<8){let n=z[y++],o=z[y++];if((n&128)>0||(o&128)>0){y-=6;return}if(t<7)return bt(e,i,s,r,n,o);let h=z[y++];if((h&128)>0){y-=7;return}return bt(e,i,s,r,n,o,h)}else{let n=z[y++],o=z[y++],h=z[y++],_=z[y++];if((n&128)>0||(o&128)>0||(h&128)>0||(_&128)>0){y-=8;return}if(t<10){if(t===8)return bt(e,i,s,r,n,o,h,_);{let c=z[y++];if((c&128)>0){y-=9;return}return bt(e,i,s,r,n,o,h,_,c)}}else if(t<12){let c=z[y++],d=z[y++];if((c&128)>0||(d&128)>0){y-=10;return}if(t<11)return bt(e,i,s,r,n,o,h,_,c,d);let p=z[y++];if((p&128)>0){y-=11;return}return bt(e,i,s,r,n,o,h,_,c,d,p)}else{let c=z[y++],d=z[y++],p=z[y++],f=z[y++];if((c&128)>0||(d&128)>0||(p&128)>0||(f&128)>0){y-=12;return}if(t<14){if(t===12)return bt(e,i,s,r,n,o,h,_,c,d,p,f);{let g=z[y++];if((g&128)>0){y-=13;return}return bt(e,i,s,r,n,o,h,_,c,d,p,f,g)}}else{let g=z[y++],x=z[y++];if((g&128)>0||(x&128)>0){y-=14;return}if(t<15)return bt(e,i,s,r,n,o,h,_,c,d,p,f,g,x);let b=z[y++];if((b&128)>0){y-=15;return}return bt(e,i,s,r,n,o,h,_,c,d,p,f,g,x,b)}}}}}function Zr(t){return Y.copyBuffers?Uint8Array.prototype.slice.call(z,y,y+=t):z.subarray(y,y+=t)}var Xs=new Float32Array(1),oi=new Uint8Array(Xs.buffer,0,4);function Xr(){let t=z[y++],e=z[y++],i=(t&127)>>2;if(i===31)return e||t&3?NaN:t&128?-1/0:1/0;if(i===0){let s=((t&3)<<8|e)/16777216;return t&128?-s:s}return oi[3]=t&128|(i>>1)+56,oi[2]=(t&7)<<5|e>>3,oi[1]=e<<5,oi[0]=0,Xs[0]}var Jn=new Array(4096),we=class{constructor(t,e){this.value=t,this.tag=e}};ct[0]=t=>new Date(t);ct[1]=t=>new Date(Math.round(t*1e3));ct[2]=t=>{let e=BigInt(0);for(let i=0,s=t.byteLength;i<s;i++)e=BigInt(t[i])+e<<BigInt(8);return e};ct[3]=t=>BigInt(-1)-ct[2](t);ct[4]=t=>+(t[1]+"e"+t[0]);ct[5]=t=>t[1]*Math.exp(t[0]*Math.log(2));var Ki=(t,e)=>{t=t-57344;let i=_t[t];i&&i.isShared&&((_t.restoreStructures||(_t.restoreStructures=[]))[t]=i),_t[t]=e,e.read=Vi(e)};ct[Vr]=t=>{let e=t.length,i=t[1];Ki(t[0],i);let s={};for(let r=2;r<e;r++){let n=i[r-2];s[Nt(n)]=t[r]}return s};ct[14]=t=>yt?yt[0].slice(yt.position0,yt.position0+=t):new we(t,14);ct[15]=t=>yt?yt[1].slice(yt.position1,yt.position1+=t):new we(t,15);var Jr={Error,RegExp};ct[27]=t=>(Jr[t[0]]||Error)(t[1],t[2]);var Js=t=>{if(z[y++]!=132)throw new Error("Packed values structure must be followed by a 4 element array");let e=t();return Rt=Rt?e.concat(Rt.slice(e.length)):e,Rt.prefixes=t(),Rt.suffixes=t(),t()};Js.handlesRead=!0;ct[51]=Js;ct[Rs]=t=>{if(!Rt)if(Y.getShared)Xi();else return new we(t,Rs);if(typeof t=="number")return Rt[16+(t>=0?2*t:-2*t-1)];throw new Error("No support for non-integer packed references yet")};ct[28]=t=>{Vt||(Vt=new Map,Vt.id=0);let e=Vt.id++,i=z[y],s;i>>5==4?s=[]:s={};let r={target:s};Vt.set(e,r);let n=t();return r.used?Object.assign(s,n):(r.target=n,n)};ct[28].handlesRead=!0;ct[29]=t=>{let e=Vt.get(t);return e.used=!0,e.target};ct[258]=t=>new Set(t);(ct[259]=t=>(Y.mapsAsObjects&&(Y.mapsAsObjects=!1,He=!0),t())).handlesRead=!0;function Re(t,e){return typeof t=="string"?t+e:t instanceof Array?t.concat(e):Object.assign({},t,e)}function ge(){if(!Rt)if(Y.getShared)Xi();else throw new Error("No packed values available");return Rt}var Qr=1399353956;Gi.push((t,e)=>{if(t>=225&&t<=255)return Re(ge().prefixes[t-224],e);if(t>=28704&&t<=32767)return Re(ge().prefixes[t-28672],e);if(t>=1879052288&&t<=2147483647)return Re(ge().prefixes[t-1879048192],e);if(t>=216&&t<=223)return Re(e,ge().suffixes[t-216]);if(t>=27647&&t<=28671)return Re(e,ge().suffixes[t-27639]);if(t>=1811940352&&t<=1879048191)return Re(e,ge().suffixes[t-1811939328]);if(t==Qr)return{packedValues:Rt,structures:_t.slice(0),version:e};if(t==55799)return e});var tn=new Uint8Array(new Uint16Array([1]).buffer)[0]==1,Ms=[Uint8Array,Uint8ClampedArray,Uint16Array,Uint32Array,typeof BigUint64Array>"u"?{name:"BigUint64Array"}:BigUint64Array,Int8Array,Int16Array,Int32Array,typeof BigInt64Array>"u"?{name:"BigInt64Array"}:BigInt64Array,Float32Array,Float64Array],en=[64,68,69,70,71,72,77,78,79,85,86];for(let t=0;t<Ms.length;t++)sn(Ms[t],en[t]);function sn(t,e){let i="get"+t.name.slice(0,-5);typeof t!="function"&&(t=null);let s=t.BYTES_PER_ELEMENT;for(let r=0;r<2;r++){if(!r&&s==1)continue;let n=s==2?1:s==4?2:3;ct[r?e:e-4]=s==1||r==tn?o=>{if(!t)throw new Error("Could not find typed array for code "+e);return new t(Uint8Array.prototype.slice.call(o,0).buffer)}:o=>{if(!t)throw new Error("Could not find typed array for code "+e);let h=new DataView(o.buffer,o.byteOffset,o.byteLength),_=o.length>>n,c=new t(_),d=h[i];for(let p=0;p<_;p++)c[p]=d.call(h,p<<n,r);return c}}}function rn(){let t=Ce(),e=y+$();for(let s=2;s<t;s++){let r=Ce();y+=r}let i=y;return y=e,yt=[Hi(Ce()),Hi(Ce())],yt.position0=0,yt.position1=0,yt.postBundlePosition=y,y=i,$()}function Ce(){let t=z[y++]&31;if(t>23)switch(t){case 24:t=z[y++];break;case 25:t=Dt.getUint16(y),y+=2;break;case 26:t=Dt.getUint32(y),y+=4;break}return t}function Xi(){if(Y.getShared){let t=Qs(()=>(z=null,Y.getShared()))||{},e=t.structures||[];Y.sharedVersion=t.version,Rt=Y.sharedValues=t.packedValues,_t===!0?Y.structures=_t=e:_t.splice.apply(_t,[0,e.length].concat(e))}}function Qs(t){let e=ye,i=y,s=Bi,r=ui,n=Ke,o=di,h=ji,_=Vt,c=yt,d=new Uint8Array(z.slice(0,ye)),p=_t,f=Y,g=$e,x=t();return ye=e,y=i,Bi=s,ui=r,Ke=n,di=o,ji=h,Vt=_,yt=c,z=d,$e=g,_t=p,Y=f,Dt=new DataView(z.buffer,z.byteOffset,z.byteLength),x}function $i(){z=null,Vt=null,_t=null}function nn(t){ct[t.tag]=t.decode}var Ji=new Array(147);for(let t=0;t<256;t++)Ji[t]=+("1e"+Math.floor(45.15-t*.30103));var Qi=new Ys({useRecords:!1}),on=Qi.decode,Qn=Qi.decodeMultiple,hn={NEVER:0,ALWAYS:1,DECIMAL_ROUND:3,DECIMAL_FIT:4},_i;try{_i=new TextEncoder}catch{}var pi,ts,fi=globalThis.Buffer,Ye=typeof fi<"u",Ri=Ye?fi.allocUnsafeSlow:Uint8Array,Ls=Ye?fi:Uint8Array,Fs=256,Ns=Ye?4294967296:2144337920,Ci,l,it,u=0,le,gt=null,an=61440,_n=/[\u0080-\uFFFF]/,Pt=Symbol("record-id"),cn=class extends Ys{constructor(t){super(t),this.offset=0;let e,i,s,r,n,o;t=t||{};let h=Ls.prototype.utf8Write?function(m,O,k){return l.utf8Write(m,O,k)}:_i&&_i.encodeInto?function(m,O){return _i.encodeInto(m,l.subarray(O)).written}:!1,_=this,c=t.structures||t.saveStructures,d=t.maxSharedStructures;if(d==null&&(d=c?128:0),d>8190)throw new Error("Maximum maxSharedStructure is 8190");let p=t.sequential;p&&(d=0),this.structures||(this.structures=[]),this.saveStructures&&(this.saveShared=this.saveStructures);let f,g,x=t.sharedValues,b;if(x){b=Object.create(null);for(let m=0,O=x.length;m<O;m++)b[x[m]]=m}let w=[],F=0,A=0;this.mapEncode=function(m,O){if(this._keyMap&&!this._mapped)switch(m.constructor.name){case"Array":m=m.map(k=>this.encodeKeys(k));break}return this.encode(m,O)},this.encode=function(m,O){if(l||(l=new Ri(8192),it=new DataView(l.buffer,0,8192),u=0),le=l.length-10,le-u<2048?(l=new Ri(l.length),it=new DataView(l.buffer,0,l.length),le=l.length-10,u=0):O===Ws&&(u=u+7&2147483640),i=u,_.useSelfDescribedHeader&&(it.setUint32(u,3654940416),u+=3),o=_.structuredClone?new Map:null,_.bundleStrings&&typeof m!="string"?(gt=[],gt.size=1/0):gt=null,s=_.structures,s){if(s.uninitialized){let I=_.getShared()||{};_.structures=s=I.structures||[],_.sharedVersion=I.version;let U=_.sharedValues=I.packedValues;if(U){b={};for(let R=0,j=U.length;R<j;R++)b[U[R]]=R}}let k=s.length;if(k>d&&!p&&(k=d),!s.transitions){s.transitions=Object.create(null);for(let I=0;I<k;I++){let U=s[I];if(!U)continue;let R,j=s.transitions;for(let G=0,V=U.length;G<V;G++){j[Pt]===void 0&&(j[Pt]=I);let H=U[G];R=j[H],R||(R=j[H]=Object.create(null)),j=R}j[Pt]=I|1048576}}p||(s.nextId=k)}if(r&&(r=!1),n=s||[],g=b,t.pack){let k=new Map;if(k.values=[],k.encoder=_,k.maxValues=t.maxPrivatePackedValues||(b?16:1/0),k.objectMap=b||!1,k.samplingPackedValues=f,ci(m,k),k.values.length>0){l[u++]=216,l[u++]=51,Jt(4);let I=k.values;S(I),Jt(0),Jt(0),g=Object.create(b||null);for(let U=0,R=I.length;U<R;U++)g[I[U]]=U}}Ci=O&Mi;try{if(Ci)return;if(S(m),gt&&Gs(i,S),_.offset=u,o&&o.idsToInsert){u+=o.idsToInsert.length*2,u>le&&dt(u),_.offset=u;let k=pn(l.subarray(i,u),o.idsToInsert);return o=null,k}return O&Ws?(l.start=i,l.end=u,l):l.subarray(i,u)}finally{if(s){if(A<10&&A++,s.length>d&&(s.length=d),F>1e4)s.transitions=null,A=0,F=0,w.length>0&&(w=[]);else if(w.length>0&&!p){for(let k=0,I=w.length;k<I;k++)w[k][Pt]=void 0;w=[]}}if(r&&_.saveShared){_.structures.length>d&&(_.structures=_.structures.slice(0,d));let k=l.subarray(i,u);return _.updateSharedData()===!1?_.encode(m):k}O&mn&&(u=i)}},this.findCommonStringsToPack=()=>(f=new Map,b||(b=Object.create(null)),m=>{let O=m&&m.threshold||4,k=this.pack?m.maxPrivatePackedValues||16:0;x||(x=this.sharedValues=[]);for(let[I,U]of f)U.count>O&&(b[I]=k++,x.push(I),r=!0);for(;this.saveShared&&this.updateSharedData()===!1;);f=null});let S=m=>{u>le&&(l=dt(u));var O=typeof m,k;if(O==="string"){if(g){let j=g[m];if(j>=0){j<16?l[u++]=j+224:(l[u++]=198,j&1?S(15-j>>1):S(j-16>>1));return}else if(f&&!t.pack){let G=f.get(m);G?G.count++:f.set(m,{count:1})}}let I=m.length;if(gt&&I>=4&&I<1024){if((gt.size+=I)>an){let G,V=(gt[0]?gt[0].length*3+gt[1].length:0)+10;u+V>le&&(l=dt(u+V)),l[u++]=217,l[u++]=223,l[u++]=249,l[u++]=gt.position?132:130,l[u++]=26,G=u-i,u+=4,gt.position&&Gs(i,S),gt=["",""],gt.size=0,gt.position=G}let j=_n.test(m);gt[j?0:1]+=m,l[u++]=j?206:207,S(I);return}let U;I<32?U=1:I<256?U=2:I<65536?U=3:U=5;let R=I*3;if(u+R>le&&(l=dt(u+R)),I<64||!h){let j,G,V,H=u+U;for(j=0;j<I;j++)G=m.charCodeAt(j),G<128?l[H++]=G:G<2048?(l[H++]=G>>6|192,l[H++]=G&63|128):(G&64512)===55296&&((V=m.charCodeAt(j+1))&64512)===56320?(G=65536+((G&1023)<<10)+(V&1023),j++,l[H++]=G>>18|240,l[H++]=G>>12&63|128,l[H++]=G>>6&63|128,l[H++]=G&63|128):(l[H++]=G>>12|224,l[H++]=G>>6&63|128,l[H++]=G&63|128);k=H-u-U}else k=h(m,u+U,R);k<24?l[u++]=96|k:k<256?(U<2&&l.copyWithin(u+2,u+1,u+1+k),l[u++]=120,l[u++]=k):k<65536?(U<3&&l.copyWithin(u+3,u+2,u+2+k),l[u++]=121,l[u++]=k>>8,l[u++]=k&255):(U<5&&l.copyWithin(u+5,u+3,u+3+k),l[u++]=122,it.setUint32(u,k),u+=4),u+=k}else if(O==="number")if(!this.alwaysUseFloat&&m>>>0===m)m<24?l[u++]=m:m<256?(l[u++]=24,l[u++]=m):m<65536?(l[u++]=25,l[u++]=m>>8,l[u++]=m&255):(l[u++]=26,it.setUint32(u,m),u+=4);else if(!this.alwaysUseFloat&&m>>0===m)m>=-24?l[u++]=31-m:m>=-256?(l[u++]=56,l[u++]=~m):m>=-65536?(l[u++]=57,it.setUint16(u,~m),u+=2):(l[u++]=58,it.setUint32(u,~m),u+=4);else{let I;if((I=this.useFloat32)>0&&m<4294967296&&m>=-2147483648){l[u++]=250,it.setFloat32(u,m);let U;if(I<4||(U=m*Ji[(l[u]&127)<<1|l[u+1]>>7])>>0===U){u+=4;return}else u--}l[u++]=251,it.setFloat64(u,m),u+=8}else if(O==="object")if(!m)l[u++]=246;else{if(o){let U=o.get(m);if(U){if(l[u++]=216,l[u++]=29,l[u++]=25,!U.references){let R=o.idsToInsert||(o.idsToInsert=[]);U.references=[],R.push(U)}U.references.push(u-i),u+=2;return}else o.set(m,{offset:u-i})}let I=m.constructor;if(I===Object)X(m,!0);else if(I===Array){k=m.length,k<24?l[u++]=128|k:Jt(k);for(let U=0;U<k;U++)S(m[U])}else if(I===Map)if((this.mapsAsObjects?this.useTag259ForMaps!==!1:this.useTag259ForMaps)&&(l[u++]=217,l[u++]=1,l[u++]=3),k=m.size,k<24?l[u++]=160|k:k<256?(l[u++]=184,l[u++]=k):k<65536?(l[u++]=185,l[u++]=k>>8,l[u++]=k&255):(l[u++]=186,it.setUint32(u,k),u+=4),_.keyMap)for(let[U,R]of m)S(_.encodeKey(U)),S(R);else for(let[U,R]of m)S(U),S(R);else{for(let U=0,R=pi.length;U<R;U++){let j=ts[U];if(m instanceof j){let G=pi[U],V=G.tag;V==null&&(V=G.getTag&&G.getTag.call(this,m)),V<24?l[u++]=192|V:V<256?(l[u++]=216,l[u++]=V):V<65536?(l[u++]=217,l[u++]=V>>8,l[u++]=V&255):V>-1&&(l[u++]=218,it.setUint32(u,V),u+=4),G.encode.call(this,m,S,dt);return}}if(m[Symbol.iterator]){if(Ci){let U=new Error("Iterable should be serialized as iterator");throw U.iteratorNotHandled=!0,U}l[u++]=159;for(let U of m)S(U);l[u++]=255;return}if(m[Symbol.asyncIterator]||Pi(m)){let U=new Error("Iterable/blob should be serialized as iterator");throw U.iteratorNotHandled=!0,U}X(m,!m.hasOwnProperty)}}else if(O==="boolean")l[u++]=m?245:244;else if(O==="bigint"){if(m<BigInt(1)<<BigInt(64)&&m>=0)l[u++]=27,it.setBigUint64(u,m);else if(m>-(BigInt(1)<<BigInt(64))&&m<0)l[u++]=59,it.setBigUint64(u,-m-BigInt(1));else if(this.largeBigIntToFloat)l[u++]=251,it.setFloat64(u,Number(m));else throw new RangeError(m+" was too large to fit in CBOR 64-bit integer format, set largeBigIntToFloat to convert to float-64");u+=8}else if(O==="undefined")l[u++]=247;else throw new Error("Unknown type: "+O)},X=this.useRecords===!1?this.variableMapSize?m=>{let O=Object.keys(m),k=Object.values(m),I=O.length;I<24?l[u++]=160|I:I<256?(l[u++]=184,l[u++]=I):I<65536?(l[u++]=185,l[u++]=I>>8,l[u++]=I&255):(l[u++]=186,it.setUint32(u,I),u+=4);let U;if(_.keyMap)for(let R=0;R<I;R++)S(encodeKey(O[R])),S(k[R]);else for(let R=0;R<I;R++)S(O[R]),S(k[R])}:(m,O)=>{l[u++]=185;let k=u-i;u+=2;let I=0;if(_.keyMap)for(let U in m)(O||m.hasOwnProperty(U))&&(S(_.encodeKey(U)),S(m[U]),I++);else for(let U in m)(O||m.hasOwnProperty(U))&&(S(U),S(m[U]),I++);l[k+++i]=I>>8,l[k+i]=I&255}:(m,O)=>{let k,I=n.transitions||(n.transitions=Object.create(null)),U=0,R=0,j,G;if(this.keyMap){G=Object.keys(m).map(H=>this.encodeKey(H)),R=G.length;for(let H=0;H<R;H++){let fe=G[H];k=I[fe],k||(k=I[fe]=Object.create(null),U++),I=k}}else for(let H in m)(O||m.hasOwnProperty(H))&&(k=I[H],k||(I[Pt]&1048576&&(j=I[Pt]&65535),k=I[H]=Object.create(null),U++),I=k,R++);let V=I[Pt];if(V!==void 0)V&=65535,l[u++]=217,l[u++]=V>>8|224,l[u++]=V&255;else if(G||(G=I.__keys__||(I.__keys__=Object.keys(m))),j===void 0?(V=n.nextId++,V||(V=0,n.nextId=1),V>=Fs&&(n.nextId=(V=d)+1)):V=j,n[V]=G,V<d){l[u++]=217,l[u++]=V>>8|224,l[u++]=V&255,I=n.transitions;for(let H=0;H<R;H++)(I[Pt]===void 0||I[Pt]&1048576)&&(I[Pt]=V),I=I[G[H]];I[Pt]=V|1048576,r=!0}else{if(I[Pt]=V,it.setUint32(u,3655335680),u+=3,U&&(F+=A*U),w.length>=Fs-d&&(w.shift()[Pt]=void 0),w.push(I),Jt(R+2),S(57344+V),S(G),O===null)return;for(let H in m)(O||m.hasOwnProperty(H))&&S(m[H]);return}if(R<24?l[u++]=128|R:Jt(R),O!==null)for(let H in m)(O||m.hasOwnProperty(H))&&S(m[H])},dt=m=>{let O;if(m>16777216){if(m-i>Ns)throw new Error("Encoded buffer would be larger than maximum buffer size");O=Math.min(Ns,Math.round(Math.max((m-i)*(m>67108864?1.25:2),4194304)/4096)*4096)}else O=(Math.max(m-i<<2,l.length-1)>>12)+1<<12;let k=new Ri(O);return it=new DataView(k.buffer,0,O),l.copy?l.copy(k,0,i,m):k.set(l.slice(i,m)),u-=i,i=0,le=k.length-10,l=k},Et=100,ve=1e3;this.encodeAsIterable=function(m,O){return be(m,O,Qt)},this.encodeAsAsyncIterable=function(m,O){return be(m,O,ke)};function*Qt(m,O,k){let I=m.constructor;if(I===Object){let U=_.useRecords!==!1;U?X(m,null):js(Object.keys(m).length,160);for(let R in m){let j=m[R];U||S(R),j&&typeof j=="object"?O[R]?yield*Qt(j,O[R]):yield*Q(j,O,R):S(j)}}else if(I===Array){let U=m.length;Jt(U);for(let R=0;R<U;R++){let j=m[R];j&&(typeof j=="object"||u-i>Et)?O.element?yield*Qt(j,O.element):yield*Q(j,O,"element"):S(j)}}else if(m[Symbol.iterator]){l[u++]=159;for(let U of m)U&&(typeof U=="object"||u-i>Et)?O.element?yield*Qt(U,O.element):yield*Q(U,O,"element"):S(U);l[u++]=255}else Pi(m)?(js(m.size,64),yield l.subarray(i,u),yield m,ut()):m[Symbol.asyncIterator]?(l[u++]=159,yield l.subarray(i,u),yield m,ut(),l[u++]=255):S(m);k&&u>i?yield l.subarray(i,u):u-i>Et&&(yield l.subarray(i,u),ut())}function*Q(m,O,k){let I=u-i;try{S(m),u-i>Et&&(yield l.subarray(i,u),ut())}catch(U){if(U.iteratorNotHandled)O[k]={},u=i+I,yield*Qt.call(this,m,O[k]);else throw U}}function ut(){Et=ve,_.encode(null,Mi)}function be(m,O,k){return O&&O.chunkThreshold?Et=ve=O.chunkThreshold:Et=100,m&&typeof m=="object"?(_.encode(null,Mi),k(m,_.iterateProperties||(_.iterateProperties={}),!0)):[_.encode(m)]}async function*ke(m,O){for(let k of Qt(m,O,!0)){let I=k.constructor;if(I===Ls||I===Uint8Array)yield k;else if(Pi(k)){let U=k.stream().getReader(),R;for(;!(R=await U.read()).done;)yield R.value}else if(k[Symbol.asyncIterator])for await(let U of k)ut(),U?yield*ke(U,O.async||(O.async={})):yield _.encode(U);else yield k}}}useBuffer(t){l=t,it=new DataView(l.buffer,l.byteOffset,l.byteLength),u=0}clearSharedData(){this.structures&&(this.structures=[]),this.sharedValues&&(this.sharedValues=void 0)}updateSharedData(){let t=this.sharedVersion||0;this.sharedVersion=t+1;let e=this.structures.slice(0),i=new tr(e,this.sharedValues,this.sharedVersion),s=this.saveShared(i,r=>(r&&r.version||0)==t);return s===!1?(i=this.getShared()||{},this.structures=i.structures||[],this.sharedValues=i.packedValues,this.sharedVersion=i.version,this.structures.nextId=this.structures.length):e.forEach((r,n)=>this.structures[n]=r),s}};function js(t,e){t<24?l[u++]=e|t:t<256?(l[u++]=e|24,l[u++]=t):t<65536?(l[u++]=e|25,l[u++]=t>>8,l[u++]=t&255):(l[u++]=e|26,it.setUint32(u,t),u+=4)}var tr=class{constructor(t,e,i){this.structures=t,this.packedValues=e,this.version=i}};function Jt(t){t<24?l[u++]=128|t:t<256?(l[u++]=152,l[u++]=t):t<65536?(l[u++]=153,l[u++]=t>>8,l[u++]=t&255):(l[u++]=154,it.setUint32(u,t),u+=4)}var dn=typeof Blob>"u"?function(){}:Blob;function Pi(t){if(t instanceof dn)return!0;let e=t[Symbol.toStringTag];return e==="Blob"||e==="File"}function ci(t,e){switch(typeof t){case"string":if(t.length>3){if(e.objectMap[t]>-1||e.values.length>=e.maxValues)return;let s=e.get(t);if(s)++s.count==2&&e.values.push(t);else if(e.set(t,{count:1}),e.samplingPackedValues){let r=e.samplingPackedValues.get(t);r?r.count++:e.samplingPackedValues.set(t,{count:1})}}break;case"object":if(t)if(t instanceof Array)for(let s=0,r=t.length;s<r;s++)ci(t[s],e);else{let s=!e.encoder.useRecords;for(var i in t)t.hasOwnProperty(i)&&(s&&ci(i,e),ci(t[i],e))}break;case"function":console.log(t)}}var un=new Uint8Array(new Uint16Array([1]).buffer)[0]==1;ts=[Date,Set,Error,RegExp,we,ArrayBuffer,Uint8Array,Uint8ClampedArray,Uint16Array,Uint32Array,typeof BigUint64Array>"u"?function(){}:BigUint64Array,Int8Array,Int16Array,Int32Array,typeof BigInt64Array>"u"?function(){}:BigInt64Array,Float32Array,Float64Array,tr];pi=[{tag:1,encode(t,e){let i=t.getTime()/1e3;(this.useTimestamp32||t.getMilliseconds()===0)&&i>=0&&i<4294967296?(l[u++]=26,it.setUint32(u,i),u+=4):(l[u++]=251,it.setFloat64(u,i),u+=8)}},{tag:258,encode(t,e){let i=Array.from(t);e(i)}},{tag:27,encode(t,e){e([t.name,t.message])}},{tag:27,encode(t,e){e(["RegExp",t.source,t.flags])}},{getTag(t){return t.tag},encode(t,e){e(t.value)}},{encode(t,e,i){Bs(t,i)}},{getTag(t){if(t.constructor===Uint8Array&&(this.tagUint8Array||Ye&&this.tagUint8Array!==!1))return 64},encode(t,e,i){Bs(t,i)}},Xt(68,1),Xt(69,2),Xt(70,4),Xt(71,8),Xt(72,1),Xt(77,2),Xt(78,4),Xt(79,8),Xt(85,4),Xt(86,8),{encode(t,e){let i=t.packedValues||[],s=t.structures||[];if(i.values.length>0){l[u++]=216,l[u++]=51,Jt(4);let r=i.values;e(r),Jt(0),Jt(0),packedObjectMap=Object.create(sharedPackedObjectMap||null);for(let n=0,o=r.length;n<o;n++)packedObjectMap[r[n]]=n}if(s){it.setUint32(u,3655335424),u+=3;let r=s.slice(0);r.unshift(57344),r.push(new we(t.version,1399353956)),e(r)}else e(new we(t.version,1399353956))}}];function Xt(t,e){return!un&&e>1&&(t-=4),{tag:t,encode:function(i,s){let r=i.byteLength,n=i.byteOffset||0,o=i.buffer||i;s(Ye?fi.from(o,n,r):new Uint8Array(o,n,r))}}}function Bs(t,e){let i=t.byteLength;i<24?l[u++]=64+i:i<256?(l[u++]=88,l[u++]=i):i<65536?(l[u++]=89,l[u++]=i>>8,l[u++]=i&255):(l[u++]=90,it.setUint32(u,i),u+=4),u+i>=l.length&&e(u+i),l.set(t.buffer?t:new Uint8Array(t),u),u+=i}function pn(t,e){let i,s=e.length*2,r=t.length-s;e.sort((n,o)=>n.offset>o.offset?1:-1);for(let n=0;n<e.length;n++){let o=e[n];o.id=n;for(let h of o.references)t[h++]=n>>8,t[h]=n&255}for(;i=e.pop();){let n=i.offset;t.copyWithin(n+s,n,r),s-=2;let o=n+s;t[o++]=216,t[o++]=28,r=n}return t}function Gs(t,e){it.setUint32(gt.position+t,u-gt.position-t+1);let i=gt;gt=null,e(i[0]),e(i[1])}function ln(t){if(t.Class){if(!t.encode)throw new Error("Extension has no encode function");ts.unshift(t.Class),pi.unshift(t)}nn(t)}var es=new cn({useRecords:!1}),fn=es.encode,to=es.encodeAsIterable,eo=es.encodeAsAsyncIterable,{NEVER:io,ALWAYS:so,DECIMAL_ROUND:ro,DECIMAL_FIT:no}=hn,Ws=512,mn=1024,Mi=2048,gn=class{constructor(t=!1,e){Object.defineProperty(this,"debug",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.debug=t,e&&e.forEach(ln)}encoder(t){return new yn(t,this.debug)}decoder(t){return new wn(t,this.debug)}},yn=class{constructor(t,e=!1){Object.defineProperty(this,"w",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"debug",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.w=t,this.debug=e}async encode(t){this.debug&&console.log("<<",t);let e=fn(t),i=0;for(;i<e.length;)i+=await this.w.write(e.subarray(i))}},wn=class{constructor(t,e=!1){Object.defineProperty(this,"r",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"debug",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.r=t,this.debug=e}async decode(t){let e=new Uint8Array(t),i=0;for(;i<t;){let r=await this.r.read(e.subarray(i));if(r===null)return Promise.resolve(null);i+=r}let s=on(e);return this.debug&&console.log(">>",s),Promise.resolve(s)}};function hi(t,e,i=0){i=Math.max(0,Math.min(i,e.byteLength));let s=e.byteLength-i;return t.byteLength>s&&(t=t.subarray(0,s)),e.set(t,i),t.byteLength}var ai=32*1024,Li=2**32-2,vn=class{constructor(t){Object.defineProperty(this,"_buf",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_off",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this._buf=t===void 0?new Uint8Array(0):new Uint8Array(t),this._off=0}bytes(t={copy:!0}){return t.copy===!1?this._buf.subarray(this._off):this._buf.slice(this._off)}empty(){return this._buf.byteLength<=this._off}get length(){return this._buf.byteLength-this._off}get capacity(){return this._buf.buffer.byteLength}truncate(t){if(t===0){this.reset();return}if(t<0||t>this.length)throw Error("bytes.Buffer: truncation out of range");this._reslice(this._off+t)}reset(){this._reslice(0),this._off=0}_tryGrowByReslice(t){let e=this._buf.byteLength;return t<=this.capacity-e?(this._reslice(e+t),e):-1}_reslice(t){this._buf=new Uint8Array(this._buf.buffer,0,t)}readSync(t){if(this.empty())return this.reset(),t.byteLength===0?0:null;let e=hi(this._buf.subarray(this._off),t);return this._off+=e,e}read(t){let e=this.readSync(t);return Promise.resolve(e)}writeSync(t){let e=this._grow(t.byteLength);return hi(t,this._buf,e)}write(t){let e=this.writeSync(t);return Promise.resolve(e)}_grow(t){let e=this.length;e===0&&this._off!==0&&this.reset();let i=this._tryGrowByReslice(t);if(i>=0)return i;let s=this.capacity;if(t<=Math.floor(s/2)-e)hi(this._buf.subarray(this._off),this._buf);else{if(s+t>Li)throw new Error("The buffer cannot be grown beyond the maximum size.");{let r=new Uint8Array(Math.min(2*s+t,Li));hi(this._buf.subarray(this._off),r),this._buf=r}}return this._off=0,this._reslice(Math.min(e+t,Li)),e}grow(t){if(t<0)throw Error("Buffer.grow: negative count");let e=this._grow(t);this._reslice(e)}async readFrom(t){let e=0,i=new Uint8Array(ai);for(;;){let s=this.capacity-this.length<ai,r=s?i:new Uint8Array(this._buf.buffer,this.length),n=await t.read(r);if(n===null)return e;s?this.writeSync(r.subarray(0,n)):this._reslice(this.length+n),e+=n}}readFromSync(t){let e=0,i=new Uint8Array(ai);for(;;){let s=this.capacity-this.length<ai,r=s?i:new Uint8Array(this._buf.buffer,this.length),n=t.readSync(r);if(n===null)return e;s?this.writeSync(r.subarray(0,n)):this._reslice(this.length+n),e+=n}}},er=class{constructor(t){Object.defineProperty(this,"codec",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.codec=t}encoder(t){return new bn(t,this.codec)}decoder(t){return new kn(t,this.codec.decoder(t))}},bn=class{constructor(t,e){Object.defineProperty(this,"w",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"codec",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.w=t,this.codec=e}async encode(t){let e=new vn;await this.codec.encoder(e).encode(t);let i=new DataView(new ArrayBuffer(4));i.setUint32(0,e.length);let s=new Uint8Array(e.length+4);s.set(new Uint8Array(i.buffer),0),s.set(e.bytes(),4);let r=0;for(;r<s.length;)r+=await this.w.write(s.subarray(r))}},kn=class{constructor(t,e){Object.defineProperty(this,"r",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dec",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.r=t,this.dec=e}async decode(t){let e=new Uint8Array(4);if(await this.r.read(e)===null)return null;let i=new DataView(e.buffer).getUint32(0);return await this.dec.decode(i)}},ir=class{constructor(t,e){Object.defineProperty(this,"session",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"codec",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.session=t,this.codec=e}async call(t,e){let i=await this.session.open();try{let s=new er(this.codec),r=s.encoder(i),n=s.decoder(i);await r.encode({S:t}),await r.encode(e);let o=await n.decode(),h=new On(i,s);if(h.error=o.E,h.error!==void 0&&h.error!==null)throw h.error;return h.value=await n.decode(),h.continue=o.C,h.continue||await i.close(),h}catch(s){return await i.close(),Promise.reject(s)}}};function xn(t){function e(i,s){return new Proxy(Object.assign(()=>{},{path:i,callable:s}),{get(r,n,o){return n.startsWith("__")?Reflect.get(r,n,o):e(r.path?`${r.path}.${n}`:n,r.callable)},apply(r,n,o=[]){return r.callable(r.path,o)}})}return e("",t.call.bind(t))}function An(t){return{respondRPC:t}}function Un(){return An((t,e)=>{t.return(new Error(`not found: ${e.selector}`))})}function Fi(t){return t===""?"/":(t[0]!="/"&&(t="/"+t),t=t.replace(".","/"),t.toLowerCase())}var sr=class{constructor(){Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers={}}async respondRPC(t,e){await this.handler(e).respondRPC(t,e)}handler(t){return this.match(t.selector)||Un()}remove(t){t=Fi(t);let e=this.match(t);return delete this.handlers[t],e||null}match(t){if(t=Fi(t),this.handlers.hasOwnProperty(t))return this.handlers[t];let e=Object.keys(this.handlers).filter(i=>i.endsWith("/"));e.sort((i,s)=>s.length-i.length);for(let i of e)if(t.startsWith(i)){let s=this.handlers[i],r=s;return r.match&&r.match instanceof Function?r.match(t.slice(i.length)):s}return null}handle(t,e){if(t==="")throw"handle: invalid selector";let i=Fi(t),s=e;if(s.match&&s.match instanceof Function&&!i.endsWith("/")&&(i=i+"/"),!e)throw"handle: invalid handler";if(this.match(i))throw"handle: selector already registered";this.handlers[i]=e}};async function En(t,e,i){let s=new er(e),r=s.decoder(t),n=await r.decode(),o=new Sn(n.S,t,r);o.caller=new ir(t.session,e);let h=new qn,_=new In(t,s,h);return i||(i=new sr),await i.respondRPC(_,o),_.responded||await _.return(null),Promise.resolve()}var In=class{constructor(t,e,i){Object.defineProperty(this,"header",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ch",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"codec",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"responded",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.ch=t,this.codec=e,this.header=i,this.responded=!1}send(t){return this.codec.encoder(this.ch).encode(t)}return(t){return this.respond(t,!1)}async continue(t){return await this.respond(t,!0),this.ch}async respond(t,e){return this.responded=!0,this.header.C=e,t instanceof Error&&(this.header.E=t.message,t=null),await this.send(this.header),await this.send(t),e||await this.ch.close(),Promise.resolve()}},Sn=class{constructor(t,e,i){Object.defineProperty(this,"selector",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"channel",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"decoder",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.selector=t,this.channel=e,this.decoder=i}receive(){return this.decoder.decode()}},qn=class{constructor(){Object.defineProperty(this,"E",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"C",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.E=void 0,this.C=!1}},On=class{constructor(t,e){Object.defineProperty(this,"error",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"continue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"channel",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"codec",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.channel=t,this.codec=e,this.error=void 0,this.continue=!1}send(t){return this.codec.encoder(this.channel).encode(t)}receive(){return this.codec.decoder(this.channel).decode()}};function Dn(t){function e(i,s){return new Proxy(Object.assign(()=>{},{path:i,callable:s}),{get(r,n,o){return n.startsWith("__")?Reflect.get(r,n,o):e(r.path?`${r.path}.${n}`:n,r.callable)},apply(r,n,o=[]){return r.callable(r.path,o)}})}return e("",t.call.bind(t))}var Tn=class{constructor(t,e){Object.defineProperty(this,"session",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"codec",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"responder",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.session=t,this.codec=e,this.caller=new ir(t,e),this.responder=new sr}close(){return this.session.close()}async respond(){for(;;){let t=await this.session.accept();if(t===null)break;En(t,this.codec,this.responder)}}async call(t,e){return this.caller.call(t,e)}handle(t,e){this.responder.handle(t,e)}respondRPC(t,e){this.responder.respondRPC(t,e)}proxy(){return Dn(this.caller)}virtualize(){return xn(this.caller)}},zn=new Map([[100,12],[101,16],[102,4],[103,8],[104,8],[105,4],[106,4]]),Rn=class{constructor(t){Object.defineProperty(this,"w",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.w=t}async encode(t){li.messages&&console.log("<<ENC",t);let e=Cn(t);li.bytes&&console.log("<<ENC",e);let i=0;for(;i<e.length;)i+=await this.w.write(e.subarray(i));return i}};function Cn(t){if(t.ID===106){let e=t,i=new DataView(new ArrayBuffer(5));return i.setUint8(0,e.ID),i.setUint32(1,e.channelID),new Uint8Array(i.buffer)}if(t.ID===104){let e=t,i=new DataView(new ArrayBuffer(9));i.setUint8(0,e.ID),i.setUint32(1,e.channelID),i.setUint32(5,e.length);let s=new Uint8Array(9+e.length);return s.set(new Uint8Array(i.buffer),0),s.set(e.data,9),s}if(t.ID===105){let e=t,i=new DataView(new ArrayBuffer(5));return i.setUint8(0,e.ID),i.setUint32(1,e.channelID),new Uint8Array(i.buffer)}if(t.ID===100){let e=t,i=new DataView(new ArrayBuffer(13));return i.setUint8(0,e.ID),i.setUint32(1,e.senderID),i.setUint32(5,e.windowSize),i.setUint32(9,e.maxPacketSize),new Uint8Array(i.buffer)}if(t.ID===101){let e=t,i=new DataView(new ArrayBuffer(17));return i.setUint8(0,e.ID),i.setUint32(1,e.channelID),i.setUint32(5,e.senderID),i.setUint32(9,e.windowSize),i.setUint32(13,e.maxPacketSize),new Uint8Array(i.buffer)}if(t.ID===102){let e=t,i=new DataView(new ArrayBuffer(5));return i.setUint8(0,e.ID),i.setUint32(1,e.channelID),new Uint8Array(i.buffer)}if(t.ID===103){let e=t,i=new DataView(new ArrayBuffer(9));return i.setUint8(0,e.ID),i.setUint32(1,e.channelID),i.setUint32(5,e.additionalBytes),new Uint8Array(i.buffer)}throw`marshal of unknown type: ${t}`}function Yi(t,e){let i=new Uint8Array(e),s=0;return t.forEach(r=>{i.set(r,s),s+=r.length}),i}var rr=class{constructor(){Object.defineProperty(this,"q",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"waiters",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"closed",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.q=[],this.waiters=[],this.closed=!1}push(t){if(this.closed)throw"closed queue";if(this.waiters.length>0){let e=this.waiters.shift();e&&e(t);return}this.q.push(t)}shift(){return this.closed?Promise.resolve(null):new Promise(t=>{if(this.q.length>0){t(this.q.shift()||null);return}this.waiters.push(t)})}close(){this.closed||(this.closed=!0,this.waiters.forEach(t=>{t(null)}))}},Pn=class{constructor(){Object.defineProperty(this,"gotEOF",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"readBuf",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"readers",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.readBuf=new Uint8Array(0),this.gotEOF=!1,this.readers=[]}read(t){return new Promise(e=>{let i=()=>{if(this.readBuf===void 0){e(null);return}if(this.readBuf.length==0){if(this.gotEOF){this.readBuf=void 0,e(null);return}this.readers.push(i);return}let s=this.readBuf.slice(0,t.length);this.readBuf=this.readBuf.slice(s.length),this.readBuf.length==0&&this.gotEOF&&(this.readBuf=void 0),t.set(s),e(s.length)};i()})}write(t){for(this.readBuf&&(this.readBuf=Yi([this.readBuf,t],this.readBuf.length+t.length));!this.readBuf||this.readBuf.length>0;){let e=this.readers.shift();if(!e)break;e()}return Promise.resolve(t.length)}eof(){this.gotEOF=!0,this.flushReaders()}close(){this.readBuf=void 0,this.flushReaders()}flushReaders(){for(;;){let t=this.readers.shift();if(!t)return;t()}}},Mn=class{constructor(t){Object.defineProperty(this,"r",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.r=t}async decode(){let t=await Ln(this.r);if(t===null)return Promise.resolve(null);li.bytes&&console.log(">>DEC",t);let e=Fn(t);return li.messages&&console.log(">>DEC",e),e}};async function Ln(t){let e=new Uint8Array(1);if(await t.read(e)===null)return Promise.resolve(null);let i=e[0],s=zn.get(i);if(s===void 0||i<100||i>106)return Promise.reject(`bad packet: ${i}`);let r=new Uint8Array(s);if(await t.read(r)===null)return Promise.reject("unexpected EOF reading packet");if(i===104){let n=new DataView(r.buffer).getUint32(4),o=0,h=[];for(;o<n;){let _=new Uint8Array(n-o),c=await t.read(_);if(c===null)return Promise.reject("unexpected EOF reading data chunk");o+=c,h.push(_.slice(0,c))}return Yi([e,r,...h],1+r.length+n)}return Yi([e,r],r.length+1)}function Fn(t){let e=new DataView(t.buffer);switch(t[0]){case 106:return{ID:t[0],channelID:e.getUint32(1)};case 104:let i=e.getUint32(5),s=new Uint8Array(t.buffer.slice(9));return{ID:t[0],channelID:e.getUint32(1),length:i,data:s};case 105:return{ID:t[0],channelID:e.getUint32(1)};case 100:return{ID:t[0],senderID:e.getUint32(1),windowSize:e.getUint32(5),maxPacketSize:e.getUint32(9)};case 101:return{ID:t[0],channelID:e.getUint32(1),senderID:e.getUint32(5),windowSize:e.getUint32(9),maxPacketSize:e.getUint32(13)};case 102:return{ID:t[0],channelID:e.getUint32(1)};case 103:return{ID:t[0],channelID:e.getUint32(1),additionalBytes:e.getUint32(5)};default:throw`unmarshal of unknown type: ${t[0]}`}}var li={messages:!1,bytes:!1},nr=9,or=Number.MAX_VALUE,Nn=class{constructor(t){Object.defineProperty(this,"conn",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"channels",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"incoming",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"enc",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dec",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"done",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"closed",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.conn=t,this.enc=new Rn(t),this.dec=new Mn(t),this.channels=[],this.incoming=new rr,this.done=this.loop(),this.closed=!1}async open(){let t=this.newChannel();if(t.maxIncomingPayload=Zi,await this.enc.encode({ID:100,windowSize:t.myWindow,maxPacketSize:t.maxIncomingPayload,senderID:t.localId}),await t.ready.shift())return t;throw"failed to open"}accept(){return this.incoming.shift()}async close(){for(let t of Object.keys(this.channels)){let e=parseInt(t);this.channels[e]!==void 0&&this.channels[e].shutdown()}this.conn.close(),this.closed=!0,await this.done}async loop(){try{for(;;){let t=await this.dec.decode();if(t===null){this.close();return}if(t.ID===100){await this.handleOpen(t);continue}let e=t,i=this.getCh(e.channelID);if(i===void 0){if(this.closed)return;console.warn(`invalid channel (${e.channelID}) on op ${e.ID}`);continue}await i.handle(e)}}catch(t){if(t.message&&t.message.contains&&t.message.contains("Connection reset by peer"))return;throw t}}async handleOpen(t){if(t.maxPacketSize<nr||t.maxPacketSize>or){await this.enc.encode({ID:102,channelID:t.senderID});return}let e=this.newChannel();e.remoteId=t.senderID,e.maxRemotePayload=t.maxPacketSize,e.remoteWin=t.windowSize,e.maxIncomingPayload=Zi,this.incoming.push(e),await this.enc.encode({ID:101,channelID:e.remoteId,senderID:e.localId,windowSize:e.myWindow,maxPacketSize:e.maxIncomingPayload})}newChannel(){let t=new Bn(this);return t.remoteWin=0,t.myWindow=jn,t.localId=this.addCh(t),t}getCh(t){let e=this.channels[t];return e&&e.localId!==t&&console.log("bad ids:",t,e.localId,e.remoteId),e}addCh(t){return this.channels.forEach((e,i)=>{if(e===void 0)return this.channels[i]=t,i}),this.channels.push(t),this.channels.length-1}rmCh(t){delete this.channels[t]}},Zi=1<<24,jn=64*Zi,Bn=class{constructor(t){Object.defineProperty(this,"localId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"remoteId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxIncomingPayload",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRemotePayload",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"session",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ready",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sentEOF",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sentClose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"remoteWin",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"myWindow",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"readBuf",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writers",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.localId=0,this.remoteId=0,this.maxIncomingPayload=0,this.maxRemotePayload=0,this.sentEOF=!1,this.sentClose=!1,this.remoteWin=0,this.myWindow=0,this.ready=new rr,this.session=t,this.writers=[],this.readBuf=new Pn}get id(){return this.localId}async read(t){let e=await this.readBuf.read(t);if(e!==null)try{await this.adjustWindow(e)}catch(i){if(i!=="EOF"&&i.name!=="BadResource")throw i}return e}write(t){return this.sentEOF?Promise.reject("EOF"):new Promise((e,i)=>{let s=0,r=()=>{if(this.sentEOF||this.sentClose){i("EOF");return}if(t.byteLength==0){e(s);return}let n=Math.min(this.maxRemotePayload,t.length),o=this.reserveWindow(n);if(o==0){this.writers.push(r);return}let h=t.slice(0,o);this.send({ID:104,channelID:this.remoteId,length:h.length,data:h}).then(()=>{if(s+=h.length,t=t.slice(h.length),t.length==0){e(s);return}this.writers.push(r)})};r()})}reserveWindow(t){return this.remoteWin<t&&(t=this.remoteWin),this.remoteWin-=t,t}addWindow(t){for(this.remoteWin+=t;this.remoteWin>0;){let e=this.writers.shift();if(!e)break;e()}}async closeWrite(){this.sentEOF=!0,await this.send({ID:105,channelID:this.remoteId}),this.writers.forEach(t=>t()),this.writers=[]}async close(){if(this.readBuf.eof(),!this.sentClose){for(await this.send({ID:106,channelID:this.remoteId}),this.sentClose=!0;await this.ready.shift()!==null;);return}this.shutdown()}shutdown(){this.readBuf.close(),this.writers.forEach(t=>t()),this.ready.close(),this.session.rmCh(this.localId)}async adjustWindow(t){this.myWindow+=t,await this.send({ID:103,channelID:this.remoteId,additionalBytes:t})}send(t){if(this.sentClose)throw"EOF";return this.sentClose=t.ID===106,this.session.enc.encode(t)}handle(t){if(t.ID===104){this.handleData(t);return}if(t.ID===106){this.close();return}if(t.ID===105&&this.readBuf.eof(),t.ID===102){this.session.rmCh(t.channelID),this.ready.push(!1);return}if(t.ID===101){if(t.maxPacketSize<nr||t.maxPacketSize>or)throw"invalid max packet size";this.remoteId=t.senderID,this.maxRemotePayload=t.maxPacketSize,this.addWindow(t.windowSize),this.ready.push(!0);return}t.ID===103&&this.addWindow(t.additionalBytes)}handleData(t){if(t.length>this.maxIncomingPayload)throw"incoming packet exceeds maximum payload size";if(this.myWindow<t.length)throw"remote side wrote too much";this.myWindow-=t.length,this.readBuf.write(t.data)}},Gn=Hs(Ks(),1),oo=Hs(Ks(),1),Wn={WebSocket:Gn.default},ho=Vn(globalThis,Wn);function Vn(t,e){return new Proxy(t,{get(i,s,r){return s in e?e[s]:t[s]},set(i,s,r){return s in e&&delete e[s],t[s]=r,!0},deleteProperty(i,s){let r=!1;return s in e&&(delete e[s],r=!0),s in t&&(delete t[s],r=!0),r},ownKeys(i){let s=Reflect.ownKeys(t),r=Reflect.ownKeys(e),n=new Set(r);return[...s.filter(o=>!n.has(o)),...r]},defineProperty(i,s,r){return s in e&&delete e[s],Reflect.defineProperty(t,s,r),!0},getOwnPropertyDescriptor(i,s){return s in e?Reflect.getOwnPropertyDescriptor(e,s):Reflect.getOwnPropertyDescriptor(t,s)},has(i,s){return s in e||s in t}})}var Hn=class{constructor(t){Object.defineProperty(this,"port",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"waiters",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"chunks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"isClosed",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.isClosed=!1,this.waiters=[],this.chunks=[],this.port=t,this.port.onmessage=e=>{let i=new Uint8Array(e.data);if(this.chunks.push(i),this.waiters.length>0){let s=this.waiters.shift();s&&s()}}}read(t){return new Promise(e=>{var i=()=>{if(this.isClosed){e(null);return}if(this.chunks.length===0){this.waiters.push(i);return}let s=0;for(;s<t.length;){let r=this.chunks.shift();if(r==null){e(s);return}let n=r.slice(0,t.length-s);if(t.set(n,s),s+=n.length,r.length>n.length){let o=r.slice(n.length);this.chunks.unshift(o)}}e(s)};i()})}write(t){return this.port.postMessage(t,[t.buffer]),Promise.resolve(t.byteLength)}close(){this.isClosed||(this.isClosed=!0,this.waiters.forEach(t=>t()),this.port.close())}},hr=class{constructor(t){let e=new Nn(new Hn(t));this.peer=new Tn(e,new gn)}async readDir(t){return(await this.peer.call("ReadDir",[t])).value}async makeDir(t){await this.peer.call("Mkdir",[t])}async makeDirAll(t){await this.peer.call("MkdirAll",[t])}async bind(t,e){await this.peer.call("Bind",[t,e])}async unbind(t,e){await this.peer.call("Unbind",[t,e])}async readFile(t){return(await this.peer.call("ReadFile",[t])).value}async readFile2(t){let e=await this.openReadable(t),i=new Response(e);return new Uint8Array(await i.arrayBuffer())}async readText(t){return new TextDecoder().decode(await this.readFile(t))}async waitFor(t,e=1e3){await this.peer.call("WaitFor",[t,e])}async stat(t){return(await this.peer.call("Stat",[t])).value}async writeFile(t,e){return typeof e=="string"&&(e=new TextEncoder().encode(e)),(await this.peer.call("WriteFile",[t,e])).value}async appendFile(t,e){return typeof e=="string"&&(e=new TextEncoder().encode(e)),(await this.peer.call("AppendFile",[t,e])).value}async rename(t,e){await this.peer.call("Rename",[t,e])}async copy(t,e){await this.peer.call("Copy",[t,e])}async remove(t){await this.peer.call("Remove",[t])}async removeAll(t){await this.peer.call("RemoveAll",[t])}async truncate(t,e){await this.peer.call("Truncate",[t,e])}async create(t){return(await this.peer.call("Create",[t])).value}async open(t){return(await this.peer.call("Open",[t])).value}async openFile(t,e,i){return(await this.peer.call("OpenFile",[t,e,i])).value}async read(t,e){return(await this.peer.call("Read",[t,e])).value}async write(t,e){return(await this.peer.call("Write",[t,e])).value}async writeAt(t,e,i){return(await this.peer.call("WriteAt",[t,e,i])).value}async close(t){return(await this.peer.call("Close",[t])).value}async sync(t){return(await this.peer.call("Sync",[t])).value}async fstat(t){return(await this.peer.call("Fstat",[t])).value}async lstat(t){return(await this.peer.call("Lstat",[t])).value}async chmod(t,e){await this.peer.call("Chmod",[t,e])}async chown(t,e,i){await this.peer.call("Chown",[t,e,i])}async fchmod(t,e){await this.peer.call("Fchmod",[t,e])}async fchown(t,e,i){await this.peer.call("Fchown",[t,e,i])}async ftruncate(t,e){await this.peer.call("Ftruncate",[t,e])}async readlink(t){return(await this.peer.call("Readlink",[t])).value}async symlink(t,e){await this.peer.call("Symlink",[t,e])}async chtimes(t,e,i){await this.peer.call("Chtimes",[t,e,i])}async openReadable(t){let e=await this.open(t);return this.readable(e)}async openWritable(t){let e=await this.open(t);return this.writable(e)}writable(t){let e=this;return new WritableStream({write(i){return e.write(t,i)}})}readable(t){let e=this;return new ReadableStream({async pull(i){let s=await e.read(t,1024);s===null&&i.close(),i.enqueue(s)}})}};ReadableStream.prototype[Symbol.asyncIterator]||(ReadableStream.prototype[Symbol.asyncIterator]=async function*(){let t=this.getReader();try{for(;;){let{done:e,value:i}=await t.read();if(e)return;yield i}}finally{t.releaseLock()}});var mi=class{constructor(e,i=1056964608,s=16777216){this.emulator=e,this.baseAddr=i,this.size=s,this.CONTROL_SIZE=4096,this.BUFFER_SIZE=(s-this.CONTROL_SIZE)/2,this.JS_GO_HEAD=0,this.JS_GO_TAIL=4,this.GO_JS_HEAD=8,this.GO_JS_TAIL=12,this.JS_GO_BUFFER=this.CONTROL_SIZE,this.GO_JS_BUFFER=this.CONTROL_SIZE+this.BUFFER_SIZE,this.channel=new MessageChannel,this.port1=this.channel.port1,this.port2=this.channel.port2,this.port1.onmessage=r=>this.write(r.data),this.pollForMessages()}readUint32(e){let i=this.emulator.read_memory(this.baseAddr+e,4);return i[0]|i[1]<<8|i[2]<<16|i[3]<<24}writeUint32(e,i){let s=new Uint8Array(4);s[0]=i&255,s[1]=i>>8&255,s[2]=i>>16&255,s[3]=i>>24&255,this.emulator.write_memory(s,this.baseAddr+e)}pollForMessages(){let e=()=>{let i=0,s=1e3;for(;i<s;){let r=this.readUint32(this.GO_JS_HEAD),n=this.readUint32(this.GO_JS_TAIL);if(r-n>>>0===0)break;let h=n%this.BUFFER_SIZE;if(h+4>this.BUFFER_SIZE){let d=(Math.floor(n/this.BUFFER_SIZE)+1)*this.BUFFER_SIZE;this.writeUint32(this.GO_JS_TAIL,d);continue}let _=this.emulator.read_memory(this.baseAddr+this.GO_JS_BUFFER+h,4),c=_[0]|_[1]<<8|_[2]<<16|_[3]<<24;if(c>0&&c<this.BUFFER_SIZE)if(h+4+c<=this.BUFFER_SIZE){let d=this.emulator.read_memory(this.baseAddr+this.GO_JS_BUFFER+h+4,c),p=n+4+c;this.writeUint32(this.GO_JS_TAIL,p),this.port1.postMessage(d.slice().buffer),i++}else{let d=(Math.floor(n/this.BUFFER_SIZE)+1)*this.BUFFER_SIZE;console.log(`Message doesn't fit (tailPos=${h}, length=${c}), skipping to ${d}`),this.writeUint32(this.GO_JS_TAIL,d)}else{let d=(Math.floor(n/this.BUFFER_SIZE)+1)*this.BUFFER_SIZE;this.writeUint32(this.GO_JS_TAIL,d);break}}setTimeout(e,0)};e()}async write(e){let i;typeof e=="string"?i=new TextEncoder().encode(e):e instanceof ArrayBuffer?i=new Uint8Array(e):e instanceof Uint8Array?i=e:i=new TextEncoder().encode(JSON.stringify(e));let s=4+i.length;for(let r=0;r<1e4;r++){let n=this.readUint32(this.JS_GO_HEAD),o=this.readUint32(this.JS_GO_TAIL),h=16384,_=n-o>>>0,c=this.BUFFER_SIZE-_;if(c>h?c-=h:c=0,s<=c){let d=n%this.BUFFER_SIZE;if(d+s>this.BUFFER_SIZE){let g=(Math.floor(n/this.BUFFER_SIZE)+1)*this.BUFFER_SIZE;if(o%this.BUFFER_SIZE>=s)n=g,d=0;else continue}let p=new Uint8Array(s);p[0]=i.length&255,p[1]=i.length>>8&255,p[2]=i.length>>16&255,p[3]=i.length>>24&255,p.set(i,4),this.emulator.write_memory(p,this.baseAddr+this.JS_GO_BUFFER+d);let f=n+s;this.writeUint32(this.JS_GO_HEAD,f);return}await new Promise(d=>setTimeout(d,10))}console.warn("Buffer full after 10k attempts - message dropped")}getUserPort(){return this.port2}};self.onmessage=async t=>{if(!t.data.id)return;console.log("v86 loading...");let e=t.data.id,i=t.data.p9,s=t.data.serial,r=new hr(t.data.sys),n=await r.readFile("#bundle/v86/seabios.bin"),o=await r.readFile("#bundle/v86/vgabios.bin"),h=await r.readFile("#bundle/kernel/bzImage"),_=await r.readFile("#bundle/v86/v86.wasm"),c=new Blob([_],{type:"application/wasm"}),d;t.data.screen&&document&&(d=document.querySelector(t.data.screen));let p=null;i.onmessage=g=>{p&&p(g.data)};let f=new Ts(Object.assign(t.data.options,{disable_speaker:!0,screen_container:d,wasm_path:URL.createObjectURL(c),filesystem:{handle9p:(g,x)=>{p=x,i.postMessage(g)}},bios:{buffer:n.slice().buffer},vga_bios:{buffer:o.slice().buffer},bzimage:{buffer:h.slice().buffer}}));f.add_listener("emulator-ready",function(){let g=new mi(f);f.shmPort=g.getUserPort(),self.postMessage({shmPort:f.shmPort},[f.shmPort])}),s.onmessage=g=>f.serial_send_bytes(0,g.data),f.add_listener("serial0-output-byte",g=>s.postMessage(g)),globalThis.window&&(window.vm=f)};})();
