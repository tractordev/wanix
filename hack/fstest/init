#!/bin/bash
set -e

# Check for help flag
if [ "$1" = "-h" ] || [ "$1" = "--help" ]; then
    echo "Usage: $0 [host:port]"
    echo "  If host:port is provided, mounts 9p filesystem at /mnt"
    echo "  Otherwise, mount directly to /mnt to test locally"
    exit 0
fi

# Parse host:port argument if provided
if [ $# -ge 1 ]; then
    HOST="${1%:*}"
    PORT="${1#*:}"

    if [ "$HOST" = "$PORT" ]; then
        echo "Error: Invalid host:port format"
        exit 1
    fi

    echo "* Mounting 9p filesystem from $HOST:$PORT at /mnt"
    sudo mount -t 9p -o trans=tcp,port=$PORT,version=9p2000.L,cache=loose,msize=524288 $HOST /mnt
fi

cd /mnt
if [ -n "$2" ]; then
    exec /bin/bash -c "$2"
fi
exec /bin/bash